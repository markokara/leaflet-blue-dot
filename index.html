<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir – Indoor & Outdoor Harita (3D + glTF)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#ffffff }
    html,body{height:100%;width:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f3f4f6}
    #map{
      position:fixed; inset:0;
      /* 0×0 görünmeme emniyeti */
      min-height:360px; min-width:360px;
    }
    .ol-attribution{font-size:10px; opacity:.85}
    .ol-attribution button{display:none}

    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); width:min(780px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:disabled{opacity:.6}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .muted{color:var(--muted)}
  </style>
</head>
<body>

  <div id="map" aria-label="Harita"></div>

  <div class="panel">
    <div class="card p-8">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz…"/>
        <button id="btn3d">3D: Kapalı</button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
        <button id="reset">Sıfırla</button>
        <span id="status" class="muted" style="margin-left:auto"></span>
      </div>
      <div class="muted" style="font-size:11px; text-align:right">© aihotelstech · © OpenStreetMap contributors</div>
    </div>
  </div>

<script>
/* ================== BOYUT & GÜVENLİK ================== */
const mapEl = document.getElementById('map');
function safeUpdateSize(){ try{ map.updateSize(); }catch{} }
if ('ResizeObserver' in window) new ResizeObserver(safeUpdateSize).observe(mapEl);
window.addEventListener('load', ()=> setTimeout(safeUpdateSize, 0));
window.addEventListener('orientationchange', ()=> setTimeout(safeUpdateSize, 25));

/* ================== KATLAR ================== */
const fmt = new ol.format.GeoJSON();

/* OSM + Carto fallback */
function makeBaseGroup(){
  const osm = new ol.layer.Tile({
    source:new ol.source.OSM({crossOrigin:'anonymous'})
  });
  const carto = new ol.layer.Tile({
    visible:false,
    source:new ol.source.XYZ({
      url:'https://{1-4}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
      attributions:'&copy; OpenStreetMap contributors &copy; CARTO'
    })
  });
  let fail=0;
  osm.getSource().on('tileloaderror',()=>{ if(++fail>=6){ osm.setVisible(false); carto.setVisible(true); }});
  return new ol.layer.Group({layers:[osm, carto]});
}

const indoorSrc  = new ol.source.Vector();
const outdoorSrc = new ol.source.Vector();
const indoorLyr  = new ol.layer.VectorImage({source:indoorSrc,  style:f=>styleFor(f)});
const outdoorLyr = new ol.layer.VectorImage({source:outdoorSrc, style:f=>styleFor(f)});

function styleFor(f){
  const g=f.getGeometry();
  if(g.getType()==='Point'){
    return new ol.style.Style({
      image:new ol.style.Circle({radius:7, fill:new ol.style.Fill({color:'#f94144'}), stroke:new ol.style.Stroke({color:'#fff', width:2})})
    });
  }
  return new ol.style.Style({
    stroke:new ol.style.Stroke({color:'#2563eb', width:2}),
    fill:new ol.style.Fill({color:'rgba(37,99,235,.10)'})
  });
}

const map = new ol.Map({
  target:'map',
  layers:[ makeBaseGroup(), indoorLyr, outdoorLyr ],
  view:new ol.View({center: ol.proj.fromLonLat([31.8046,36.6002]), zoom:16 })
});
map.addControl(new ol.control.Attribution({collapsible:false}));
map.addControl(new ol.control.Rotate());

/* Indoor/Outdoor verisini yükle */
async function loadIO(){
  const bust='v='+Date.now();
  const [indoor, outdoor] = await Promise.all([
    fetch('indoor.json?'+bust,  {cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]})),
    fetch('outdoor.json?'+bust, {cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
  ]);
  indoorSrc.clear(); outdoorSrc.clear();
  indoorSrc.addFeatures(fmt.readFeatures(indoor, {featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'}));
  outdoorSrc.addFeatures(fmt.readFeatures(outdoor,{featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'}));

  const ext=ol.extent.extend(indoorSrc.getExtent(), outdoorSrc.getExtent());
  if(ext && ext.every(isFinite)) map.getView().fit(ext,{padding:[140,20,160,20], maxZoom:19});
}
loadIO();

/* Katman görünürlüğü */
document.getElementById('tglIndoor').onchange=()=> indoorLyr.setVisible(document.getElementById('tglIndoor').checked);
document.getElementById('tglOutdoor').onchange=()=> outdoorLyr.setVisible(document.getElementById('tglOutdoor').checked);

/* ================== 3D + glTF (deck.gl) ================== */
const deckGlue = (function(){
  const deckDiv = document.createElement('div');
  deckDiv.id='deck3d'; deckDiv.style.cssText='position:absolute;inset:0;pointer-events:none;z-index:3';
  mapEl.style.position='relative'; mapEl.appendChild(deckDiv);

  const CDNS = [
    'https://cdn.jsdelivr.net/npm/deck.gl@8.9.36/dist.min.js',
    'https://unpkg.com/deck.gl@8.9.36/dist.min.js'
  ];
  function loadSeq(urls){
    return new Promise((res,rej)=>{
      const go=i=>{
        if(i>=urls.length) return rej(new Error('CDN blocked'));
        const s=document.createElement('script'); s.src=urls[i]; s.defer=true;
        s.onload=()=>res(urls[i]); s.onerror=()=>{s.remove(); go(i+1);};
        document.head.appendChild(s);
      }; go(0);
    });
  }

  const ZOFF=-1;
  const viewState=()=>{
    const v=map.getView(); const [lon,lat]=ol.proj.toLonLat(v.getCenter());
    const size=map.getSize()||[mapEl.clientWidth,mapEl.clientHeight];
    return {longitude:lon, latitude:lat, zoom:(v.getZoom()||0)+ZOFF, bearing:(-v.getRotation()*180/Math.PI), pitch:45, width:size[0], height:size[1]};
  };
  let deckI=null, hook=null, buildings=null;
  const sync=()=>{ if(deckI) deckI.setProps({viewState:viewState()}); };

  // centroid (lon,lat)
  function centroidLL(f){
    const g=f.geometry; if(!g) return [0,0];
    const ring = g.type==='Polygon' ? g.coordinates[0] : (g.type==='MultiPolygon' ? g.coordinates[0][0] : null);
    if(!ring) return [0,0];
    let x=0,y=0,a=0;
    for(let i=0;i<ring.length-1;i++){ const [x1,y1]=ring[i], [x2,y2]=ring[i+1]; const f=(x1*y2-x2*y1); x+=(x1+x2)*f; y+=(y1+y2)*f; a+=f; }
    a*=0.5; if(Math.abs(a)<1e-12) return ring[0]; return [x/(6*a), y/(6*a)];
  }

  function geoLayer(){
    return new deck.GeoJsonLayer({
      id:'b-extruded',
      data:buildings,
      extruded:true,
      material:{ambient:.35, diffuse:.7, shininess:12},
      getElevation:f=>{ const p=f.properties||{}; const h=+p.height||0; const lv=+p['building:levels']||+p.levels||0; return h || (lv>0? lv*3.2 : 8); },
      getFillColor:[185,185,185,235],
      getLineColor:[110,110,110],
      parameters:{depthTest:true}
    });
  }
  function modelLayer(){
    const feats=(buildings.features||[]).filter(f=>(f.properties||{}).modelUrl);
    if(!feats.length) return null;
    return new deck.ScenegraphLayer({
      id:'b-models', data:feats, scenegraph:f=>(f.properties||{}).modelUrl, _lighting:'pbr',
      getPosition:f=>{ const p=f.properties||{}; const ll=(typeof p.anchorLon==='number'&&typeof p.anchorLat==='number')?[p.anchorLon,p.anchorLat]:centroidLL(f); const z=+p.z||0; return [ll[0],ll[1],z]; },
      getOrientation:f=>{ const p=f.properties||{}; return [ +p.pitch||0, +p.yaw||0, +p.roll||0 ]; },
      getScale:f=>{ const p=f.properties||{}; if(Array.isArray(p.scale)&&p.scale.length===3) return p.scale; const s=+p.scale||1; return [s,s,s]; },
      parameters:{depthTest:true}
    });
  }

  async function enable(){
    if(deckI) return;
    document.getElementById('status').textContent='3D yükleniyor…';
    await loadSeq(CDNS);
    buildings = await fetch('buildings.json?v='+Date.now(),{cache:'no-store'}).then(r=>r.json());
    const layers=[geoLayer()]; const m=modelLayer(); if(m) layers.push(m);
    deckI = new deck.Deck({ parent:deckDiv, controller:false, initialViewState:viewState(), layers,
      effects:[ new deck.LightingEffect({ambientLight:new deck.AmbientLight({intensity:.7}), directionalLights:[new deck.DirectionalLight({intensity:1,direction:[-1,-1,-2]})]}) ]
    });
    hook = map.on('postrender', sync);
    new ResizeObserver(sync).observe(mapEl);
    document.getElementById('status').textContent='';
  }
  function disable(){
    if(!deckI) return;
    if(hook){ ol.Observable.unByKey(hook); hook=null; }
    deckI.finalize(); deckI=null;
  }
  return {enable, disable, get enabled(){return !!deckI;}};
})();

/* 3D butonu */
document.getElementById('btn3d').onclick=async (e)=>{
  const b=e.currentTarget; b.disabled=true;
  try{
    if(deckGlue.enabled){ deckGlue.disable(); b.textContent='3D: Kapalı'; }
    else { await deckGlue.enable(); b.textContent='3D: Açık'; }
  }catch(err){
    console.error(err);
    document.getElementById('status').textContent='3D (deck.gl) veya buildings.json yüklenemedi';
    b.textContent='3D: Kapalı';
  }finally{ b.disabled=false; }
};

/* Sıfırla */
document.getElementById('reset').onclick=()=>{
  if(deckGlue.enabled){ deckGlue.disable(); document.getElementById('btn3d').textContent='3D: Kapalı'; }
  loadIO();
};
</script>
</body>
</html>
