<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Otel Misafir Haritasƒ± ‚Äî Yerel Rota (routes.json)</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
  :root{ --shadow:0 10px 28px rgba(0,0,0,.18);
    --muted:#5b6a6a; --bg:#fff; --brand:#0f5132; --border:#cfe3da; --field:#f4fbf7; --chip:#e6f4ef;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eaf4f0}
  #map{position:fixed; inset:0}
  .panel{position:fixed; left:50%; bottom:0; transform:translateX(-50%); width:min(860px,96vw); z-index:1001}
  .card{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
  .p-8{padding:10px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:10px}
  input[type="search"]{width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field)}
  button{padding:9px 11px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:var(--field); white-space:nowrap}
  button:active{transform:translateY(1px)}
  .results{background:#fff; border:1px solid var(--border); border-radius:12px; max-height:36vh; overflow:auto; position:relative; z-index:1003; display:none}
  .results .item{display:flex; justify-content:space-between; gap:8px; padding:10px 12px; cursor:pointer}
  .results .item:hover{background:#f1f7f4}
  .badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#edf7f3; border:1px solid var(--border); font-size:12px}
  .acc{position:fixed; right:12px; bottom:12px; z-index:1001; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
  .muted{color:#6d7a7a}
</style>
</head>
<body>
<div id="map" aria-label="Harita"></div>

<!-- Alt kontrol paneli -->
<div class="panel">
  <div class="card">
    <div class="p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz‚Ä¶"/>
        <button id="pickDest">Haritadan Hedef</button>
        <button id="pickStart">Ba≈ülangƒ±√ß Se√ß</button>
        <button id="go" disabled>Git</button>
        <button id="reset">Sƒ±fƒ±rla</button>
        <select id="mode">
          <option value="foot" selected>Mod: Yaya</option>
          <option value="bike">Bisiklet</option>
          <option value="shuttle">Shuttle</option>
          <option value="service">Ara√ß/Servis</option>
          <option value="run">Ko≈üu</option>
          <option value="indoor">Indoor</option>
        </select>
        <button id="follow">üìç Takip: Kapalƒ±</button>
      </div>
      <div id="results" class="results"></div>
      <div class="muted" style="font-size:11px; text-align:right">¬© aihotelstech ¬∑ ¬© OpenStreetMap contributors ¬∑ ¬© MapTiler ¬∑ ¬© Mapbox</div>
    </div>
  </div>
</div>

<div id="acc" class="acc" style="display:none"></div>

<script>
/* ================== SABƒ∞TLER (kolayca deƒüi≈ütir) ================== */
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";

const HOTEL_BBOX = [31.801445, 36.597411, 31.808467, 36.600917];
const PADDING    = {top:120,right:16,bottom:160,left:16};
const DEFAULT_PITCH = 15, DEFAULT_BEARING = 0;

/* OSM √ºst raster opaklƒ±ƒüƒ± ‚Äì buradan istediƒüin deƒüeri ver (0‚Äì1) */
const OSM_OPACITY = 0.4;

/* Snap menzili (m) ‚Äì konum/POI yol aƒüƒ±na bu mesafeye kadar yapƒ±≈üƒ±r */
const SNAP_MAX_METERS = 12;

/* ================== K√ú√á√úK YARDIMCILAR ================== */
const $=id=>document.getElementById(id);
const centerOfHotel=[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
function emptyFC(){return {type:'FeatureCollection',features:[]};}
function linkify(text){ return (text||'').replace(/(https?:\/\/[^\s<>"']+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); }

/* Haversine (m) */
function haversine(a,b){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const dLat=toRad(b[1]-a[1]), dLon=toRad(b[0]-a[0]);
  const lat1=toRad(a[1]), lat2=toRad(b[1]);
  const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
/* Noktanƒ±n segmente dik izd√º≈ü√ºm√º */
function projectPointOnSegment(p,a,b){
  const k=Math.cos((a[1]+b[1])*Math.PI/360);
  const ax=a[0]*k, ay=a[1], bx=b[0]*k, by=b[1], px=p[0]*k, py=p[1];
  const vx=bx-ax, vy=by-ay, wx=px-ax, wy=py-ay;
  const vv=vx*vx+vy*vy || 1e-12;
  let t=(wx*vx+wy*vy)/vv; if(t<0)t=0; else if(t>1)t=1;
  const qx=ax+t*vx, qy=ay+t*vy;
  const q=[qx/k,qy];
  return {point:q, t, distM:haversine(p,q)};
}
/* En yakƒ±n segmenti bul */
function nearestOnNetwork(p, edges){
  let best=null;
  for(let i=0;i<edges.length;i++){
    const e=edges[i];
    const pr=projectPointOnSegment(p,e.a,e.b);
    if(!best || pr.distM<best.distM) best={...pr, edgeIndex:i};
  }
  return best;
}
/* Anahtar (kuantize) */
function keyOf(c){ return c[0].toFixed(6)+','+c[1].toFixed(6); }

/* ================== HARƒ∞TA ================== */
const baseStyle={version:8, sources:{}, layers:[{id:'bg',type:'background',paint:{'background-color':'#dfe7e7'}}]};
const map=new maplibregl.Map({
  container:'map', style:baseStyle,
  center:centerOfHotel, zoom:16, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEARING,
  maxZoom:21, attributionControl:false
});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}),'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'¬© aihotelstech'}));

/* ====== RASTER: Mapbox Satellite (altta) + OSM (√ºstte, opaklƒ±ƒüƒ± sabitten) ====== */
map.on('load', async ()=>{
  map.addSource('sat',{ type:'raster',
    tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`],
    tileSize:256, attribution:"¬© Mapbox ¬© OSM"
  });
  map.addLayer({id:'sat-lyr', type:'raster', source:'sat', paint:{'raster-opacity':1}});

  map.addSource('osm',{ type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, attribution:"¬© OpenStreetMap contributors" });
  map.addLayer({id:'osm-lyr', type:'raster', source:'osm', paint:{'raster-opacity': OSM_OPACITY}});

  // POI/√ßizimler
  map.addSource('indoor',{type:'geojson', data:emptyFC()});
  map.addSource('outdoor',{type:'geojson', data:emptyFC()});
  addFeatureLayers('indoor'); addFeatureLayers('outdoor');

  // Rota katmanlarƒ±
  map.addSource('routes_view',{type:'geojson', data:emptyFC()});
  map.addLayer({id:'routes_view', type:'line', source:'routes_view',
    paint:{'line-color':'#222','line-width':3,'line-opacity':0.9}});

  map.addSource('dest',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'dest-pt',type:'circle',source:'dest',paint:{'circle-radius':7,'circle-color':'#ef4444','circle-stroke-color':'#fff','circle-stroke-width':1.8}});

  map.addSource('start',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'start-pt',type:'circle',source:'start',paint:{'circle-radius':6,'circle-color':'#0ea5e9','circle-stroke-color':'#fff','circle-stroke-width':1.6}});

  map.addSource('route',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'route-line',type:'line',source:'route',paint:{'line-color':'#1b7a5b','line-width':4}});

  map.addSource('me',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'me-pt',type:'circle',source:'me',paint:{'circle-radius':6,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1.6}});

  await loadJSONs();
  await loadRoutes();

  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING});
});

function addFeatureLayers(src){
  map.addLayer({id:`${src}-fill`,type:'fill',source:src,paint:{'fill-color':['coalesce',['get','fill'],'#2563eb'],'fill-opacity':['coalesce',['get','fill_op'],0.35]}});
  map.addLayer({id:`${src}-line`,type:'line',source:src,filter:['==',['geometry-type'],'LineString'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],2.5]}});
  map.addLayer({id:`${src}-pts`,type:'circle',source:src,filter:['==',['geometry-type'],'Point'],paint:{'circle-radius':['coalesce',['get','icon_sz'],6],'circle-color':['coalesce',['get','stroke'],'#e53935'],'circle-stroke-color':'#fff','circle-stroke-width':1.6}});
}

/* ================== DATA LOAD ================== */
async function loadJSONs(){
  const bust='v='+Date.now();
  const [indoor,outdoor] = await Promise.all([
    fetch('indoor.json?'+bust,{cache:'no-store'}).then(r=>r.ok?r.json():emptyFC()).catch(()=>emptyFC()),
    fetch('outdoor.json?'+bust,{cache:'no-store'}).then(r=>r.ok?r.json():emptyFC()).catch(()=>emptyFC())
  ]);
  map.getSource('indoor').setData(indoor);
  map.getSource('outdoor').setData(outdoor);
}

/* ====== Routes (yerel aƒü) ====== */
let ROUTE_GJ=emptyFC();
let EDGES=[]; // {a:[lon,lat], b:[lon,lat], lenM, dir:'both'|'fwd'|'rev', mode:'foot'|'bike'|...}

async function loadRoutes(){
  const bust='v='+Date.now();
  ROUTE_GJ = await fetch('routes.json?'+bust,{cache:'no-store'}).then(r=>r.ok?r.json():emptyFC()).catch(()=>emptyFC());
  map.getSource('routes_view').setData(ROUTE_GJ);
  buildEdgesFromRoutes(ROUTE_GJ);
  console.log('ROUTES:', EDGES.length, 'edges');
}

function buildEdgesFromRoutes(gj){
  EDGES=[];
  (gj.features||[]).forEach(f=>{
    const g=f.geometry; if(!g) return;
    const way=(f.properties?.way||'foot'); // mod/tek-y√∂n ipucu
    const dir = way==='oneway_fwd' ? 'fwd' : way==='oneway_rev' ? 'rev' : 'both';
    const mode = (['foot','bike','shuttle','service','run','indoor'].includes(way)) ? way : 'foot';

    const add=(arr)=>{ for(let i=1;i<arr.length;i++){
      const a=arr[i-1], b=arr[i]; if(!a||!b) continue;
      const lenM=haversine(a,b); if(lenM<0.2) continue;
      EDGES.push({a,b,lenM,dir,mode});
    }};
    if(g.type==='LineString') add(g.coordinates);
    else if(g.type==='MultiLineString') g.coordinates.forEach(add);
  });
}

/* ================== UI, ARA, HEDEF/BA≈ûLANGI√á ================== */
const q=$('q'), goBtn=$('go'), pickDestBtn=$('pickDest'), pickStartBtn=$('pickStart'), resetBtn=$('reset'), modeSel=$('mode');
const results=$('results');

let pickDest=false, pickStart=false;
let startPicked=null; // [lon,lat]
let lastKnown=null;
let followState=false;

function setDestination(xy){
  map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]});
  goBtn.disabled=false;
}
function clearDestination(){ map.getSource('dest').setData(emptyFC()); }
function setStart(xy){
  startPicked=xy;
  map.getSource('start').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]});
}
function clearStart(){ startPicked=null; map.getSource('start').setData(emptyFC()); }

pickDestBtn.onclick=()=>{ pickDest=!pickDest; pickDestBtn.classList.toggle('active', pickDest); };
pickStartBtn.onclick=()=>{ pickStart=!pickStart; pickStartBtn.classList.toggle('active', pickStart); };
resetBtn.onclick=()=>{ clearDestination(); clearStart(); map.getSource('route').setData(emptyFC()); q.value=''; results.style.display='none'; };

map.on('click', e=>{
  const p=[e.lngLat.lng,e.lngLat.lat];

  // √ñnce se√ßim modlarƒ±
  if(pickDest){ setDestination(p); pickDest=false; pickDestBtn.classList.remove('active'); return; }
  if(pickStart){ setStart(p); pickStart=false; pickStartBtn.classList.remove('active'); return; }

  // Normal tƒ±klama: katman i√ßi bir ≈üeyse popup + HEDEF
  const feats = map.queryRenderedFeatures(e.point, {layers:['indoor-pts','outdoor-pts','indoor-fill','outdoor-fill','indoor-line','outdoor-line']});
  if(feats && feats[0]){
    showPopup(feats[0], e.lngLat);
    setDestination(p);
  }else{
    // bo≈üluƒüa tƒ±klanƒ±rsa da hedefi set edelim
    setDestination(p);
  }
});

/* Popup */
let popup;
function showPopup(f,lngLat){
  const p=f.properties||{};
  const html = `<div style="min-width:220px">
      <div style="font-weight:600;margin-bottom:6px;color:#0f5132">${p.name||p['name_tr']||''}</div>
      ${p.category?`<div class="badge">${p.category}</div>`:''}
      ${p.hours?`<div style="margin-top:6px"><small>Saat:</small> ${p.hours}</div>`:''}
      ${p.level?`<div><small>Kat:</small> ${p.level}</div>`:''}
      ${p.desc?`<div style="margin-top:6px" class="muted">${linkify(p.desc)}</div>`:''}
    </div>`;
  (popup||(popup=new maplibregl.Popup({closeButton:true, closeOnClick:true}))).setLngLat(lngLat).setHTML(html).addTo(map);
}

/* ================== GEOLOCATION ================== */
const acc=$('acc');
if('geolocation' in navigator){
  try{ navigator.geolocation.getCurrentPosition(()=>{},()=>{}, {enableHighAccuracy:true, timeout:10000}); }catch{}
  navigator.geolocation.watchPosition(p=>{
    const accM=Math.round(p.coords.accuracy||999);
    lastKnown=[p.coords.longitude,p.coords.latitude];
    map.getSource('me').setData({type:'FeatureCollection',features:[{type:'Feature',properties:{acc:accM},geometry:{type:'Point',coordinates:lastKnown}}]});
    acc.textContent="¬±"+accM+" m"; acc.style.display='block';
    if(followState) map.easeTo({center:lastKnown});
  }, console.warn, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
}
$('follow').onclick=()=>{ followState=!followState; $('follow').textContent = followState ? "üìç Takip: A√ßƒ±k" : "üìç Takip: Kapalƒ±"; if(followState && lastKnown) map.easeTo({center:lastKnown}); };

/* ================== ROUTING (A* sadece routes.json aƒüƒ±) ================== */

/* Mod filtre: se√ßili moda uygun kenarlar kullanƒ±lacak */
function edgeAllowed(e, mode){
  // Eƒüer kenarƒ±n bir modu varsa ve se√ßilen modla uyu≈ümuyorsa kullanma.
  if(e.mode && e.mode!==mode && !(mode==='foot' && e.mode==='indoor')) return false;
  return true;
}

/* Ba≈ülangƒ±√ß/varƒ±≈üƒ± aƒüa ekle (segmanƒ± b√∂l) ve ge√ßici graf olu≈ütur */
function buildGraphWithSplit(ns, nd, mode){
  // 1) Orijinal kenarlardan kopya listesi + √ßƒ±karƒ±lacaklar
  const removed=new Set([ns.edgeIndex, nd.edgeIndex]);
  const base = EDGES.filter((_,i)=>!removed.has(i));

  // 2) ns i√ßin iki yeni kenar
  const eS = EDGES[ns.edgeIndex];
  const s1 = {a:eS.a, b:ns.point, lenM:haversine(eS.a,ns.point), dir:eS.dir, mode:eS.mode};
  const s2 = {a:ns.point, b:eS.b, lenM:haversine(ns.point,eS.b), dir:eS.dir, mode:eS.mode};

  // 3) nd i√ßin iki yeni kenar
  const eD = EDGES[nd.edgeIndex];
  const d1 = {a:eD.a, b:nd.point, lenM:haversine(eD.a,nd.point), dir:eD.dir, mode:eD.mode};
  const d2 = {a:nd.point, b:eD.b, lenM:haversine(nd.point,eD.b), dir:eD.dir, mode:eD.mode};

  const edges = base.concat([s1,s2,d1,d2]).filter(e=>edgeAllowed(e,mode));

  // 4) D√ºƒü√ºmler ve kom≈üuluk
  const nodes=new Map(); // key -> {coord:[lon,lat], neigh:[{toKey, w}]}
  const addNode=(c)=>{ const k=keyOf(c); if(!nodes.has(k)) nodes.set(k,{coord:c,neigh:[]}); return k; };
  const addEdge=(u,v,w,dir)=>{
    const ku=addNode(u), kv=addNode(v);
    if(dir==='both'||dir===undefined) { nodes.get(ku).neigh.push({to:kv,w}); nodes.get(kv).neigh.push({to:ku,w}); }
    else if(dir==='fwd'){ nodes.get(ku).neigh.push({to:kv,w}); }
    else if(dir==='rev'){ nodes.get(kv).neigh.push({to:ku,w}); }
  };
  edges.forEach(e=> addEdge(e.a,e.b,e.lenM,e.dir));

  return {nodes, startKey:keyOf(ns.point), destKey:keyOf(nd.point)};
}

/* Basit A* */
function aStar(nodes, startKey, destKey){
  const h = (k)=> haversine(nodes.get(k).coord, nodes.get(destKey).coord);

  const open=new Set([startKey]);
  const came=new Map();
  const g=new Map([[startKey,0]]);
  const f=new Map([[startKey,h(startKey)]]);

  while(open.size){
    // en k√º√ß√ºk f
    let current=null, best=Infinity;
    for(const k of open){ const val=f.get(k)??Infinity; if(val<best){best=val; current=k;} }
    if(current===destKey) break;
    open.delete(current);

    for(const nb of nodes.get(current).neigh){
      const tentative=(g.get(current)??Infinity)+nb.w;
      if(tentative < (g.get(nb.to)??Infinity)){
        came.set(nb.to, current);
        g.set(nb.to, tentative);
        f.set(nb.to, tentative + h(nb.to));
        open.add(nb.to);
      }
    }
  }

  // yol geri sarma
  if(!came.has(destKey) && startKey!==destKey) return null;
  const path=[destKey];
  let cur=destKey;
  while(cur!==startKey){
    cur=came.get(cur);
    if(cur==null) break;
    path.push(cur);
  }
  path.reverse();
  return path.map(k=>nodes.get(k).coord);
}

/* ================== GO ================== */
$('go').onclick=()=>{
  const destF = map.getSource('dest')._data?.features?.[0];
  if(!destF){ alert('Hedef se√ßilmedi.'); return; }
  if(!EDGES.length){ alert('routes.json bo≈ü veya √ßizgi yok.'); return; }

  const mode = modeSel.value;
  const start = startPicked || lastKnown || centerOfHotel;
  const dest  = destF.geometry.coordinates;

  const ns=nearestOnNetwork(start, EDGES);
  const nd=nearestOnNetwork(dest,  EDGES);
  if(!ns || !nd || ns.distM>SNAP_MAX_METERS || nd.distM>SNAP_MAX_METERS){
    alert('Aƒüa baƒülanƒ±lamadƒ±. Ba≈ülangƒ±√ß/hedefi yol aƒüƒ±na daha yakƒ±n se√ßin.');
    return;
  }

  const {nodes,startKey,destKey} = buildGraphWithSplit(ns, nd, mode);
  const coords = aStar(nodes, startKey, destKey);
  if(!coords || !coords.length){ alert('Aƒü baƒülƒ± deƒüil veya se√ßilen moda uygun yol yok.'); return; }

  map.getSource('route').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:coords}}]});
  fitToCoords(coords);
};

function fitToCoords(coords){
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  coords.forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
  if(isFinite(minX)) map.fitBounds([[minX,minY],[maxX,maxY]],{padding:PADDING,maxZoom:18});
}

/* ================== BASƒ∞T ARAMA (ismi i√ßeren) ================== */
let allFeats=[];
async function indexFeats(){
  const ind = map.getSource('indoor')._data?.features||[];
  const out = map.getSource('outdoor')._data?.features||[];
  allFeats = ind.concat(out);
}
map.on('load', ()=> setTimeout(indexFeats, 500));

q.addEventListener('input', ()=>{
  const val=(q.value||'').trim().toLowerCase();
  if(!val){ results.style.display='none'; return; }
  results.innerHTML='';
  allFeats.filter(f=>((f.properties?.name||'')+(f.properties?.desc||'')).toLowerCase().includes(val))
    .slice(0,80)
    .forEach(f=>{
      const div=document.createElement('div'); div.className='item';
      div.innerHTML=`<span>${f.properties?.name||'(isimsiz)'}</span><small>${f.properties?.category||''}</small>`;
      div.onclick=()=>{ const c=coordOfFeature(f); setDestination(c); map.easeTo({center:c}); results.style.display='none'; goBtn.disabled=false; };
      results.appendChild(div);
    });
  results.style.display='block';
});

function coordOfFeature(f){
  const g=f.geometry; if(!g) return centerOfHotel;
  if(g.type==='Point') return g.coordinates;
  if(g.type==='Polygon'){ const ring=g.coordinates[0]; return ring[Math.floor(ring.length/2)]; }
  if(g.type==='MultiPolygon'){ const ring=g.coordinates[0][0]; return ring[Math.floor(ring.length/2)]; }
  if(g.type==='LineString'){ const c=g.coordinates; return c[Math.floor(c.length/2)]; }
  return centerOfHotel;
}
</script>
</body>
</html>
