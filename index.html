<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir â€“ Indoor & Outdoor Harita</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#ffffff }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f3f4f6}
    #map{position:fixed; inset:0}

    /* Attribution kÃ¼Ã§Ã¼k ve sade (lisansa uygun) */
    .ol-attribution{font-size:10px; opacity:.85}
    .ol-attribution button{display:none}

    /* Alt panel (tek yerde tÃ¼m kontroller) */
    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); width:min(780px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px}
    .stack{display:flex; flex-direction:column; gap:8px}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button,.btn{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .pill input{accent-color:#1d4ed8}
    .muted{color:var(--muted)}

    /* Arama sonuÃ§larÄ± */
    .results{background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:36vh; overflow:auto; display:none}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}
    .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}

    /* YÃ¶nerge kutusu */
    .dir{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:10px}
    .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb}
    .dir .sum{font-weight:600}
    .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
    .step{display:flex; gap:8px; padding:6px 0; border-bottom:1px dashed #e5e7eb}
    .step:last-child{border-bottom:none}

    /* Popup */
    .ol-popup{position:absolute; background:#fff; padding:10px; border-radius:10px; border:1px solid #e5e7eb; min-width:220px; box-shadow:var(--shadow); transform:translate(-50%,-100%); }
    .ol-popup-closer{position:absolute; right:8px; top:6px; text-decoration:none; color:#9ca3af}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}

    /* Konum doÄŸruluk rozeti: SAÄž ALTA */
    .acc{position:fixed; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}

    @media (max-width:520px){ .panel{bottom:8px} }
  </style>
</head>
<body>

  <!-- Tek panel -->
  <div class="panel">
    <div class="card p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuzâ€¦" />
        <button id="go" disabled>Git</button>
        <select id="lang" aria-label="Language">
          <option value="tr" selected>TR</option>
          <option value="en">EN</option>
          <option value="ru">RU</option>
          <option value="de">DE</option>
          <option value="pl">PL</option>
        </select>
      </div>

      <div class="row" style="flex-wrap:wrap">
        <button id="pick">Haritadan Hedef</button>
        <button id="follow">ðŸŽ¯ Ä°zle: KapalÄ±</button>
        <button id="toggleDetails">Detaylar: KapalÄ±</button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
        <button id="reset">SÄ±fÄ±rla</button>
        <span class="muted" id="hint" style="display:none">ðŸ”Ž Arama aÃ§Ä±k</span>
      </div>

      <div id="results" class="results"></div>

      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">â€“</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">â–²</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>

      <div class="muted" style="font-size:11px; text-align:right">Â© aihotelstech Â· Â© OpenStreetMap contributors</div>
    </div>
  </div>

  <!-- Konum doÄŸruluk rozeti -->
  <div id="acc" class="acc" style="display:none"></div>

  <!-- Popup -->
  <div id="popup" class="ol-popup" style="display:none">
    <a href="#" id="popup-closer" class="ol-popup-closer">âœ•</a>
    <div id="popup-content"></div>
  </div>

  <div id="map" aria-label="Harita"></div>

  <script>
    /* ========= i18n ========= */
    const I18N = {
      tr:{
        searchPH:"Ara: restoran, spa, havuzâ€¦",
        go:"Git",
        ui:{
          pick:"Haritadan Hedef",
          followOn:"Ä°zle: AÃ§Ä±k",
          followOff:"Ä°zle: KapalÄ±",
          detailsOn:"Detaylar: AÃ§Ä±k",
          detailsOff:"Detaylar: KapalÄ±",
          reset:"SÄ±fÄ±rla",
          hint:"ðŸ”Ž Arama aÃ§Ä±k: sadece eÅŸleÅŸenler gÃ¶steriliyor",
          clearRoute:"Rota Temizle"
        },
        labels:{name:"Ä°sim", category:"TÃ¼r", hours:"Saat", level:"Kat", desc:"AÃ§Ä±klama", dist:"Mesafe", duration:"SÃ¼re"},
        cats:{
          pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"DÃ¼kkan",
          toilet:"WC", reception:"Resepsiyon", beach:"Plaj", kidsclub:"Ã‡ocuk KulÃ¼bÃ¼", elevator:"AsansÃ¶r",
          gate:"KapÄ±", parking:"Otopark", shuttle:"Servis", gym:"Spor Salonu"
        },
        nav:{
          depart:"BaÅŸla", arrive:"VarÄ±ÅŸ", turn_left:"Sola dÃ¶n", turn_right:"SaÄŸa dÃ¶n", straight:"DÃ¼z devam",
          roundabout:"GÃ¶bekte %n. Ã§Ä±kÄ±ÅŸ", onto:" â†’ %s"
        }
      },
      en:{
        searchPH:"Search: restaurant, spa, poolâ€¦",
        go:"Go",
        ui:{
          pick:"Pick on Map",
          followOn:"Follow: On",
          followOff:"Follow: Off",
          detailsOn:"Details: On",
          detailsOff:"Details: Off",
          reset:"Reset",
          hint:"ðŸ”Ž Search is active: only matches are shown",
          clearRoute:"Clear Route"
        },
        labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description", dist:"Distance", duration:"Duration"},
        cats:{
          pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop",
          toilet:"Toilet", reception:"Reception", beach:"Beach", kidsclub:"Kids Club", elevator:"Elevator",
          gate:"Gate", parking:"Parking", shuttle:"Shuttle", gym:"Gym"
        },
        nav:{
          depart:"Depart", arrive:"Arrive", turn_left:"Turn left", turn_right:"Turn right", straight:"Go straight",
          roundabout:"At roundabout take exit %n", onto:" onto %s"
        }
      }
    };
    let LANG = localStorage.getItem("lang") || "tr";
    const t = () => I18N[LANG] || I18N.tr;
    const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/[Ì€-Í¯]/g,'');

    /* eÅŸanlamlÄ±lar */
    const SYNONYMS = {
      pool:['havuz','pool','basen','Ð±Ð°ÑÑÐµÐ¹Ð½','schwimmbad'],
      restaurant:['restoran','restaurant','restauracja','Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½','gaststÃ¤tte'],
      spa:['spa','wellness','ÑÐ¿Ð°'],
      bar:['bar','barÄ±','Ð±Ð°Ñ€'],
      cafe:['cafe','cafÃ©','kafe','ÐºÐ°Ñ„Ðµ','kawiarnia'],
      shop:['shop','store','market','magaza','sklep','Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½','laden'],
      toilet:['wc','toilet','tuvalet','restroom','toaleta','Ñ‚ÑƒÐ°Ð»ÐµÑ‚'],
      reception:['reception','resepsiyon','recepcja','Ñ€ÐµÑ†ÐµÐ¿Ñ†Ð¸Ñ'],
      beach:['beach','plaj','plaÅ¼a','Ð¿Ð»ÑÐ¶','strand'],
      kidsclub:['kids club','kidsclub','Ã§ocuk','miniclub','Ð´ÐµÑ‚ÑÐºÐ¸Ð¹ ÐºÐ»ÑƒÐ±','kinderclub'],
      elevator:['elevator','lift','asansÃ¶r','aufzug','Ð»Ð¸Ñ„Ñ‚','winda'],
      gate:['gate','kapÄ±','giriÅŸ','brama','Ð²Ð¾Ñ€Ð¾Ñ‚Ð°'],
      parking:['parking','park','otopark','parkplatz'],
      shuttle:['shuttle','servis','bus'],
      gym:['gym','fitness','spor','siÅ‚ownia']
    };
    const KEYWORD_TO_CAT = (()=>{ const m={}; Object.entries(SYNONYMS).forEach(([k,a])=>a.forEach(w=>m[norm(w)]=k)); return m; })();

    /* ========= Map ========= */
    const base = new ol.layer.Tile({
      source: new ol.source.OSM({ attributions: 'Â© aihotelstech Â· Â© OpenStreetMap contributors' })
    });

    const indoorSource = new ol.source.Vector();
    const outdoorSource = new ol.source.Vector();

    let showAllDetails=false;
    const FEATURED=new Set(['reception','restaurant','spa','pool','beach','bar','toilet','kidsclub','elevator','gate','parking','shuttle','shop']);
    let searchIds=null;

    function styleFactory(kind){
      return f=>{
        if(f.get('src')!==kind) return null;
        if(Array.isArray(searchIds)){
          const id = f.ol_uid || f.getId();
          const hit = searchIds.includes(id);
          return hit ? styleFor(f,1) : null;
        }
        const cat=(f.get('category')||'').toLowerCase();
        if(!showAllDetails && !FEATURED.has(cat)) return null;
        return styleFor(f,1);
      };
    }

    function styleFor(f,dim){
      const g=f.getGeometry();
      if(g.getType()==='Point'){
        return new ol.style.Style({
          image:new ol.style.Circle({
            radius:7,
            fill:new ol.style.Fill({color:`rgba(249,65,68,${0.95*dim})`}),
            stroke:new ol.style.Stroke({color:`rgba(193,18,31,${1*dim})`,width:2})
          })
        });
      }
      return new ol.style.Style({
        stroke:new ol.style.Stroke({color:`rgba(37,99,235,${1*dim})`,width:2}),
        fill:new ol.style.Fill({color:`rgba(37,99,235,${.10*dim})`})
      });
    }

    const indoorLayer = new ol.layer.VectorImage({ source: indoorSource, style: styleFactory('indoor') });
    const outdoorLayer = new ol.layer.VectorImage({ source: outdoorSource, style: styleFactory('outdoor') });

    // BaÅŸlangÄ±Ã§ta 30Â° aÃ§Ä±
    const view = new ol.View({
      center: ol.proj.fromLonLat([31.8046,36.6002]),
      zoom:16,
      rotation: Math.PI / 6  // 30 derece
    });

     // Otelin koordinat sÄ±nÄ±rlarÄ± (yaklaÅŸÄ±k bounding box)
  const hotelExtent = ol.proj.transformExtent(
    [31.8015, 36.5980, 31.8080, 36.6035], // Long Beach Hotel alanÄ± (lon/lat minX,minY,maxX,maxY)
    'EPSG:4326', 'EPSG:3857'
  );

  const map = new ol.Map({
    target: 'map',
    layers: [base, indoorLayer, outdoorLayer],
    view: new ol.View({
      center: ol.proj.fromLonLat([31.8046, 36.6002]), // otel merkezi
      zoom: 17,
      minZoom: 16,
      maxZoom: 19,
      rotation: Math.PI / 6, // 30 derece dÃ¶ndÃ¼r
      extent: hotelExtent // sadece otel alanÄ± iÃ§inde gezilebilir
    }),
    controls: ol.control.defaults().extend([
      new ol.control.Rotate(),
      new ol.control.Attribution({ collapsible: false })
    ])
  });

  // Oteli ekrana tam sÄ±ÄŸdÄ±r
  map.getView().fit(hotelExtent, {
    padding: [80, 20, 120, 20],
    maxZoom: 18,
    duration: 800
  });

    /* ========= UI ========= */
    const $ = id=>document.getElementById(id);
    const q=$('q'), go=$('go'), langSel=$('lang'), pickBtn=$('pick'), followBtn=$('follow'), toggleDetails=$('toggleDetails'), resetBtn=$('reset'), results=$('results'), acc=$('acc'), hint=$('hint');
    const tglIndoor=$('tglIndoor'), tglOutdoor=$('tglOutdoor');
    const dirBox=$('dir'), dirSum=$('dirSum'), dirSub=$('dirSub'), dirList=$('dirList'), collapseDir=$('collapseDir'), clearRouteBtn=$('clearRoute');
    const popupEl=$('popup'), popupCloser=$('popup-closer'), popupContent=$('popup-content');

    const popupOverlay=new ol.Overlay({element:popupEl, autoPan:{animation:{duration:200}}});
    map.addOverlay(popupOverlay);
    popupCloser.addEventListener('click',e=>{e.preventDefault(); hidePopup();});

    function setSearchUIState(active){
      toggleDetails.disabled = active;
      hint.style.display = active ? 'inline' : 'none';
    }

    /* ========= Veri (cache-bypass + â€œSÄ±fÄ±rlaâ€ ile yeniden yÃ¼kle) ========= */
    const fmt=new ol.format.GeoJSON();
    let allFeats=[];
    let HOTEL_EXTENT_PADDED=null;

    async function loadJSONs(){
      const bust = 'v=' + Date.now();
      const [indoor, outdoor] = await Promise.all([
        fetch('indoor.json?'+bust, {cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]})),
        fetch('outdoor.json?'+bust, {cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
      ]);

      indoorSource.clear();
      outdoorSource.clear();

      const add=(src,gj,kind)=>{
        const fs=fmt.readFeatures(gj,{featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'});
        fs.forEach(f=>f.set('src',kind));
        src.addFeatures(fs);
      };
      add(indoorSource,indoor,'indoor');
      add(outdoorSource,outdoor,'outdoor');

      allFeats = indoorSource.getFeatures().concat(outdoorSource.getFeatures());

      if(allFeats.length){
        // Otel alanÄ±nÄ± hesapla ve biraz tampon ekle
        const raw=ol.extent.extend(indoorSource.getExtent(), outdoorSource.getExtent());
        if(raw && raw.every(isFinite)){
          const pad=30; // metre cinsinden
          HOTEL_EXTENT_PADDED=[raw[0]-pad, raw[1]-pad, raw[2]+pad, raw[3]+pad];
          lockToHotel(); // kilitle + 30Â° gÃ¶ster
        }
      }

      applyLang();
      searchIds=null;
      results.style.display='none';
      setSearchUIState(false);
      redraw();
    }
    loadJSONs();

    // â€”â€”â€” Sadece otel alanÄ±: pan/zoom kilidi + baÅŸlangÄ±Ã§ 30Â°
    function lockToHotel(){
      if(!HOTEL_EXTENT_PADDED) return;
      view.setRotation(Math.PI/6); // 30Â°
      view.fit(HOTEL_EXTENT_PADDED,{padding:[140,20,180,20], maxZoom:22, duration:0});
      const zFull=view.getZoom();      // en uzak gÃ¶rÃ¼nÃ¼m = otelin tamamÄ±
      view.setMinZoom(zFull);          // daha fazla uzaklaÅŸma YOK
      view.setMaxZoom(zFull+4);        // 4 kademe yakÄ±nlaÅŸma SERBEST (istersen deÄŸiÅŸtir)
      view.setExtent(HOTEL_EXTENT_PADDED); // merkez bu extenti terk etmez
      view.setConstrainOnlyCenter(true);   // sadece merkezi kÄ±sÄ±tla (daha doÄŸal his)
    }
    // Ekran boyutu deÄŸiÅŸirse kilidi koru
    new ResizeObserver(()=> lockToHotel()).observe(document.body);

    /* ========= Dil ========= */
    function applyLang(){
      const L=t();
      q.placeholder=L.searchPH;
      go.textContent=L.go;
      pickBtn.textContent=L.ui.pick;
      followBtn.textContent = followState ? L.ui.followOn : L.ui.followOff;
      toggleDetails.textContent = showAllDetails ? L.ui.detailsOn : L.ui.detailsOff;
      resetBtn.textContent=L.ui.reset;
      clearRouteBtn.textContent=L.ui.clearRoute;
      localStorage.setItem('lang',LANG);
      if(currentPopupFeature && popupOverlay.getPosition()) popupContent.innerHTML=renderPopup(currentPopupFeature);
    }
    langSel.value=LANG;
    langSel.addEventListener('change',()=>{ LANG=langSel.value; applyLang(); });

    /* ========= Arama ========= */
    function detectCategory(qs){
      const nq=norm(qs), dict=I18N[LANG]?.cats||{};
      for(const [k,label] of Object.entries(dict)){
        if(norm(label).includes(nq) || nq.includes(norm(label))) return k;
      }
      return KEYWORD_TO_CAT[nq] || null;
    }

    q.addEventListener('input', ()=>{
      const val=(q.value||'').trim();
      if(!val){
        searchIds=null;
        redraw();
        results.style.display='none';
        setSearchUIState(false);
        return;
      }
      const qn=norm(val);
      const maybeCat=detectCategory(val);

      const hits=allFeats.filter(f=>{
        const p=f.getProperties();
        const cat=(p.category||'').toLowerCase();
        if(maybeCat && cat===maybeCat) return true;

        const names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
        if(names.some(n=>n.includes(qn))) return true;

        const ex=[p.desc,p['desc_'+LANG],p.level,p['level_'+LANG],p.hours,p['hours_'+LANG]].filter(Boolean).map(norm);
        return ex.some(d=>d.includes(qn));
      });

      showResults(hits, maybeCat);
      searchIds = hits.map(f=> f.ol_uid || f.getId());
      redraw();
      setSearchUIState(true);
    });

    q.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const first=results.querySelector('.item');
        if(first){ first.click(); e.preventDefault(); }
      }
    });

    function showResults(list,cat){
      results.innerHTML='';
      const hintDiv=document.createElement('div');
      hintDiv.className='hint';
      hintDiv.textContent=t().ui.hint;
      results.appendChild(hintDiv);

      if(cat){
        const feats=allFeats.filter(f=> (f.get('category')||'').toLowerCase()===cat);
        const div=document.createElement('div');
        div.className='item';
        div.innerHTML = `<span>âž¤ ${(t().cats?.[cat] || cat)}</span> <small>${feats.length}</small>`;
        div.onclick=()=>{
          if(!feats.length) return;
          searchIds = feats.map(f=> f.ol_uid || f.getId());
          redraw();
          const ext=ol.extent.createEmpty();
          feats.forEach(f=> ol.extent.extend(ext,f.getGeometry().getExtent()));
          map.getView().fit(ext,{padding:[140,20,160,20], maxZoom:18});
          results.style.display='none';
          setSearchUIState(true);
        };
        results.appendChild(div);
      }

      list.slice(0,80).forEach(f=>{
        const div=document.createElement('div');
        div.className='item';
        const name= f.get('name_'+LANG) || f.get('name') || '(isimsiz)';
        const meta=[f.get('src')==='indoor'?'Indoor':'Outdoor', f.get('category')||'', f.get('level')||''].filter(Boolean).join(' Â· ');
        div.innerHTML = `<span>${name}</span><small>${meta}</small>`;
        div.onclick=()=>{
          searchIds = [f.ol_uid || f.getId()];
          redraw();
          focusFeature(f,true);
          setDestination(coordOfFeature(f));
          results.style.display='none';
          go.disabled=false;
          setSearchUIState(true);
        };
        results.appendChild(div);
      });

      results.style.display='block';
    }

    /* ========= KalabalÄ±k azaltma ========= */
    toggleDetails.onclick=()=>{
      if(toggleDetails.disabled) return;
      showAllDetails=!showAllDetails;
      toggleDetails.textContent = showAllDetails ? t().ui.detailsOn : t().ui.detailsOff;
      redraw();
    };

    function redraw(){ indoorLayer.changed(); outdoorLayer.changed(); }

    /* ========= Katman toggles ========= */
    tglIndoor.addEventListener('change',()=> indoorLayer.setVisible(tglIndoor.checked));
    tglOutdoor.addEventListener('change',()=> outdoorLayer.setVisible(tglOutdoor.checked));

    /* ========= Konum + takip ========= */
    let userLayer=null,userPoint=null,accCircle=null,followState=false,watchId=null;

    function ensureUserLayer(){
      if(userLayer) return;
      userPoint=new ol.Feature(new ol.geom.Point([0,0]));
      userPoint.setStyle(new ol.style.Style({
        image:new ol.style.Circle({radius:6, fill:new ol.style.Fill({color:'#1d4ed8'}), stroke:new ol.style.Stroke({color:'#fff',width:1.8})})
      }));
      accCircle=new ol.Feature(new ol.geom.Circle([0,0],1));
      accCircle.setStyle(new ol.style.Style({
        stroke:new ol.style.Stroke({color:'#1d4ed8',width:1}),
        fill:new ol.style.Fill({color:'rgba(29,78,216,.06)'})
      }));
      userLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[accCircle,userPoint]}) });
      map.addLayer(userLayer);
    }

    (function startWatch(){
      if(!('geolocation' in navigator)) return;
      try{ if(watchId!==null) navigator.geolocation.clearWatch(watchId);}catch{}
      watchId=navigator.geolocation.watchPosition(pos=>{
        const c=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]);
        ensureUserLayer();
        userPoint.getGeometry().setCoordinates(c);
        accCircle.getGeometry().setCenter(c);
        accCircle.getGeometry().setRadius(pos.coords.accuracy||0);
        acc.textContent="Â±"+Math.round(pos.coords.accuracy||0)+" m";
        acc.style.display='block';
        if(followState) map.getView().animate({center:c,duration:200});
      },()=>{}, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
    })();

    followBtn.onclick=()=>{
      followState=!followState;
      followBtn.textContent= followState ? t().ui.followOn : t().ui.followOff;
      if(followState && userPoint) map.getView().setCenter(userPoint.getGeometry().getCoordinates());
    };

    /* ========= Hedef & rota ========= */
    let destLayer=null,destPoint=null,routeLayer=null,bearingLayer=null,pickMode=false;

    function setDestination(coord){
      if(!destLayer){
        destPoint=new ol.Feature(new ol.geom.Point(coord));
        destPoint.setStyle(new ol.style.Style({
          image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'#ef4444'}),stroke:new ol.style.Stroke({color:'#fff',width:1.8})})
        }));
        destLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[destPoint]})});
        map.addLayer(destLayer);
      } else {
        destPoint.getGeometry().setCoordinates(coord);
      }
      go.disabled=false;
    }

    function clearDestination(){
      if(destLayer){ map.removeLayer(destLayer); destLayer=null; destPoint=null; }
    }

    pickBtn.onclick=()=>{ pickMode=!pickMode; pickBtn.classList.toggle('active',pickMode); };

    map.on('click',evt=>{
      if(pickMode){
        setDestination(evt.coordinate);
        pickMode=false;
        pickBtn.classList.remove('active');
        return;
      }
      currentPopupFeature=null;
      [indoorLayer,outdoorLayer].forEach(layer=>
        map.forEachFeatureAtPixel(evt.pixel,(feature,lay)=>{ if(lay===layer) currentPopupFeature=feature; })
      );
      if(currentPopupFeature){ showPopup(currentPopupFeature, evt.coordinate); } else hidePopup();
    });

    function clearRouteAndBearing(){
      if(routeLayer){map.removeLayer(routeLayer);routeLayer=null;}
      if(bearingLayer){map.removeLayer(bearingLayer);bearingLayer=null;}
      dirBox.style.display='none';
      dirList.innerHTML='';
    }

    function routeToDestination(){
      if(!userPoint || !destPoint){
        alert(LANG==='tr'?'Konum ve hedef gerekli.':'Need location and destination.');
        return;
      }
      clearRouteAndBearing();
      const a=ol.proj.toLonLat(userPoint.getGeometry().getCoordinates()),
            b=ol.proj.toLonLat(destPoint.getGeometry().getCoordinates());
      const url = `https://router.project-osrm.org/route/v1/foot/${a[0]},${a[1]};${b[0]},${b[1]}?overview=full&geometries=geojson&steps=true`;

      fetch(url).then(r=>r.json()).then(d=>{
        if(d && d.routes && d.routes.length){
          const route=d.routes[0];
          const line=new ol.geom.LineString(route.geometry.coordinates).transform('EPSG:4326','EPSG:3857');
          const feat=new ol.Feature({geometry:line});
          routeLayer=new ol.layer.Vector({
            source:new ol.source.Vector({features:[feat]}),
            style:new ol.style.Style({stroke:new ol.style.Stroke({color:'#16a34a',width:4})})
          });
          map.addLayer(routeLayer);
          map.getView().fit(line.getExtent(),{padding:[140,20,160,20], maxZoom:18});

          const km=(route.distance/1000).toFixed(2)+" km";
          const min=Math.round(route.duration/60)+" dk";
          dirSum.textContent=km;
          dirSub.textContent='Â· '+min;

          const steps=(route.legs?.[0]?.steps)||[];
          dirList.innerHTML='';
          steps.forEach((s,i)=>{
            const txt=stepText(s);
            const dist=(s.distance>=1000? (s.distance/1000).toFixed(2)+' km' : Math.round(s.distance)+' m');
            const el=document.createElement('div');
            el.className='step';
            el.innerHTML = `<div>${i+1}.</div><div><div>${txt}</div><div class="muted" style="font-size:12px">${dist}</div></div>`;
            dirList.appendChild(el);
          });
          dirBox.style.display='block';
        }else{
          drawBearingLine();
        }
      }).catch(()=> drawBearingLine());
    }

    function stepText(s){
      const L=t();
      const man=s.maneuver||{}; const type=man.type||''; const mod=man.modifier||''; const street=s.name||'';
      const onto=street? (L.nav.onto||'').replace('%s', street) : '';
      switch(type){
        case 'depart': return L.nav.depart + onto;
        case 'arrive': return L.nav.arrive;
        case 'turn':
          if(mod==='left') return L.nav.turn_left + onto;
          if(mod==='right') return L.nav.turn_right + onto;
          return (L.nav.straight||'') + onto;
        case 'roundabout':
          const ex=man.exit||1; return (L.nav.roundabout||'').replace('%n', ex) + onto;
        default: return (L.nav.straight||'') + onto;
      }
    }

    go.onclick=routeToDestination;
    clearRouteBtn.onclick=()=>{ clearRouteAndBearing(); };
    collapseDir.onclick=()=>{
      const s=getComputedStyle(dirList).display;
      dirList.style.display= s==='none' ? 'block' : 'none';
      collapseDir.textContent = s==='none' ? 'â–²' : 'â–¼';
    };

    function drawBearingLine(){
      const a=userPoint.getGeometry().getCoordinates(),
            b=destPoint.getGeometry().getCoordinates();
      const line=new ol.geom.LineString([a,b]);

      const arrow=new ol.style.Style({
        geometry:new ol.geom.Point(b),
        image:new ol.style.RegularShape({
          points:3,radius:10,rotation:Math.atan2(b[1]-a[1],b[0]-a[0]),
          fill:new ol.style.Fill({color:'#16a34a'}),
          stroke:new ol.style.Stroke({color:'#fff',width:1})
        })
      });

      const aLL=ol.proj.toLonLat(a), bLL=ol.proj.toLonLat(b);
      const dist=Math.round(ol.sphere.getDistance(aLL,bLL));

      const label=new ol.style.Style({
        geometry:new ol.geom.Point([(a[0]+b[0])/2,(a[1]+b[1])/2]),
        text:new ol.style.Text({
          text:(dist>=1000?(dist/1000).toFixed(2)+' km':dist+' m'),
          offsetY:-12,
          padding:[3,6,3,6],
          backgroundFill:new ol.style.Fill({color:'rgba(255,255,255,.9)'}),
          backgroundStroke:new ol.style.Stroke({color:'#e5e7eb',width:1}),
          fill:new ol.style.Fill({color:'#111'})
        })
      });

      const feat=new ol.Feature({geometry:line});
      bearingLayer=new ol.layer.Vector({
        source:new ol.source.Vector({features:[feat]}),
        style:[
          new ol.style.Style({stroke:new ol.style.Stroke({color:'#16a34a',width:4})}),
          arrow,
          label
        ]
      });
      map.addLayer(bearingLayer);
      map.getView().fit(line.getExtent(),{padding:[140,20,160,20], maxZoom:19});

      // Basit yÃ¶nerge: dÃ¼z Ã§izgi
      dirSum.textContent=(dist>=1000?(dist/1000).toFixed(2)+' km':dist+' m');
      dirSub.textContent='';
      dirList.innerHTML='';
      dirBox.style.display='block';
    }

    /* ========= Popup ========= */
    let currentPopupFeature=null;

    function coordOfFeature(f){
      const g=f.getGeometry();
      if(g.getType()==='Point') return g.getCoordinates();
      if(g.getType()==='Polygon') return g.getInteriorPoint().getCoordinates();
      return g.getFirstCoordinate();
    }

    function renderPopup(f){
      const p=f.getProperties(), L=t();
      const name = p['name_'+LANG] || p.name || '';
      const catKey=(p.category||'').toLowerCase();
      const catLabel=L.cats[catKey] || p.category || '';
      const hours = p['hours_'+LANG] || p.hours || '';
      const level = p['level_'+LANG] || p.level || '';
      const desc = p['desc_'+LANG] || p.desc || '';
      const img = p['image_'+LANG] || p.image || '';

      return `
        <div style="min-width:220px">
          <div style="font-weight:600;margin-bottom:6px">${name}</div>
          ${catLabel?`<div class="badge" title="${L.labels.category}">${catLabel}</div>`:''}
          ${hours?`<div style="margin-top:6px"><small>${L.labels.hours}:</small> ${hours}</div>`:''}
          ${level?`<div><small>${L.labels.level}:</small> ${level}</div>`:''}
          ${desc?`<div style="margin-top:6px" class="muted">${desc}</div>`:''}
          ${/^https?:\/\//i.test(img)?`<div style="margin-top:6px"><img src="${img}" alt="" style="width:100%;max-height:140px;object-fit:cover;border-radius:8px"></div>`:''}
        </div>
      `;
    }

    function showPopup(f,coord){
      currentPopupFeature=f;
      popupContent.innerHTML=renderPopup(f);
      popupEl.style.display='block';
      popupOverlay.setPosition(coord);
    }
    function hidePopup(){
      popupEl.style.display='none';
      popupOverlay.setPosition(undefined);
      currentPopupFeature=null;
    }

    function focusFeature(f,open){
      const g=f.getGeometry();
      const extent=g.getExtent();
      map.getView().fit(extent,{padding:[140,20,160,20], maxZoom:18});
      const c=coordOfFeature(f);
      if(open) showPopup(f,c);
    }

    /* ========= Reset ========= */
    resetBtn.onclick=()=>{
      hidePopup();
      clearRouteAndBearing();
      results.style.display='none';
      q.value=''; // arama temizle
      searchIds=null;
      redraw();
      clearDestination(); // seÃ§ilen kÄ±rmÄ±zÄ± hedefi de kaldÄ±r
      loadJSONs();        // veri ve kilidi tazele
    };

    document.addEventListener('keydown',e=>{
      if(e.key==='Escape'){
        results.style.display='none';
        hidePopup();
      }
    });

    applyLang();
  </script>
</body>
</html>
