<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OpenLayers – Indoor & Outdoor</title>

  <!-- OpenLayers CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>

  <style>
    html, body {
      margin:0; padding:0; height:100%;
    }
    #map {
      width:100%; height:100%;
    }
    .toolbar {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:#fff; padding:6px; border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.2);
      display:flex; gap:6px;
    }
    .toolbar input { padding:6px; width:220px; }
    .toolbar select, .toolbar button { padding:6px; }
    .results {
      position:absolute; top:50px; left:10px; z-index:1001;
      background:#fff; border:1px solid #ccc; border-radius:6px;
      width:220px; max-height:40vh; overflow:auto; display:none;
    }
    .results .item { padding:6px; cursor:pointer; }
    .results .item:hover { background:#f0f0f0; }
  </style>
</head>
<body>

  <!-- Harita -->
  <div id="map"></div>

  <!-- Araç Çubuğu -->
  <div class="toolbar">
    <input id="searchInput" type="text" placeholder="Ara: disco, havuz, restoran, spa…" />
    <select id="lang">
      <option value="tr">TR</option>
      <option value="en">EN</option>
      <option value="ru">RU</option>
    </select>
    <button id="goBtn" disabled>Git</button>
    <button id="pickBtn">Hedef Seç</button>
  </div>

  <!-- Arama Sonuçları -->
  <div id="results" class="results"></div>

<script>
/* --- 1) Otel Alanı --- */
const HOTEL_GEOMETRY = {
  "type":"Polygon","coordinates":[[
    [31.80488563536983,36.60144809135009],
    [31.80141125277774,36.599560719072684],
    [31.806994242514662,36.59688713533359],
    [31.80828178115803,36.59899633325935],
    [31.80488563536983,36.60144809135009]
  ]]
};

/* --- 2) DEMO Indoor/Outdoor --- */
const DEMO_INDOOR = {
  "type":"FeatureCollection","features":[
    {
      "type":"Feature",
      "properties":{"name":"Lobi","category":"lobby"},
      "geometry":{"type":"Polygon","coordinates":[[
        [31.8050,36.6005],[31.8052,36.6005],
        [31.8052,36.6007],[31.8050,36.6007],
        [31.8050,36.6005]
      ]]}
    },
    {
      "type":"Feature",
      "properties":{"name":"Ana Restoran","category":"restaurant"},
      "geometry":{"type":"Polygon","coordinates":[[
        [31.8053,36.6006],[31.8056,36.6006],
        [31.8056,36.6009],[31.8053,36.6009],
        [31.8053,36.6006]
      ]]}
    }
  ]
};

const DEMO_OUTDOOR = {
  "type":"FeatureCollection","features":[
    {
      "type":"Feature",
      "properties":{"name":"Disco","category":"disco"},
      "geometry":{"type":"Point","coordinates":[31.8053,36.6002]}
    },
    {
      "type":"Feature",
      "properties":{"name":"Ana Havuz","category":"pool"},
      "geometry":{"type":"Point","coordinates":[31.8055,36.6004]}
    }
  ]
};

/* --- 3) Layer Helper --- */
function makeVectorLayer(geojson, color){
  return new ol.layer.Vector({
    source: new ol.source.Vector({
      features: new ol.format.GeoJSON().readFeatures(geojson,{featureProjection:"EPSG:3857"})
    }),
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({color:color,width:2}),
      fill: new ol.style.Fill({color:color.replace("1)", "0.2)")}),
      image: new ol.style.Circle({
        radius:5,
        fill: new ol.style.Fill({color:color}),
        stroke: new ol.style.Stroke({color:"#fff",width:1})
      })
    })
  });
}

/* --- 4) Layers --- */
const hotelLayer = makeVectorLayer(
  {"type":"FeatureCollection","features":[{"type":"Feature","geometry":HOTEL_GEOMETRY}]},
  "rgba(0,0,255,1)"
);
const indoorLayer  = makeVectorLayer(DEMO_INDOOR,"rgba(0,200,0,1)");
const outdoorLayer = makeVectorLayer(DEMO_OUTDOOR,"rgba(200,0,0,1)");

/* --- 5) Map --- */
const map = new ol.Map({
  target:"map",
  layers:[
    new ol.layer.Tile({source:new ol.source.OSM()}),
    hotelLayer, indoorLayer, outdoorLayer
  ],
  view:new ol.View({
    center: ol.proj.fromLonLat([31.805,36.600]),
    zoom:17, rotation:0
  })
});

/* --- 6) Search --- */
const searchInput=document.getElementById("searchInput");
const resultsEl=document.getElementById("results");
let selectedFeature=null;

const allFeatures = indoorLayer.getSource().getFeatures()
  .concat(outdoorLayer.getSource().getFeatures());

function showResults(list){
  resultsEl.innerHTML="";
  if(!list.length){ resultsEl.style.display="none"; return; }
  list.forEach(f=>{
    const div=document.createElement("div");
    div.className="item";
    div.textContent=f.get("name")+" ("+(f.get("category")||"")+")";
    div.onclick=()=>{
      selectedFeature=f;
      searchInput.value=f.get("name");
      map.getView().fit(f.getGeometry().getExtent(),{maxZoom:19});
      resultsEl.style.display="none";
      document.getElementById("goBtn").disabled=false;
      setDestination(f.getGeometry().getFirstCoordinate());
    };
    resultsEl.appendChild(div);
  });
  resultsEl.style.display="block";
}

searchInput.addEventListener("input",()=>{
  const val=searchInput.value.toLowerCase().trim();
  if(!val){ resultsEl.style.display="none"; return; }
  const matches=allFeatures.filter(f=>(f.get("name")||"").toLowerCase().includes(val));
  showResults(matches);
});

/* --- 7) Blue Dot (Konum) --- */
let userMarker=null, accCircle=null;
navigator.geolocation.watchPosition(pos=>{
  const coords=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]);
  if(!userMarker){
    userMarker=new ol.Feature(new ol.geom.Point(coords));
    userMarker.setStyle(new ol.style.Style({
      image:new ol.style.Circle({
        radius:5,
        fill:new ol.style.Fill({color:"#007bff"}),
        stroke:new ol.style.Stroke({color:"#fff",width:1.5})
      })
    }));
    accCircle=new ol.Feature(new ol.geom.Circle(coords,pos.coords.accuracy));
    accCircle.setStyle(new ol.style.Style({
      stroke:new ol.style.Stroke({color:"#007bff",width:1}),
      fill:new ol.style.Fill({color:"rgba(0,123,255,0.05)"})
    }));
    const layer=new ol.layer.Vector({
      source:new ol.source.Vector({features:[accCircle,userMarker]})
    });
    map.addLayer(layer);
  }else{
    userMarker.getGeometry().setCoordinates(coords);
    accCircle.getGeometry().setCenter(coords);
    accCircle.getGeometry().setRadius(pos.coords.accuracy);
  }
},{ enableHighAccuracy:true, maximumAge:0, timeout:10000 });

/* --- 8) Hedef seç (map click) --- */
let destMarker=null;
function setDestination(coords){
  if(!destMarker){
    destMarker=new ol.Feature(new ol.geom.Point(coords));
    destMarker.setStyle(new ol.style.Style({
      image:new ol.style.Circle({
        radius:6,
        fill:new ol.style.Fill({color:"red"}),
        stroke:new ol.style.Stroke({color:"#fff",width:1.5})
      })
    }));
    const layer=new ol.layer.Vector({source:new ol.source.Vector({features:[destMarker]})});
    map.addLayer(layer);
  } else {
    destMarker.getGeometry().setCoordinates(coords);
  }
  document.getElementById("goBtn").disabled=false;
}

let pickMode=false;
document.getElementById("pickBtn").onclick=()=>{
  pickMode=!pickMode;
  document.getElementById("pickBtn").classList.toggle("active",pickMode);
};

map.on("click",evt=>{
  if(pickMode){
    setDestination(evt.coordinate);
    pickMode=false;
    document.getElementById("pickBtn").classList.remove("active");
  }
});

/* --- 9) Routing --- */
document.getElementById("goBtn").onclick=()=>{
  if(!userMarker || !destMarker)
    return alert("Konum ve hedef seçilmeli");

  const userLonLat=ol.proj.toLonLat(userMarker.getGeometry().getCoordinates());
  const destLonLat=ol.proj.toLonLat(destMarker.getGeometry().getCoordinates());

  const url=`https://router.project-osrm.org/route/v1/foot/${userLonLat[0]},${userLonLat[1]};${destLonLat[0]},${destLonLat[1]}?overview=full&geometries=geojson`;

  fetch(url).then(r=>r.json()).then(data=>{
    if(data.routes.length){
      const coords=data.routes[0].geometry.coordinates;
      const line=new ol.geom.LineString(coords).transform("EPSG:4326","EPSG:3857");
      const route=new ol.Feature({geometry:line});
      const routeLayer=new ol.layer.Vector({
        source:new ol.source.Vector({features:[route]}),
        style:new ol.style.Style({
          stroke:new ol.style.Stroke({color:"blue",width:3})
        })
      });
      map.addLayer(routeLayer);
    }
  });
};

/* --- 10) Rotate --- */
// Mobil: 2 parmak ile çevir
// Desktop: Alt + Drag
</script>
</body>
</html>
