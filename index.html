<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Misafir – Indoor & Outdoor Harita (3D Binalar güvenli)</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>

<style>
  :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#fff }
  html,body,#map{height:100%}
  html,body{margin:0;background:#f3f4f6;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #map{position:absolute; inset:0; overflow:hidden}

  .ol-attribution{font-size:10px; opacity:.9}
  .ol-attribution button{display:none}

  .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); width:min(780px,96vw); z-index:10}
  .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
  .p-8{padding:12px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:8px}
  .grow{flex:1 1 auto}
  input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
  button{padding:10px 12px; border:1px solid #e5e7eb; background:#fff; border-radius:10px; cursor:pointer}
  button:disabled{opacity:.55; cursor:not-allowed}
  select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
  .muted{color:var(--muted)}
</style>
</head>
<body>

<div id="map" aria-label="Harita"></div>

<!-- Tek panel (mevcut UI’nin sade hâli) -->
<div class="panel">
  <div class="card p-8 stack">
    <div class="row">
      <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz…"/>
      <button id="go" disabled>Git</button>
      <select id="lang" aria-label="Dil">
        <option value="tr" selected>TR</option>
        <option value="en">EN</option>
        <option value="ru">RU</option>
        <option value="de">DE</option>
        <option value="pl">PL</option>
      </select>
    </div>
    <div class="row">
      <button id="pick">Haritadan Hedef</button>
      <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
      <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
      <button id="reset">Sıfırla</button>
      <span class="muted" style="margin-left:auto">Taban: OSM</span>
      <!-- 3D buton sağ uçta -->
      <button id="btn3d" title="buildings.json ile 3D binalar">3D: Kapalı</button>
    </div>
  </div>
</div>

<script>
/* ------------------ OpenLayers temel harita ------------------ */
const base = new ol.layer.Tile({
  source: new ol.source.OSM({attributions:'© aihotelstech · © OpenStreetMap contributors'})
});
const indoorLayer  = new ol.layer.VectorImage({source:new ol.source.Vector()});
const outdoorLayer = new ol.layer.VectorImage({source:new ol.source.Vector()});

const map = new ol.Map({
  target:'map',
  layers:[base, indoorLayer, outdoorLayer],
  view:new ol.View({center: ol.proj.fromLonLat([31.8046,36.6002]), zoom:16, rotation:0})
});
map.addControl(new ol.control.Attribution({collapsible:false}));
map.addControl(new ol.control.Rotate());

/* Görünürlük güvenliği: map konteyneri sıfır boyutta kurulmasın */
window.addEventListener('load', ()=> map.updateSize(), {once:true});
new ResizeObserver(()=> map.updateSize()).observe(document.getElementById('map'));

/* JSON veri (indoor/outdoor) – varsa yükle, yoksa boş bırak */
const fmt = new ol.format.GeoJSON();
(async function loadLayers(){
  const bust = 'v='+Date.now();
  const safeRead = async (url)=> {
    try{ const r=await fetch(url+'?'+bust,{cache:'no-store'}); if(r.ok) return r.json(); }
    catch(e){} return {type:'FeatureCollection',features:[]};
  };
  const [indoor, outdoor] = await Promise.all([
    safeRead('indoor.json'), safeRead('outdoor.json')
  ]);
  indoorLayer.getSource().addFeatures(fmt.readFeatures(indoor,{featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'}));
  outdoorLayer.getSource().addFeatures(fmt.readFeatures(outdoor,{featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'}));
})();

document.getElementById('tglIndoor').onchange = e=> indoorLayer.setVisible(e.target.checked);
document.getElementById('tglOutdoor').onchange = e=> outdoorLayer.setVisible(e.target.checked);

document.getElementById('reset').onclick = ()=>{
  // sadece görünümü sıfırla – 3D modül ayrı kapatılıyor
  map.getView().setCenter(ol.proj.fromLonLat([31.8046,36.6002]));
  map.getView().setZoom(16);
};

/* ------------------ 3D BİNALAR (deck.gl) – haritayı etkilemeden ------------------ */
/* Çalışma mantığı:
   - İlk başta hiçbir şey yüklenmez.
   - "3D: Açık" denince deck.gl UMD tek dosyası 2 CDN’den fallback’li yüklenir.
   - #map içine şeffaf bir canvas eklenir (pointer-events:none).
   - OpenLayers görünümü her frame’de deck viewState’e aktarılır (postrender).
   - Kapatılınca finalize + DOM temizliği; harita asla bloklanmaz. */
<!-- === 3D BİNALAR (deck.gl) — kayma yok + daha iyi görünüm === -->
<script>
(function(){
  const btn3d = document.getElementById('btn3d');
  const mapEl = document.getElementById('map');

  let deckDiv = null;
  let deckInstance = null;
  let postRenderUnsub = null;
  let buildings = null;

  const DECK_CDNS = [
    'https://cdn.jsdelivr.net/npm/deck.gl@8.9.36/dist.min.js',
    'https://unpkg.com/deck.gl@8.9.36/dist.min.js'
  ];
  function loadScriptSequential(urls){
    return new Promise((resolve,reject)=>{
      const tryAt=(i)=>{
        if(i>=urls.length){ reject(new Error('CDN blocked')); return; }
        const s=document.createElement('script');
        s.src=urls[i]; s.defer=true;
        s.onload=()=>resolve(urls[i]);
        s.onerror=()=>{ s.remove(); tryAt(i+1); };
        document.head.appendChild(s);
      };
      tryAt(0);
    });
  }

  // OL -> deck viewState: zoom'u resolution'dan hesapla (512'lik dünya)
  function toViewState(){
    const v = map.getView();
    const [lon,lat] = ol.proj.toLonLat(v.getCenter());
    const size = map.getSize() || [mapEl.clientWidth, mapEl.clientHeight];
    const res  = v.getResolution() || 156543.033928; // m/px (EPSG:3857)
    const MPP_Z0_512 = 78271.51696402048;           // 512 tile dünyada z0 m/px
    const zoom = Math.log2(MPP_Z0_512 / res);       // KAYMA YOK

    return {
      longitude: lon, latitude: lat, zoom,
      bearing: (-v.getRotation()*180/Math.PI),
      pitch: 55,
      width: size[0], height: size[1]
    };
  }

  // Stil: yükseklik & renkler
  const getHeight = f=>{
    const p=f.properties||{};
    const h = Number(p.height)||0;
    const lv= Number(p['building:levels']||p.levels||0);
    return h || (lv>0 ? lv*3.2 : 8);
  };
  const wallColor = f=>{
    const p=f.properties||{};
    return p.wallColor || [180,180,180,235];
  };
  const roofColor = f=>{
    const p=f.properties||{};
    return p.roofColor || [210,210,210,245];
  };

  function makeLayers(){
    if(!buildings) return [];
    // Duvarlar (extruded)
    const walls = new deck.GeoJsonLayer({
      id:'bld-walls',
      data: buildings,
      extruded:true,
      wireframe:false,
      pickable:false,
      getElevation:getHeight,
      getFillColor:wallColor,
      getLineColor:[110,110,110],
      getLineWidth:1,
      material: new deck.PhongMaterial({ambient:0.6, diffuse:0.8, shininess:16}),
      parameters:{depthTest:true}
    });
    // Çatı (düz poligon, z-fighting olmasın diye depthMask kapalı)
    const roofs = new deck.GeoJsonLayer({
      id:'bld-roofs',
      data: buildings,
      extruded:false,
      pickable:false,
      filled:true,
      stroked:true,
      getFillColor:roofColor,
      getLineColor:[100,100,100,180],
      lineWidthMinPixels:1,
      parameters:{depthTest:true, depthMask:false, polygonOffsetUnits:1, polygonOffsetFactor:1}
    });
    return [walls, roofs];
  }

  function start3D(){
    deckDiv = document.createElement('div');
    deckDiv.style.cssText='position:absolute;inset:0;pointer-events:none;z-index:3';
    mapEl.appendChild(deckDiv);

    deckInstance = new deck.Deck({
      parent: deckDiv,
      controller: false,                         // kontrol OL’de
      initialViewState: toViewState(),
      layers: makeLayers(),
      glOptions:{alpha:true, antialias:true},
      parameters:{blend:true, clearColor:[0,0,0,0]},
      effects:[
        new deck.LightingEffect({
          ambientLight: new deck.AmbientLight({intensity:0.7}),
          directionalLights:[ new deck.DirectionalLight({direction:[-1,-1,-2], intensity:1.15}) ]
        })
      ]
    });

    // CANLI senkron: her karede deck'i güncelle
    postRenderUnsub = map.on('postrender', ()=>{
      deckInstance.setProps({viewState: toViewState()});
    });
    new ResizeObserver(()=> deckInstance.setProps({viewState: toViewState()})).observe(mapEl);
  }

  function stop3D(){
    if(postRenderUnsub){ ol.Observable.unByKey(postRenderUnsub); postRenderUnsub=null; }
    if(deckInstance){ deckInstance.finalize(); deckInstance=null; }
    if(deckDiv && deckDiv.parentNode){ deckDiv.parentNode.removeChild(deckDiv); deckDiv=null; }
  }

  async function toggle(){
    if(deckInstance){ stop3D(); btn3d.textContent='3D: Kapalı'; return; }
    btn3d.disabled=true; btn3d.textContent='3D: yükleniyor…';
    try{
      await loadScriptSequential(DECK_CDNS);
      buildings = await fetch('buildings.json?v='+Date.now(),{cache:'no-store'}).then(r=>r.json());
      start3D();
      btn3d.textContent='3D: Açık';
    }catch(e){
      console.error(e);
      alert('3D binalar yüklenemedi (CDN veya buildings.json). Harita etkilenmedi.');
      stop3D();
      btn3d.textContent='3D: Kapalı';
    }finally{
      btn3d.disabled=false;
    }
  }
  btn3d.addEventListener('click', toggle);
  document.getElementById('reset').addEventListener('click', ()=>{ if(deckInstance){ stop3D(); btn3d.textContent='3D: Kapalı'; }});
})();
</script>

</body>
</html>
