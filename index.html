<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Long Beach ‚Äì Misafir Harita</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<!-- Turf.js: mesafe, bearing, nearestPointOnLine -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js" charset="utf-8"></script>

<style>
  :root{
    --shadow:0 10px 28px rgba(0,0,0,.18);
    --muted:#5b6a6a; --bg:#fff; --brand:#0f5132; --border:#cfe3da; --field:#f4fbf7; --chip:#e6f4ef;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eaf4f0}
  #map{position:fixed; inset:0}

  .maplibregl-popup{ max-width:min(320px,86vw)!important; }
  .maplibregl-popup-content{ padding:10px 12px; overflow-wrap:anywhere; }
  .maplibregl-popup-content img{ width:100%; max-height:140px; height:auto; object-fit:cover; border-radius:8px; }
  @media (max-width:480px){ .maplibregl-popup-content{padding:9px 10px} }

  .lang-float{position:fixed; left:12px; top:12px; z-index:1200; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:6px 8px}
  .lang-float select{border:1px solid var(--border); background:var(--field); border-radius:10px; padding:6px 8px}

  .panel{
    position:fixed; left:50%; bottom:0;
    transform:translate(-50%,var(--panel-ty,0px));
    transition:transform .2s ease;
    width:min(860px,96vw); z-index:1100
  }
  .card{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
  .p-8{padding:10px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:10px}
  .grow{flex:1 1 auto}

  .grab{position:relative; width:64px; height:28px; margin:8px auto 0; cursor:grab}
  .grab::before,.grab::after{
    content:""; position:absolute; left:50%; transform:translateX(-50%);
    width:56px; height:6px; background:#9fd3b3; border-radius:999px; box-shadow:inset 0 0 0 1px #83c7a1;
  }
  .grab::before{ top:6px } .grab::after{ bottom:6px }

  input[type="search"]{width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field)}
  button{padding:9px 11px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:var(--field); white-space:nowrap}
  button:active{transform:translateY(1px)}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--chip); font-size:13px}
  .chip input{accent-color:#1b7a5b}
  .chip .tick{opacity:.18; transition:.15s}
  .chip input:checked ~ .tick{opacity:1}

  .results{background:#fff; border:1px solid var(--border); border-radius:12px; max-height:36vh; overflow:auto; position:relative; z-index:2001; display:none; -webkit-overflow-scrolling:touch}
  .results .item{display:flex; justify-content:space-between; gap:8px; padding:10px 12px; cursor:pointer}
  .results .item:hover{background:#f1f7f4}
  .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}

  .dir{display:none; background:#fff; border:1px solid var(--border); border-radius:12px}
  .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5efe9}
  .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}

  .badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#edf7f3; border:1px solid var(--border); font-size:12px}
  .acc{position:fixed; right:12px; bottom:12px; z-index:1005; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
  @media (max-width:520px){ .panel{bottom:8px} }

  .row.searchrow{display:grid; grid-template-columns:1fr auto; gap:8px}
  .row.ctlsB .chip{padding:6px 10px}
  .muted{color:var(--muted)}
</style>
</head>
<body>

<!-- Dil -->
<div class="lang-float">
  <select id="lang" aria-label="Dil">
    <option value="tr" selected>TR</option><option value="en">EN</option>
    <option value="ru">RU</option><option value="de">DE</option><option value="pl">PL</option>
  </select>
</div>

<div id="map" aria-label="Harita"></div>

<!-- Bottom sheet -->
<div class="panel" id="sheet">
  <div class="card">
    <div class="grab" id="grab"></div>
    <div class="p-8 stack" id="sheetContent">

      <div class="row searchrow">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz‚Ä¶"/>
        <button id="go" title="Se√ßili hedefe rota" disabled>Git</button>
      </div>

      <div class="row ctlsB">
        <button id="pickStart">Ba≈ülangƒ±√ß Se√ß</button>
        <button id="pickDest">Hedef Se√ß</button>
        <button id="follow">üìç Konumum: Kapalƒ±</button>
        <button id="reset">Sƒ±fƒ±rla</button>
        <span class="grow"></span>
        <label class="chip" title="Satellite (raster)">
          <input type="radio" name="basemap" id="baseSat" checked><span>Satellite</span><span class="tick">‚úì</span>
        </label>
        <label class="chip" title="MapLibre 3D (terrain + binalar)">
          <input type="radio" name="basemap" id="base3d"><span>MapLibre 3D</span><span class="tick">‚úì</span>
        </label>

        <!-- DEBUG SE√áENEKLERƒ∞ -->
        <label class="chip" title="Debug: Bile≈üenleri renklendir">
         <input type="checkbox" id="dbgComps"><span>Debug: Bile≈üenler</span><span class="tick">‚úì</span>
          </label>
          <label class="chip" title="Debug: Snap noktalarƒ±nƒ± ve segmanlarƒ±nƒ± g√∂ster">
          <input type="checkbox" id="dbgSnaps"><span>Snap</span><span class="tick">‚úì</span>
          </label>
        <label class="chip" title="Debug: Dead-end d√ºƒü√ºmler">
  <input type="checkbox" id="dbgDead"><span>Dead-ends</span><span class="tick">‚úì</span>
        </label>











        <!-- PROFƒ∞L SE√áƒ∞Mƒ∞ -->
        <label class="chip" title="Yaya">
          <input type="radio" name="profile" value="walk" checked><span>Yaya</span><span class="tick">‚úì</span>
        </label>
        <label class="chip" title="Bisiklet">
          <input type="radio" name="profile" value="bike"><span>Bisiklet</span><span class="tick">‚úì</span>
        </label>
        <label class="chip" title="Shuttle">
          <input type="radio" name="profile" value="shuttle"><span>Shuttle</span><span class="tick">‚úì</span>
        </label>
      </div>

      <div id="results" class="results"></div>

      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">‚Äì</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">‚ñ≤</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>

      <div class="muted" style="font-size:11px; text-align:right">¬© aihotelstech ¬∑ ¬© OpenStreetMap contributors ¬∑ ¬© MapTiler ¬∑ ¬© Mapbox</div>
    </div>
  </div>
</div>

<div id="acc" class="acc" style="display:none"></div>

<script>
/* ================== ANAHTARLAR ================== */
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";
const MAPTILER_KEY = "ym4UWHwsNK61YUsmqi5C";

/* ================== AYARLAR ================== */
const HOTEL_BBOX = [39.13710445451708, 23.57468831349931, 39.1409541038188, 23.578998311345902];
const PADDING = {top:120,right:16,bottom:160,left:16};
const DEFAULT_PITCH = 45, DEFAULT_BEARING = 0;

const OSM_OPACITY = 0.05;
const OSM_VISIBLE = true;

/* ===== Sƒ∞M√úLASYON: sabit bluedot ===== */
const SIMULATE_ME   = false; // true: simule et, false: ger√ßek GPS  
const SIM_ME_COORD  = [31.005858, 36.862770];
const SIM_ME_ACC_M  = 5;

/* ===== ROTA BAƒûLANTI (connector) E≈ûƒ∞KLERƒ∞ ===== */
const MAX_CONNECTOR_M     = 50; // >50 m ise rota yapma ve uyar
const HIDE_CONNECTOR_LT_M = 5;  // <5 m ise connector‚Äôƒ± √ßizme (gizle)


/* ================== i18n ================== */
const I18N = {
  tr:{searchPH:"Ara: restoran, spa, havuz‚Ä¶", go:"Git",
      ui:{pickStart:"Ba≈ülangƒ±√ß Se√ß", pickDest:"Hedef Se√ß", followOn:"üìç Konumum: A√ßƒ±k", followOff:"üìç Konumum: Kapalƒ±", reset:"Sƒ±fƒ±rla", clearRoute:"Rota Temizle"},
      labels:{name:"ƒ∞sim", category:"T√ºr", hours:"Saat", level:"Kat", desc:"A√ßƒ±klama"},
      cats:{pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"D√ºkkan", toilet:"WC", reception:"Resepsiyon", beach:"Plaj", kidsclub:"√áocuk Kul√ºb√º", elevator:"Asans√∂r", gate:"Kapƒ±", parking:"Otopark", shuttle:"Servis", gym:"Spor Salonu"},
      nav:{depart:"Ba≈üla", arrive:"Varƒ±≈ü", turn_left:"Sola d√∂n", turn_right:"Saƒüa d√∂n", straight:"D√ºz devam", roundabout:"G√∂bekte %n. √ßƒ±kƒ±≈ü", onto:" ‚Üí %s"}
  },
  en:{searchPH:"Search: restaurant, spa, pool‚Ä¶", go:"Go",
      ui:{pickStart:"Pick Start", pickDest:"Pick Destination", followOn:"üìç My Location: On", followOff:"üìç My Location: Off", reset:"Reset", clearRoute:"Clear Route"},
      labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description"},
      cats:{pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet", reception:"Reception", beach:"Beach", kidsclub:"Kids Club", elevator:"Elevator", gate:"Gate", parking:"Parking", shuttle:"Shuttle", gym:"Gym"},
      nav:{depart:"Depart", arrive:"Arrive", turn_left:"Turn left", turn_right:"Turn right", straight:"Go straight", roundabout:"At roundabout take exit %n", onto:" onto %s"}
  },
  de:{searchPH:"Suche: Restaurant, Spa, Pool‚Ä¶", go:"Los",
      ui:{pickStart:"Start w√§hlen", pickDest:"Ziel w√§hlen", followOn:"üìç Mein Standort: An", followOff:"üìç Mein Standort: Aus", reset:"Zur√ºcksetzen", clearRoute:"Route l√∂schen"},
      labels:{name:"Name", category:"Typ", hours:"√ñffnungszeiten", level:"Etage", desc:"Beschreibung"},
      cats:{pool:"Pool", restaurant:"Restaurant", spa:"Spa/Wellness", bar:"Bar", cafe:"Caf√©", shop:"Shop", toilet:"Toilette", reception:"Rezeption", beach:"Strand", kidsclub:"Kinderclub", elevator:"Aufzug", gate:"Eingangstor", parking:"Parkplatz", shuttle:"Shuttle", gym:"Fitnessstudio"},
      nav:{depart:"Start", arrive:"Ankunft", turn_left:"Links abbiegen", turn_right:"Rechts abbiegen", straight:"Geradeaus", roundabout:"Im Kreisverkehr Ausfahrt %n nehmen", onto:" auf %s"}
  },
  ru:{searchPH:"–ü–æ–∏—Å–∫: —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å–ø–∞, –±–∞—Å—Å–µ–π–Ω‚Ä¶", go:"–ü–æ–µ—Ö–∞–ª–∏",
      ui:{pickStart:"–í—ã–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—Ç", pickDest:"–í—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç", followOn:"üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –í–∫–ª", followOff:"üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –í—ã–∫–ª", reset:"–°–±—Ä–æ—Å", clearRoute:"–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"},
      labels:{name:"–ù–∞–∑–≤–∞–Ω–∏–µ", category:"–¢–∏–ø", hours:"–ß–∞—Å—ã", level:"–≠—Ç–∞–∂", desc:"–û–ø–∏—Å–∞–Ω–∏–µ"},
      cats:{pool:"–ë–∞—Å—Å–µ–π–Ω", restaurant:"–†–µ—Å—Ç–æ—Ä–∞–Ω", spa:"–°–ø–∞", bar:"–ë–∞—Ä", cafe:"–ö–∞—Ñ–µ", shop:"–ú–∞–≥–∞–∑–∏–Ω", toilet:"–¢—É–∞–ª–µ—Ç", reception:"–†–µ—Å–µ–ø—à–µ–Ω", beach:"–ü–ª—è–∂", kidsclub:"–î–µ—Ç—Å–∫–∏–π –∫–ª—É–±", elevator:"–õ–∏—Ñ—Ç", gate:"–í—Ö–æ–¥/–≤–æ—Ä–æ—Ç–∞", parking:"–ü–∞—Ä–∫–æ–≤–∫–∞", shuttle:"–®–∞—Ç—Ç–ª", gym:"–°–ø–æ—Ä—Ç–∑–∞–ª"},
      nav:{depart:"–ù–∞—á–∞—Ç—å", arrive:"–ü—Ä–∏–±—ã—Ç–∏–µ", turn_left:"–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ", turn_right:"–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ", straight:"–î–≤–∏–≥–∞–π—Ç–µ—Å—å –ø—Ä—è–º–æ", roundabout:"–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º —Å—ä–µ–∑–¥–µ ‚Äî —Å—ä–µ–∑–¥ ‚Ññ%n", onto:" –Ω–∞ %s"}
  },
  pl:{searchPH:"Szukaj: restauracja, spa, basen‚Ä¶", go:"Jed≈∫",
      ui:{pickStart:"Wybierz start", pickDest:"Wybierz cel", followOn:"üìç Moja lokalizacja: W≈Ç", followOff:"üìç Moja lokalizacja: Wy≈Ç", reset:"Resetuj", clearRoute:"Wyczy≈õƒá trasƒô"},
      labels:{name:"Nazwa", category:"Typ", hours:"Godziny", level:"Poziom", desc:"Opis"},
      cats:{pool:"Basen", restaurant:"Restauracja", spa:"Spa", bar:"Bar", cafe:"Kawiarnia", shop:"Sklep", toilet:"Toaleta", reception:"Recepcja", beach:"Pla≈ºa", kidsclub:"Klub dzieciƒôcy", elevator:"Winda", gate:"Brama/Wej≈õcie", parking:"Parking", shuttle:"Shuttle", gym:"Si≈Çownia"},
      nav:{depart:"Start", arrive:"Meta", turn_left:"Skrƒôƒá w lewo", turn_right:"Skrƒôƒá w prawo", straight:"Jed≈∫ prosto", roundabout:"Na rondzie zjed≈∫ zjazdem nr %n", onto:" na %s"}
  }
};
const SUP_LANGS = ['tr','en','ru','de','pl'];
let LANG = localStorage.getItem("lang");
if (!LANG) {
  const nav = (navigator.language || navigator.userLanguage || 'en').slice(0,2).toLowerCase();
  LANG = SUP_LANGS.includes(nav) ? nav : 'en';
  localStorage.setItem('lang', LANG);
}
const t = () => I18N[LANG] || I18N.tr;
const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'');

/* Profiller (m/sn hƒ±zlar) */
const SPEEDS = { walk: 1.35, bike: 4.5, shuttle: 7.0 };
let CURRENT_PROFILE = 'walk';

/* ================== MAP ================== */
const baseStyle = {version:8, glyphs:`https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${MAPTILER_KEY}`, sources:{}, layers:[{id:"bg",type:"background",paint:{"background-color":"#dfe7e7"}}]};

const map = new maplibregl.Map({ container:'map', style:baseStyle, center:[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2], zoom:16, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEARING, maxZoom:19, attributionControl:false });

map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), 'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'¬© aihotelstech'}));

/* DOM */
const $=id=>document.getElementById(id);
const langSel=$('lang'), q=$('q'), goBtn=$('go'), pickStartBtn=$('pickStart'), pickDestBtn=$('pickDest'), followBtn=$('follow'), resetBtn=$('reset'), results=$('results'), acc=$('acc');
const dirBox=$('dir'), dirSum=$('dirSum'), dirSub=$('dirSub'), dirList=$('dirList'), collapseDir=$('collapseDir'), clearRouteBtn=$('clearRoute');
const baseSat=$('baseSat'), base3d=$('base3d');
const searchRow = document.querySelector('.row.searchrow');
const ctlsRow   = document.querySelector('.row.ctlsB'); 

function setMode(mode){            // 'search' | 'route'
  const isRoute = mode === 'route';
  // Search alanƒ± + kontrol √ßipleri
  searchRow.style.display = isRoute ? 'none'  : 'grid';
  ctlsRow.style.display   = isRoute ? 'none'  : 'flex';
  // Rota alanƒ±
  dirBox.style.display    = isRoute ? 'block' : 'none';
}



/* State */
let allFeats=[], followState=false, lastKnown=null;
let pickMode='none'; // 'start' | 'dest' | 'none'
let startCoord=null, destCoord=null;

/* Profiller dinleyici */
document.querySelectorAll('input[name="profile"]').forEach(r=>{
  r.addEventListener('change', ()=> CURRENT_PROFILE = r.value);
});

/* Helpers */
function emptyFC(){return {type:'FeatureCollection',features:[]};}
function linkify(text){ return (text||'').replace(/(https?:\/\/[^\s<>"']+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); }
function nameInAnyLang(p){ return p['name_'+LANG] || p.name || p.name_tr || p.name_en || p.name_ru || p.name_de || p.name_pl || ''; }

/* LOAD */
map.on('load', async ()=>{
  // Satellite (altta)
  map.addSource('sat',{ type:'raster',
    tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`],
    tileSize:256, attribution:"¬© Mapbox ¬© OSM"
  });
  map.addLayer({id:'sat-lyr', type:'raster', source:'sat'});


  // Drone ortofoto kutucuklarƒ± (16‚Äì19 seviyeleri)
map.addSource('drone', {
  type: 'raster',
  tiles: ['./{z}/{x}/{y}.png'], // Proje k√∂k√ºndeki 16,17,18,19 klas√∂rlerini kullanƒ±r
  tileSize: 256,
  minzoom: 16,
  maxzoom: 21,
  scheme: 'xyz'
  
});
map.addLayer({
  id: 'drone-layer',
  type: 'raster',
  source: 'drone',
  paint: { 'raster-opacity': 1.0 }
});


  // OSM raster √úSTTE
  map.addSource('osmRaster',{ type:'raster',
    tiles:[`https://api.maptiler.com/maps/streets/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`],
    tileSize:256, attribution:"¬© OpenMapTiles ¬© OpenStreetMap contributors"
  });
  map.addLayer({id:'osm-raster', type:'raster', source:'osmRaster',
    paint:{'raster-opacity': OSM_VISIBLE ? OSM_OPACITY : 0}});
    // DEBUG kaynak
map.addSource('debug', {type:'geojson', data:{type:'FeatureCollection',features:[]}});
// Bile≈üenleri renklendirilmi≈ü edge‚Äôler
map.addLayer({id:'dbg-comps', type:'line', source:'debug',
  filter:['==',['get','kind'],'edge'],
  paint:{
    // comp id'ye g√∂re pastel renk
    'line-color': ['interpolate',['linear'],['coalesce',['to-number',['get','comp']],0],
      0,'#7dd3fc', 5,'#a78bfa', 10,'#f472b6', 15,'#34d399', 20,'#f59e0b', 25,'#60a5fa'],
    'line-width': 3,
    'line-opacity': 0.7
  }
});
 // Snap noktalarƒ±
map.addLayer({id:'dbg-snap', type:'circle', source:'debug',
  filter:['==',['get','kind'],'snap'],
  paint:{'circle-radius':6,'circle-color':'#ef4444','circle-stroke-color':'#fff','circle-stroke-width':1.5}
});
 // Snap edilen A‚ÄìB segmentleri (kesik kƒ±rmƒ±zƒ±)
map.addLayer({id:'dbg-seg', type:'line', source:'debug',
  filter:['==',['get','kind'],'seg'],
  paint:{'line-color':'#ef4444','line-width':3,'line-dasharray':[1,1]}
});
 // Dead-end d√ºƒü√ºmler
map.addLayer({id:'dbg-dead', type:'circle', source:'debug',
  filter:['==',['get','kind'],'dead'],
  paint:{'circle-radius':4,'circle-color':'#000','circle-stroke-color':'#fff','circle-stroke-width':1}
});


  // 3D
  map.addSource('omt',{ type:'vector', url:`https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}` });
  map.addSource('dem',{ type:'raster-dem', url:`https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key=${MAPTILER_KEY}`, tileSize:256 });
  map.addLayer({ id:'bldg-3d', type:'fill-extrusion', source:'omt', 'source-layer':'building', layout:{visibility:'none'},
    paint:{'fill-extrusion-color':'#b9c9d6','fill-extrusion-opacity':0.85,'fill-extrusion-height':['coalesce', ['to-number',['get','render_height']], ['to-number',['get','height']], 6],'fill-extrusion-base':['coalesce', ['to-number',['get','render_min_height']], ['to-number',['get','min_height']], 0]}, minzoom:14 });

  // POI/√ßizimler
  map.addSource('indoor',{type:'geojson', data:emptyFC(), promoteId:'fid'});
  map.addSource('outdoor',{type:'geojson', data:emptyFC(), promoteId:'fid'});
  map.addSource('routes',{type:'geojson', data:emptyFC(), promoteId:'fid'}); // ROUTES aƒüƒ±

  addFeatureLayers('indoor'); addFeatureLayers('outdoor');

  // ROUTES g√∂r√ºn√ºm√º
  map.addLayer({id:'routes-casing', type:'line', source:'routes',
    paint:{'line-color':'#ffffff','line-width':['+',['coalesce',['to-number',['get','width']],['to-number',['get','stroke_w']],2.4],2],'line-opacity':0.6},
    layout:{'line-cap':'round','line-join':'round'}, minzoom:10
  });
  map.addLayer({id:'routes-net', type:'line', source:'routes',
    paint:{
      'line-color': ['coalesce',['get','stroke'], ['get','fill'], '#6c9f90'],
      'line-width' : ['coalesce',['to-number',['get','width']],['to-number',['get','stroke_w']],['to-number',['get','stroke-width']],2.4],
      'line-opacity': ['coalesce', ['to-number',['get','stroke_op']], 1]
    },
    layout:{'line-cap':'round','line-join':'round'}, minzoom:10
  });

  // hedef/rota/bluedot/start
  map.addSource('start',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'start-pt',type:'circle',source:'start',paint:{'circle-radius':7,'circle-color':'#22c55e','circle-stroke-color':'#fff','circle-stroke-width':1.8}});

  map.addSource('dest',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'dest-pt',type:'circle',source:'dest',paint:{'circle-radius':7,'circle-color':'#ef4444','circle-stroke-color':'#fff','circle-stroke-width':1.8}});

  map.addSource('route',{type:'geojson',data:emptyFC()});
  // Ana rota (ye≈üil)
  map.addLayer({id:'route-line',type:'line',source:'route',
    paint:{'line-color':'#1b7a5b','line-width':4}, layout:{'line-cap':'round','line-join':'round'},
    filter:['==',['get','role'],'main']
  });
  // Baƒülayƒ±cƒ±lar (kesik)
  map.addLayer({id:'route-connector',type:'line',source:'route',
    paint:{'line-color':'#94a3b8','line-width':3,'line-dasharray':[2,2]}, layout:{'line-cap':'round','line-join':'round'},
    filter:['==',['get','role'],'connector']
  });
  // Oklar sadece ana rotada
  map.addLayer({id:'route-arrows',type:'symbol',source:'route',
    layout:{'symbol-placement':'line','text-field':'‚ñ∂','text-size':12,'symbol-spacing':50,'text-rotation-alignment':'map','text-keep-upright':false},
    paint:{'text-color':'#1b7a5b','text-halo-color':'#fff','text-halo-width':1},
    filter:['==',['get','role'],'main']
  });

  // BLUEDOT
  map.addSource('me',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'me-pt',type:'circle',source:'me',paint:{'circle-radius':6,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1.6}});

  await loadJSONs();
  applyLang();
  applyBasemap();
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING});
});

/* Katman yardƒ±mcƒ±larƒ± */
function addFeatureLayers(src){
  map.addLayer({id:`${src}-fill`,type:'fill',source:src,paint:{'fill-color':['coalesce',['get','fill'],'#2563eb'],'fill-opacity':['coalesce',['get','fill_op'],0.35]}});
  map.addLayer({id:`${src}-fill-outline`,type:'line',source:src,filter:['==',['geometry-type'],'Polygon'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],1.6]}});
  map.addLayer({id:`${src}-line`,type:'line',source:src,filter:['==',['geometry-type'],'LineString'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],2.5]}});
  map.addLayer({id:`${src}-pts`,type:'circle',source:src,filter:['==',['geometry-type'],'Point'],paint:{'circle-radius':['coalesce',['get','icon_sz'],6],'circle-color':['coalesce',['get','stroke'],'#e53935'],'circle-stroke-color':'#fff','circle-stroke-width':1.6}});
}

/* JSON y√ºkleme */
async function loadJSONs(){
  const bust='v='+Date.now();
  const [rawIndoor, rawOutdoor, routes] = await Promise.all([
    fetch('indoor.json?'+bust,{cache:'no-store'}).then(safeJson).catch(errLog('indoor')),
    fetch('outdoor.json?'+bust,{cache:'no-store'}).then(safeJson).catch(errLog('outdoor')),
    fetch('routes.json?'+bust,{cache:'no-store'}).then(safeJson).catch(errLog('routes'))
  ]);

  const indoor  = ensureFid(rawIndoor,  'in');
  const outdoor = ensureFid(rawOutdoor, 'out');

  map.getSource('indoor').setData(indoor||emptyFC());
  map.getSource('outdoor').setData(outdoor||emptyFC());

  const validRoutes = validateRoutes(routes) ? routes : emptyFC();
  map.getSource('routes').setData(validRoutes);

  const indoorFs = (indoor?.features||[]).map(f=>({...f,__src:'indoor'}));
  const outdoorFs = (outdoor?.features||[]).map(f=>({...f,__src:'outdoor'}));
  allFeats = indoorFs.concat(outdoorFs);

  // Rota grafƒ± (METRE + mod kƒ±sƒ±tlƒ±)
  buildRouteGraph(validRoutes);

  autoZoomToRoutes(validRoutes);
}

function ensureFid(fc, prefix){
  if(!fc || !Array.isArray(fc.features)) return fc;
  fc.features.forEach((f,i)=>{ if(!f.properties) f.properties={}; if(!f.properties.fid) f.properties.fid=`${prefix}-${i}-${(f.id||'x')}`; });
  return fc;
}
function validateRoutes(fc){
  if(!fc || fc.type!=='FeatureCollection'){ console.warn('routes.json FeatureCollection deƒüil'); return false; }
  const hasLS = (fc.features||[]).some(f=>f.geometry && f.geometry.type==='LineString');
  if(!hasLS){ console.warn('routes.json i√ßinde LineString yok'); return false; }
  return true;
}
function autoZoomToRoutes(fc){
  const f = (fc.features||[]).filter(g=>g.geometry && g.geometry.type==='LineString');
  if(!f.length) return;
  let minX= Infinity, minY= Infinity, maxX= -Infinity, maxY= -Infinity;
  f.forEach(ft=>{ (ft.geometry.coordinates||[]).forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; }); });
  if(!isFinite(minX)) return;
  const curr = map.getBounds();
  const intersects = !(maxX<curr.getWest() || minX>curr.getEast() || maxY<curr.getSouth() || minY>curr.getNorth());
  if(!intersects) map.fitBounds([[minX,minY],[maxX,maxY]], {padding:PADDING, maxZoom:18});
}
function safeJson(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
function errLog(tag){ return e=>{ console.error(`[${tag}.json] y√ºklenemedi:`, e?.message||e); return emptyFC(); } }

/* ================== BASMAP TOGGLE ================== */
baseSat.addEventListener('change', applyBasemap);
base3d.addEventListener('change', applyBasemap);
function applyBasemap(){
  const osmOpacity = OSM_VISIBLE ? OSM_OPACITY : 0;
  if(base3d.checked){
    map.setLayoutProperty('bldg-3d','visibility','visible');
    map.setTerrain({source:'dem', exaggeration:1});
    if(!map.getLayer('sky')){
      map.addLayer({ id:'sky', type:'sky', paint:{'sky-type':'atmosphere','sky-atmosphere-sun':[0,45],'sky-atmosphere-sun-intensity':10} });
    }
  }else{
    if(map.getLayer('sky')) map.removeLayer('sky');
    map.setTerrain(null);
    map.setLayoutProperty('bldg-3d','visibility','none');
  }
  if(map.getLayer('osm-raster')) map.setPaintProperty('osm-raster','raster-opacity',osmOpacity);
}

/* ================== Dƒ∞L ================== */
function applyLang(){
  const L=t(); $('q').placeholder=L.searchPH; $('go').textContent=L.go;
  $('pickStart').textContent=L.ui.pickStart; $('pickDest').textContent=L.ui.pickDest; $('reset').textContent=L.ui.reset;
  followBtn.textContent = followState ? L.ui.followOn : L.ui.followOff;
  clearRouteBtn.textContent=L.ui.clearRoute; localStorage.setItem('lang',LANG);
}
langSel.value=LANG; langSel.addEventListener('change',()=>{LANG=langSel.value; applyLang();});

/* ================== ARAMA (basit isim/kategori) ================== */
const SYNONYMS = {
  bar:['bar','–±–∞—Ä'],
  cafe:['cafe','caf√©','kafe','–∫–∞—Ñ–µ','kawiarnia'],
  restaurant:['restoran','restaurant','restauracja','—Ä–µ—Å—Ç–æ—Ä–∞–Ω'],
  pool:['havuz','pool','basen','–±–∞—Å—Å–µ–π–Ω'],
  spa:['spa','wellness','—Å–ø–∞','sauna'],
  shop:['shop','market','sklep','–º–∞–≥–∞–∑–∏–Ω','butik'],
  toilet:['wc','toilet','tuvalet','toaleta','—Ç—É–∞–ª–µ—Ç'],
  reception:['reception','resepsiyon','recepcja','—Ä–µ—Å–µ–ø—à–µ–Ω'],
  beach:['beach','plaj','pla≈ºa','–ø–ª—è–∂'],
  kidsclub:['kids club','mini club','–¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±','club dzieciƒôcy'],
  elevator:['elevator','lift','asans√∂r','–ª–∏—Ñ—Ç','winda'],
  gate:['gate','kapƒ±','giri≈ü','brama','eingang','–≤–æ—Ä–æ—Ç–∞'],
  parking:['parking','otopark','parkplatz','–ø–∞—Ä–∫–æ–≤–∫–∞'],
  shuttle:['shuttle','servis','bus','autobus','—à–∞—Ç—Ç–ª'],
  gym:['gym','fitness','spor','fitnessstudio','si≈Çownia']
};
const KEYWORD_TO_CAT = (()=>{const m={}; Object.entries(SYNONYMS).forEach(([k,a])=>a.forEach(w=>m[norm(w)]=k)); return m;})();
function detectCategory(qs){
  const nq=norm(qs), dict=I18N[LANG]?.cats||{};
  for(const [k,label] of Object.entries(dict)){ if(norm(label).includes(nq)||nq.includes(norm(label))) return k; }
  return KEYWORD_TO_CAT[nq] || null;
}
q.addEventListener('input', ()=>{
  const val=(q.value||'').trim();
  if(!val){ results.style.display='none'; return; }
  const qn=norm(val), maybeCat=detectCategory(val);
  const hits = allFeats.filter(f=>{
    const p=f.properties||{}; const cat=(p.category||'').toLowerCase();
    if(maybeCat && cat===maybeCat) return true;
    const names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
    if(names.some(n=>n.includes(qn))) return true;
    const ex=[p.desc,p['desc_'+LANG],p.level,p['level_'+LANG],p.hours,p['hours_'+LANG]].filter(Boolean).map(norm);
    return ex.some(d=>d.includes(qn));
  });
  renderResults(hits, maybeCat);
});
function renderResults(list, cat){
  results.innerHTML='';
  const hint=document.createElement('div'); hint.className='hint'; hint.textContent='üîé Sonu√ßlardan birine dokun';
  results.appendChild(hint);
  if(cat){
    const feats=allFeats.filter(f=>(f.properties?.category||'').toLowerCase()===cat);
    const div=document.createElement('div'); div.className='item'; div.dataset.fid='__cat__'+cat;
    div.innerHTML=`<span>‚û§ ${(t().cats?.[cat]||cat)}</span> <small>${feats.length}</small>`;
    results.appendChild(div);
  }
  list.slice(0,80).forEach((f,idx)=>{
    const p=f.properties||{}; const meta=[p.category||'', p.level||'', (f.__src==='indoor'?'Indoor':'Outdoor')].filter(Boolean).join(' ¬∑ ');
    const div=document.createElement('div'); div.className='item';
    div.dataset.fid = p.fid || `tmp-${idx}`;
    div.dataset.src = f.__src;
    div.innerHTML=`<span>${nameInAnyLang(p)||'(isimsiz)'}</span><small>${meta}</small>`;
    results.appendChild(div);
  });
  results.style.display='block';
}
results.addEventListener('click', (e)=>{
  const item=e.target.closest('.item'); if(!item) return;
  const fid=item.dataset.fid;
  if(fid && fid.startsWith('__cat__')){ results.style.display='none'; return; }
  const f=allFeats.find(x=>x.properties && x.properties.fid===fid);
  if(!f) return;
  const center=coordOfFeature(f);
  document.getElementById('sheet').style.setProperty('--panel-ty','0px');
  showPopup(f, Array.isArray(center)?center:[center.lng,center.lat], true);
  setDestination(Array.isArray(center)?center:[center.lng,center.lat]);
  results.style.display='none';
  goBtn.disabled = !(startCoord || lastKnown);
});

/* ================== KONUM (BLUEDOT) ================== */
if (SIMULATE_ME){
  map.on('load', ()=>{
    setMe(SIM_ME_COORD, SIM_ME_ACC_M);
    followState = true;
    followBtn.textContent = t().ui.followOn;
    map.easeTo({center: SIM_ME_COORD});
  });
} else if ('geolocation' in navigator){
  try{ navigator.geolocation.getCurrentPosition(()=>{},()=>{}, {enableHighAccuracy:true, timeout:10000}); }catch{}
  navigator.geolocation.watchPosition(p=>{
    const accM = Math.round(p.coords.accuracy||999);
    setMe([p.coords.longitude, p.coords.latitude], accM);
  }, (err)=>{ console.warn('geo error',err); }, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
}
followBtn.onclick=()=>{ followState=!followState; followBtn.textContent = followState ? t().ui.followOn : t().ui.followOff; if(followState && lastKnown) map.easeTo({center:lastKnown}); };

/* ================== HEDEF & BA≈ûLANGI√á SE√áƒ∞Mƒ∞ ================== */
pickStartBtn.onclick=()=>{ pickMode = pickMode==='start' ? 'none' : 'start'; pickStartBtn.classList.toggle('active', pickMode==='start'); pickDestBtn.classList.remove('active'); };
pickDestBtn.onclick =()=>{ pickMode = pickMode==='dest'  ? 'none' : 'dest';  pickDestBtn.classList.toggle('active',  pickMode==='dest');  pickStartBtn.classList.remove('active'); };
map.on('click', e=>{
  if(pickMode==='start'){
    startCoord=[e.lngLat.lng,e.lngLat.lat];
    map.getSource('start').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:startCoord}}]});
    pickMode='none'; pickStartBtn.classList.remove('active');
    if(destCoord) goBtn.disabled=false;
  }else if(pickMode==='dest'){
    destCoord=[e.lngLat.lng,e.lngLat.lat];
    map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:destCoord}}]});
    pickMode='none'; pickDestBtn.classList.remove('active');
    if(startCoord || lastKnown) goBtn.disabled=false;
  }else{
    const feats = map.queryRenderedFeatures(e.point, {layers:['indoor-pts','outdoor-pts','indoor-fill','outdoor-fill','indoor-line','outdoor-line','indoor-fill-outline','outdoor-fill-outline']});
    if(feats && feats[0]) showPopup(feats[0], e.lngLat, true);
  }
});
function setDestination(xy){
  destCoord=xy;
  map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]});
}

/* ================== ROTA: METRE + SNAP + GE√áƒ∞Cƒ∞ D√úƒû√úM ================== */
let ROUTE_GRAPH = null;  // {nodes, adj, idOf, getId(), addEdge(), removeEdge()}
let ROUTES_FC   = null;  // routes.json ham FC (snap i√ßin)

function buildRouteGraph(fc){
  ROUTES_FC = fc;
  const nodes = [];
  const idOf  = new Map();   // "lon,lat" -> nodeId
  const adj   = {};          // nodeId -> [{to, w, modes:Set<string>}]

  function key(xy){ return xy[0].toFixed(7)+','+xy[1].toFixed(7); }
  function getId(xy, forceNew=false){
  const k = key(xy);
  if(!forceNew && idOf.has(k)) return idOf.get(k);

  // üëá BURAYA tolerans ekle
  if(!forceNew){
    const TOL_M = 2.0;  // istersen 2.0 yapabilirsin
    for(let i=0; i<nodes.length; i++){
      const dist = turf.distance(
        turf.point(nodes[i].xy),
        turf.point(xy),
        {units:'meters'}
      );
      if(dist <= TOL_M){
        idOf.set(k, nodes[i].id);
        return nodes[i].id;
      }
    }
  }

  const id = nodes.length;
  idOf.set(k,id);
  nodes.push({id, xy});
  if(!adj[id]) adj[id] = [];
  return id;
}

  function addEdge(aId,bId,w,meta){
    const modes = (meta?.modes || new Set(['walk','bike','shuttle']));
    adj[aId].push({to:bId, w, modes});
    adj[bId].push({to:aId, w, modes});
  }
  function removeEdge(aId,bId){
    adj[aId] = (adj[aId]||[]).filter(e=>e.to!==bId);
    adj[bId] = (adj[bId]||[]).filter(e=>e.to!==aId);
  }

  (fc.features||[]).forEach(f=>{
    if(!f.geometry || f.geometry.type!=='LineString') return;
    const c = f.geometry.coordinates || [];
    const modes = new Set(String(f.properties?.modes||'walk,bike,shuttle').split(/[,\s;]+/).filter(Boolean));
    for(let i=1;i<c.length;i++){
      const aId = getId(c[i-1]);
      const bId = getId(c[i]);
      const w   = meters(c[i-1], c[i]); // METRE
      addEdge(aId, bId, w, {modes});
    }
  });

  ROUTE_GRAPH = { nodes, adj, idOf, getId, addEdge, removeEdge };
}

/* Snap: t√ºm route √ßizgilerinde en yakƒ±n nokta */
function snapToNetworkAllRoutes(xy){
  if(!ROUTES_FC) return null;
  const pt = turf.point(xy);
  let best = null;

  (ROUTES_FC.features||[]).forEach((f, fi)=>{
    if(!f.geometry || f.geometry.type!=='LineString') return;
    const res = turf.nearestPointOnLine(f, pt, {units:'meters'});
    const idx = res.properties.index;
    const line = f.geometry.coordinates;
    const a = line[Math.max(0, idx)];
    const b = line[Math.min(line.length-1, idx+1)];
    const snap = {
      xy: res.geometry.coordinates,
      a, b,
      modes: new Set(String(f.properties?.modes||'walk,bike,shuttle').split(/[,\s;]+/).filter(Boolean)),
      distM: res.properties.dist,
      featureIndex: fi
    };
    if(!best || snap.distM < best.distM) best = snap;
  });

  return best; // {xy, a, b, modes, ...}
}


/* Ge√ßici d√ºƒü√ºm: A‚ÄìB yi, A‚ÄìS ve S‚ÄìB olarak b√∂l */
function insertTempNodeIntoGraph(snap){
  const {xy,a,b,modes} = snap;
  const S   = ROUTE_GRAPH.getId(xy, /*forceNew*/ true);
  const aId = ROUTE_GRAPH.getId(a);
  const bId = ROUTE_GRAPH.getId(b);

  ROUTE_GRAPH.removeEdge(aId, bId);
  ROUTE_GRAPH.addEdge(aId, S, meters(a,xy), {modes});
  ROUTE_GRAPH.addEdge(S,  bId, meters(xy,b), {modes});

  return S;
}

/* Dijkstra: profil filtresi ile */
function dijkstra(startId, endId, profileKey='walk'){
  const allowed = new Set([profileKey]);
  const N = ROUTE_GRAPH.nodes.length, adj = ROUTE_GRAPH.adj;
  const distArr = new Array(N).fill(Infinity);
  const prev    = new Array(N).fill(-1);
  const used    = new Array(N).fill(false);

  distArr[startId] = 0;

  for(let k=0; k<N; k++){
    let u=-1, best=Infinity;
    for(let i=0;i<N;i++) if(!used[i] && distArr[i]<best){ best=distArr[i]; u=i; }
    if(u===-1) break;
    used[u]=true;
    if(u===endId) break;

    for(const e of (adj[u]||[])){
      if(e.modes && ![...e.modes].some(m=>allowed.has(m))) continue;
      const alt = distArr[u] + e.w;
      if(alt < distArr[e.to]){ distArr[e.to]=alt; prev[e.to]=u; }
    }
  }
  if(prev[endId]===-1 && endId!==startId) return null;

  const path=[]; let cur=endId;
  while(cur!==-1){ path.push(cur); if(cur===startId) break; cur=prev[cur]; }
  return path.reverse();
}

/* Rota hesapla (SNAP + ge√ßici d√ºƒü√ºm + turn-by-turn + s√ºre/mesafe) */

goBtn.onclick = ()=>{
  closePopup(); // ‚ûú ekle
  const srcStart = startCoord || lastKnown;
  const srcDest  = destCoord;

  if(!srcDest){ alert(LANG==='tr'?'Hedef se√ßilmedi.':'No destination.'); return; }
  if(!srcStart){ alert(LANG==='tr'?'Ba≈ülangƒ±√ß se√ßin ya da konum izni verin.':'Pick a start or allow location.'); return; }
  if(!ROUTE_GRAPH || ROUTE_GRAPH.nodes.length===0){ alert('routes.json y√ºklenemedi ya da bo≈ü.'); return; }

  const Ssnap = snapToNetworkAllRoutes(srcStart);
  const Tsnap = snapToNetworkAllRoutes(srcDest);
  if(!Ssnap || !Tsnap){ alert('Aƒüa snap edilemedi.'); return; }

  // --- connector mesafeleri
  const usedStart  = startCoord || lastKnown;
  const usedDest   = destCoord;
  const startConnM = usedStart ? meters(usedStart, Ssnap.xy) : 0;
  const destConnM  = usedDest  ? meters(Tsnap.xy,  usedDest)  : 0;

  // --- √ßok uzaksa iptal
  if (startConnM > MAX_CONNECTOR_M || destConnM > MAX_CONNECTOR_M) {
    alert('Ba≈ülangƒ±√ß veya hedef yol aƒüƒ±ndan √ßok uzakta. L√ºtfen yola yakƒ±n bir nokta se√ßin.');
    updateDebugOverlay({showComps:true, showSnaps:true, showDead:true, snaps:[Ssnap, Tsnap]});
    return;
  }

  // --- graf i√ßine ge√ßici d√ºƒü√ºmler
  const Sid = insertTempNodeIntoGraph(Ssnap);
  const Tid = insertTempNodeIntoGraph(Tsnap);

  const nodePath = dijkstra(Sid, Tid, CURRENT_PROFILE);
  if(!nodePath){
    printGraphStats();
    logSnap('START', Ssnap); logSnap('DEST', Tsnap);
    const comp = components(); const cS = comp[Sid], cT = comp[Tid];
    const msg = (cS===cT)
      ? 'Uygun rota bulunamadƒ±. (Mod kƒ±sƒ±tƒ± olabilir veya snap edilen segmentte hata/u√ß nokta var.)'
      : `Aƒü kopuk: ba≈ülangƒ±√ß bile≈üeni=${cS}, hedef bile≈üeni=${cT}. Baƒülantƒ± yok.`;
    alert(msg);
    updateDebugOverlay({showComps:true, showSnaps:true, showDead:true, snaps:[Ssnap, Tsnap]});
    return;
  }

  updateDebugOverlay({
    showComps: document.getElementById('dbgComps').checked,
    showSnaps: document.getElementById('dbgSnaps').checked,
    showDead : document.getElementById('dbgDead').checked,
    snaps:[Ssnap, Tsnap]
  });

  // --- geojson features
  const nodeCoords = nodePath.map(id=>ROUTE_GRAPH.nodes[id].xy);
  const features = [
    {type:'Feature', properties:{role:'main'}, geometry:{type:'LineString', coordinates: nodeCoords}}
  ];
  if (usedStart && startConnM >= HIDE_CONNECTOR_LT_M) {
    features.push({type:'Feature', properties:{role:'connector'},
      geometry:{type:'LineString', coordinates:[usedStart, Ssnap.xy]}});
  }
  if (usedDest && destConnM >= HIDE_CONNECTOR_LT_M) {
    features.push({type:'Feature', properties:{role:'connector'},
      geometry:{type:'LineString', coordinates:[Tsnap.xy, usedDest]}});
  }
  map.getSource('route').setData({type:'FeatureCollection', features});

  const mainLenM = totalLength(nodeCoords);
  const totalLenM= mainLenM + (usedStart?meters(usedStart,Ssnap.xy):0) + (usedDest?meters(Tsnap.xy,usedDest):0);
  const durSec   = mainLenM / (SPEEDS[CURRENT_PROFILE] || 1.3);
  dirSum.textContent = fmtDist(totalLenM)+' ¬∑ '+fmtDur(durSec);
  dirSub.textContent = '¬∑ '+CURRENT_PROFILE;

  renderTurnByTurn(nodeCoords);

  // >>> BURAYA EKLE
dirList.style.display = 'none';      // listeyi kapat
collapseDir.textContent = '‚ñº';       // buton oku a≈üaƒüƒ± olsun
// <<< BURAYA EKLE
  const bb = bboxFromCoords(nodeCoords.concat(usedStart?[usedStart]:[], usedDest?[usedDest]:[]));
  if(bb) map.fitBounds([[bb[0],bb[1]],[bb[2],bb[3]]], {padding:PADDING, maxZoom:18});
  showRouteUI();
};

/* ================== TURN-BY-TURN ================== */
function renderTurnByTurn(coords){
  dirList.innerHTML='';
  if(!coords || coords.length<2) return;

  const L = t().nav;

  // Kalkƒ±≈ü
  appendStep(L.depart, 0);

  // ƒ∞lk segment d√ºz toplamƒ±na eklensin
  let accStraightM = meters(coords[0], coords[1]);

  for(let i=1; i<coords.length-1; i++){
    const b1 = turf.bearing(turf.point(coords[i-1]), turf.point(coords[i]));
    const b2 = turf.bearing(turf.point(coords[i]),   turf.point(coords[i+1]));
    const turn = angDiff(b1, b2); // [-180,180]
    const nextSegM = meters(coords[i], coords[i+1]);

    // |turn| < 35¬∞ ise d√ºz kabul et, biriktir
    if (Math.abs(turn) < 35){
      accStraightM += nextSegM;
      continue;
    }

    // D√∂n√º≈ü var: √∂nce ‚Äútoplu d√ºz‚Äù√º yaz
    if (accStraightM > 0) {
      appendStep(L.straight, accStraightM);
      accStraightM = 0;
    }

    // D√∂n√º≈ü√º yaz (mesafesiz)
    if (turn > 0)      appendStep(L.turn_right, 0);
    else               appendStep(L.turn_left,  0);

    // D√∂n√º≈üten sonraki segment d√ºz toplamƒ±nƒ± ba≈ülat
    accStraightM = nextSegM;
  }

  // Sonda kalan d√ºz varsa yaz
  if (accStraightM > 0) appendStep(L.straight, accStraightM);

  // Varƒ±≈ü
  appendStep(L.arrive, 0);

  function appendStep(text, m){
    const el=document.createElement('div');
    el.className='step';
    el.style.display='grid';
    el.style.gridTemplateColumns='20px 1fr';
    el.style.gap='8px';
    el.style.padding='6px 0';
    el.innerHTML = `<div>‚Ä¢</div><div><div>${text}</div>${m?`<div class="muted" style="font-size:12px">${fmtDist(m)}</div>`:''}</div>`;
    dirList.appendChild(el);
  }
}

/* ================== POPUP ================== */
let popup;
function showPopup(f,lngLat,withGo){
  const p=f.properties||{}, L=t();
  const name = p['name_'+LANG] || p.name || '';
  const catKey=(p.category||'').toLowerCase(); const catLabel=L.cats?.[catKey] || p.category || '';
  const hours = p['hours_'+LANG] || p.hours || ''; const level=p['level_'+LANG]||p.level||'';
  const desc  = p['desc_'+LANG]  || p.desc  || ''; const img  = p['image_'+LANG]||p.image||'';
  const btn = withGo? `<div style="margin-top:8px"><button class="goto-btn" data-x="${Array.isArray(lngLat)?lngLat[0]:lngLat.lng}" data-y="${Array.isArray(lngLat)?lngLat[1]:lngLat.lat}">${L.go||'Git'} ‚ûú</button></div>` : '';
  const html = `<div style="min-width:220px">
      <div style="font-weight:600;margin-bottom:6px;color:#0f5132">${name}</div>
      ${catLabel?`<div class="badge">${catLabel}</div>`:''}
      ${hours?`<div style="margin-top:6px"><small>${L.labels.hours}:</small> ${hours}</div>`:''}
      ${level?`<div><small>${L.labels.level}:</small> ${level}</div>`:''}
      ${desc?`<div style="margin-top:6px" class="muted">${linkify(desc)}</div>`:''}
      ${/^https?:\/\//i.test(img)?`<div style="margin-top:6px"><img src="${img}" alt=""></div>`:''}
      ${btn}
    </div>`;
  (popup||(popup=new maplibregl.Popup({closeButton:true, closeOnClick:true}))).setLngLat(lngLat).setHTML(html).addTo(map);
}
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('.goto-btn'); if(!btn) return;
  const x=parseFloat(btn.dataset.x), y=parseFloat(btn.dataset.y);
  setDestination([x,y]);
  closePopup();
  goBtn.disabled = !(startCoord || lastKnown);
  if(!goBtn.disabled) goBtn.click();
});

/* ================== YARDIMCILAR ================== */
// Metre bazlƒ± mesafe (Turf haversine)
function meters(a, b){
  return turf.distance(turf.point(a), turf.point(b), {units:'meters'});
}
function totalLength(coords){
  let s=0; for(let i=1;i<coords.length;i++) s+=meters(coords[i-1], coords[i]); 
  return s;
}
function fmtDist(m){ return m>=1000 ? (m/1000).toFixed(2)+' km' : Math.round(m)+' m'; }
function fmtDur(sec){
  if(!isFinite(sec)) return '‚Äì';
  const m = Math.round(sec/60);
  if(m<60) return m+' dk';
  const h = Math.floor(m/60), mm = m%60;
  return h+' sa '+(mm?mm+' dk':'');
}
// A√ßƒ± farkƒ±nƒ± [-180,180] normalize
function angDiff(a,b){ let d=((b-a)%360+540)%360-180; return d; }

// Diƒüer yardƒ±mcƒ±lar
function coordOfFeature(f){
  const g=f.geometry; if(!g) return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
  if(g.type==='Point') return g.coordinates;
  if(g.type==='Polygon'){ const ring=g.coordinates[0]; return ring[Math.floor(ring.length/2)]; }
  if(g.type==='LineString'){ const c=g.coordinates; return c[Math.floor(c.length/2)]; }
  return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
}
function bboxFromCoords(coords){
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  coords.forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
  return (isFinite(minX)&&isFinite(minY)&&isFinite(maxX)&&isFinite(maxY))?[minX,minY,maxX,maxY]:null;
}
function showRouteUI(){
  if (results) results.style.display = 'none';
  if (searchRow) searchRow.style.display = 'none';
  if (ctlsRow)   ctlsRow.style.display   = 'none';

  // Rota paneli √∂zet modda a√ßƒ±lsƒ±n
   showSearchUI();   // ‚Üê rota paneli kapansƒ±n, arama alanƒ± geri gelsin
  collapseDir.textContent = '‚ñº';

  setMode('route'); 
}

function showSearchUI(){
  dirBox.style.display = 'none';   // rota panelini kapat
  if (searchRow) searchRow.style.display = 'grid'; // arama satƒ±rƒ± grid
  if (ctlsRow)   ctlsRow.style.display   = 'flex'; // butonlar flex
}

// Graf √∂zetini consola yaz
function printGraphStats(){
  if(!ROUTE_GRAPH){ console.warn('Graph yok'); return; }
  const N = ROUTE_GRAPH.nodes.length;
  let E = 0, deg1 = 0;
  const deg = new Array(N).fill(0);
  for(let i=0;i<N;i++){
    const d=(ROUTE_GRAPH.adj[i]||[]).length; deg[i]=d; E+=d;
    if(d===1) deg1++;
  }
  E = E/2; // √ßift y√∂nl√º
  const comp = components();
  const compCount = Math.max(...comp)+1;
  console.log('[GRAPH]', {nodes:N, edges:E, deg1, components:compCount});
}

// u->v kenarƒ±nƒ±n metadata'sƒ±
function getEdgeMeta(u,v){
  const list = ROUTE_GRAPH.adj[u]||[];
  return list.find(e=>e.to===v) || null;
}

// Bile≈üen hesapla
function components(){
  const N = ROUTE_GRAPH.nodes.length;
  const comp = new Array(N).fill(-1);
  let cid=0;
  for(let i=0;i<N;i++){
    if(comp[i]!==-1) continue;
    const q=[i]; comp[i]=cid;
    for(let qi=0; qi<q.length; qi++){
      const u = q[qi];
      for(const e of (ROUTE_GRAPH.adj[u]||[])){
        if(comp[e.to]===-1){ comp[e.to]=cid; q.push(e.to); }
      }
    }
    cid++;
  }
  return comp;
}

// Adj'dan edge feature'larƒ± (bile≈üen id'li) √ºret
function makeDebugEdges(comp){
  const seen = new Set();
  const feats=[];
  for(let u=0; u<ROUTE_GRAPH.nodes.length; u++){
    for(const e of (ROUTE_GRAPH.adj[u]||[])){
      const v = e.to; if(u>v) continue; // her kenarƒ± 1 kez
      const key = u+'-'+v; if(seen.has(key)) continue; seen.add(key);
      feats.push({
        type:'Feature',
        properties:{kind:'edge', comp: comp[u]},
        geometry:{type:'LineString', coordinates:[ROUTE_GRAPH.nodes[u].xy, ROUTE_GRAPH.nodes[v].xy]}
      });
    }
  }
  return feats;
}

// Dead-end d√ºƒü√ºm noktalarƒ±
function makeDeadEnds(){
  const feats=[];
  for(let i=0;i<ROUTE_GRAPH.nodes.length;i++){
    if((ROUTE_GRAPH.adj[i]||[]).length===1){
      feats.push({type:'Feature', properties:{kind:'dead'}, geometry:{type:'Point', coordinates:ROUTE_GRAPH.nodes[i].xy}});
    }
  }
  return feats;
}

// Snap debug (S/T noktalarƒ± ve A‚ÄìB segmentleri)
function makeSnapDebug(snap, label){
  if(!snap) return [];
  const feats=[];
  feats.push({type:'Feature', properties:{kind:'snap', label}, geometry:{type:'Point', coordinates:snap.xy}});
  feats.push({type:'Feature', properties:{kind:'seg', label}, geometry:{type:'LineString', coordinates:[snap.a, snap.b]}});
  return feats;
}

// Toggle'lardan √ßiz (her √ßaƒürƒ±da komple yeniler)
function updateDebugOverlay(opts={}){
  const {showComps, showSnaps, showDead, snaps=[]} = opts;
  const fc = {type:'FeatureCollection', features:[]};
  if(showComps && ROUTE_GRAPH){
    const comp = components();
    fc.features.push(...makeDebugEdges(comp));
  }
  if(showDead && ROUTE_GRAPH){
    fc.features.push(...makeDeadEnds());
  }
  if(showSnaps && snaps.length){
    snaps.forEach((s,i)=> fc.features.push(...makeSnapDebug(s, i===0?'S':'T')));
  }
  map.getSource('debug').setData(fc);
}

// Checkbox deƒüi≈üimleri
['dbgComps','dbgSnaps','dbgDead'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('change', ()=>{
    updateDebugOverlay({
      showComps: document.getElementById('dbgComps').checked,
      showSnaps: document.getElementById('dbgSnaps').checked,
      showDead : document.getElementById('dbgDead').checked,
    });
  });
});

// Snap ayrƒ±ntƒ±larƒ±nƒ± consola yaz (te≈ühis i√ßin)
function logSnap(tag, snap){
  if(!snap){ console.warn(tag, 'snap yok'); return; }
  console.log(`[SNAP:${tag}]`, {
    xy: snap.xy,
    distM: snap.distM,
    a: snap.a, b: snap.b,
    featureId: snap.featureId, featureName: snap.featureName
  });
}


/* ================== ROTA PANELƒ∞ BUTONLARI ================== */
function clearRoute(){
  map.getSource('route').setData(emptyFC());

  dirList.innerHTML='';
  dirSum.textContent='‚Äì';
  dirSub.textContent='';
  setMode('search');               // ‚ûú rota alanƒ±nƒ± kapat, search‚Äôi a√ß
}
clearRouteBtn.onclick=()=>clearRoute();
collapseDir.onclick=()=>{ const s=getComputedStyle(dirList).display; dirList.style.display= s==='none' ? 'block':'none'; collapseDir.textContent = s==='none' ? '‚ñ≤':'‚ñº'; };

/* ================== RESET + POPUP KAPAT ================== */
function closePopup(){ if(popup) popup.remove(); }
resetBtn.onclick=()=>{ 
  closePopup(); clearRoute(); setMode('search');
  map.getSource('dest').setData(emptyFC()); destCoord=null;
  map.getSource('start').setData(emptyFC()); startCoord=null;
  q.value=''; results.style.display='none'; pickMode='none';
  pickStartBtn.classList.remove('active'); pickDestBtn.classList.remove('active');
  document.getElementById('sheet').style.setProperty('--panel-ty','0px');
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING});
};

/* ================== BLUEDOT (BENƒ∞M KONUMUM) ================== */
function setMe(xy, accM=5){
  lastKnown = xy;
  const meSrc = map.getSource('me');
  if (meSrc) {
    meSrc.setData({
      type:'FeatureCollection',
      features:[{type:'Feature', properties:{acc:accM},
        geometry:{type:'Point', coordinates:xy}}]
    });
  }
  acc.textContent = "¬±"+accM+" m";
  acc.style.display='block';
  if (followState) map.easeTo({center:lastKnown});
  goBtn.disabled = !(startCoord || lastKnown);
}

/* ================== ALT PANEL (A√á/KAPA S√úR√úKLEME) ================== */
(function(){
  const sheet=$('sheet'), grab=$('grab');
  const H_GRAB=24;
  const setTy=v=> sheet.style.setProperty('--panel-ty',v+'px');
  const getTy=()=> parseFloat(getComputedStyle(sheet).getPropertyValue('--panel-ty'))||0;
  function maxTravel(){
    const h=sheet.getBoundingClientRect().height||320;
    const byH=Math.max(0,h-(H_GRAB+8));
    const byV=Math.min(window.innerHeight*0.6,520);
    return Math.min(byH,byV);
  }
  let MAX=0, sy=null, st=0;
  function recalc(){ MAX=maxTravel(); setTy(Math.min(getTy(),MAX)); }
  window.addEventListener('resize',recalc);
  requestAnimationFrame(()=>{ recalc(); setTy(0); });

  grab.addEventListener('pointerdown',e=>{ sy=e.clientY; st=getTy(); grab.setPointerCapture(e.pointerId); });
  grab.addEventListener('pointermove',e=>{ if(sy==null)return; const dy=e.clientY-sy; setTy(Math.max(0,Math.min(MAX,st+dy))); });
  function end(){ if(sy==null)return; const ty=getTy(); setTy(ty>MAX*0.5?MAX:0); sy=null; }
  grab.addEventListener('pointerup',end); grab.addEventListener('pointercancel',end);
  grab.addEventListener('click',()=>{ const ty=getTy(); setTy(ty===0?MAX:0); });
})();
</script>
</body>
</html>
