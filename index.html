<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Admin â€“ Indoor/Outdoor Veri EditÃ¶rÃ¼ (GeliÅŸmiÅŸ)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{position:fixed; inset:0; height:auto; width:auto; touch-action:none;}
  .panel{position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10;
    background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    padding:10px; width:calc(100% - 20px); max-width:1100px; pointer-events:auto;}
  .row{display:flex; flex-wrap:wrap; gap:8px}
  .row>*{flex:1 1 auto; min-width:120px}
  button,select,input[type="file"],input[type="text"]{
    padding:12px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer
  }
  input[type="text"]{cursor:text}
  .primary{border-color:#b3d7ff; background:#f0f7ff}
  .danger{border-color:#ffb3b3; background:#fff0f0}
  .active{outline:2px solid #3b82f6; background:#eaf2ff}
  #status{position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:11; background:#111; color:#fff; padding:6px 10px; border-radius:8px; display:none; font-size:13px}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:12}
  .panel2{background:#fff; width:min(560px,92vw); border-radius:14px; padding:14px; box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid label{font-size:12px; color:#555}
  .grid input,.grid textarea,.grid select{width:100%; padding:10px; border:1px solid #ddd; border-radius:8px}
  textarea{min-height:72px}
  .actions{display:flex; gap:8px; justify-content:space-between; margin-top:10px}
  .actions .left{display:flex; gap:8px}
  .actions button{padding:10px 14px; border:1px solid #ddd; border-radius:8px; background:#fff}
  .save{border-color:#b3d7ff; background:#f0f7ff}
  .cancel{background:#fafafa}
  .pill{padding:4px 8px; font-size:12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe}
  .small{font-size:12px; color:#555}
</style>
</head>
<body>
<div id="map"></div>
<div id="status"></div>

<div class="panel">
  <div class="row" style="margin-bottom:8px">
    <select id="layerSel">
      <option value="outdoor">Hedef: OUTDOOR</option>
      <option value="indoor">Hedef: INDOOR</option>
    </select>
    <input id="levelFilter" placeholder="Kat filtresi (Ã¶r: 1) â€“ boÅŸ=hepsi" />
    <button id="myPos" class="primary">ğŸ“ Benim Konumum</button>
    <button id="addPoint" class="primary">â• Nokta</button>
    <button id="addLine" class="primary">ã€°ï¸ Ã‡izgi</button>
    <button id="addPoly" class="primary">â¬› Poligon</button>
    <button id="finishDraw" style="display:none">âœ” Bitir</button>
    <button id="modify">âœ DÃ¼zenle</button>
    <button id="selectBtn">â˜‘ SeÃ§ / Ã–zellik</button>
    <button id="del" class="danger">ğŸ—‘ Sil</button>
  </div>
  <div class="row">
    <button id="undo">â†¶ Geri Al</button>
    <button id="redo">â†· Ä°leri Al</button>
    <button id="expIndoor">â¤“ indoor.json</button>
    <button id="expOutdoor">â¤“ outdoor.json</button>
    <label style="display:flex;align-items:center;gap:6px">â¤’ JSON YÃ¼kle
      <input id="imp" type="file" accept=".json,application/json">
    </label>
    <button id="clearLocal" class="danger">ğŸ§¹ Yerel Veriyi Temizle</button>
    <span class="pill small">Aktif katman vurgulu, diÄŸeri soldurulmuÅŸ</span>
  </div>
</div>

<!-- Ã–zellik Formu -->
<div id="propModal" class="modal" aria-hidden="true">
  <div class="panel2">
    <h3>Ã–zellikler</h3>
    <div class="grid">
      <div><label>Ä°sim</label><input id="f_name" placeholder="Ã–rn: Ana Restoran"></div>
      <div>
        <label>Kategori</label>
        <select id="f_category">
          <option value="">SeÃ§inizâ€¦</option>
          <option>restaurant</option>
          <option>bar</option>
          <option>spa</option>
          <option>pool</option>
          <option>wc</option>
          <option>elevator</option>
          <option>stair</option>
          <option>kidsclub</option>
          <option>reception</option>
          <option>shop</option>
          <option>gym</option>
          <option>beach</option>
          <option>shuttle</option>
          <option>parking</option>
          <option>gate</option>
          <option>info</option>
          <option value="_other">DiÄŸerâ€¦</option>
        </select>
      </div>
      <div style="grid-column:1/-1; display:none" id="catOtherWrap"><label>DiÄŸer Kategori</label><input id="f_category_other" placeholder="Ã¶r. lounge"></div>
      <div><label>Saatler</label><input id="f_hours" placeholder="09:00-22:00"></div>
      <div><label>Seviye/Kat</label><input id="f_level" placeholder="1"></div>
      <div style="grid-column:1/-1"><label>AÃ§Ä±klama</label><textarea id="f_desc" placeholder="KÄ±sa aÃ§Ä±klama"></textarea></div>
      <div style="grid-column:1/-1"><label>FotoÄŸraf URL</label><input id="f_image" placeholder="https://.../foto.jpg"></div>
      <div><label>Ã–ÄŸe ID (otomatik)</label><input id="f_id" disabled></div>
      <div><label>Alan/Uzunluk</label><input id="f_metric" disabled></div>
    </div>
    <div class="actions">
      <div class="left">
        <button class="cancel" id="propCancel">VazgeÃ§</button>
        <button id="propDelete" class="danger">Sil</button>
      </div>
      <button class="save" id="propSave">Kaydet</button>
    </div>
  </div>
</div>

<script>
/* ===================== YardÄ±mcÄ±lar & Kurulum ===================== */
const $ = id => document.getElementById(id);
const statusEl = $("status");
const setStatus = (msg, ms=2200) => {
  if(!msg){ statusEl.style.display="none"; return; }
  statusEl.textContent = msg; statusEl.style.display = "block";
  if(ms>0) setTimeout(()=>{ statusEl.style.display="none"; }, ms);
};
const layerKey = () => $("layerSel").value;

const fmt = new ol.format.GeoJSON();
function isFeatureCollection(gj){
  return gj && gj.type === "FeatureCollection" && Array.isArray(gj.features);
}
const writeGJ = layer =>
  JSON.parse(fmt.writeFeatures(layer.getSource().getFeatures(), {
    featureProjection: "EPSG:3857",
    dataProjection: "EPSG:4326"
  }));
const readGJToLayer = (layer, gj) => {
  if(!isFeatureCollection(gj)) throw new Error("GeoJSON FeatureCollection bekleniyor.");
  const fs = fmt.readFeatures(gj, {
    featureProjection: "EPSG:3857",
    dataProjection: "EPSG:4326"
  });
  layer.getSource().clear();
  layer.getSource().addFeatures(fs);
};

function debounce(fn, wait){
  let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
}

/* GÃ¼venli localStorage kaydÄ± */
const saveLocalRaw = (key, data) => {
  try { localStorage.setItem(key, JSON.stringify(data)); }
  catch(e){ console.warn(e); alert("Yerel depolama kotasÄ± dolu olabilir. DÄ±ÅŸa aktarÄ±n ve temizleyin."); }
};
const saveLocal = debounce((key, layer)=> saveLocalRaw(key, writeGJ(layer)), 300);
const loadLocal = key => {
  const s = localStorage.getItem(key);
  try{ return s ? JSON.parse(s) : null; }catch{ return null; }
};

async function tryFetch(url){
  try{
    const r = await fetch(url, {cache:"no-cache"});
    if(!r.ok) throw 0;
    return await r.json();
  }catch{return null;}
}

/* ===================== Stil & Katmanlar ===================== */
function baseStyleFor(f, dim=1){
  const t = f.getGeometry().getType();
  const stroke = new ol.style.Stroke({color:`rgba(0,0,0,${0.6*dim})`,width:2});
  const fill = new ol.style.Fill({color:`rgba(0,150,0,${0.18*dim})`});
  const circle = new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:`rgba(200,0,0,${1*dim})`}),stroke:new ol.style.Stroke({color:"#fff",width:1})});
  return t==="Point" ? new ol.style.Style({image:circle}) : new ol.style.Style({stroke,fill});
}

/* level filtresi + aktif/diÄŸer katman gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ */
function styleWrapper(layerName){
  return function(f){
    const activeLayer = layerKey();
    const filter = $("levelFilter").value.trim();
    const lvl = (f.get("level") ?? "").toString().trim();
    const isActive = activeLayer === layerName;
    if(filter && lvl !== filter) return null; // gizle
    return baseStyleFor(f, isActive ? 1 : 0.35); // diÄŸer katman soldur
  };
}

/* VectorImage: Ã§ok Ã¶ÄŸede performans avantajÄ± */
const indoorSource  = new ol.source.Vector();
const outdoorSource = new ol.source.Vector();
const indoorLayer  = new ol.layer.VectorImage({source: indoorSource,  style: styleWrapper("indoor")});
const outdoorLayer = new ol.layer.VectorImage({source: outdoorSource, style: styleWrapper("outdoor")});

const map = new ol.Map({
  target:"map",
  layers:[ new ol.layer.Tile({source:new ol.source.OSM()}), indoorLayer, outdoorLayer ],
  view:new ol.View({center: ol.proj.fromLonLat([31.805,36.600]), zoom:17})
});
const tgtLayer = ()=> layerKey()==="indoor" ? indoorLayer : outdoorLayer;

/* ===================== Veri yÃ¼kleme (localâ†’dosyaâ†’boÅŸ) ===================== */
let isBulkLoading = false;
(async ()=>{
  isBulkLoading = true;
  const ind = loadLocal("indoor")  || (await tryFetch("indoor.json"))  || {"type":"FeatureCollection","features":[]};
  const out = loadLocal("outdoor") || (await tryFetch("outdoor.json")) || {"type":"FeatureCollection","features":[]};
  readGJToLayer(indoorLayer, ind);
  readGJToLayer(outdoorLayer, out);
  isBulkLoading = false;
})();

/* ===================== Jeolokasyon ===================== */
let lastPos=null;
function geoError(err){
  setStatus("Konum alÄ±namadÄ±: " + (err?.message || err?.code || "bilinmiyor"));
}
if(navigator.geolocation){
  navigator.geolocation.watchPosition(
    p => { lastPos = p; },
    geoError,
    { enableHighAccuracy:true, maximumAge:5000, timeout:10000 }
  );
}

/* ===================== EtkileÅŸim DurumlarÄ± ===================== */
let mode = null; // 'point'|'line'|'polygon'|'modify'|'select'|null
let draw = null, modify = null, select = null, snap = null, selected = null;

function resetInteractions(){
  if(draw){ map.removeInteraction(draw); draw=null; }
  if(modify){ map.removeInteraction(modify); modify=null; }
  if(select){ map.removeInteraction(select); select=null; }
  if(snap){ map.removeInteraction(snap); snap=null; }
  selected=null; mode=null;
  ["addPoint","addLine","addPoly","modify","selectBtn"].forEach(id=>$(id).classList.remove("active"));
  $("finishDraw").style.display="none";
  setStatus(""); map.getTargetElement().style.cursor="";
}
function withDCZoomDisabled(fn){
  const dc = map.getInteractions().getArray().find(i=>i instanceof ol.interaction.DoubleClickZoom);
  const prev = dc ? dc.getActive() : null;
  if(dc) dc.setActive(false);
  try{ fn(); } finally { if(dc && prev!==null) dc.setActive(prev); }
}
function enableSnap(layer){
  if(snap) map.removeInteraction(snap);
  snap = new ol.interaction.Snap({ source: layer.getSource() });
  map.addInteraction(snap);
}

/* ===================== Geometri zenginleÅŸtirme ===================== */
function enrichFeature(f){
  try{ if(!f.getId() && crypto?.randomUUID) f.setId(crypto.randomUUID()); }catch{}
  const g = f.getGeometry(); const t = g.getType();
  // 3857 dÃ¼zleminde yaklaÅŸÄ±k m/mÂ²; otel Ã¶lÃ§eÄŸinde yeterli
  if(t === "Polygon"){ f.set("area_m2", Math.round(g.getArea())); }
  else if(t === "LineString"){ f.set("len_m", Math.round(g.getLength())); }
}

/* ===================== Undo / Redo ===================== */
const history = {
  indoor: { undo:[], redo:[] },
  outdoor:{ undo:[], redo:[] }
};
function snapshot(key){
  const layer = key==="indoor" ? indoorLayer : outdoorLayer;
  return writeGJ(layer);
}
function pushHistory(key){
  if(isBulkLoading) return;
  const h = history[key];
  h.undo.push(snapshot(key));
  if(h.undo.length>50) h.undo.shift(); // makul limit
  h.redo.length = 0; // yeni hareket â†’ ileri temizlenir
}
function applySnapshot(key, gj){
  const layer = key==="indoor" ? indoorLayer : outdoorLayer;
  isBulkLoading = true;
  readGJToLayer(layer, gj);
  isBulkLoading = false;
  saveLocal(key, layer);
}
function undo(){
  const key = layerKey(), h = history[key];
  if(h.undo.length===0) return;
  const current = snapshot(key);
  const prev = h.undo.pop();
  h.redo.push(current);
  applySnapshot(key, prev);
}
function redo(){
  const key = layerKey(), h = history[key];
  if(h.redo.length===0) return;
  const current = snapshot(key);
  const next = h.redo.pop();
  h.undo.push(current);
  applySnapshot(key, next);
}
$("undo").onclick = ()=> undo();
$("redo").onclick = ()=> redo();

/* Kaydetme ve tarihÃ§e tetikleyicileri */
function wireSourceEvents(layerName, layer){
  const src = layer.getSource();
  src.on("addfeature",  ()=>{ pushHistory(layerName); saveLocal(layerName, layer); });
  src.on("removefeature", ()=>{ pushHistory(layerName); saveLocal(layerName, layer); });
}
wireSourceEvents("indoor", indoorLayer);
wireSourceEvents("outdoor", outdoorLayer);

/* ===================== Ã–zellik Formu ===================== */
const propModal = $("propModal");
function validateImg(url){
  try{
    const u = new URL(url);
    if(!(u.protocol==="http:" || u.protocol==="https:")) return false;
    const ok = /\.(jpg|jpeg|png|gif|webp|avif|svg)(\?.*)?$/i.test(u.pathname);
    return ok;
  }catch{return false;}
}

function openForm(f){
  const p = f.getProperties();
  $("f_name").value = p.name || "";
  const catSel = $("f_category");
  const otherWrap = $("catOtherWrap");
  const otherInput = $("f_category_other");
  if(p.category && [...catSel.options].some(o=>o.value===p.category)){
    catSel.value = p.category; otherWrap.style.display="none"; otherInput.value="";
  }else if(p.category){
    catSel.value = "_other"; otherWrap.style.display="block"; otherInput.value = p.category;
  }else{
    catSel.value = ""; otherWrap.style.display="none"; otherInput.value="";
  }
  $("f_hours").value = p.hours || "";
  $("f_level").value = p.level || "";
  $("f_desc").value  = p.desc  || "";
  $("f_image").value = p.image || "";
  $("f_id").value    = f.getId() || "(oluÅŸturulacak)";
  const g = f.getGeometry();
  $("f_metric").value = g.getType()==="Polygon" ? (p.area_m2 ? (p.area_m2+" mÂ²"): "") :
                        g.getType()==="LineString" ? (p.len_m ? (p.len_m+" m"): "") : "";

  propModal.style.display="flex";
  propModal.setAttribute("aria-hidden","false");

  const updateCatOther = ()=>{
    if(catSel.value==="_other"){ otherWrap.style.display="block"; }
    else { otherWrap.style.display="none"; otherInput.value=""; }
  };
  catSel.onchange = updateCatOther; updateCatOther();

  $("propSave").onclick = ()=>{
    const catVal = (catSel.value==="_other") ? otherInput.value.trim() : catSel.value.trim();
    const img = $("f_image").value.trim();
    if(img && !validateImg(img)){ alert("FotoÄŸraf URL geÃ§ersiz gÃ¶rÃ¼nÃ¼yor."); return; }

    f.setProperties({
      name: $("f_name").value.trim(),
      category: catVal || "",
      hours: $("f_hours").value.trim(),
      level: $("f_level").value.trim(),
      desc: $("f_desc").value.trim(),
      image: img
    });
    enrichFeature(f); // id/metrikleri gÃ¼ncelle
    const key = layerKey(); const layer = tgtLayer();
    pushHistory(key); saveLocal(key, layer);
    propModal.style.display="none";
    propModal.setAttribute("aria-hidden","true");
    resetInteractions();
  };

  $("propCancel").onclick = ()=>{
    propModal.style.display="none";
    propModal.setAttribute("aria-hidden","true");
    resetInteractions();
  };

  $("propDelete").onclick = ()=>{
    if(confirm("Bu Ã¶ÄŸe silinsin mi?")){
      const layer = tgtLayer();
      layer.getSource().removeFeature(f);
      const key = layerKey();
      pushHistory(key); saveLocal(key, layer);
      propModal.style.display="none";
      propModal.setAttribute("aria-hidden","true");
      resetInteractions();
    }
  };
}
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape" && propModal.style.display==="flex"){
    propModal.style.display="none"; propModal.setAttribute("aria-hidden","true"); resetInteractions();
  }
});

/* ===================== Harita EtkileÅŸimleri ===================== */
map.on("singleclick", (evt)=>{
  if(mode!=="point") return;
  const layer = tgtLayer();
  const f = new ol.Feature(new ol.geom.Point(evt.coordinate));
  enrichFeature(f);
  layer.getSource().addFeature(f);
  openForm(f);
});

$("addPoint").onclick = (e)=>{
  e.preventDefault(); resetInteractions();
  mode="point"; $("addPoint").classList.add("active");
  setStatus("NOKTA: haritaya tÄ±kla/dokun"); map.getTargetElement().style.cursor="crosshair";
};

$("addLine").onclick = (e)=>{
  e.preventDefault(); resetInteractions();
  mode="line"; $("addLine").classList.add("active");
  setStatus("Ã‡Ä°ZGÄ°: noktalarÄ± yerleÅŸtir; bitirmek iÃ§in Ã§ift tÄ±k ya da âœ” Bitir");
  map.getTargetElement().style.cursor="crosshair";
  const layer=tgtLayer();

  withDCZoomDisabled(()=>{
    draw = new ol.interaction.Draw({ source: layer.getSource(), type: "LineString" });
    map.addInteraction(draw);
  });
  enableSnap(layer);
  $("finishDraw").style.display="inline-block";
  $("finishDraw").onclick = ()=> { if(draw) draw.finishDrawing(); };

  draw.once("drawend", (ev)=>{
    $("finishDraw").style.display="none";
    enrichFeature(ev.feature);
    openForm(ev.feature);
    const key = layerKey();
    pushHistory(key); saveLocal(key, layer);
  });
};

$("addPoly").onclick = (e)=>{
  e.preventDefault(); resetInteractions();
  mode="polygon"; $("addPoly").classList.add("active");
  setStatus("POLÄ°GON: noktalarÄ± yerleÅŸtir; bitirmek iÃ§in Ã§ift tÄ±k ya da âœ” Bitir");
  map.getTargetElement().style.cursor="crosshair";
  const layer=tgtLayer();

  withDCZoomDisabled(()=>{
    draw = new ol.interaction.Draw({ source: layer.getSource(), type: "Polygon" });
    map.addInteraction(draw);
  });
  enableSnap(layer);
  $("finishDraw").style.display="inline-block";
  $("finishDraw").onclick = ()=> { if(draw) draw.finishDrawing(); };

  draw.once("drawend", (ev)=>{
    $("finishDraw").style.display="none";
    enrichFeature(ev.feature);
    openForm(ev.feature);
    const key = layerKey();
    pushHistory(key); saveLocal(key, layer);
  });
};

$("modify").onclick = (e)=>{
  e.preventDefault(); resetInteractions();
  mode="modify"; $("modify").classList.add("active");
  setStatus("DÃœZENLE: kÃ¶ÅŸeleri sÃ¼rÃ¼kle (Snap aÃ§Ä±k)");
  const layer=tgtLayer();
  modify = new ol.interaction.Modify({ source: layer.getSource() });
  map.addInteraction(modify);
  enableSnap(layer);
  modify.on("modifyend", ()=>{
    // metrikleri gÃ¼ncelle
    const feats = modify.getOverlay().getSource ? layer.getSource().getFeatures() : layer.getSource().getFeatures();
    feats.forEach(enrichFeature);
    const key = layerKey();
    pushHistory(key); saveLocal(key, layer);
  });
};

$("selectBtn").onclick = (e)=>{
  e.preventDefault(); resetInteractions();
  mode="select"; $("selectBtn").classList.add("active");
  setStatus("SEÃ‡Ä°M: Ã¶ÄŸeye tÄ±kla â†’ form aÃ§Ä±lÄ±r");
  const layer=tgtLayer();
  select = new ol.interaction.Select({ layers:[layer] });
  if(select.setHitTolerance) select.setHitTolerance(6);
  map.addInteraction(select);
  select.on("select", ev=>{
    selected = ev.selected[0] || null;
    if(selected) openForm(selected);
  });
};

$("del").onclick = (e)=>{
  e.preventDefault();
  const layer=tgtLayer();
  if(!selected){ alert("Silmek iÃ§in Ã¶nce 'SeÃ§ / Ã–zellik' ile Ã¶ÄŸe seÃ§in."); return; }
  if(confirm("SeÃ§ili Ã¶ÄŸe silinsin mi?")){
    layer.getSource().removeFeature(selected); selected=null;
    const key = layerKey();
    pushHistory(key); saveLocal(key, layer);
    resetInteractions();
  }
};

document.addEventListener("keydown", (e)=>{
  if(e.key === "Delete" && selected){
    const layer=tgtLayer();
    if(confirm("SeÃ§ili Ã¶ÄŸe silinsin mi?")){
      layer.getSource().removeFeature(selected); selected=null;
      const key = layerKey();
      pushHistory(key); saveLocal(key, layer);
      resetInteractions();
    }
  }
});

/* Katman deÄŸiÅŸince stil gÃ¼ncellensin, seÃ§imi sÄ±fÄ±rla */
$("layerSel").addEventListener("change", ()=>{
  resetInteractions();
  indoorLayer.changed(); outdoorLayer.changed();
});
$("levelFilter").addEventListener("input", ()=>{
  indoorLayer.changed(); outdoorLayer.changed();
});

/* ===================== Benim Konumum ===================== */
$("myPos").onclick = async (e)=>{
  e.preventDefault();
  const layer=tgtLayer();

  if(!lastPos && navigator.geolocation){
    await new Promise(res=>navigator.geolocation.getCurrentPosition(
      p=>{ lastPos=p; res(); }, geoError, { enableHighAccuracy:true, timeout:8000 }
    ));
  }
  if(!lastPos){ alert("Konum alÄ±namadÄ±."); return; }

  const c = ol.proj.fromLonLat([lastPos.coords.longitude, lastPos.coords.latitude]);
  const f = new ol.Feature(new ol.geom.Point(c));
  enrichFeature(f);
  layer.getSource().addFeature(f);
  openForm(f);
  const key = layerKey();
  pushHistory(key); saveLocal(key, layer);
};

/* ===================== Ä°ndir / YÃ¼kle / Temizle ===================== */
function downloadJSON(obj, name){
  const b=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const u=URL.createObjectURL(b); const a=document.createElement("a");
  a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u);
}
$("expIndoor").onclick = ()=>{
  const data=writeGJ(indoorLayer);
  downloadJSON(data, "indoor.json");
};
$("expOutdoor").onclick = ()=>{
  const data=writeGJ(outdoorLayer);
  downloadJSON(data, "outdoor.json");
};

$("imp").addEventListener("change", async e=>{
  const file=e.target.files[0]; if(!file) return;
  if(file.size > 5 * 1024 * 1024){ alert("Dosya > 5MB, lÃ¼tfen kÃ¼Ã§Ã¼ltÃ¼n."); e.target.value=""; return; }
  try{
    const txt=await file.text();
    const json=JSON.parse(txt);
    if(!isFeatureCollection(json)) throw new Error();
    if(json.features.length > 5000){ alert("Maksimum 5000 Ã¶ÄŸe."); e.target.value=""; return; }
    const layer=tgtLayer();
    isBulkLoading = true;
    readGJToLayer(layer, json);
    isBulkLoading = false;
    const key = layerKey();
    pushHistory(key); saveLocal(key, layer);
    alert("GeoJSON yÃ¼klendi.");
  } catch {
    alert("GeÃ§ersiz GeoJSON.");
  }
  e.target.value="";
});

$("clearLocal").onclick = ()=>{
  if(confirm("TarayÄ±cÄ± yerel verisi silinsin mi?")){
    localStorage.removeItem("indoor"); localStorage.removeItem("outdoor");
    alert("Yerel veri temizlendi. SayfayÄ± yenileyin.");
  }
};

/* ===================== BaÅŸlangÄ±Ã§ Bilgisi ===================== */
setStatus("HazÄ±r: Kat filtresi, Snap, Undo/Redo, âœ” Bitir eklendi.", 2600);
</script>
</body>
</html>
