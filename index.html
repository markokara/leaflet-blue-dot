<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir â€“ MapLibre GL (3D/Pitch/Rotation)</title>

  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>

  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#ffffff }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f3f4f6}
    #map{position:fixed; inset:0}

    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); width:min(780px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px}
    .stack{display:flex; flex-direction:column; gap:8px}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button,.btn{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .muted{color:var(--muted)}
    .results{background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:36vh; overflow:auto; display:none}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}
    .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}
    .dir{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:10px}
    .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb}
    .dir .sum{font-weight:600}
    .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
    .step{display:flex; gap:8px; padding:6px 0; border-bottom:1px dashed #e5e7eb}
    .step:last-child{border-bottom:none}
    .acc{position:fixed; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
    .popup{font:13px/1.35 system-ui; padding:4px 2px}
    @media (max-width:520px){ .panel{bottom:8px} }
  </style>
</head>
<body>

  <!-- Kontrol paneli (seninle aynÄ± UI) -->
  <div class="panel">
    <div class="card p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuzâ€¦" />
        <button id="go" disabled>Git</button>
        <select id="lang" aria-label="Language">
          <option value="tr" selected>TR</option>
          <option value="en">EN</option>
          <option value="ru">RU</option>
          <option value="de">DE</option>
          <option value="pl">PL</option>
        </select>
      </div>
      <div class="row" style="flex-wrap:wrap">
        <button id="pick">Haritadan Hedef</button>
        <button id="follow">ðŸŽ¯ Ä°zle: KapalÄ±</button>
        <button id="toggleDetails">Detaylar: KapalÄ±</button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
        <button id="reset">SÄ±fÄ±rla</button>
        <span class="muted" id="hint" style="display:none">ðŸ”Ž Arama aÃ§Ä±k</span>
      </div>

      <div id="results" class="results"></div>

      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">â€“</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">â–²</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>

      <div class="muted" style="font-size:11px; text-align:right">Â© aihotelstech Â· Â© OpenStreetMap contributors</div>
    </div>
  </div>

  <div id="acc" class="acc" style="display:none"></div>

  <!-- Map -->
  <div id="map" aria-label="Harita"></div>

  <script>
  /* ====== Basit i18n (senin metinlerin kÄ±saltÄ±lmÄ±ÅŸ hali) ====== */
  const I18N={tr:{ui:{pick:"Haritadan Hedef",followOn:"Ä°zle: AÃ§Ä±k",followOff:"Ä°zle: KapalÄ±",detailsOn:"Detaylar: AÃ§Ä±k",detailsOff:"Detaylar: KapalÄ±",reset:"SÄ±fÄ±rla",hint:"ðŸ”Ž Arama aÃ§Ä±k: sadece eÅŸleÅŸenler",clearRoute:"Rota Temizle"},
    labels:{name:"Ä°sim",category:"TÃ¼r",level:"Kat",hours:"Saat"},
    nav:{depart:"BaÅŸla",arrive:"VarÄ±ÅŸ",turn_left:"Sola dÃ¶n",turn_right:"SaÄŸa dÃ¶n",straight:"DÃ¼z devam",roundabout:"GÃ¶bekte %n. Ã§Ä±kÄ±ÅŸ",onto:" â†’ %s"},
    cats:{pool:"Havuz",restaurant:"Restoran",spa:"Spa",bar:"Bar",cafe:"Kafe",shop:"DÃ¼kkan",toilet:"WC",reception:"Resepsiyon",beach:"Plaj",kidsclub:"Ã‡ocuk KulÃ¼bÃ¼",elevator:"AsansÃ¶r",gate:"KapÄ±",parking:"Otopark",shuttle:"Servis",gym:"Spor Salonu"}},
  en:{ui:{pick:"Pick on Map",followOn:"Follow: On",followOff:"Follow: Off",detailsOn:"Details: On",detailsOff:"Details: Off",reset:"Reset",hint:"ðŸ”Ž Search active",clearRoute:"Clear Route"},
    labels:{name:"Name",category:"Type",level:"Level",hours:"Hours"},
    nav:{depart:"Depart",arrive:"Arrive",turn_left:"Turn left",turn_right:"Turn right",straight:"Go straight",roundabout:"At roundabout take exit %n",onto:" onto %s"},
    cats:{pool:"Pool",restaurant:"Restaurant",spa:"Spa",bar:"Bar",cafe:"Cafe",shop:"Shop",toilet:"Toilet",reception:"Reception",beach:"Beach",kidsclub:"Kids Club",elevator:"Elevator",gate:"Gate",parking:"Parking",shuttle:"Shuttle",gym:"Gym"}}};
  let LANG=localStorage.getItem('lang')||'tr'; const t=()=>(I18N[LANG]||I18N.tr);

  /* ====== 1) MapLibre GL BaÅŸlat ====== */
  // MapTiler stilini kullanÄ±yoruz (kendi key'inizi koyun) veya kendi style.json'Ä±nÄ±zÄ±n URL'ini verin.
  const STYLE_URL = "https://api.maptiler.com/maps/streets/style.json?key=ym4UWHwsNK61YUsmqi5C";

  const map = new maplibregl.Map({
    container:'map',
    style: STYLE_URL,
    center:[33.8046,36.6002],   // lon,lat
    zoom:16,
    pitch:30,                   // 30Â° eÄŸim ðŸŽ¯
    bearing:0,                  // rotation
    antialias:true
  });

  map.addControl(new maplibregl.NavigationControl({visualizePitch:true}));
  map.addControl(new maplibregl.ScaleControl({unit:'metric'}));

  /* ====== 2) Indoor/Outdoor GeoJSON kaynaklarÄ± ====== */
  // Sizin indoor.json / outdoor.json dosyalarÄ±nÄ±zÄ± MapLibre'a source+layer olarak ekliyoruz.
  function addGeoJsonLayer(id, url, kind){
    fetch(url+'?v='+(Date.now())).then(r=>r.json()).then(gj=>{
      // kaynak
      if(map.getSource(id)) map.removeSource(id);
      map.addSource(id,{type:'geojson', data: gj});
      // polygon
      map.addLayer({
        id:`${id}-poly`, source:id, type:'fill',
        filter:['==',['geometry-type'],'Polygon'],
        paint:{'fill-color':'#2563eb','fill-opacity':0.12}
      });
      map.addLayer({
        id:`${id}-poly-outline`, source:id, type:'line',
        filter:['==',['geometry-type'],'Polygon'],
        paint:{'line-color':'#2563eb','line-width':2}
      });
      // line
      map.addLayer({
        id:`${id}-line`, source:id, type:'line',
        filter:['==',['geometry-type'],'LineString'],
        paint:{'line-color':'#2563eb','line-width':2}
      });
      // point
      map.addLayer({
        id:`${id}-pt`, source:id, type:'circle',
        filter:['==',['geometry-type'],'Point'],
        paint:{
          'circle-radius':7,
          'circle-color':'#f94144',
          'circle-stroke-color':'#fff',
          'circle-stroke-width':2
        }
      });

      // popup (temel)
      const popup = new maplibregl.Popup({closeButton:true, className:'popup'});
      ['-pt','-poly'].forEach(suffix=>{
        map.on('click', `${id}${suffix}`, (e)=>{
          const f=e.features[0]; const p=f.properties||{};
          const L=t();
          const cat=(p.category||'').toLowerCase(); const label=(L.cats?.[cat]||p.category||'');
          const name=p[`name_${LANG}`]||p.name||'';
          const hours=p[`hours_${LANG}`]||p.hours||''; const level=p[`level_${LANG}`]||p.level||'';
          popup.setLngLat(e.lngLat).setHTML(`
            <div><b>${name}</b></div>
            ${label?`<div class="badge">${label}</div>`:''}
            ${hours?`<div><small>${L.labels.hours}:</small> ${hours}</div>`:''}
            ${level?`<div><small>${L.labels.level}:</small> ${level}</div>`:''}
          `).addTo(map);
        });
        map.on('mouseenter', `${id}${suffix}`, ()=> map.getCanvas().style.cursor='pointer');
        map.on('mouseleave', `${id}${suffix}`, ()=> map.getCanvas().style.cursor='');
      });

      // extent'e oturt (ilk yÃ¼klemede)
      if(gj.features?.length){
        const bbox = turf.bbox(gj); // turf ile bbox (aÅŸaÄŸÄ±da mini turf cdn'i ekleyeceÄŸiz)
        map.fitBounds([[bbox[0],bbox[1]],[bbox[2],bbox[3]]],{padding:{top:140,right:20,bottom:160,left:20}, maxZoom:21});
      }
    }).catch(()=>{ /* yoksay */ });
  }

  // Turf (yalnÄ±zca bbox iÃ§in hafif import)
  const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js'; document.head.appendChild(s);

  map.on('load', ()=>{
    addGeoJsonLayer('indoor','indoor.json','indoor');
    addGeoJsonLayer('outdoor','outdoor.json','outdoor');
  });

  /* ====== 3) Katman toggles ====== */
  const $=id=>document.getElementById(id);
  $('tglIndoor').addEventListener('change',()=>toggleGroup('indoor', $('tglIndoor').checked));
  $('tglOutdoor').addEventListener('change',()=>toggleGroup('outdoor', $('tglOutdoor').checked));
  function toggleGroup(prefix, visible){
    ['-poly','-poly-outline','-line','-pt'].forEach(s=>{
      const id = prefix+s;
      if(map.getLayer(id)) map.setLayoutProperty(id,'visibility', visible?'visible':'none');
    });
  }

  /* ====== 4) Konum izleme + hedef seÃ§imi ====== */
  let follow=false, userMarker=null, destMarker=null, pickMode=false;

  $('follow').onclick=()=>{
    follow=!follow;
    $('follow').textContent = follow ? t().ui.followOn : t().ui.followOff;
  };
  $('pick').onclick=()=>{ pickMode=!pickMode; $('pick').classList.toggle('active',pickMode); };

  // kullanÄ±cÄ± konumunu sÃ¼rekli izle
  if('geolocation' in navigator){
    navigator.geolocation.watchPosition(pos=>{
      const lng=pos.coords.longitude, lat=pos.coords.latitude;
      if(!userMarker){
        userMarker = new maplibregl.Marker({color:'#1d4ed8'}).setLngLat([lng,lat]).addTo(map);
      }else userMarker.setLngLat([lng,lat]);
      $('acc').textContent = 'Â±'+Math.round(pos.coords.accuracy||0)+' m';
      $('acc').style.display='block';
      if(follow) map.easeTo({center:[lng,lat], duration:200});
    },()=>{}, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  }

  map.on('click', (e)=>{
    if(!pickMode) return;
    if(!destMarker) destMarker = new maplibregl.Marker({color:'#ef4444'}).addTo(map);
    destMarker.setLngLat(e.lngLat);
    $('go').disabled=false;
    pickMode=false; $('pick').classList.remove('active');
  });

  /* ====== 5) OSRM ile rota (foot) ====== */
  let routeId='route-line';
  $('go').onclick=()=> routeToDest();
  $('clearRoute').onclick=()=> clearRoute();
  function clearRoute(){
    if(map.getLayer(routeId)) map.removeLayer(routeId);
    if(map.getSource(routeId)) map.removeSource(routeId);
    $('dir').style.display='none';
    $('dirList').innerHTML=''; $('dirSum').textContent='â€“'; $('dirSub').textContent='';
  }

  function routeToDest(){
    if(!userMarker || !destMarker){ alert(LANG==='tr'?'Konum ve hedef gerekli.':'Need location and destination.'); return; }
    clearRoute();
    const a=userMarker.getLngLat(), b=destMarker.getLngLat();
    const url=`https://router.project-osrm.org/route/v1/foot/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson&steps=true`;
    fetch(url).then(r=>r.json()).then(d=>{
      const route=d?.routes?.[0]; if(!route) return drawBearing(a,b);
      map.addSource(routeId,{type:'geojson', data: {type:'Feature', geometry: route.geometry}});
      map.addLayer({id:routeId, source:routeId, type:'line', paint:{'line-color':'#16a34a','line-width':4}});
      const coords=route.geometry.coordinates; const bounds=new maplibregl.LngLatBounds(coords[0],coords[0]); coords.forEach(c=>bounds.extend(c));
      map.fitBounds(bounds,{padding:{top:140,right:20,bottom:160,left:20}, maxZoom:18});
      $('dir').style.display='block';
      $('dirSum').textContent=(route.distance/1000).toFixed(2)+' km';
      $('dirSub').textContent='Â· '+Math.round(route.duration/60)+' dk';
      const L=t(); const steps=(route.legs?.[0]?.steps)||[]; const list=$('dirList'); list.innerHTML='';
      steps.forEach((s,i)=>{
        const man=s.maneuver||{}; const type=man.type||'', mod=man.modifier||''; const street=s.name||'';
        const onto= street ? (L.nav.onto||'').replace('%s',street) : '';
        let txt=L.nav.straight||'';
        if(type==='depart') txt=L.nav.depart+onto;
        else if(type==='arrive') txt=L.nav.arrive;
        else if(type==='turn'){ if(mod==='left') txt=L.nav.turn_left+onto; else if(mod==='right') txt=L.nav.turn_right+onto; else txt=(L.nav.straight||'')+onto;}
        else if(type==='roundabout'){ const ex=man.exit||1; txt=(L.nav.roundabout||'').replace('%n',ex)+onto; }
        const dist = s.distance>=1000 ? (s.distance/1000).toFixed(2)+' km' : Math.round(s.distance)+' m';
        const el=document.createElement('div'); el.className='step'; el.innerHTML=`<div>${i+1}.</div><div><div>${txt}</div><div class="muted" style="font-size:12px">${dist}</div></div>`;
        list.appendChild(el);
      });
    }).catch(()=> drawBearing(a,b));
  }

  function drawBearing(a,b){
    // basit bearing Ã§izgisi (OSRM yoksa)
    const gj={type:'Feature', geometry:{type:'LineString', coordinates:[[a.lng,a.lat],[b.lng,b.lat]]}};
    map.addSource(routeId,{type:'geojson', data:gj});
    map.addLayer({id:routeId, source:routeId, type:'line', paint:{'line-color':'#16a34a','line-width':4}});
    const bounds=new maplibregl.LngLatBounds([a.lng,a.lat],[b.lng,b.lat]);
    map.fitBounds(bounds,{padding:{top:140,right:20,bottom:160,left:20}, maxZoom:19});
    $('dir').style.display='block'; $('dirSum').textContent='';
  }

  /* ====== 6) Dil / Reset ====== */
  $('lang').value=LANG;
  $('lang').addEventListener('change',()=>{ LANG=$('lang').value; localStorage.setItem('lang',LANG); });

  $('reset').onclick=()=>{
    clearRoute();
    if(destMarker){ destMarker.remove(); destMarker=null; }
    $('q').value=''; $('go').disabled=true;
    addGeoJsonLayer('indoor','indoor.json','indoor');
    addGeoJsonLayer('outdoor','outdoor.json','outdoor');
  };

  // Detay toggle (sade): point dÄ±ÅŸÄ±ndakileri gizle/gÃ¶ster
  let showAll=false;
  $('toggleDetails').onclick=()=>{
    showAll=!showAll; $('toggleDetails').textContent = showAll? t().ui.detailsOn : t().ui.detailsOff;
    ['indoor','outdoor'].forEach(p=>{
      ['-poly','-poly-outline','-line'].forEach(s=>{
        if(map.getLayer(p+s)) map.setLayoutProperty(p+s,'visibility', showAll?'visible':'none');
      });
    });
  };
  </script>
</body>
</html>
