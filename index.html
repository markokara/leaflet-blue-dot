<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Long Beach ‚Äì Misafir Harita</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
  :root{
    --shadow:0 10px 28px rgba(0,0,0,.18);
    --muted:#5b6a6a; --bg:#fff; --brand:#0f5132; --border:#cfe3da; --field:#f4fbf7; --chip:#e6f4ef;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eaf4f0}
  #map{position:fixed; inset:0}
  /* OSM √ºstte yarƒ± saydam: */
  #osmOverlay{position:fixed; inset:0; pointer-events:none; z-index:5; mix-blend-mode:normal; opacity:var(--osm, .45)}

  .lang-float{position:fixed; left:12px; top:12px; z-index:1002; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:6px 8px}
  .lang-float select{border:1px solid var(--border); background:var(--field); border-radius:10px; padding:6px 8px}

  .panel{position:fixed; left:50%; bottom:0; transform:translate(-50%,var(--ty,0px)); transition:transform .2s; width:min(860px,96vw); z-index:1001}
  .card{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
  .p-8{padding:10px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:10px}
  .grow{flex:1 1 auto}
  .grab{width:56px; height:6px; background:#9fd3b3; border-radius:999px; margin:8px auto 0; box-shadow:inset 0 0 0 1px #83c7a1; cursor:grab; touch-action:none}
  input[type="search"]{width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field)}
  button{padding:9px 11px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:var(--field); white-space:nowrap}
  button:active{transform:translateY(1px)}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--chip); font-size:13px}
  .chip input{accent-color:#1b7a5b}
  .chip .tick{opacity:.18; transition:.15s}
  .chip input:checked ~ .tick{opacity:1}
  .results{background:#fff; border:1px solid var(--border); border-radius:12px; max-height:36vh; overflow:auto; position:relative; z-index:2005; display:none}
  .results .item{display:flex; justify-content:space-between; gap:8px; padding:10px 12px; cursor:pointer}
  .results .item:hover{background:#f1f7f4}
  .results .hint{padding:8px 12px; color:var(--muted); font-size:12px}
  .dir{display:none; background:#fff; border:1px solid var(--border); border-radius:12px}
  .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5efe9}
  .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
  .badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#edf7f3; border:1px solid var(--border); font-size:12px}
  .acc{position:fixed; right:12px; bottom:12px; z-index:1001; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
  @media (max-width:520px){ .panel{bottom:8px} }
  .row.searchrow{display:grid; grid-template-columns:1fr auto; gap:8px}
  .muted{color:var(--muted)}
</style>
</head>
<body>

<!-- Dil -->
<div class="lang-float">
  <select id="lang" aria-label="Dil">
    <option value="tr" selected>TR</option><option value="en">EN</option>
    <option value="ru">RU</option><option value="de">DE</option><option value="pl">PL</option>
  </select>
</div>

<div id="map" aria-label="Harita"></div>
<!-- OSM √ºst katman -->
<iframe id="osmOverlay" title="OSM overlay" loading="eager"
  srcdoc='<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"><style>html,body,#m{height:100%;margin:0}</style></head><body><div id="m"></div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script><script>var m=L.map("m",{zoomControl:false,attributionControl:false,keyboard:false,scrollWheelZoom:false,dragging:false,boxZoom:false,doubleClickZoom:false,touchZoom:false});var t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:20});t.addTo(m);window.addEventListener("message",e=>{if(e.data&&e.data.type==="sync"){m.setView([e.data.lat,e.data.lon],e.data.z);}});<\/script></body></html>'>
</iframe>

<!-- Bottom sheet -->
<div class="panel" id="sheet">
  <div class="card">
    <div class="grab" id="grab"></div>
    <div class="p-8 stack" id="sheetContent">

      <div class="row searchrow">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz‚Ä¶"/>
        <button id="go" title="Se√ßili hedefe rota" disabled>Git</button>
      </div>

      <div class="row">
        <button id="pickStart">Ba≈ülangƒ±√ß Se√ß</button>
        <button id="pick">Hedef Se√ß</button>
        <button id="follow">üìç Konumum: Kapalƒ±</button>
        <button id="reset">Sƒ±fƒ±rla</button>
        <span class="grow"></span>
        <label class="chip" title="Satellite (raster)">
          <input type="radio" name="basemap" id="baseSat" checked><span>Satellite</span><span class="tick">‚úì</span>
        </label>
        <label class="chip" title="MapLibre 3D (terrain + binalar)">
          <input type="radio" name="basemap" id="base3d"><span>MapLibre 3D</span><span class="tick">‚úì</span>
        </label>
      </div>

      <div id="results" class="results"></div>

      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">‚Äì</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">‚ñ≤</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>

      <div class="muted" style="font-size:11px; text-align:right">¬© aihotelstech ¬∑ ¬© OpenStreetMap contributors ¬∑ ¬© MapTiler ¬∑ ¬© Mapbox</div>
    </div>
  </div>
</div>

<div id="acc" class="acc" style="display:none"></div>

<script>
/* ================== ANAHTARLAR ================== */
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";
const MAPTILER_KEY = "ym4UWHwsNK61YUsmqi5C";

/* ================== AYARLAR ================== */
const HOTEL_BBOX = [31.801445, 36.597411, 31.808467, 36.600917];
const PADDING = {top:120,right:16,bottom:160,left:16};
const DEFAULT_PITCH = 45, DEFAULT_BEARING = 0;
// OSM √ºst katman opaklƒ±ƒüƒ± (0‚Äì1)
const OSM_OPACITY = 0.45; document.documentElement.style.setProperty('--osm', OSM_OPACITY);

/* ================== i18n (kƒ±saltƒ±lmƒ±≈ü) ================== */
const I18N = {
  tr:{searchPH:"Ara: restoran, spa, havuz‚Ä¶", go:"Git",
      ui:{pickStart:"Ba≈ülangƒ±√ß Se√ß", pick:"Hedef Se√ß", followOn:"üìç Konumum: A√ßƒ±k", followOff:"üìç Konumum: Kapalƒ±", reset:"Sƒ±fƒ±rla", clearRoute:"Rota Temizle"},
      labels:{name:"ƒ∞sim", category:"T√ºr", hours:"Saat", level:"Kat", desc:"A√ßƒ±klama"},
      cats:{pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"D√ºkkan", toilet:"WC", reception:"Resepsiyon", beach:"Plaj", kidsclub:"√áocuk Kul√ºb√º", elevator:"Asans√∂r", gate:"Kapƒ±", parking:"Otopark", shuttle:"Servis", gym:"Spor Salonu"},
      nav:{depart:"Ba≈üla", arrive:"Varƒ±≈ü", turn_left:"Sola d√∂n", turn_right:"Saƒüa d√∂n", straight:"D√ºz devam", roundabout:"G√∂bekte %n. √ßƒ±kƒ±≈ü", onto:" ‚Üí %s"}
  },
  en:{searchPH:"Search: restaurant, spa, pool‚Ä¶", go:"Go",
      ui:{pickStart:"Pick Start", pick:"Pick Destination", followOn:"üìç My Location: On", followOff:"üìç My Location: Off", reset:"Reset", clearRoute:"Clear Route"},
      labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description"},
      cats:{pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet", reception:"Reception", beach:"Beach", kidsclub:"Kids Club", elevator:"Elevator", gate:"Gate", parking:"Parking", shuttle:"Shuttle", gym:"Gym"},
      nav:{depart:"Depart", arrive:"Arrive", turn_left:"Turn left", turn_right:"Turn right", straight:"Go straight", roundabout:"At roundabout take exit %n", onto:" onto %s"}
  }
};
let LANG = localStorage.getItem("lang") || "tr";
const t = () => I18N[LANG] || I18N.tr;
const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'');

/* e≈üanlamlƒ±lar (kƒ±saltƒ±lmƒ±≈ü) */
const SYNONYMS = { pool:['havuz','pool','basen','–±–∞—Å—Å–µ–π–Ω','schwimmbad'], restaurant:['restoran','restaurant','restauracja','—Ä–µ—Å—Ç–æ—Ä–∞–Ω'], spa:['spa','wellness','—Å–ø–∞'], bar:['bar','–±–∞—Ä'], cafe:['cafe','kafe','–∫–∞—Ñ–µ'], shop:['shop','market','sklep','–º–∞–≥–∞–∑–∏–Ω'], toilet:['wc','toilet','tuvalet'], reception:['reception','resepsiyon','recepcja'], beach:['beach','plaj','pla≈ºa','–ø–ª—è–∂'], kidsclub:['kids club','kidsclub','miniclub','–¥–µ—Ç—Å–∫–∏–π'], elevator:['elevator','asans√∂r','–ª–∏—Ñ—Ç'], gate:['gate','kapƒ±','giri≈ü'], parking:['parking','otopark','parkplatz'], shuttle:['shuttle','servis','bus'], gym:['gym','fitness','spor'] };
const KEYWORD_TO_CAT = (()=>{const m={}; Object.entries(SYNONYMS).forEach(([k,a])=>a.forEach(w=>m[norm(w)]=k)); return m;})();

/* ================== MAP ================== */
const baseStyle = {version:8, glyphs:`https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${MAPTILER_KEY}`, sources:{}, layers:[{id:"bg",type:"background",paint:{"background-color":"#dfe7e7"}}]};
const map = new maplibregl.Map({ container:'map', style:baseStyle, center:[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2], zoom:16, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEARING, maxZoom:21, attributionControl:false, hash:false });
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), 'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'¬© aihotelstech'}));

/* DOM */
const $=id=>document.getElementById(id);
const langSel=$('lang'), q=$('q'), goBtn=$('go'), pickBtn=$('pick'), pickStartBtn=$('pickStart'), followBtn=$('follow'), resetBtn=$('reset'), results=$('results'), acc=$('acc');
const dirBox=$('dir'), dirSum=$('dirSum'), dirSub=$('dirSub'), dirList=$('dirList'), collapseDir=$('collapseDir'), clearRouteBtn=$('clearRoute');
const baseSat=$('baseSat'), base3d=$('base3d');

/* State */
let allFeats=[], searchActive=false, searchIds=[], followState=false, lastKnown=null;
let routesFC={type:'FeatureCollection',features:[]}; // ham yollar
let graph=null; // topoloji
let startLL=null, destLL=null;

/* Helpers */
function emptyFC(){return {type:'FeatureCollection',features:[]};}
function linkify(text){ return (text||'').replace(/(https?:\/\/[^\s<>"']+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); }
function nameInAnyLang(p){ return p['name_'+LANG] || p.name || p.name_tr || p.name_en || p.name_ru || p.name_de || p.name_pl || ''; }

/* SAFE JSON loader (bo≈ü/bozuk dosya yakalar) */
async function loadJSONSafe(url){
  try{
    const r = await fetch(url,{cache:'no-store'});
    if(!r.ok) return emptyFC();
    const txt = await r.text();
    if(!txt || !txt.trim()) return emptyFC();
    return JSON.parse(txt);
  }catch(e){ console.warn(url,'y√ºklenemedi:',e); return emptyFC(); }
}

/* LOAD */
map.on('load', async ()=>{
  // Satellite tabanƒ± (raster)
  map.addSource('sat',{ type:'raster',
    tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`],
    tileSize:256, attribution:"¬© Mapbox ¬© OSM"
  });
  map.addLayer({id:'sat-lyr', type:'raster', source:'sat'});

  // 3D kaynaklarƒ± (ba≈üta kapalƒ±)
  map.addSource('omt',{ type:'vector', url:`https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}` });
  map.addSource('dem',{ type:'raster-dem', url:`https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key=${MAPTILER_KEY}`, tileSize:256 });

  map.addLayer({ id:'bldg-3d', type:'fill-extrusion', source:'omt', 'source-layer':'building', layout:{visibility:'none'},
    paint:{
      'fill-extrusion-color':'#b9c9d6','fill-extrusion-opacity':0.85,
      'fill-extrusion-height':['coalesce', ['to-number',['get','render_height']], ['to-number',['get','height']], 6],
      'fill-extrusion-base'  :['coalesce', ['to-number',['get','render_min_height']], ['to-number',['get','min_height']], 0]
    }, minzoom:14
  });

  // POI/√ßizimler
  map.addSource('indoor',{type:'geojson', data:emptyFC(), promoteId:'fid'});
  map.addSource('outdoor',{type:'geojson', data:emptyFC(), promoteId:'fid'});
  map.addSource('routes',{type:'geojson', data:emptyFC(), promoteId:'fid'}); // <- y√∂netimden gelen yollar

  // indoor/outdoor stilleri
  addFeatureLayers('indoor'); addFeatureLayers('outdoor');

  // routes (√∂zellik rengi/kalƒ±nlƒ±ƒüƒ± ile)
  map.addLayer({id:'routes-line',type:'line',source:'routes',
    paint:{
      'line-color':['coalesce',['get','stroke'],'#22c55e'],
      'line-opacity':['coalesce',['get','stroke_op'],0.95],
      'line-width':['coalesce',['get','width'],3]
    }, filter:['==',['geometry-type'],'LineString']
  });

  // hedef/ba≈ülangƒ±√ß/rota ve oklar
  map.addSource('start',{type:'geojson',data:emptyFC()});
  map.addSource('dest',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'start-pt',type:'circle',source:'start',paint:{'circle-radius':6,'circle-color':'#16a34a','circle-stroke-color':'#fff','circle-stroke-width':1.6}});
  map.addLayer({id:'dest-pt',type:'circle',source:'dest',paint:{'circle-radius':6,'circle-color':'#ef4444','circle-stroke-color':'#fff','circle-stroke-width':1.6}});

  map.addSource('routeLine',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'route-line',type:'line',source:'routeLine',paint:{'line-color':['coalesce',['get','stroke'],'#1b7a5b'],'line-width':['coalesce',['get','width'],4]}});

  // yol oklarƒ± (metin ‚Äì √º√ßgen)
  map.addSource('routeArrows',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'route-arrows',type:'symbol',source:'routeArrows',
    layout:{'symbol-placement':'line','text-field':'‚ñ∂','text-size':14,'text-keep-upright':true,'text-offset':[0,0]},
    paint:{'text-color':['coalesce',['get','stroke'],'#1b7a5b'],'text-opacity':0.9}
  });

  // konum
  map.addSource('me',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'me-pt',type:'circle',source:'me',paint:{'circle-radius':6,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1.6}});

  await loadJSONs();
  applyLang();
  applyBasemap(); // Satellite varsayƒ±lan
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING});

  // panel default A√áIK
  requestAnimationFrame(()=>{ setSheet(0); });
});

/* i√ß/dƒ±≈ü POI √ßizim katmanlarƒ± */
function addFeatureLayers(src){
  map.addLayer({id:`${src}-fill`,type:'fill',source:src,paint:{'fill-color':['coalesce',['get','fill'],'#2563eb'],'fill-opacity':['coalesce',['get','fill_op'],0.35]}});
  map.addLayer({id:`${src}-fill-outline`,type:'line',source:src,filter:['==',['geometry-type'],'Polygon'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','width'],1.8]}});
  map.addLayer({id:`${src}-line`,type:'line',source:src,filter:['==',['geometry-type'],'LineString'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','width'],2.5]}});
  map.addLayer({id:`${src}-pts`,type:'circle',source:src,filter:['==',['geometry-type'],'Point'],paint:{'circle-radius':['coalesce',['get','icon_sz'],6],'circle-color':['coalesce',['get','stroke'],'#e53935'],'circle-stroke-color':'#fff','circle-stroke-width':1.6}});
}

/* JSON‚Äôlarƒ± y√ºkle */
async function loadJSONs(){
  const bust='v='+Date.now();
  const [indoor,outdoor,routes] = await Promise.all([
    loadJSONSafe('indoor.json?'+bust),
    loadJSONSafe('outdoor.json?'+bust),
    loadJSONSafe('routes.json?'+bust)
  ]);
  map.getSource('indoor').setData(indoor);
  map.getSource('outdoor').setData(outdoor);
  map.getSource('routes').setData(routes);
  allFeats = indoor.features.map(f=>({...f,__src:'indoor'})).concat(outdoor.features.map(f=>({...f,__src:'outdoor'})));
  routesFC = routes;
  graph = buildGraph(routesFC.features.filter(f=>f.geometry && f.geometry.type==='LineString'));
}

/* ================== BASMAP TOGGLE (2 se√ßenek) ================== */
baseSat.addEventListener('change', applyBasemap);
base3d.addEventListener('change', applyBasemap);

function applyBasemap(){
  if(base3d.checked){
    map.setLayoutProperty('bldg-3d','visibility','visible');
    map.setTerrain({source:'dem', exaggeration:1});
    if(!map.getLayer('sky')){
      map.addLayer({ id:'sky', type:'sky', paint:{'sky-type':'atmosphere','sky-atmosphere-sun':[0,45],'sky-atmosphere-sun-intensity':10} });
    }
  }else{
    if(map.getLayer('sky')) map.removeLayer('sky');
    map.setTerrain(null);
    map.setLayoutProperty('bldg-3d','visibility','none');
  }
}

/* ================== Dƒ∞L ================== */
function applyLang(){
  const L=t(); $('q').placeholder=L.searchPH; $('go').textContent=L.go;
  $('pick').textContent=L.ui.pick; $('pickStart').textContent=L.ui.pickStart; $('reset').textContent=L.ui.reset;
  followBtn.textContent = followState ? L.ui.followOn : L.ui.followOff;
  clearRouteBtn.textContent=L.ui.clearRoute; localStorage.setItem('lang',LANG);
}
langSel.value=LANG; langSel.addEventListener('change',()=>{LANG=langSel.value; applyLang();});

/* ================== ARAMA ================== */
function detectCategory(qs){
  const nq=norm(qs), dict=I18N[LANG]?.cats||{};
  for(const [k,label] of Object.entries(dict)){ if(norm(label).includes(nq)||nq.includes(norm(label))) return k; }
  return KEYWORD_TO_CAT[nq] || null;
}
q.addEventListener('input', ()=>{
  const val=(q.value||'').trim();
  if(!val){ results.style.display='none'; searchActive=false; searchIds=[]; return; }
  const qn=norm(val), maybeCat=detectCategory(val);
  const hits = allFeats.filter(f=>{
    const p=f.properties||{}; const cat=(p.category||'').toLowerCase();
    if(maybeCat && cat===maybeCat) return true;
    const names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
    if(names.some(n=>n.includes(qn))) return true;
    const ex=[p.desc,p['desc_'+LANG],p.level,p['level_'+LANG],p.hours,p['hours_'+LANG]].filter(Boolean).map(norm);
    return ex.some(d=>d.includes(qn));
  });
  renderResults(hits, maybeCat);
});

/* sonu√ß listesi ‚Äì hem fare hem dokunma */
function renderResults(list, cat){
  results.innerHTML='';
  const hint=document.createElement('div'); hint.className='hint'; hint.textContent='üîé Sonu√ßlardan birine dokun';
  results.appendChild(hint);

  if(cat){
    const feats=allFeats.filter(f=>(f.properties?.category||'').toLowerCase()===cat);
    const div=document.createElement('div'); div.className='item'; div.dataset.fid='__cat__'+cat;
    div.innerHTML=`<span>‚û§ ${(t().cats?.[cat]||cat)}</span> <small>${feats.length}</small>`;
    results.appendChild(div);
  }
  list.slice(0,80).forEach(f=>{
    const p=f.properties||{}; const meta=[f.__src==='indoor'?'Indoor':'Outdoor', p.category||'', p.level||''].filter(Boolean).join(' ¬∑ ');
    const div=document.createElement('div'); div.className='item'; div.dataset.fid=p.fid; div.dataset.src=f.__src;
    div.innerHTML=`<span>${nameInAnyLang(p)||'(isimsiz)'}</span><small>${meta}</small>`;
    results.appendChild(div);
  });
  results.style.display='block';
}
function resultActivate(item){
  const fid=item.dataset.fid;
  if(fid && fid.startsWith('__cat__')){
    const cat=fid.replace('__cat__','');
    const ids=allFeats.filter(f=>(f.properties?.category||'').toLowerCase()===cat).map(f=>f.properties?.fid);
    searchIds=ids; searchActive=true; results.style.display='none'; return;
  }
  const src=item.dataset.src;
  const f=allFeats.find(x=>x.properties?.fid===fid);
  if(!f) return;
  searchIds=[fid]; searchActive=true; focusFeature(f,true); setDestination(coordOfFeature(f));
  results.style.display='none'; goBtn.disabled=false;
}
results.addEventListener('click',e=>{const it=e.target.closest('.item'); if(it) resultActivate(it);});
results.addEventListener('touchstart',e=>{const it=e.target.closest('.item'); if(it){ e.preventDefault(); resultActivate(it); }}, {passive:false});

/* ================== KONUM ================== */
if('geolocation' in navigator){
  try{ navigator.geolocation.getCurrentPosition(()=>{},()=>{}, {enableHighAccuracy:true, timeout:10000}); }catch{}
  navigator.geolocation.watchPosition(p=>{
    const accM=Math.round(p.coords.accuracy||999);
    lastKnown=[p.coords.longitude,p.coords.latitude];
    map.getSource('me').setData({type:'FeatureCollection',features:[{type:'Feature',properties:{acc:accM},geometry:{type:'Point',coordinates:lastKnown}}]});
    acc.textContent="¬±"+accM+" m"; acc.style.display='block';
    if(followState) map.easeTo({center:lastKnown, duration:250});
    // OSM √ºst katmanƒ± ile senkron
    syncOSMOverlay();
  }, console.warn, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
}
followBtn.onclick=()=>{ followState=!followState; followBtn.textContent = followState ? t().ui.followOn : t().ui.followOff; if(followState && lastKnown) map.easeTo({center:lastKnown}); };

/* ================== BA≈ûLANGI√á/HEDEF ================== */
let pickMode=null; // 'start' | 'dest'
pickBtn.onclick = ()=>{ pickMode = (pickMode==='dest'? null : 'dest'); pickBtn.classList.toggle('active', pickMode==='dest'); };
pickStartBtn.onclick = ()=>{ pickMode = (pickMode==='start'? null : 'start'); pickStartBtn.classList.toggle('active', pickMode==='start'); };

map.on('click', e=>{
  if(!pickMode){
    // POI popup
    const feats = map.queryRenderedFeatures(e.point, {layers:['indoor-pts','outdoor-pts','indoor-fill','outdoor-fill','indoor-line','outdoor-line','indoor-fill-outline','outdoor-fill-outline']});
    if(feats && feats[0]) showPopup(feats[0], e.lngLat); return;
  }
  const xy=[e.lngLat.lng,e.lngLat.lat];
  if(pickMode==='start'){ setStart(xy); }
  if(pickMode==='dest'){ setDestination(xy); goBtn.disabled=false; }
  pickMode=null; pickBtn.classList.remove('active'); pickStartBtn.classList.remove('active');
});

function setStart(xy){ startLL=xy; map.getSource('start').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]}); }
function setDestination(xy){ destLL=xy; map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]}); }
function clearStart(){ startLL=null; map.getSource('start').setData(emptyFC()); }
function clearDestination(){ destLL=null; map.getSource('dest').setData(emptyFC()); }
function clearRoute(){ map.getSource('routeLine').setData(emptyFC()); map.getSource('routeArrows').setData(emptyFC()); dirBox.style.display='none'; dirList.innerHTML=''; dirSum.textContent='‚Äì'; dirSub.textContent=''; }

goBtn.onclick = async ()=>{
  const a = startLL || lastKnown;
  const b = destLL;
  if(!a){ alert(LANG==='tr'?'Ba≈ülangƒ±√ß gerekli (konum izni verin ya da haritadan se√ßin).':'Need a start point.'); return; }
  if(!b){ alert(LANG==='tr'?'Hedef se√ßilmedi.':'No destination.'); return; }
  if(!graph){ alert('routes.json yok ya da bo≈ü'); return; }

  // Ba≈ülangƒ±√ß & hedefi √ßizgiye snap et, en kƒ±sa yolu hesapla
  const route = routeAlongGraph(graph, a, b);
  if(route && route.coordinates && route.coordinates.length>1){
    const feat={type:'Feature', properties: route.style || {}, geometry:{type:'LineString', coordinates: route.coordinates}};
    map.getSource('routeLine').setData({type:'FeatureCollection',features:[feat]});
    map.getSource('routeArrows').setData({type:'FeatureCollection',features:[{type:'Feature',properties: route.style || {}, geometry:{type:'LineString',coordinates: route.coordinates}}]});
    // Mesafe & s√ºre tahmini
    const distM = lengthOf(route.coordinates);
    dirSum.textContent=(distM/1000).toFixed(2)+" km";
    dirSub.textContent='¬∑ routes.json';
    dirList.innerHTML='';
    const step = document.createElement('div'); step.innerHTML = `<div>1.</div><div><div>${t().nav.straight}</div><div class="muted" style="font-size:12px">${fmtDist(distM)}</div></div>`;
    dirList.appendChild(step);
    dirBox.style.display='block';

    const ex=bboxFromCoords(route.coordinates);
    if(ex) map.fitBounds([[ex[0],ex[1]],[ex[2],ex[3]]],{padding:PADDING,maxZoom:19});
    return;
  }
  alert('Se√ßili yol aƒüƒ± √ºzerinde baƒülantƒ± bulunamadƒ±.');
};

clearRouteBtn.onclick=()=>clearRoute();
collapseDir.onclick=()=>{ const s=getComputedStyle(dirList).display; dirList.style.display= s==='none' ? 'block':'none'; collapseDir.textContent = s==='none' ? '‚ñ≤':'‚ñº'; };
resetBtn.onclick=()=>{ closePopup(); clearRoute(); clearDestination(); clearStart(); q.value=''; results.style.display='none'; pickMode=null; pickBtn.classList.remove('active'); pickStartBtn.classList.remove('active'); map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING}); };

/* Bottom sheet ‚Äì s√ºr√ºkle */
(function(){
  const sheet=$('sheet'), grab=$('grab'); const H=24; let sy=null, st=0, mt=0;
  const set=v=> sheet.style.setProperty('--ty',v+'px');
  const get=()=> parseFloat(getComputedStyle(sheet).getPropertyValue('--ty'))||0;
  const calc=()=>{ const h=sheet.getBoundingClientRect().height||320; const byH=Math.max(0,h-(H+8)); const byV=Math.min(window.innerHeight*0.6,520); return Math.min(byH,byV); };
  function recalc(){ mt=calc(); set(Math.min(get(),mt)); }
  window.addEventListener('resize',recalc);
  function setDefaultOpen(){ mt=calc(); set(0); } // varsayƒ±lan a√ßƒ±k

  function start(e){ sy=e.clientY||e.touches?.[0]?.clientY; st=get(); grab.setPointerCapture?.(e.pointerId); }
  function move(e){ const y=e.clientY||e.touches?.[0]?.clientY; if(sy==null||y==null)return; const dy=y-sy; set(Math.max(0,Math.min(mt,st+dy))); }
  function end(){ if(sy==null)return; const ty=get(); set(ty>mt*0.5?mt:0); sy=null; }

  grab.addEventListener('pointerdown',start); grab.addEventListener('pointermove',move); grab.addEventListener('pointerup',end); grab.addEventListener('pointercancel',end);
  grab.addEventListener('touchstart',start,{passive:true}); grab.addEventListener('touchmove',move,{passive:false}); grab.addEventListener('touchend',end);

  window.setSheet=set; window.setSheetDefault=setDefaultOpen;
  requestAnimationFrame(()=>{ recalc(); setDefaultOpen(); });
})();

/* Popup */
let popup;
function showPopup(f,lngLat){
  const p=f.properties||{}, L=t();
  const name = p['name_'+LANG] || p.name || '';
  const catKey=(p.category||'').toLowerCase(); const catLabel=L.cats[catKey] || p.category || '';
  const hours = p['hours_'+LANG] || p.hours || ''; const level=p['level_'+LANG]||p.level||''; const desc=p['desc_'+LANG]||p.desc||''; const img=p['image_'+LANG]||p.image||'';
  const html = `<div style="min-width:220px">
      <div style="font-weight:600;margin-bottom:6px;color:#0f5132">${name}</div>
      ${catLabel?`<div class="badge">${catLabel}</div>`:''}
      ${hours?`<div style="margin-top:6px"><small>${L.labels.hours}:</small> ${hours}</div>`:''}
      ${level?`<div><small>${L.labels.level}:</small> ${level}</div>`:''}
      ${desc?`<div style="margin-top:6px" class="muted">${linkify(desc)}</div>`:''}
      ${/^https?:\/\//i.test(img)?`<div style="margin-top:6px"><img src="${img}" style="width:100%;max-height:140px;object-fit:cover;border-radius:8px"></div>`:''}
      <div style="margin-top:8px"><button id="goHereBtn">Git ‚Üí</button></div>
    </div>`;
  (popup||(popup=new maplibregl.Popup({closeButton:true, closeOnClick:true}))).setLngLat(lngLat).setHTML(html).addTo(map);
  setTimeout(()=>{ const btn=document.getElementById('goHereBtn'); if(btn){ btn.onclick=()=>{ setDestination([lngLat.lng,lngLat.lat]); goBtn.disabled=false; popup.remove(); }; } },0);
}
function closePopup(){ if(popup) popup.remove(); }

function coordOfFeature(f){
  const g=f.geometry; if(!g) return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
  if(g.type==='Point') return g.coordinates;
  if(g.type==='Polygon'){ const ring=g.coordinates[0]; return ring[Math.floor(ring.length/2)]; }
  if(g.type==='LineString'){ const c=g.coordinates; return c[Math.floor(c.length/2)]; }
  return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
}
function focusFeature(f,open){
  const ex=bboxFromGeom(f.geometry);
  if(ex) map.fitBounds([[ex[0],ex[1]],[ex[2],ex[3]]],{padding:PADDING,maxZoom:18});
  if(open) showPopup(f, {lng:coordOfFeature(f)[0], lat:coordOfFeature(f)[1]});
}

/* k√º√ß√ºk yardƒ±mcƒ±lar */
function fmtDist(m){ return m>=1000 ? (m/1000).toFixed(2)+' km' : Math.round(m)+' m'; }
function bboxFromGeom(g){ try{ const coords=g.type==='Polygon'?g.coordinates.flat(1):g.type==='MultiPolygon'?g.coordinates.flat(2):g.type==='LineString'?g.coordinates:g.type==='Point'?[g.coordinates]:[]; let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; coords.forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; }); return (isFinite(minX)&&isFinite(minY)&&isFinite(maxX)&&isFinite(maxY))?[minX,minY,maxX,maxY]:null; }catch{return null;} }
function bboxFromCoords(coords){ let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; coords.forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; }); return (isFinite(minX)&&isFinite(minY)&&isFinite(maxX)&&isFinite(maxY))?[minX,minY,maxX,maxY]:null; }
function lengthOf(coords){ let d=0; for(let i=1;i<coords.length;i++){ d+=haversine(coords[i-1], coords[i]); } return d; }
function haversine(a,b){ const R=6371000; const toRad=x=>x*Math.PI/180; const dLat=toRad(b[1]-a[1]), dLon=toRad(b[0]-a[0]); const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2); const c=2*Math.asin(Math.sqrt(s1*s1+Math.cos(toRad(a[1]))*Math.cos(toRad(b[1]))*s2*s2)); return R*c; }

/* ===== OSM overlay senkron ===== */
function syncOSMOverlay(){
  const v = map.getCenter(); const z = map.getZoom();
  const fr = document.getElementById('osmOverlay').contentWindow;
  if(fr) fr.postMessage({type:'sync', lon:v.lng, lat:v.lat, z:Math.round(z)}, '*');
}
map.on('move', syncOSMOverlay);

/* ===== routes.json -> grafik ve routing ===== */

/* graf d√ºƒü√ºmleri: her LineString segmenti i√ßin u√ßlar; yakƒ±n noktalarƒ± birle≈ütirir */
function buildGraph(lines){
  const nodes=[]; const edges=[];
  const snapTol=1e-6; // ~ < 0.1 m
  function key(pt){ return pt[0].toFixed(6)+','+pt[1].toFixed(6); }
  const nodeIndex=new Map();
  function addNode(pt){ const k=key(pt); if(nodeIndex.has(k)) return nodeIndex.get(k); const i=nodes.length; nodes.push(pt); nodeIndex.set(k,i); return i; }

  lines.forEach(f=>{
    const coords=f.geometry.coordinates;
    for(let i=1;i<coords.length;i++){
      const a=coords[i-1], b=coords[i];
      const ia=addNode(a), ib=addNode(b);
      const w=haversine(a,b);
      const style={stroke:(f.properties&&f.properties.stroke)||'#1b7a5b', width:(f.properties&&f.properties.width)||4};
      edges.push({u:ia,v:ib,w,style}); edges.push({u:ib,v:ia,w,style});
    }
  });
  return {nodes,edges};
}

/* bir noktayƒ± en yakƒ±n segmente snap et */
function snapToGraph(g, pt){
  let best=null, bestD=Infinity, bestT=0;
  for(const e of g.edges){
    const a=g.nodes[e.u], b=g.nodes[e.v];
    const t = projectT(a,b,pt);
    const p = lerp(a,b,t);
    const d = haversine(p, pt);
    if(d<bestD){ best={edge:e, p, t}; bestD=d; }
  }
  return best; // {edge, p:[lng,lat], t in [0,1]}
}
function projectT(a,b,p){
  const ax=a[0], ay=a[1], bx=b[0], by=b[1], px=p[0], py=p[1];
  const vx=bx-ax, vy=by-ay; const wx=px-ax, wy=py-ay; const c1=vx*wx+vy*wy; const c2=vx*vx+vy*vy; if(c2<=0) return 0; let t=c1/c2; if(t<0)t=0; if(t>1)t=1; return t;
}
function lerp(a,b,t){ return [a[0]+(b[0]-a[0])*t, a[1]+(b[1]-a[1])*t]; }

/* A* en kƒ±sa yol (d√ºƒü√ºmler + eklenen snap noktalarƒ±) */
function routeAlongGraph(g, startLL, destLL){
  // snap start & dest
  const sSnap = snapToGraph(g,startLL), dSnap = snapToGraph(g,destLL);
  if(!sSnap||!dSnap) return null;
  // sanal d√ºƒü√ºmler ekle
  const sn = g.nodes.length, dn = sn+1;
  const nodes = g.nodes.slice(); nodes.push(sSnap.p, dSnap.p);
  const edges = g.edges.slice();
  edges.push({u:sn,v:sSnap.edge.u,w:haversine(sSnap.p,g.nodes[sSnap.edge.u]),style:sSnap.edge.style});
  edges.push({u:sn,v:sSnap.edge.v,w:haversine(sSnap.p,g.nodes[sSnap.edge.v]),style:sSnap.edge.style});
  edges.push({u:dn,v:dSnap.edge.u,w:haversine(dSnap.p,g.nodes[dSnap.edge.u]),style:dSnap.edge.style});
  edges.push({u:dn,v:dSnap.edge.v,w:haversine(dSnap.p,g.nodes[dSnap.edge.v]),style:dSnap.edge.style});

  // A*
  const N=nodes.length;
  const adj=new Array(N).fill(0).map(()=>[]);
  edges.forEach(e=>adj[e.u].push(e));
  const open=new Set([sn]);
  const gScore=new Array(N).fill(Infinity); gScore[sn]=0;
  const fScore=new Array(N).fill(Infinity); fScore[sn]=haversine(nodes[sn], nodes[dn]);
  const came=new Map();

  function lowest(){ let best=null, bestF=Infinity; open.forEach(i=>{ if(fScore[i]<bestF){best=i;bestF=fScore[i];} }); return best; }

  while(open.size){
    const cur=lowest();
    if(cur===dn) break;
    open.delete(cur);
    for(const e of adj[cur]){
      const tentative=gScore[cur]+e.w;
      if(tentative<gScore[e.v]){
        came.set(e.v,{u:cur,edge:e});
        gScore[e.v]=tentative;
        fScore[e.v]=tentative + haversine(nodes[e.v], nodes[dn]);
        open.add(e.v);
      }
    }
  }
  if(!came.has(dn)) return null;

  // geri izle ‚Üí koordinatlar
  const coords=[nodes[dn]];
  let cur=dn; let usedStyle=null;
  while(cur!==sn){
    const c=came.get(cur); if(!c) break;
    usedStyle = usedStyle || c.edge.style;
    coords.push(nodes[c.u]);
    cur=c.u;
  }
  coords.reverse();
  // ilk/sonu ger√ßek ba≈ülangƒ±√ß/hedefe uzat
  coords[0]=startLL; coords[coords.length-1]=destLL;
  // oklar i√ßin aynƒ± stil
  return {coordinates:coords, style:usedStyle};
}

/* ========== Yardƒ±mcƒ± g√∂rsellik/mesafe ========== */
function stepText(s){ return t().nav.straight; }
</script>
</body>
</html>
