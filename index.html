<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Long Beach ‚Äì Misafir Harita</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
  :root{ --shadow:0 10px 28px rgba(0,0,0,.18);
    --muted:#5b6a6a; --bg:#fff; --brand:#0f5132; --border:#cfe3da; --field:#f4fbf7; --chip:#e6f4ef;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eaf4f0}
  #map{position:fixed; inset:0}
  .lang-float{position:fixed; left:12px; top:12px; z-index:1002; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:6px 8px}
  .lang-float select{border:1px solid var(--border); background:var(--field); border-radius:10px; padding:6px 8px}
  .panel{position:fixed; left:50%; bottom:0; transform:translate(-50%,var(--ty,0px)); transition:transform .18s; width:min(860px,96vw); z-index:1001; -webkit-user-select:none; user-select:none}
  .card{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
  .p-8{padding:10px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:10px}
  .grow{flex:1 1 auto}
  .grab{width:56px; height:6px; background:#9fd3b3; border-radius:999px; margin:8px auto 0; box-shadow:inset 0 0 0 1px #83c7a1; cursor:grab}
  input[type="search"]{width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field)}
  button{padding:9px 11px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:var(--field); white-space:nowrap}
  button:active{transform:translateY(1px)}
  .results{background:#fff; border:1px solid var(--border); border-radius:12px; max-height:36vh; overflow:auto; position:relative; z-index:1003; display:none; pointer-events:auto}
  .results .item{display:flex; justify-content:space-between; gap:8px; padding:10px 12px; cursor:pointer}
  .results .item:hover{background:#f1f7f4}
  .dir{display:none; background:#fff; border:1px solid var(--border); border-radius:12px}
  .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5efe9}
  .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
  .badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#edf7f3; border:1px solid var(--border); font-size:12px}
  .acc{position:fixed; right:12px; bottom:12px; z-index:1001; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
  @media (max-width:520px){ .panel{bottom:8px} }
  .muted{color:var(--muted)}
</style>
</head>
<body>

<div class="lang-float">
  <select id="lang" aria-label="Dil">
    <option value="tr" selected>TR</option><option value="en">EN</option>
  </select>
</div>

<div id="map"></div>

<div class="panel" id="sheet">
  <div class="card">
    <div class="grab" id="grab"></div>
    <div class="p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz‚Ä¶"/>
        <button id="go" disabled>Git</button>
      </div>
      <div class="row">
        <button id="pick">Haritadan Hedef</button>
        <button id="follow">üìç Konumum: Kapalƒ±</button>
        <button id="reset">Sƒ±fƒ±rla</button>
      </div>
      <div id="results" class="results"></div>
      <div id="dir" class="dir">
        <div class="hdr">
          <div><span id="dirSum">‚Äì</span> <span class="muted" id="dirSub"></span></div>
          <div class="row"><button id="clearRoute">Rota Temizle</button></div>
        </div>
        <div class="list" id="dirList"></div>
      </div>
    </div>
  </div>
</div>

<div id="acc" class="acc" style="display:none"></div>

<script>
const HOTEL_BBOX=[31.801445,36.597411,31.808467,36.600917];
const PADDING={top:80,right:16,bottom:160,left:16};
const DEFAULT_PITCH=45,DEFAULT_BEARING=0;

function emptyFC(){return {type:'FeatureCollection',features:[]};}
function dist2d(a,b){const dx=a[0]-b[0],dy=a[1]-b[1];return dx*dx+dy*dy;}

/* MAP */
const map=new maplibregl.Map({
  container:'map',
  style:{version:8,sources:{},layers:[]},
  center:[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2],
  zoom:16,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING
});
map.addControl(new maplibregl.NavigationControl(),'top-right');

const $=id=>document.getElementById(id);
const goBtn=$('go'),pickBtn=$('pick'),followBtn=$('follow'),resetBtn=$('reset');
const dirBox=$('dir'),dirSum=$('dirSum'),dirList=$('dirList'),clearRouteBtn=$('clearRoute');

let lastKnown=null,followState=false,ROUTES=null;

map.on('load',async()=>{
  map.addSource('dest',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'dest-pt',type:'circle',source:'dest',paint:{'circle-radius':6,'circle-color':'red'}});

  map.addSource('route',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'route-line',type:'line',source:'route',paint:{'line-color':'#1b7a5b','line-width':4}});

  map.addSource('me',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'me-pt',type:'circle',source:'me',paint:{'circle-radius':6,'circle-color':'blue'}});

  ROUTES=await loadRoutes();
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING});
});

/* routes.json y√ºkle */
async function loadRoutes(){
  const gj=await fetch('routes.json?'+Date.now()).then(r=>r.json()).catch(()=>emptyFC());
  map.addSource('routes',{type:'geojson',data:gj});
  map.addLayer({id:'routes-line',type:'line',source:'routes',paint:{'line-color':'#aaa','line-width':2}});
  return gj;
}

/* hedef se√ßme */
let pickMode=false;
pickBtn.onclick=()=>{pickMode=!pickMode;pickBtn.classList.toggle('active',pickMode);};
map.on('click',e=>{
  if(pickMode){
    setDestination([e.lngLat.lng,e.lngLat.lat]);
    goBtn.disabled=false;pickMode=false;
  }
});
function setDestination(xy){
  map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]});
}

/* geolocation */
if('geolocation'in navigator){
  navigator.geolocation.watchPosition(p=>{
    lastKnown=[p.coords.longitude,p.coords.latitude];
    map.getSource('me').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:lastKnown}}]});
    if(followState)map.easeTo({center:lastKnown});
  });
}
followBtn.onclick=()=>{followState=!followState;};

/* rota temizle */
function clearRoute(){map.getSource('route').setData(emptyFC());dirBox.style.display='none';dirList.innerHTML='';}
clearRouteBtn.onclick=clearRoute;
resetBtn.onclick=()=>{clearRoute();map.getSource('dest').setData(emptyFC());};

/* basit rota hesaplama */
goBtn.onclick=()=>{
  if(!lastKnown){alert("Konum gerekli");return;}
  const destF=map.getSource('dest')._data.features[0];
  if(!destF){alert("Hedef se√ßilmedi");return;}
  const a=lastKnown,b=destF.geometry.coordinates;
  const start=nearestNode(a,ROUTES),end=nearestNode(b,ROUTES);
  const path=shortestPath(start,end);
  map.getSource('route').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:path}}]});
  dirSum.textContent=(path.length-1)+" adƒ±m";dirBox.style.display='block';
};

/* yardƒ±mcƒ±lar */
function nearestNode(pt,gj){
  let best=null,dist=Infinity;
  (gj.features||[]).forEach(f=>{
    if(f.geometry.type==='LineString'){
      f.geometry.coordinates.forEach(c=>{
        const d=dist2d(pt,c);
        if(d<dist){dist=d;best=c;}
      });
    }
  });
  return best;
}
function shortestPath(a,b){return [a,b];}
</script>
</body>
</html>
