<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Misafir – MapLibre (3D/Pitch/Rotation)</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
  :root{ --pad:14px; --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280 }
  html,body,#map{height:100%;margin:0}
  #panel{position:fixed;left:50%;bottom:10px;transform:translateX(-50%);z-index:10;
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:var(--shadow);
    width:min(820px,96vw);padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=search]{flex:1 1 auto;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  button,select{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#f8fafc;cursor:pointer}
  .results{margin-top:8px;display:none;max-height:34vh;overflow:auto;border:1px solid #e5e7eb;border-radius:10px}
  .item{display:flex;justify-content:space-between;padding:8px 10px;cursor:pointer}
  .item:hover{background:#f1f5f9}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>

<div id="map" aria-label="Harita"></div>

<div id="panel">
  <div class="row">
    <input id="q" type="search" placeholder="Ara: restoran, spa, havuz…"/>
    <button id="pick">Haritadan Hedef</button>
    <button id="go" disabled>Git</button>
    <select id="lang">
      <option value="tr" selected>TR</option><option value="en">EN</option>
      <option value="ru">RU</option><option value="de">DE</option><option value="pl">PL</option>
    </select>
  </div>
  <div id="results" class="results"></div>
  <div class="muted" style="text-align:right;margin-top:6px">© aihotelstech · © OpenStreetMap contributors · © MapTiler</div>
</div>

<script>
/* ====== Sabitler ====== */
// Otel BBOX (minLon,minLat,maxLon,maxLat) → değerleri kendi tesisine göre güncelle
const HOTEL_BBOX = [31.010, 36.857, 31.029, 36.871];
// İlk açılış için pitch ve bearing
const DEFAULT_PITCH = 45;   // 45° eğim
const DEFAULT_BEARING = 0;  // yatay rota (istersen değiştir)
const PADDING = {top:140, right:20, bottom:180, left:20};

const MAPTILER_KEY = "YOUR_MAPTILER_KEY"; // <— anahtarını koy

/* ====== MapLibre init (tek taban: MapTiler Streets) ====== */
const map = new maplibregl.Map({
  container: 'map',
  style: `https://api.maptiler.com/maps/streets/style.json?key=ym4UWHwsNK61YUsmqi5C`,
  attributionControl: false,
  center: [ (HOTEL_BBOX[0]+HOTEL_BBOX[2])/2, (HOTEL_BBOX[1]+HOTEL_BBOX[3])/2 ],
  zoom: 16,
  pitch: DEFAULT_PITCH,
  bearing: DEFAULT_BEARING,
  maxZoom: 21
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'© aihotelstech'}));

map.once('load', () => {
  // Otel alanına fit
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]], {padding:PADDING, maxZoom:19, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEARING});

  // indoor/outdoor kaynakları (boş başlat; sonra JSON yükleyip güncelleyeceğiz)
  map.addSource('indoor', { type:'geojson', data:{type:'FeatureCollection',features:[]} });
  map.addSource('outdoor',{ type:'geojson', data:{type:'FeatureCollection',features:[]} });

  // Poligonlar
  [['indoor','#2563eb'],['outdoor','#2563eb']].forEach(([src,color])=>{
    map.addLayer({ id:`${src}-fill`, type:'fill', source:src,
      paint:{ 'fill-color': color, 'fill-opacity': 0.12 }});
    map.addLayer({ id:`${src}-line`, type:'line', source:src,
      paint:{ 'line-color': color, 'line-width': 2 }});
  });
  // Noktalar
  [['indoor','#f94144'],['outdoor','#f94144']].forEach(([src,color])=>{
    map.addLayer({ id:`${src}-pts`, type:'circle', source:src,
      paint:{ 'circle-radius': 6, 'circle-color': color, 'circle-stroke-color':'#fff', 'circle-stroke-width':1.6 }});
  });

  // Hedef için ayrı bir source/layer
  map.addSource('dest', {type:'geojson', data:{type:'FeatureCollection',features:[]}});
  map.addLayer({id:'dest-pt', type:'circle', source:'dest',
    paint:{'circle-radius':7,'circle-color':'#ef4444','circle-stroke-color':'#fff','circle-stroke-width':1.8}});

  // Rota (OSRM veya fallback çizgisi)
  map.addSource('route', {type:'geojson', data:{type:'FeatureCollection',features:[]}});
  map.addLayer({id:'route-line', type:'line', source:'route',
    paint:{'line-color':'#16a34a','line-width':4}});

  // GeoJSON’ları yükle
  loadHotelData();
});

/* ====== Veri yükleme + arama index’i ====== */
let allFeats = []; // arama için birleşik dizi

async function loadHotelData(){
  const bust = 'v=' + Date.now();
  const [indoor,outdoor] = await Promise.all([
    fetch('indoor.json?'+bust, {cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]})),
    fetch('outdoor.json?'+bust,{cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
  ]);
  map.getSource('indoor').setData(indoor);
  map.getSource('outdoor').setData(outdoor);
  allFeats = (indoor.features||[]).map(f=>({...f, __src:'indoor'}))
           .concat((outdoor.features||[]).map(f=>({...f, __src:'outdoor'})));
}

/* ====== Dil/i18n (yalın) ====== */
const I18N = {
  tr:{searchPH:"Ara: restoran, spa, havuz…", pick:"Haritadan Hedef", go:"Git"},
  en:{searchPH:"Search: restaurant, spa, pool…", pick:"Pick on Map", go:"Go"},
  ru:{searchPH:"Поиск: ресторан, спа, бассейн…", pick:"Выбрать на карте", go:"Маршрут"},
  de:{searchPH:"Suche: Restaurant, Spa, Pool…", pick:"Auf Karte wählen", go:"Los"},
  pl:{searchPH:"Szukaj: restauracja, spa, basen…", pick:"Wybierz na mapie", go:"Start"}
};
const langSel = document.getElementById('lang'); let LANG = localStorage.getItem('lang') || 'tr';
function applyLang(){ const L=I18N[LANG]||I18N.tr; q.placeholder=L.searchPH; pickBtn.textContent=L.pick; goBtn.textContent=L.go; localStorage.setItem('lang',LANG); }
langSel.value = LANG; langSel.onchange = ()=>{ LANG=langSel.value; applyLang(); };

/* ====== Arama (otomatik doldurma) ====== */
const q = document.getElementById('q'), results = document.getElementById('results');
const pickBtn = document.getElementById('pick'), goBtn = document.getElementById('go');
const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,'');

// Çok dilli alan adları: name, name_tr, name_en…
function nameInAnyLang(p){
  return p['name_'+LANG] || p.name || p.name_tr || p.name_en || p.name_ru || p.name_de || p.name_pl || '';
}
function hitList(text){
  const nq = norm(text);
  return allFeats.filter(f=>{
    const p=f.properties||{};
    const name = norm(nameInAnyLang(p));
    const cat = norm(p.category||'');
    const desc = norm(p['desc_'+LANG]||p.desc||'');
    return name.includes(nq) || cat.includes(nq) || desc.includes(nq);
  }).slice(0,80);
}

q.addEventListener('input', ()=>{
  const v = (q.value||'').trim();
  if(!v){ results.style.display='none'; return; }
  const hits = hitList(v);
  results.innerHTML = '';
  hits.forEach(f=>{
    const p=f.properties||{};
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML = `<span>${nameInAnyLang(p) || '(isimsiz)'}</span><small class="muted">${(p.category||'')}${f.__src==='indoor'?' · Indoor':' · Outdoor'}</small>`;
    el.onclick=()=>{
      focusFeature(f,true);
      setDestination(coordOfFeature(f));
      results.style.display='none';
      goBtn.disabled = false;
    };
    results.appendChild(el);
  });
  results.style.display = hits.length ? 'block' : 'none';
});

document.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const first = results.querySelector('.item');
    if(first){ first.click(); e.preventDefault(); }
  }
});

/* ====== Hedef seçme, rota ====== */
let pickMode = false;
pickBtn.onclick = ()=>{ pickMode = !pickMode; pickBtn.classList.toggle('active',pickMode); };

map.on('click', (e)=>{
  if(!pickMode) return;
  setDestination([e.lngLat.lng, e.lngLat.lat]);
  pickMode = false; pickBtn.classList.remove('active');
  goBtn.disabled = false;
});

function setDestination(lnglat){
  map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:lnglat}}]});
}
function clearRoute(){
  map.getSource('route').setData({type:'FeatureCollection',features:[]});
}
function focusFeature(f,openPopup){
  const g=f.geometry;
  if(!g) return;
  if(g.type==='Point'){
    map.easeTo({center:g.coordinates, zoom:18, pitch:DEFAULT_PITCH});
  }else{
    const bbox = turf.bbox(f); // turf.js kullanmadan kendimiz hesaplayalım:
  }
  // Basit fit:
  const ex = turfBBoxFromGeom(g);
  if(ex) map.fitBounds([[ex[0],ex[1]],[ex[2],ex[3]]],{padding:PADDING,maxZoom:19});
}
// Küçük bbox yardımcıları (turf yoksa):
function turfBBoxFromGeom(geom){
  try{
    const coords = (geom.type==='Polygon')
      ? geom.coordinates.flat(1)
      : (geom.type==='MultiPolygon' ? geom.coordinates.flat(2)
      : (geom.type==='LineString' ? geom.coordinates
      : (geom.type==='Point' ? [geom.coordinates] : [])));
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    coords.forEach(([x,y])=>{ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; });
    return [minX,minY,maxX,maxY];
  }catch{return null;}
}
function coordOfFeature(f){
  const g=f.geometry;
  if(g.type==='Point') return g.coordinates;
  if(g.type==='Polygon'){
    const ring=g.coordinates[0]; // iç halka
    return ring[Math.floor(ring.length/2)];
  }
  if(g.type==='LineString') return g.coordinates[Math.floor(g.coordinates.length/2)];
  return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
}

/* Geoloc (mavi nokta = MapLibre yerleşik yok; basitçe navigator ile) */
let lastPos = null;
if('geolocation' in navigator){
  navigator.geolocation.watchPosition(p=>{ lastPos = p; }, ()=>{}, {enableHighAccuracy:true,maximumAge:0,timeout:10000});
}

goBtn.onclick = async ()=>{
  if(!lastPos){ alert(LANG==='tr'?'Konum izni/konum bulunamadı.':'Location missing.'); return; }
  const dest = map.getSource('dest')._data;
  if(!dest.features.length){ alert(LANG==='tr'?'Hedef yok.':'No destination.'); return; }
  const a = [lastPos.coords.longitude,lastPos.coords.latitude];
  const b = dest.features[0].geometry.coordinates;

  // OSRM (toplu kullanıma açık endpoint – yoğun kullanımda limitlenebilir)
  try{
    const url = `https://router.project-osrm.org/route/v1/foot/${a[0]},${a[1]};${b[0]},${b[1]}?overview=full&geometries=geojson`;
    const d = await fetch(url).then(r=>r.json());
    if(d.routes && d.routes.length){
      map.getSource('route').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:d.routes[0].geometry}]});
      const ex = turfBBoxFromGeom(d.routes[0].geometry); if(ex) map.fitBounds([[ex[0],ex[1]],[ex[2],ex[3]]],{padding:PADDING,maxZoom:18});
      return;
    }
  }catch{}
  // Fallback: düz çizgi
  map.getSource('route').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:[a,b]}}]});
  map.fitBounds([a,b],{padding:PADDING,maxZoom:19});
};

applyLang();
</script>
<!-- Küçük bbox yardımcıları için harici kütüphane kullanmadık; üstte basit fonksiyon yazdık. -->
</body>
</html>
