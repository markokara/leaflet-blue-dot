<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir â€“ MapLibre GL (3D/Pitch/Rotation)</title>

  <link href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>

  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#ffffff }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f3f4f6}
    #map{position:fixed; inset:0}

    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); width:min(780px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px}
    .stack{display:flex; flex-direction:column; gap:8px}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button,.btn{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .pill input{accent-color:#1d4ed8}
    .muted{color:var(--muted)}
    .results{background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:36vh; overflow:auto; display:none}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}
    .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}
    .dir{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:10px}
    .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb}
    .dir .sum{font-weight:600}
    .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
    .step{display:flex; gap:8px; padding:6px 0; border-bottom:1px dashed #e5e7eb}
    .step:last-child{border-bottom:none}
    .acc{position:fixed; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
    @media (max-width:520px){ .panel{bottom:8px} }
  </style>
</head>
<body>

  <div class="panel">
    <div class="card p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuzâ€¦" />
        <button id="go" disabled>Git</button>
        <select id="lang" aria-label="Language">
          <option value="tr" selected>TR</option>
          <option value="en">EN</option>
          <option value="ru">RU</option>
          <option value="de">DE</option>
          <option value="pl">PL</option>
        </select>
        <select id="basemap" title="Base map">
          <option value="demo" selected>OSM (key'siz)</option>
          <option value="streets">MapTiler Streets</option>
          <option value="satellite">MapTiler Satellite</option>
        </select>
      </div>

      <div class="row" style="flex-wrap:wrap">
        <button id="pick">Haritadan Hedef</button>
        <button id="follow">ðŸŽ¯ Ä°zle: KapalÄ±</button>
        <button id="toggleDetails">Detaylar: KapalÄ±</button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
        <button id="reset">SÄ±fÄ±rla</button>
        <span class="muted" id="hint" style="display:none">ðŸ”Ž Arama aÃ§Ä±k</span>
      </div>

      <div id="results" class="results"></div>

      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">â€“</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">â–²</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>

      <div class="muted" style="font-size:11px; text-align:right">Â© aihotelstech Â· Â© OpenStreetMap contributors</div>
    </div>
  </div>

  <div id="acc" class="acc" style="display:none"></div>
  <div id="map" aria-label="Harita"></div>

<script>
/* ========= i18n (senin sÃ¶zlÃ¼ÄŸÃ¼n) ========= */
const I18N = {
  tr:{ searchPH:"Ara: restoran, spa, havuzâ€¦", go:"Git",
    ui:{ pick:"Haritadan Hedef", followOn:"Ä°zle: AÃ§Ä±k", followOff:"Ä°zle: KapalÄ±", detailsOn:"Detaylar: AÃ§Ä±k", detailsOff:"Detaylar: KapalÄ±", reset:"SÄ±fÄ±rla", hint:"ðŸ”Ž Arama aÃ§Ä±k: sadece eÅŸleÅŸenler gÃ¶steriliyor", clearRoute:"Rota Temizle" },
    labels:{name:"Ä°sim", category:"TÃ¼r", hours:"Saat", level:"Kat", desc:"AÃ§Ä±klama", dist:"Mesafe", duration:"SÃ¼re"},
    cats:{ pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"DÃ¼kkan", toilet:"WC", reception:"Resepsiyon", beach:"Plaj", kidsclub:"Ã‡ocuk KulÃ¼bÃ¼", elevator:"AsansÃ¶r", gate:"KapÄ±", parking:"Otopark", shuttle:"Servis", gym:"Spor Salonu" },
    nav:{ depart:"BaÅŸla", arrive:"VarÄ±ÅŸ", turn_left:"Sola dÃ¶n", turn_right:"SaÄŸa dÃ¶n", straight:"DÃ¼z devam", roundabout:"GÃ¶bekte %n. Ã§Ä±kÄ±ÅŸ", onto:" â†’ %s" }
  },
  en:{ searchPH:"Search: restaurant, spa, poolâ€¦", go:"Go",
    ui:{ pick:"Pick on Map", followOn:"Follow: On", followOff:"Follow: Off", detailsOn:"Details: On", detailsOff:"Details: Off", reset:"Reset", hint:"ðŸ”Ž Search is active: only matches are shown", clearRoute:"Clear Route" },
    labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description", dist:"Distance", duration:"Duration"},
    cats:{ pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet", reception:"Reception", beach:"Beach", kidsclub:"Kids Club", elevator:"Elevator", gate:"Gate", parking:"Parking", shuttle:"Shuttle", gym:"Gym" },
    nav:{ depart:"Depart", arrive:"Arrive", turn_left:"Turn left", turn_right:"Turn right", straight:"Go straight", roundabout:"At roundabout take exit %n", onto:" onto %s" }
  }
};
let LANG=localStorage.getItem("lang")||"tr";
const t = () => I18N[LANG]||I18N.tr;

/* ========= YardÄ±mcÄ±lar ========= */
const $ = id=>document.getElementById(id);
function applyLang(){
  const L=t();
  $('q').placeholder=L.searchPH;
  $('go').textContent=L.go;
  $('pick').textContent=L.ui.pick;
  $('follow').textContent = follow ? L.ui.followOn : L.ui.followOff;
  $('toggleDetails').textContent = showAll ? L.ui.detailsOn : L.ui.detailsOff;
  $('reset').textContent=L.ui.reset;
  $('clearRoute').textContent=L.ui.clearRoute;
  localStorage.setItem('lang',LANG);
}

/* ========= HARÄ°TA ========= */
const START_CENTER=[33.8046,36.6002]; // lon,lat (sabit â€“ otomatik fit YOK)
const START_ZOOM=16;

const STYLE_DEMO = "https://demotiles.maplibre.org/style.json"; // key'siz
const MT_KEY = "YOUR_MAPTILER_KEY"; // varsa koy
const STYLES = {
  demo: STYLE_DEMO,
  streets: `https://api.maptiler.com/maps/streets/style.json?key=${MT_KEY}`,
  satellite: `https://api.maptiler.com/maps/satellite/style.json?key=${MT_KEY}`
};

let map = new maplibregl.Map({
  container:'map',
  style: STYLES.demo,
  center: START_CENTER,
  zoom: START_ZOOM,
  pitch: 45,           // ðŸŽ¯ 45Â°
  bearing: 0,
  antialias: true
});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}));
map.addControl(new maplibregl.ScaleControl({unit:'metric'}));

/* ========= Base map deÄŸiÅŸtirici ========= */
$('basemap').addEventListener('change',()=>{
  const s = STYLES[$('basemap').value];
  map.setStyle(s);            // stil deÄŸiÅŸse de center/zoom/pitch korunur
  map.once('styledata',()=>{  // kaynak/katmanlar stil sonrasÄ± tekrar eklenir
    mountDataLayers();
    if (routeDrawn) drawRouteGeoJSON(lastRouteGeoJSON);
  });
});

/* ========= ÃœST KATMANLAR: indoor/outdoor ========= */
const indoorUrl='indoor.json', outdoorUrl='outdoor.json';
function addGeoSource(id,url){
  if(map.getSource(id)) map.removeSource(id);
  map.addSource(id,{type:'geojson', data:url});
}
function addLayersFor(id,color='#2563eb'){
  // Polygon
  map.addLayer({ id:`${id}-fill`, type:'fill', source:id,
    filter:['==',['geometry-type'],'Polygon'],
    paint:{'fill-color':color,'fill-opacity':0.12}
  });
  map.addLayer({ id:`${id}-stroke`, type:'line', source:id,
    filter:['==',['geometry-type'],'Polygon'],
    paint:{'line-color':color,'line-width':2}
  });
  // Line
  map.addLayer({ id:`${id}-line`, type:'line', source:id,
    filter:['==',['geometry-type'],'LineString'],
    paint:{'line-color':color,'line-width':2}
  });
  // Point
  map.addLayer({ id:`${id}-pt`, type:'circle', source:id,
    filter:['==',['geometry-type'],'Point'],
    paint:{'circle-radius':7,'circle-color':'#f94144','circle-stroke-color':'#fff','circle-stroke-width':2}
  });
}
function mountDataLayers(){
  addGeoSource('indoor', indoorUrl);
  addGeoSource('outdoor', outdoorUrl);
  addLayersFor('indoor','#2563eb');
  addLayersFor('outdoor','#2563eb');

  // tÄ±klama â†’ popup
  const popup=new maplibregl.Popup({closeButton:true});
  ['indoor-pt','indoor-fill','outdoor-pt','outdoor-fill'].forEach(id=>{
    if(map.getLayer(id)){
      map.on('click', id, e=>{
        const p=e.features[0].properties||{}; const L=t();
        const name=p[`name_${LANG}`]||p.name||'';
        const cat=(p.category||'').toLowerCase();
        const catLabel=L.cats?.[cat]||p.category||'';
        const hours=p[`hours_${LANG}`]||p.hours||''; const level=p[`level_${LANG}`]||p.level||'';
        popup.setLngLat(e.lngLat).setHTML(`
          <div style="min-width:200px">
            <div style="font-weight:600">${name}</div>
            ${catLabel?`<div style="display:inline-block;padding:.15rem .45rem;border-radius:999px;background:#eef2ff;border:1px solid #dfe6ff;font-size:12px">${catLabel}</div>`:''}
            ${hours?`<div style="margin-top:6px"><small>${L.labels.hours}:</small> ${hours}</div>`:''}
            ${level?`<div><small>${L.labels.level}:</small> ${level}</div>`:''}
          </div>
        `).addTo(map);
      });
      map.on('mouseenter',id,()=>map.getCanvas().style.cursor='pointer');
      map.on('mouseleave',id,()=>map.getCanvas().style.cursor='');
    }
  });
}
map.on('load', mountDataLayers);

/* ========= Katman toggle & detay ========= */
function setGroupVisible(prefix,visible){
  ['-fill','-stroke','-line','-pt'].forEach(s=>{
    const id=prefix+s; if(map.getLayer(id)) map.setLayoutProperty(id,'visibility', visible?'visible':'none');
  });
}
$('tglIndoor').onchange=()=> setGroupVisible('indoor',$('tglIndoor').checked);
$('tglOutdoor').onchange=()=> setGroupVisible('outdoor',$('tglOutdoor').checked);

let showAll=false;
$('toggleDetails').onclick=()=>{
  showAll=!showAll;
  $('toggleDetails').textContent = showAll ? t().ui.detailsOn : t().ui.detailsOff;
  // showAll=false ise sadece noktalarÄ± gÃ¶ster
  ['indoor','outdoor'].forEach(p=>{
    ['-fill','-stroke','-line'].forEach(s=>{
      if(map.getLayer(p+s)) map.setLayoutProperty(p+s,'visibility', showAll?'visible':'none');
    });
  });
};

/* ========= Konum + Hedef seÃ§imi ========= */
let follow=false, userMarker=null, accEl=$('acc'), pickMode=false, destMarker=null;
$('follow').onclick=()=>{ follow=!follow; $('follow').textContent = follow? t().ui.followOn : t().ui.followOff; };

if('geolocation' in navigator){
  navigator.geolocation.watchPosition(pos=>{
    const lng=pos.coords.longitude, lat=pos.coords.latitude;
    if(!userMarker) userMarker=new maplibregl.Marker({color:'#1d4ed8'}).setLngLat([lng,lat]).addTo(map);
    else userMarker.setLngLat([lng,lat]);
    accEl.textContent="Â±"+Math.round(pos.coords.accuracy||0)+" m"; accEl.style.display='block';
    if(follow) map.easeTo({center:[lng,lat], duration:200});
  },()=>{}, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
}

$('pick').onclick=()=>{ pickMode=!pickMode; $('pick').classList.toggle('active',pickMode); };
map.on('click',e=>{
  if(!pickMode) return;
  if(!destMarker) destMarker=new maplibregl.Marker({color:'#ef4444'}).addTo(map);
  destMarker.setLngLat(e.lngLat);
  $('go').disabled=false;
  pickMode=false; $('pick').classList.remove('active');
});

/* ========= Rota (OSRM) ========= */
let routeDrawn=false, lastRouteGeoJSON=null;
$('clearRoute').onclick=clearRoute;
$('go').onclick=routeToDestination;

function clearRoute(){
  if(map.getLayer('route')) map.removeLayer('route');
  if(map.getSource('route')) map.removeSource('route');
  $('dir').style.display='none'; $('dirList').innerHTML=''; $('dirSum').textContent='â€“'; $('dirSub').textContent='';
  routeDrawn=false; lastRouteGeoJSON=null;
}
function drawRouteGeoJSON(gj){
  if(!gj) return;
  if(map.getSource('route')) map.removeSource('route');
  map.addSource('route',{type:'geojson', data: gj});
  if(!map.getLayer('route')) map.addLayer({id:'route',type:'line',source:'route',paint:{'line-color':'#16a34a','line-width':4}});
  const coords=gj.geometry.coordinates;
  const b=new maplibregl.LngLatBounds(coords[0],coords[0]); coords.forEach(c=>b.extend(c));
  map.fitBounds(b,{padding:{top:140,right:20,bottom:160,left:20}, maxZoom:18});
  routeDrawn=true; lastRouteGeoJSON=gj;
}
function routeToDestination(){
  if(!userMarker || !destMarker){ alert(LANG==='tr'?'Konum ve hedef gerekli.':'Need location and destination.'); return; }
  clearRoute();
  const a=userMarker.getLngLat(), b=destMarker.getLngLat();
  const url=`https://router.project-osrm.org/route/v1/foot/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson&steps=true`;
  fetch(url).then(r=>r.json()).then(d=>{
    const route=d?.routes?.[0];
    if(!route){ drawBearing(a,b); return; }
    drawRouteGeoJSON(route.geometry);
    $('dir').style.display='block';
    $('dirSum').textContent=(route.distance/1000).toFixed(2)+' km';
    $('dirSub').textContent='Â· '+Math.round(route.duration/60)+' dk';
    const L=t(), steps=(route.legs?.[0]?.steps)||[], list=$('dirList');
    steps.forEach((s,i)=>{
      const man=s.maneuver||{}, type=man.type||'', mod=man.modifier||''; const street=s.name||'';
      const onto= street ? (L.nav.onto||'').replace('%s',street) : '';
      let txt=L.nav.straight||''; if(type==='depart') txt=L.nav.depart+onto; else if(type==='arrive') txt=L.nav.arrive;
      else if(type==='turn'){ if(mod==='left') txt=L.nav.turn_left+onto; else if(mod==='right') txt=L.nav.turn_right+onto; else txt=(L.nav.straight||'')+onto; }
      else if(type==='roundabout'){ const ex=man.exit||1; txt=(L.nav.roundabout||'').replace('%n',ex)+onto; }
      const dist = s.distance>=1000 ? (s.distance/1000).toFixed(2)+' km' : Math.round(s.distance)+' m';
      const el=document.createElement('div'); el.className='step'; el.innerHTML=`<div>${i+1}.</div><div><div>${txt}</div><div class="muted" style="font-size:12px">${dist}</div></div>`;
      list.appendChild(el);
    });
  }).catch(()=> drawBearing(a,b));
}
function drawBearing(a,b){
  const gj={type:'Feature', geometry:{type:'LineString', coordinates:[[a.lng,a.lat],[b.lng,b.lat]]}};
  drawRouteGeoJSON(gj);
}

/* ========= Arama/dil ========= */
$('lang').value=LANG;
$('lang').addEventListener('change',()=>{ LANG=$('lang').value; applyLang(); });
applyLang();
</script>
</body>
</html>
