<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir ‚Äì Indoor & Outdoor Harita + 3D Binalar</title>

  <!-- OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>

  <!-- OSMBuildings -->
  <link href="https://cdn.osmbuildings.org/4.0.0/OSMBuildings.css" rel="stylesheet">
  <script src="https://cdn.osmbuildings.org/4.0.0/OSMBuildings.js"></script>

  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#ffffff }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,sans-serif;background:#f3f4f6}
    #map-ol,#map-osmb{position:fixed;inset:0}
    #map-osmb{display:none}

    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
           width:min(780px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:8px}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .muted{color:var(--muted)}
    .results{background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:36vh; overflow:auto; display:none}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between}
    .results .item small{color:var(--muted)}
    .dir{display:none; background:#fff; border:1px solid #e5e7eb; border-radius:10px}
    .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5e7eb}
    .dir .sum{font-weight:600}
    .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}
    .step{display:flex; gap:8px; padding:6px 0; border-bottom:1px dashed #e5e7eb}
    .step:last-child{border-bottom:none}
    .ol-popup{position:absolute; background:#fff; padding:10px; border-radius:10px; border:1px solid #e5e7eb; min-width:220px; box-shadow:var(--shadow); transform:translate(-50%,-100%);}
    .ol-popup-closer{position:absolute; right:8px; top:6px; text-decoration:none; color:#9ca3af}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}
    .acc{position:fixed; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
  </style>
</head>
<body>

  <!-- Panel -->
  <div class="panel">
    <div class="card p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search"/>
        <button id="go" disabled></button>
        <select id="lang">
          <option value="tr">T√ºrk√ße</option>
          <option value="en">English</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="pl">Polski</option>
          <option value="de">Deutsch</option>
        </select>
      </div>
      <div class="row">
        <button id="pick"></button>
        <button id="follow"></button>
        <button id="toggleDetails"></button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked><span id="lblIndoor"></span></label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked><span id="lblOutdoor"></span></label>
        <button id="reset"></button>
        <button onclick="showOSMB()" id="btn3d"></button>
        <button onclick="showOL()" id="btn2d"></button>
      </div>
      <div id="results" class="results"></div>
      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">‚Äì</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">‚ñ≤</button>
            <button id="clearRoute"></button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>
      <div class="muted" style="font-size:11px; text-align:right">¬© aihotelstech ¬∑ ¬© OpenStreetMap contributors</div>
    </div>
  </div>

  <!-- Map alanlarƒ± -->
  <div id="map-ol"></div>
  <div id="map-osmb"></div>

<script>
/* ========= √áoklu Dil ========= */
const I18N={
  tr:{search:"Ara: restoran, spa, havuz‚Ä¶",go:"Git",pick:"Haritadan Hedef",followOff:"üéØ ƒ∞zle: Kapalƒ±",followOn:"üéØ ƒ∞zle: A√ßƒ±k",detailsOff:"Detaylar: Kapalƒ±",detailsOn:"Detaylar: A√ßƒ±k",indoor:"Indoor",outdoor:"Outdoor",reset:"Sƒ±fƒ±rla",b3d:"3D Binalar",b2d:"2D Harita",clearRoute:"Rota Temizle"},
  en:{search:"Search: restaurant, spa, pool‚Ä¶",go:"Go",pick:"Pick on Map",followOff:"üéØ Follow: Off",followOn:"üéØ Follow: On",detailsOff:"Details: Off",detailsOn:"Details: On",indoor:"Indoor",outdoor:"Outdoor",reset:"Reset",b3d:"3D Buildings",b2d:"2D Map",clearRoute:"Clear Route"},
  ru:{search:"–ü–æ–∏—Å–∫: —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å–ø–∞, –±–∞—Å—Å–µ–π–Ω‚Ä¶",go:"–ü–æ–∏—Å–∫",pick:"–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ",followOff:"üéØ –°–ª–µ–¥–∏—Ç—å: –≤—ã–∫–ª",followOn:"üéØ –°–ª–µ–¥–∏—Ç—å: –≤–∫–ª",detailsOff:"–î–µ—Ç–∞–ª–∏: –≤—ã–∫–ª",detailsOn:"–î–µ—Ç–∞–ª–∏: –≤–∫–ª",indoor:"–í–Ω—É—Ç—Ä–∏",outdoor:"–°–Ω–∞—Ä—É–∂–∏",reset:"–°–±—Ä–æ—Å",b3d:"3D –∑–¥–∞–Ω–∏—è",b2d:"2D –∫–∞—Ä—Ç–∞",clearRoute:"–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"},
  pl:{search:"Szukaj: restauracja, spa, basen‚Ä¶",go:"Szukaj",pick:"Wybierz na mapie",followOff:"üéØ ≈öled≈∫: wy≈Ç",followOn:"üéØ ≈öled≈∫: w≈Ç",detailsOff:"Szczeg√≥≈Çy: wy≈Ç",detailsOn:"Szczeg√≥≈Çy: w≈Ç",indoor:"WewnƒÖtrz",outdoor:"Na zewnƒÖtrz",reset:"Resetuj",b3d:"Budynki 3D",b2d:"Mapa 2D",clearRoute:"Wyczy≈õƒá trasƒô"},
  de:{search:"Suche: Restaurant, Spa, Pool‚Ä¶",go:"Los",pick:"Auf Karte w√§hlen",followOff:"üéØ Folgen: Aus",followOn:"üéØ Folgen: An",detailsOff:"Details: Aus",detailsOn:"Details: An",indoor:"Innen",outdoor:"Au√üen",reset:"Zur√ºcksetzen",b3d:"3D Geb√§ude",b2d:"2D Karte",clearRoute:"Route l√∂schen"}
};
let LANG="tr";
function applyLang(){
  const L=I18N[LANG];
  q.placeholder=L.search;
  go.textContent=L.go;
  pickBtn.textContent=L.pick;
  followBtn.textContent=followState?L.followOn:L.followOff;
  toggleDetails.textContent=showAllDetails?L.detailsOn:L.detailsOff;
  document.getElementById("lblIndoor").textContent=L.indoor;
  document.getElementById("lblOutdoor").textContent=L.outdoor;
  resetBtn.textContent=L.reset;
  document.getElementById("btn3d").textContent=L.b3d;
  document.getElementById("btn2d").textContent=L.b2d;
  document.getElementById("clearRoute").textContent=L.clearRoute;
}

/* ========= OpenLayers ========= */
const base = new ol.layer.Tile({ source: new ol.source.OSM() });
const indoorSource  = new ol.source.Vector();
const outdoorSource = new ol.source.Vector();

const indoorLayer  = new ol.layer.VectorImage({ source: indoorSource });
const outdoorLayer = new ol.layer.VectorImage({ source: outdoorSource });

const map = new ol.Map({
  target:'map-ol',
  layers:[base, indoorLayer, outdoorLayer],
  view:new ol.View({ center: ol.proj.fromLonLat([31.8046,36.6002]), zoom:16 })
});

/* ========= JSON y√ºkleme ========= */
const fmt=new ol.format.GeoJSON();
async function loadJSONs(){
  const bust = 'v=' + Date.now();
  const [indoor, outdoor] = await Promise.all([
    fetch('indoor.json?'+bust).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}),
    fetch('outdoor.json?'+bust).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]})
  ]);
  indoorSource.clear(); outdoorSource.clear();
  const add=(src,gj,kind)=>{ const fs=fmt.readFeatures(gj,{featureProjection:'EPSG:3857'}); fs.forEach(f=>f.set('src',kind)); src.addFeatures(fs); };
  add(indoorSource,indoor,'indoor'); add(outdoorSource,outdoor,'outdoor');
}
loadJSONs();

/* ========= Popup ========= */
const popupEl=document.createElement('div');
popupEl.className='ol-popup';
const popupContent=document.createElement('div');
popupEl.appendChild(popupContent);
const popupCloser=document.createElement('a');
popupCloser.className='ol-popup-closer';
popupCloser.textContent='‚úï';
popupEl.appendChild(popupCloser);
document.body.appendChild(popupEl);

const popupOverlay=new ol.Overlay({element:popupEl, autoPan:{animation:{duration:200}}});
map.addOverlay(popupOverlay);

popupCloser.onclick=()=>{ popupOverlay.setPosition(undefined); return false; };

map.on('singleclick',evt=>{
  map.forEachFeatureAtPixel(evt.pixel,(f)=>{
    const props=f.getProperties();
    popupContent.innerHTML=`<b>${props.name||'(isimsiz)'}</b><br>${props.category||''}`;
    popupOverlay.setPosition(evt.coordinate);
  });
});

/* ========= Arama ========= */
let allFeats=[];
function refreshFeats(){
  allFeats=indoorSource.getFeatures().concat(outdoorSource.getFeatures());
}
indoorSource.on('change',refreshFeats);
outdoorSource.on('change',refreshFeats);

const q=document.getElementById('q');
const results=document.getElementById('results');
q.addEventListener('input',()=>{
  const val=q.value.trim().toLowerCase();
  results.innerHTML='';
  if(!val){ results.style.display='none'; return; }
  const hits=allFeats.filter(f=>{
    const p=f.getProperties();
    return (p.name||'').toLowerCase().includes(val) || (p.category||'').toLowerCase().includes(val);
  });
  hits.forEach(f=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<span>${f.get('name')||'(isimsiz)'}</span><small>${f.get('category')||''}</small>`;
    div.onclick=()=>{
      const c=f.getGeometry().getFirstCoordinate();
      map.getView().animate({center:c,zoom:18});
    };
    results.appendChild(div);
  });
  results.style.display='block';
});

/* ========= Rota ========= */
let userPoint=null, destPoint=null, routeLayer=null, followState=false, showAllDetails=false;

navigator.geolocation.getCurrentPosition(pos=>{
  const c=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]);
  userPoint=new ol.Feature(new ol.geom.Point(c));
  const userLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[userPoint]}) });
  map.addLayer(userLayer);
});

function setDestination(coord){
  destPoint=new ol.Feature(new ol.geom.Point(coord));
  const destLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[destPoint]}) });
  map.addLayer(destLayer);
}

map.on('dblclick',evt=>{
  setDestination(evt.coordinate);
});

document.getElementById('go').onclick=()=>{
  if(!userPoint||!destPoint){ alert("Konum ve hedef gerekli"); return; }
  if(routeLayer){ map.removeLayer(routeLayer); }
  const a=ol.proj.toLonLat(userPoint.getGeometry().getCoordinates());
  const b=ol.proj.toLonLat(destPoint.getGeometry().getCoordinates());
  fetch(`https://router.project-osrm.org/route/v1/foot/${a[0]},${a[1]};${b[0]},${b[1]}?overview=full&geometries=geojson`)
  .then(r=>r.json()).then(json=>{
    const coords=json.routes[0].geometry.coordinates;
    const line=new ol.geom.LineString(coords).transform('EPSG:4326','EPSG:3857');
    const feat=new ol.Feature(line);
    routeLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[feat]}),
      style:new ol.style.Style({ stroke:new ol.style.Stroke({color:'red',width:3}) })
    });
    map.addLayer(routeLayer);
    map.getView().fit(line.getExtent(),{padding:[50,50,50,50]});
  });
};

/* ========= Reset ========= */
const resetBtn=document.getElementById('reset');
resetBtn.onclick=()=>{
  q.value=''; results.style.display='none';
  indoorSource.clear(); outdoorSource.clear(); loadJSONs();
  if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
};

/* ========= UI Elemanlarƒ± ========= */
const go=document.getElementById('go');
const pickBtn=document.getElementById('pick');
const followBtn=document.getElementById('follow');
const toggleDetails=document.getElementById('toggleDetails');

/* ========= Dil se√ßimi ========= */
document.getElementById('lang').onchange=(e)=>{ LANG=e.target.value; applyLang(); };
applyLang();

/* ========= OSMBuildings ========= */
const osmb = new OSMBuildings({
  container: 'map-osmb',
  position: { latitude: 36.88414, longitude: 30.70563 },
  zoom: 16, tilt: 45, rotation: 0
});
osmb.addMapTiles('https://{a,b,c}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { attribution: '¬© OpenStreetMap contributors' });
osmb.addGeoJSONTiles('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json');

function showOL(){
  document.getElementById('map-ol').style.display='block';
  document.getElementById('map-osmb').style.display='none';
}
function showOSMB(){
  document.getElementById('map-ol').style.display='none';
  document.getElementById('map-osmb').style.display='block';
}
</script>
</body>
</html>
