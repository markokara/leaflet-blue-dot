<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Long Beach ‚Äì Misafir Harita</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<!-- Rota i√ßin gerekli k√ºt√ºphaneler -->
<script src="https://unpkg.com/@turf/turf@7.2.0/turf.min.js"></script>
<script src="https://unpkg.com/cheap-ruler@3.0.1/cheap-ruler.umd.js"></script>

<style>
  :root{
    --shadow:0 10px 28px rgba(0,0,0,.18);
    --muted:#5b6a6a; --bg:#fff; --brand:#0f5132; --border:#cfe3da; --field:#f4fbf7; --chip:#e6f4ef;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eaf4f0}
  #map{position:fixed; inset:0}

  .maplibregl-popup{ max-width:min(320px,86vw)!important; }
  .maplibregl-popup-content{ padding:10px 12px; overflow-wrap:anywhere; }
  .maplibregl-popup-content img{
    width:100%; max-height:140px; height:auto; object-fit:cover; border-radius:8px;
  }
  @media (max-width:480px){ .maplibregl-popup-content{padding:9px 10px} }

  .lang-float{position:fixed; left:12px; top:12px; z-index:1200; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:6px 8px}
  .lang-float select{border:1px solid var(--border); background:var(--field); border-radius:10px; padding:6px 8px}

  /* Bottom sheet */
  .panel{
    position:fixed; left:50%; bottom:0;
    transform:translate(-50%,var(--panel-ty,0px));
    transition:transform .2s ease;
    width:min(860px,96vw); z-index:1100;
  }
  .card{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
  .p-8{padding:10px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .stack{display:flex; flex-direction:column; gap:10px}
  .grow{flex:1 1 auto}

  .grab{position:relative; width:64px; height:28px; margin:8px auto 0; cursor:grab}
  .grab::before,.grab::after{
    content:""; position:absolute; left:50%; transform:translateX(-50%);
    width:56px; height:6px; background:#9fd3b3; border-radius:999px; box-shadow:inset 0 0 0 1px #83c7a1;
  }
  .grab::before{ top:6px } .grab::after{ bottom:6px }

  input[type="search"]{width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:12px; background:var(--field)}
  button{padding:9px 11px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:var(--field); white-space:nowrap}
  button:active{transform:translateY(1px)}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--chip); font-size:13px}
  .chip input{accent-color:#1b7a5b}
  .chip .tick{opacity:.18; transition:.15s}
  .chip input:checked ~ .tick{opacity:1}

  .results{background:#fff; border:1px solid var(--border); border-radius:12px; max-height:36vh; overflow:auto; position:relative; z-index:2001; display:none; -webkit-overflow-scrolling:touch}
  .results .item{display:flex; justify-content:space-between; gap:8px; padding:10px 12px; cursor:pointer}
  .results .item:hover{background:#f1f7f4}
  .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}

  .dir{display:none; background:#fff; border:1px solid var(--border); border-radius:12px}
  .dir .hdr{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #e5efe9}
  .dir .list{max-height:30vh; overflow:auto; padding:8px 12px}

  .badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#edf7f3; border:1px solid var(--border); font-size:12px}
  .acc{position:fixed; right:12px; bottom:12px; z-index:1005; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}

  @media (max-width:520px){ .panel{bottom:8px} }

  .row.searchrow{display:grid; grid-template-columns:1fr auto; gap:8px}
  .row.ctlsB .chip{padding:6px 10px}
  .muted{color:var(--muted)}
</style>
</head>
<body>

<!-- Dil -->
<div class="lang-float">
  <select id="lang" aria-label="Dil">
    <option value="tr" selected>TR</option><option value="en">EN</option>
    <option value="ru">RU</option><option value="de">DE</option><option value="pl">PL</option>
  </select>
</div>

<div id="map" aria-label="Harita"></div>

<!-- Bottom sheet -->
<div class="panel" id="sheet">
  <div class="card">
    <div class="grab" id="grab"></div>
    <div class="p-8 stack" id="sheetContent">

      <div class="row searchrow">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz‚Ä¶"/>
        <button id="go" title="Se√ßili hedefe rota" disabled>Git</button>
      </div>

      <div class="row ctlsB">
        <button id="pickStart">Ba≈ülangƒ±√ß Se√ß</button>
        <button id="pickDest">Hedef Se√ß</button>
        <button id="follow">üìç Konumum: Kapalƒ±</button>
        <button id="reset">Sƒ±fƒ±rla</button>
        <span class="grow"></span>
        <label class="chip" title="Satellite (raster)">
          <input type="radio" name="basemap" id="baseSat" checked><span>Satellite</span><span class="tick">‚úì</span>
        </label>
        <label class="chip" title="MapLibre 3D (terrain + binalar)">
          <input type="radio" name="basemap" id="base3d"><span>MapLibre 3D</span><span class="tick">‚úì</span>
        </label>
      </div>

      <div id="results" class="results"></div>

      <div id="dir" class="dir">
        <div class="hdr">
          <div><span class="sum" id="dirSum">‚Äì</span> <span class="muted" id="dirSub"></span></div>
          <div class="row">
            <button id="collapseDir">‚ñ≤</button>
            <button id="clearRoute">Rota Temizle</button>
          </div>
        </div>
        <div class="list" id="dirList"></div>
      </div>

      <div class="muted" style="font-size:11px; text-align:right">¬© aihotelstech ¬∑ ¬© OpenStreetMap contributors ¬∑ ¬© MapTiler ¬∑ ¬© Mapbox</div>
    </div>
  </div>
</div>

<div id="acc" class="acc" style="display:none"></div>

<script>
/* ================== ANAHTARLAR ================== */
var MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";
var MAPTILER_KEY = "ym4UWHwsNK61YUsmqi5C";

/* ================== AYARLAR ================== */
var HOTEL_BBOX = [31.004958004, 36.854332231, 31.01965811, 36.869973060]; // [minLon,minLat,maxLon,maxLat]
var PADDING = {top:120,right:16,bottom:160,left:16};
var DEFAULT_PITCH = 45, DEFAULT_BEARING = 0;

/* OSM √ºst katman ayarlarƒ± */
var OSM_OPACITY = 0.75;   // 0‚Äì1
var OSM_VISIBLE = true;   // true/false

/* ===== Sƒ∞M√úLASYON ===== */
var SIMULATE_ME   = true;
var SIM_ME_COORD  = [31.005858, 36.862770];
var SIM_ME_ACC_M  = 5;

/* ================== i18n ================== */
var I18N = {
  tr:{searchPH:"Ara: restoran, spa, havuz‚Ä¶", go:"Git",
      ui:{pickStart:"Ba≈ülangƒ±√ß Se√ß", pickDest:"Hedef Se√ß", followOn:"üìç Konumum: A√ßƒ±k", followOff:"üìç Konumum: Kapalƒ±", reset:"Sƒ±fƒ±rla", clearRoute:"Rota Temizle"},
      labels:{name:"ƒ∞sim", category:"T√ºr", hours:"Saat", level:"Kat", desc:"A√ßƒ±klama"},
      cats:{pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"D√ºkkan", toilet:"WC", reception:"Resepsiyon", beach:"Plaj", kidsclub:"√áocuk Kul√ºb√º", elevator:"Asans√∂r", gate:"Kapƒ±", parking:"Otopark", shuttle:"Servis", gym:"Spor Salonu"},
      nav:{depart:"Ba≈üla", arrive:"Varƒ±≈ü", turn_left:"Sola d√∂n", turn_right:"Saƒüa d√∂n", straight:"D√ºz devam", roundabout:"G√∂bekte %n. √ßƒ±kƒ±≈ü", onto:" ‚Üí %s"}
  },
  en:{searchPH:"Search: restaurant, spa, pool‚Ä¶", go:"Go",
      ui:{pickStart:"Pick Start", pickDest:"Pick Destination", followOn:"üìç My Location: On", followOff:"üìç My Location: Off", reset:"Reset", clearRoute:"Clear Route"},
      labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description"},
      cats:{pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet", reception:"Reception", beach:"Beach", kidsclub:"Kids Club", elevator:"Elevator", gate:"Gate", parking:"Parking", shuttle:"Shuttle", gym:"Gym"},
      nav:{depart:"Depart", arrive:"Arrive", turn_left:"Turn left", turn_right:"Turn right", straight:"Go straight", roundabout:"At roundabout take exit %n", onto:" onto %s"}
  },
  de:{searchPH:"Suche: Restaurant, Spa, Pool‚Ä¶", go:"Los",
      ui:{pickStart:"Start w√§hlen", pickDest:"Ziel w√§hlen", followOn:"üìç Mein Standort: An", followOff:"üìç Mein Standort: Aus", reset:"Zur√ºcksetzen", clearRoute:"Route l√∂schen"},
      labels:{name:"Name", category:"Typ", hours:"√ñffnungszeiten", level:"Etage", desc:"Beschreibung"},
      cats:{pool:"Pool", restaurant:"Restaurant", spa:"Spa/Wellness", bar:"Bar", cafe:"Caf√©", shop:"Shop", toilet:"Toilette", reception:"Rezeption", beach:"Strand", kidsclub:"Kinderclub", elevator:"Aufzug", gate:"Eingangstor", parking:"Parkplatz", shuttle:"Shuttle", gym:"Fitnessstudio"},
      nav:{depart:"Start", arrive:"Ankunft", turn_left:"Links abbiegen", turn_right:"Rechts abbiegen", straight:"Geradeaus", roundabout:"Im Kreisverkehr Ausfahrt %n nehmen", onto:" auf %s"}
  },
  ru:{searchPH:"–ü–æ–∏—Å–∫: —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å–ø–∞, –±–∞—Å—Å–µ–π–Ω‚Ä¶", go:"–ü–æ–µ—Ö–∞–ª–∏",
      ui:{pickStart:"–í—ã–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—Ç", pickDest:"–í—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç", followOn:"üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –í–∫–ª", followOff:"üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –í—ã–∫–ª", reset:"–°–±—Ä–æ—Å", clearRoute:"–û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç"},
      labels:{name:"–ù–∞–∑–≤–∞–Ω–∏–µ", category:"–¢–∏–ø", hours:"–ß–∞—Å—ã", level:"–≠—Ç–∞–∂", desc:"–û–ø–∏—Å–∞–Ω–∏–µ"},
      cats:{pool:"–ë–∞—Å—Å–µ–π–Ω", restaurant:"–†–µ—Å—Ç–æ—Ä–∞–Ω", spa:"–°–ø–∞", bar:"–ë–∞—Ä", cafe:"–ö–∞—Ñ–µ", shop:"–ú–∞–≥–∞–∑–∏–Ω", toilet:"–¢—É–∞–ª–µ—Ç", reception:"–†–µ—Å–µ–ø—à–µ–Ω", beach:"–ü–ª—è–∂", kidsclub:"–î–µ—Ç—Å–∫–∏–π –∫–ª—É–±", elevator:"–õ–∏—Ñ—Ç", gate:"–í—Ö–æ–¥/–≤–æ—Ä–æ—Ç–∞", parking:"–ü–∞—Ä–∫–æ–≤–∫–∞", shuttle:"–®–∞—Ç—Ç–ª", gym:"–°–ø–æ—Ä—Ç–∑–∞–ª"},
      nav:{depart:"–ù–∞—á–∞—Ç—å", arrive:"–ü—Ä–∏–±—ã—Ç–∏–µ", turn_left:"–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ª–µ–≤–æ", turn_right:"–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–æ", straight:"–î–≤–∏–≥–∞–π—Ç–µ—Å—å –ø—Ä—è–º–æ", roundabout:"–ù–∞ –∫—Ä—É–≥–æ–≤–æ–º —Å—ä–µ–∑–¥–µ ‚Äî —Å—ä–µ–∑–¥ ‚Ññ%n", onto:" –Ω–∞ %s"}
  },
  pl:{searchPH:"Szukaj: restauracja, spa, basen‚Ä¶", go:"Jed≈∫",
      ui:{pickStart:"Wybierz start", pickDest:"Wybierz cel", followOn:"üìç Moja lokalizacja: W≈Ç", followOff:"üìç Moja lokalizacja: Wy≈Ç", reset:"Resetuj", clearRoute:"Wyczy≈õƒá trasƒô"},
      labels:{name:"Nazwa", category:"Typ", hours:"Godziny", level:"Poziom", desc:"Opis"},
      cats:{pool:"Basen", restaurant:"Restauracja", spa:"Spa", bar:"Bar", cafe:"Kawiarnia", shop:"Sklep", toilet:"Toaleta", reception:"Recepcja", beach:"Pla≈ºa", kidsclub:"Klub dzieciƒôcy", elevator:"Winda", gate:"Brama/Wej≈õcie", parking:"Parking", shuttle:"Shuttle", gym:"Si≈Çownia"},
      nav:{depart:"Start", arrive:"Meta", turn_left:"Skrƒôƒá w lewo", turn_right:"Skrƒôƒá w prawo", straight:"Jed≈∫ prosto", roundabout:"Na rondzie zjed≈∫ zjazdem nr %n", onto:" na %s"}
  }
};
var SUP_LANGS = ['tr','en','ru','de','pl'];
var LANG = localStorage.getItem("lang");
if (!LANG) {
  var navLang = (navigator.language || navigator.userLanguage || 'en').slice(0,2).toLowerCase();
  LANG = SUP_LANGS.indexOf(navLang)>-1 ? navLang : 'en';
  localStorage.setItem('lang', LANG);
}
function t(){ return I18N[LANG] || I18N.tr; }
function norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,''); }

/* synonyms */
var SYNONYMS = {
  bar:['bar','–±–∞—Ä'],
  cafe:['cafe','caf√©','kafe','–∫–∞—Ñ–µ','kawiarnia'],
  restaurant:['restoran','restaurant','restauracja','—Ä–µ—Å—Ç–æ—Ä–∞–Ω','gastst√§tte'],
  pool:['havuz','pool','basen','–±–∞—Å—Å–µ–π–Ω','schwimmbad'],
  spa:['spa','wellness','—Å–ø–∞','sauna'],
  shop:['shop','market','marketplace','sklep','–º–∞–≥–∞–∑–∏–Ω','boutique','butik'],
  toilet:['wc','toilet','tuvalet','≈Çazienka','toaleta','—Ç—É–∞–ª–µ—Ç'],
  reception:['reception','resepsiyon','recepcja','—Ä–µ—Å–µ–ø—à–µ–Ω','front desk'],
  beach:['beach','plaj','pla≈ºa','–ø–ª—è–∂','strand'],
  kidsclub:['kids club','kidsclub','mini club','miniclub','–¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±','club dzieciƒôcy'],
  elevator:['elevator','lift','asans√∂r','–ª–∏—Ñ—Ç','winda','aufzug'],
  gate:['gate','kapƒ±','giri≈ü','brama','eingang','–≤–æ—Ä–æ—Ç–∞'],
  parking:['parking','otopark','parkplatz','–ø–∞—Ä–∫–æ–≤–∫–∞'],
  shuttle:['shuttle','servis','bus','autobus','—à–∞—Ç—Ç–ª'],
  gym:['gym','fitness','spor salonu','fitnessstudio','si≈Çownia'],
  info:['info','information','bilgi','–∏–Ω—Ñ–æ','informacja'],
  shoping:['shopping','alƒ±≈üveri≈ü','—Ç–æ—Ä–≥–æ–≤–ª—è','zakupy'],
  pier:['pier','iskele','molo','–ø—Ä–∏—á–∞–ª']
};
var KEYWORD_TO_CAT = (function(){var m={}; Object.keys(SYNONYMS).forEach(function(k){ SYNONYMS[k].forEach(function(w){ m[norm(w)]=k; }); }); return m;})();

/* ================== MAP ================== */
var baseStyle = {version:8, glyphs:"https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key="+MAPTILER_KEY, sources:{}, layers:[{id:"bg",type:"background",paint:{"background-color":"#dfe7e7"}}]};
var map = new maplibregl.Map({ container:'map', style:baseStyle, center:[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2], zoom:16, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEARING, maxZoom:21, attributionControl:false });
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), 'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'¬© aihotelstech'}));

/* DOM */
function $(id){ return document.getElementById(id); }
var langSel=$('lang'), q=$('q'), goBtn=$('go'), pickStartBtn=$('pickStart'), pickDestBtn=$('pickDest'), followBtn=$('follow'), resetBtn=$('reset'), results=$('results'), acc=$('acc');
var dirBox=$('dir'), dirSum=$('dirSum'), dirSub=$('dirSub'), dirList=$('dirList'), collapseDir=$('collapseDir'), clearRouteBtn=$('clearRoute');
var baseSat=$('baseSat'), base3d=$('base3d');

/* State */
var allFeats=[], followState=false, lastKnown=null;
var pickMode='none'; // 'start' | 'dest' | 'none'
var startCoord=null, destCoord=null;

/* Helpers */
function emptyFC(){return {type:'FeatureCollection',features:[]};}
function linkify(text){ return (text||'').replace(/(https?:\/\/[^\s<>"']+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); }
function nameInAnyLang(p){ return p['name_'+LANG] || p.name || p.name_tr || p.name_en || p.name_ru || p.name_de || p.name_pl || ''; }

/* ===== DERƒ∞N Lƒ∞NK ===== */
var DEEP_LINK = (function(){
  var p = new URL(location.href).searchParams;
  return {
    dest:   p.get('dest'),
    autoGo: p.get('autoGo') === '1',
    follow: p.get('follow') === '1',
    lang:   p.get('lang') || null
  };
})();

/* Uygulama dili (link ile geldiyse) */
if (DEEP_LINK.lang && SUP_LANGS.indexOf(DEEP_LINK.lang)>-1) { LANG = DEEP_LINK.lang; applyLang(); }

/* ============== KATMANLAR ============== */
map.on('load', function(){
  // Satellite
  map.addSource('sat',{ type:'raster',
    tiles:["https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token="+MAPBOX_TOKEN],
    tileSize:256, attribution:"¬© Mapbox ¬© OSM"
  });
  map.addLayer({id:'sat-lyr', type:'raster', source:'sat'});

  // OSM raster
  map.addSource('osmRaster',{ type:'raster',
    tiles:["https://api.maptiler.com/maps/streets/256/{z}/{x}/{y}.png?key="+MAPTILER_KEY],
    tileSize:256, attribution:"¬© OpenMapTiles ¬© OpenStreetMap contributors"
  });
  map.addLayer({id:'osm-raster', type:'raster', source:'osmRaster',
    paint:{'raster-opacity': OSM_VISIBLE ? OSM_OPACITY : 0}});

  // 3D
  map.addSource('omt',{ type:'vector', url:"https://api.maptiler.com/tiles/v3/tiles.json?key="+MAPTILER_KEY });
  map.addSource('dem',{ type:'raster-dem', url:"https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key="+MAPTILER_KEY, tileSize:256 });
  map.addLayer({ id:'bldg-3d', type:'fill-extrusion', source:'omt', 'source-layer':'building', layout:{visibility:'none'},
    paint:{'fill-extrusion-color':'#b9c9d6','fill-extrusion-opacity':0.85,'fill-extrusion-height':['coalesce', ['to-number',['get','render_height']], ['to-number',['get','height']], 6],'fill-extrusion-base':['coalesce', ['to-number',['get','render_min_height']], ['to-number',['get','min_height']], 0]}, minzoom:14 });

  // POI/√ßizimler
  map.addSource('indoor',{type:'geojson', data:emptyFC(), promoteId:'fid'});
  map.addSource('outdoor',{type:'geojson', data:emptyFC(), promoteId:'fid'});
  map.addSource('routes',{type:'geojson', data:emptyFC(), promoteId:'fid'}); // ROUTES aƒüƒ±

  addFeatureLayers('indoor'); addFeatureLayers('outdoor');

  // ROUTES g√∂r√ºn√ºm√º
  map.addLayer({id:'routes-casing', type:'line', source:'routes',
    paint:{'line-color':'#ffffff','line-width':['+',['coalesce',['to-number',['get','width']],['to-number',['get','stroke_w']],2.4],2],'line-opacity':0.6},
    layout:{'line-cap':'round','line-join':'round'}, minzoom:10
  });
  map.addLayer({id:'routes-net', type:'line', source:'routes',
    paint:{
      'line-color': ['coalesce',['get','stroke'], ['get','fill'], '#6c9f90'],
      'line-width' : ['coalesce',['to-number',['get','width']],['to-number',['get','stroke_w']],['to-number',['get','stroke-width']],2.4],
      'line-opacity': ['coalesce', ['to-number',['get','stroke_op']], 1]
    },
    layout:{'line-cap':'round','line-join':'round'}, minzoom:10
  });

  // hedef/rota/bluedot/start
  map.addSource('start',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'start-pt',type:'circle',source:'start',paint:{'circle-radius':7,'circle-color':'#22c55e','circle-stroke-color':'#fff','circle-stroke-width':1.8}});

  map.addSource('dest',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'dest-pt',type:'circle',source:'dest',paint:{'circle-radius':7,'circle-color':'#ef4444','circle-stroke-color':'#fff','circle-stroke-width':1.8}});

  map.addSource('route',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'route-line',type:'line',source:'route',paint:{'line-color':'#1b7a5b','line-width':4}, layout:{'line-cap':'round','line-join':'round'}});
  map.addLayer({id:'route-arrows',type:'symbol',source:'route',
    layout:{'symbol-placement':'line','text-field':'‚ñ∂','text-size':12,'symbol-spacing':50,'text-rotation-alignment':'map','text-keep-upright':false},
    paint:{'text-color':'#1b7a5b','text-halo-color':'#fff','text-halo-width':1}});

  // BLUEDOT
  map.addSource('me',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'me-pt',type:'circle',source:'me',paint:{'circle-radius':6,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1.6}});

  // JSON'larƒ± y√ºkle
  loadJSONs().then(function(){
    if (DEEP_LINK.dest) deepLinkSetDestinationByToken(DEEP_LINK.dest, true);
    if (DEEP_LINK.follow) { followState=true; followBtn.textContent=t().ui.followOn; if(lastKnown) map.easeTo({center:lastKnown}); }
    applyLang();
    applyBasemap();
    map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING});
  });

  // SIM bluedot
  if (SIMULATE_ME){
    setMe(SIM_ME_COORD, SIM_ME_ACC_M);
    followState = true;
    followBtn.textContent = t().ui.followOn;
    map.easeTo({center: SIM_ME_COORD});
  }
});

/* √ñzellik katmanlarƒ± */
function addFeatureLayers(src){
  map.addLayer({id:src+'-fill',type:'fill',source:src,paint:{'fill-color':['coalesce',['get','fill'],'#2563eb'],'fill-opacity':['coalesce',['get','fill_op'],0.35]}});
  map.addLayer({id:src+'-fill-outline',type:'line',source:src,filter:['==',['geometry-type'],'Polygon'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],1.6]}});
  map.addLayer({id:src+'-line',type:'line',source:src,filter:['==',['geometry-type'],'LineString'],paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],2.5]}});
  map.addLayer({id:src+'-pts',type:'circle',source:src,filter:['==',['geometry-type'],'Point'],paint:{'circle-radius':['coalesce',['get','icon_sz'],6],'circle-color':['coalesce',['get','stroke'],'#e53935'],'circle-stroke-color':'#fff','circle-stroke-width':1.6}});
}

/* JSON Y√ºkleme */
function safeJson(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
function errLog(tag){ return function(e){ console.error('['+tag+'.json] y√ºklenemedi:', (e&&e.message)||e); return emptyFC(); }; }

function ensureFid(fc, prefix){
  if(!fc || !Array.isArray(fc.features)) return fc;
  fc.features.forEach(function(f,i){ if(!f.properties) f.properties={}; if(!f.properties.fid) f.properties.fid=prefix+'-'+i+'-'+(f.id||'x'); });
  return fc;
}
function validateRoutes(fc){
  if(!fc || fc.type!=='FeatureCollection'){ console.warn('routes.json FeatureCollection deƒüil'); return false; }
  var hasLS = (fc.features||[]).some(function(f){return f.geometry && f.geometry.type==='LineString';});
  if(!hasLS){ console.warn('routes.json i√ßinde LineString yok'); return false; }
  return true;
}
function autoZoomToRoutes(fc){
  var f = (fc.features||[]).filter(function(g){return g.geometry && g.geometry.type==='LineString';});
  if(!f.length) return;
  var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  f.forEach(function(ft){ (ft.geometry.coordinates||[]).forEach(function(xy){var x=xy[0],y=xy[1]; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y;}); });
  if(!isFinite(minX)) return;
  var curr = map.getBounds();
  var intersects = !(maxX<curr.getWest() || minX>curr.getEast() || maxY<curr.getSouth() || minY>curr.getNorth());
  if(!intersects) map.fitBounds([[minX,minY],[maxX,maxY]], {padding:PADDING, maxZoom:18});
}

function loadJSONs(){
  var bust='v='+Date.now();
  return Promise.all([
    fetch('indoor.json?'+bust,{cache:'no-store'}).then(safeJson).catch(errLog('indoor')),
    fetch('outdoor.json?'+bust,{cache:'no-store'}).then(safeJson).catch(errLog('outdoor')),
    fetch('routes.json?'+bust,{cache:'no-store'}).then(safeJson).catch(errLog('routes'))
  ]).then(function(arr){
    var rawIndoor=arr[0], rawOutdoor=arr[1], routes=arr[2];
    var indoor  = ensureFid(rawIndoor,  'in');
    var outdoor = ensureFid(rawOutdoor, 'out');

    map.getSource('indoor').setData(indoor||emptyFC());
    map.getSource('outdoor').setData(outdoor||emptyFC());

    var validRoutes = validateRoutes(routes) ? routes : emptyFC();
    map.getSource('routes').setData(validRoutes);

    var indoorFs = (indoor && indoor.features ? indoor.features : []).map(function(f){var o={}; for(var k in f) o[k]=f[k]; o.__src='indoor'; return o;});
    var outdoorFs = (outdoor && outdoor.features ? outdoor.features : []).map(function(f){var o={}; for(var k in f) o[k]=f[k]; o.__src='outdoor'; return o;});
    allFeats = indoorFs.concat(outdoorFs);

    buildRouteGraphMeters(validRoutes);
    autoZoomToRoutes(validRoutes);
  });
}

/* ================== BASMAP TOGGLE ================== */
baseSat.addEventListener('change', applyBasemap);
base3d.addEventListener('change', applyBasemap);
function applyBasemap(){
  var osmOpacity = OSM_VISIBLE ? OSM_OPACITY : 0;
  if(base3d.checked){
    map.setLayoutProperty('bldg-3d','visibility','visible');
    map.setTerrain({source:'dem', exaggeration:1});
    if(!map.getLayer('sky')){
      map.addLayer({ id:'sky', type:'sky', paint:{'sky-type':'atmosphere','sky-atmosphere-sun':[0,45],'sky-atmosphere-sun-intensity':10} });
    }
  }else{
    if(map.getLayer('sky')) map.removeLayer('sky');
    map.setTerrain(null);
    map.setLayoutProperty('bldg-3d','visibility','none');
  }
  if(map.getLayer('osm-raster')) map.setPaintProperty('osm-raster','raster-opacity',osmOpacity);
}

/* ================== Dƒ∞L ================== */
function applyLang(){
  var L=t(); $('q').placeholder=L.searchPH; $('go').textContent=L.go;
  $('pickStart').textContent=L.ui.pickStart; $('pickDest').textContent=L.ui.pickDest; $('reset').textContent=L.ui.reset;
  followBtn.textContent = followState ? L.ui.followOn : L.ui.followOff;
  clearRouteBtn.textContent=L.ui.clearRoute; localStorage.setItem('lang',LANG);
}
langSel.value=LANG;
langSel.addEventListener('change', function(){LANG=langSel.value; applyLang();});

/* ================== ARAMA ================== */
function detectCategory(qs){
  var nq=norm(qs), dict=(I18N[LANG] && I18N[LANG].cats) || {};
  for(var k in dict){ if(!dict.hasOwnProperty(k)) continue; var label=dict[k]; if(norm(label).indexOf(nq)>-1 || nq.indexOf(norm(label))>-1) return k; }
  return KEYWORD_TO_CAT[nq] || null;
}
q.addEventListener('input', function(){
  var val=(q.value||'').trim();
  if(!val){ results.style.display='none'; return; }
  var qn=norm(val), maybeCat=detectCategory(val);
  var hits = allFeats.filter(function(f){
    var p=f.properties||{}; var cat=(p.category||'').toLowerCase();
    if(maybeCat && cat===maybeCat) return true;
    var names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
    if(names.some(function(n){return n.indexOf(qn)>-1;})) return true;
    var ex=[p.desc,p['desc_'+LANG],p.level,p['level_'+LANG],p.hours,p['hours_'+LANG]].filter(Boolean).map(norm);
    return ex.some(function(d){return d.indexOf(qn)>-1;});
  });
  renderResults(hits, maybeCat);
});

function renderResults(list, cat){
  results.innerHTML='';
  var hint=document.createElement('div'); hint.className='hint'; hint.textContent='üîé Sonu√ßlardan birine dokun';
  results.appendChild(hint);

  if(cat){
    var feats=allFeats.filter(function(f){return ((f.properties && f.properties.category) ? f.properties.category.toLowerCase() : '')===cat;});
    var div=document.createElement('div'); div.className='item'; div.dataset.fid='__cat__'+cat;
    div.innerHTML='<span>‚û§ '+((t().cats && t().cats[cat])||cat)+'</span> <small>'+feats.length+'</small>';
    results.appendChild(div);
  }
  list.slice(0,80).forEach(function(f,idx){
    var p=f.properties||{}; var meta=[p.category||'', p.level||'', (f.__src==='indoor'?'Indoor':'Outdoor')].filter(Boolean).join(' ¬∑ ');
    var div=document.createElement('div'); div.className='item';
    div.dataset.fid = p.fid || ('tmp-'+idx);
    div.dataset.src = f.__src;
    div.innerHTML='<span>'+(nameInAnyLang(p)||'(isimsiz)')+'</span><small>'+meta+'</small>';
    results.appendChild(div);
  });
  results.style.display='block';
}

/* sonu√ß tƒ±klanƒ±nca: popup + git */
results.addEventListener('click', function(e){
  var item=e.target.closest('.item'); if(!item) return;
  var fid=item.dataset.fid;
  if(fid && fid.indexOf('__cat__')===0){ results.style.display='none'; return; }
  var f=allFeats.find(function(x){return x.properties && x.properties.fid===fid;});
  if(!f) return;
  var center=coordOfFeature(f);
  document.getElementById('sheet').style.setProperty('--panel-ty','0px');
  showPopup(f, Array.isArray(center)?center:[center.lng,center.lat], true);
  setDestination(Array.isArray(center)?center:[center.lng,center.lat]);
  results.style.display='none';
  goBtn.disabled = !(startCoord || lastKnown);
});

/* ================== KONUM (BLUEDOT) ================== */
if ('geolocation' in navigator && !SIMULATE_ME){
  try{ navigator.geolocation.getCurrentPosition(function(){},function(){}, {enableHighAccuracy:true, timeout:10000}); }catch(e){}
  navigator.geolocation.watchPosition(function(p){
    var accM = Math.round(p.coords.accuracy||999);
    setMe([p.coords.longitude, p.coords.latitude], accM);
  }, function(err){
    console.warn('geo error',err);
  }, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
}

followBtn.onclick=function(){ followState=!followState; followBtn.textContent = followState ? t().ui.followOn : t().ui.followOff; if(followState && lastKnown) map.easeTo({center:lastKnown}); };

/* ================== HEDEF & BA≈ûLANGI√á SE√áƒ∞Mƒ∞ ================== */
pickStartBtn.onclick=function(){ pickMode = pickMode==='start' ? 'none' : 'start'; pickStartBtn.classList.toggle('active', pickMode==='start'); pickDestBtn.classList.remove('active'); };
pickDestBtn.onclick =function(){ pickMode = pickMode==='dest'  ? 'none' : 'dest';  pickDestBtn.classList.toggle('active',  pickMode==='dest');  pickStartBtn.classList.remove('active'); };

map.on('click', function(e){
  if(pickMode==='start'){
    startCoord=[e.lngLat.lng,e.lngLat.lat];
    map.getSource('start').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:startCoord}}]});
    pickMode='none'; pickStartBtn.classList.remove('active');
    if(destCoord) goBtn.disabled=false;
  }else if(pickMode==='dest'){
    destCoord=[e.lngLat.lng,e.lngLat.lat];
    map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:destCoord}}]});
    pickMode='none'; pickDestBtn.classList.remove('active');
    if(startCoord || lastKnown) goBtn.disabled=false;
  }else{
    var feats = map.queryRenderedFeatures(e.point, {layers:['indoor-pts','outdoor-pts','indoor-fill','outdoor-fill','indoor-line','outdoor-line','indoor-fill-outline','outdoor-fill-outline']});
    if(feats && feats[0]) showPopup(feats[0], e.lngLat, true);
  }
});

function setDestination(xy){
  destCoord=xy;
  map.getSource('dest').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:xy}}]});
}

/* =========================
   ROTA ‚Äì METRE, SNAP & GE√áƒ∞Cƒ∞ D√úƒû√úM
   ========================= */
var RULER = cheapRuler(36.862, 'meters'); // ortalama enlem
var SPEED = { walk: 1.35, shuttle: 6.0 };

var ROUTES_FC = null;
var GRAPH = null; // {nodes:[{id,xy}], adj:{id:[{to,w}]}, key2id:Map, _temp:{nodes:[],edges:[]} }

function key7(xy){ return xy[0].toFixed(7)+','+xy[1].toFixed(7); }
function metersAB(a,b){ return RULER.distance([a[0],a[1]],[b[0],b[1]]); }
function lineMeters(coords){ var s=0; for(var i=1;i<coords.length;i++) s+=metersAB(coords[i-1],coords[i]); return s; }
function bearingAB(a,b){ if (a[0]===b[0] && a[1]===b[1]) return 0; return turf.bearing(turf.point(a), turf.point(b)); }

// Grafƒ± kur (metre bazlƒ±)
function buildRouteGraphMeters(routesFC){
  ROUTES_FC = routesFC;
  var nodes=[], adj={}, key2id=new Map();

  function getId(xy){
    var k=key7(xy);
    if(key2id.has(k)) return key2id.get(k);
    var id=nodes.length;
    key2id.set(k,id); nodes.push({id:id, xy:[xy[0],xy[1]]}); adj[id]=[];
    return id;
  }
  function addEdge(aId,bId,w){ adj[aId].push({to:bId, w:w}); adj[bId].push({to:aId, w:w}); }

  var feats=(routesFC && routesFC.features) ? routesFC.features : [];
  for(var fi=0; fi<feats.length; fi++){
    var f = feats[fi];
    if(!f.geometry || f.geometry.type!=='LineString') continue;
    var c=f.geometry.coordinates||[];
    for(var i=1;i<c.length;i++){
      var A=c[i-1], B=c[i];
      var aId=getId(A), bId=getId(B);
      addEdge(aId,bId, metersAB(A,B));
    }
  }
  GRAPH = {nodes:nodes, adj:adj, key2id:key2id, _temp:{nodes:[],edges:[]} };
  if (GRAPH.nodes.length===0) console.warn('routes.json bo≈ü veya LineString yok; rota √ºretilemez.');
}

// overlay yardƒ±mcƒ±larƒ±
function beginOverlay(){ if(!GRAPH._temp) GRAPH._temp={nodes:[],edges:[]}; }
function addTempNode(xy){
  var id=GRAPH.nodes.length;
  GRAPH.nodes.push({id:id, xy:[xy[0],xy[1]]});
  GRAPH.adj[id]=[]; GRAPH._temp.nodes.push(id);
  return id;
}
function addTempEdge(aId,bId,w){
  GRAPH.adj[aId].push({to:bId,w:w}); GRAPH.adj[bId].push({to:aId,w:w});
  GRAPH._temp.edges.push([aId,bId,w]);
}
function endOverlay(){ /* k√º√ß√ºk √∂l√ßekte temizlik gerekli deƒüil */ }

// t√ºm route √ßizgileri i√ßinde snap
function snapToNetworkAllRoutes(pointLngLat){
  var best = {dist:Infinity, snap:null, segA:null, segB:null, feature:null, index:-1};
  var feats = (ROUTES_FC && ROUTES_FC.features) ? ROUTES_FC.features : [];
  for (var fi=0; fi<feats.length; fi++){
    var f = feats[fi];
    if(!f.geometry || f.geometry.type!=='LineString') continue;

    var snap = turf.nearestPointOnLine(f, turf.point(pointLngLat), {units:'meters'});
    var props = (snap && snap.properties) ? snap.properties : {};
    var d = (typeof props.dist==='number') ? props.dist : Infinity;

    if(d < best.dist){
      var coords = f.geometry.coordinates || [];
      var idx = (typeof props.index==='number') ? props.index : 0;
      idx = Math.max(0, Math.min(coords.length-2, idx));

      best.dist = d;
      best.snap = (snap && snap.geometry) ? snap.geometry.coordinates : null;
      best.feature = f;
      best.index = idx;
      best.segA = coords[idx];
      best.segB = coords[idx+1];
    }
  }
  return best;
}

// snap noktasƒ±nƒ± graf‚Äôa ge√ßici d√ºƒü√ºm olarak ekle
function insertTempNodeIntoGraph(snapObj){
  var snap = snapObj.snap, segA = snapObj.segA, segB = snapObj.segB;
  if(!snap || !segA || !segB) return null;

  var aId = GRAPH.key2id.get(key7(segA));
  var bId = GRAPH.key2id.get(key7(segB));
  if(aId==null || bId==null) return null;

  var sId = addTempNode(snap);
  addTempEdge(aId, sId, metersAB(segA, snap));
  addTempEdge(sId, bId, metersAB(snap, segB));
  return sId;
}

// Dijkstra
function dijkstra(startId,endId){
  var N=GRAPH.nodes.length, dist=new Array(N).fill(Infinity), prev=new Array(N).fill(-1), used=new Array(N).fill(false);
  dist[startId]=0;
  for(var k=0;k<N;k++){
    var u=-1,b=Infinity; for(var i=0;i<N;i++) if(!used[i] && dist[i]<b){b=dist[i];u=i;}
    if(u===-1) break; used[u]=true; if(u===endId) break;
    var adjU = GRAPH.adj[u]||[];
    for(var j=0;j<adjU.length;j++){
      var e = adjU[j];
      if(used[e.to]) continue;
      var alt=dist[u]+e.w; if(alt<dist[e.to]){dist[e.to]=alt; prev[e.to]=u;}
    }
  }
  if(prev[endId]===-1 && startId!==endId) return null;
  var path=[]; var cur=endId; while(cur!==-1){ path.push(cur); if(cur===startId) break; cur=prev[cur]; }
  return path.reverse();
}

// adƒ±m adƒ±m y√∂nlendirme
function makeTurnByTurn(coords){
  var steps=[];
  for(var i=1;i<coords.length;i++){
    var segM=metersAB(coords[i-1],coords[i]);
    var instr='straight';
    if(i<coords.length-1){
      var d0 = bearingAB(coords[i-1],coords[i+0]);
      var d1 = bearingAB(coords[i],coords[i+1]);
      var d = ((d1 - d0 + 540) % 360) - 180;
      if(d>35) instr='turn_right'; else if(d<-35) instr='turn_left';
    }
    steps.push({i:i, meters:segM, instr:instr});
  }
  return steps;
}

// rotayƒ± hesapla + √ßiz
function computeRouteSnapAndDraw(startLngLat, destLngLat, mode){
  if(mode===undefined) mode='walk';
  if(!ROUTES_FC || !GRAPH || !GRAPH.nodes || !GRAPH.adj) throw new Error('Graph not ready');

  beginOverlay();
  var sSnap=snapToNetworkAllRoutes(startLngLat);
  var tSnap=snapToNetworkAllRoutes(destLngLat);
  if(!sSnap.snap || !tSnap.snap) throw new Error('Snap failed');

  var sId=insertTempNodeIntoGraph(sSnap);
  var tId=insertTempNodeIntoGraph(tSnap);
  if(sId==null || tId==null) throw new Error('Temp node failed');

  var nodePath=dijkstra(sId,tId);
  if(!nodePath || !nodePath.length) throw new Error('No route');

  var pathCoords=nodePath.map(function(id){ return GRAPH.nodes[id].xy; });

  var routeFC={ type:'FeatureCollection', features:[{type:'Feature', properties:{mode:mode}, geometry:{type:'LineString', coordinates:pathCoords}}] };
  if(map.getSource('route')) map.getSource('route').setData(routeFC);

  var totalMeters=lineMeters(pathCoords);
  var totalSec = totalMeters / (SPEED[mode]||SPEED.walk);
  var steps=makeTurnByTurn(pathCoords);

  endOverlay();
  return { routeGeojson:routeFC, steps:steps, totalMeters:totalMeters, totalSec:totalSec };
}

function fmtMeters(m){ return m>=1000 ? (m/1000).toFixed(2)+' km' : Math.round(m)+' m'; }
function fmtMinutes(s){ return Math.max(1, Math.round(s/60))+' dk'; }

/* Rota hesapla */
goBtn.onclick = function(){
  var srcStart = startCoord || lastKnown;
  var srcDest  = destCoord;
  if(!srcDest){ alert(LANG==='tr'?'Hedef se√ßilmedi.':'No destination.'); return; }
  if(!srcStart){ alert(LANG==='tr'?'Ba≈ülangƒ±√ß yok (konum ya da se√ßim).':'No start.'); return; }

  try{
    var mode = 'walk';
    var res = computeRouteSnapAndDraw(srcStart, srcDest, mode);
    var routeCoords = res.routeGeojson.features[0].geometry.coordinates;
    var ex = bboxFromCoords(routeCoords);
    if(ex) map.fitBounds([[ex[0],ex[1]],[ex[2],ex[3]]], {padding:PADDING, maxZoom:18});

    dirList.innerHTML='';
    var Lnav=t().nav;
    res.steps.forEach(function(st){
      var label = st.instr==='turn_right' ? Lnav.turn_right
                 : st.instr==='turn_left' ? Lnav.turn_left
                 : Lnav.straight;
      var el=document.createElement('div'); el.className='step';
      el.innerHTML = '<div>'+st.i+'.</div><div><div>'+label+'</div><div class="muted" style="font-size:12px">'+fmtMeters(st.meters)+'</div></div>';
      dirList.appendChild(el);
    });
    dirSum.textContent = fmtMeters(res.totalMeters)+' ¬∑ '+fmtMinutes(res.totalSec)+' ('+mode+')';
    dirSub.textContent = '¬∑ routes.json ¬∑ snap+temp';
    dirBox.style.display='block';
  }catch(e){
    console.warn(e);
    alert(LANG==='tr'?'Rota hesaplanamadƒ±.':'Route failed.');
  }
};

/* ================== POPUP (k√º√ß√ºk) ================== */
var popup;
function showPopup(f,lngLat,withGo){
  var p=f.properties||{}, L=t();
  var name = p['name_'+LANG] || p.name || '';
  var catKey=(p.category||'').toLowerCase(); var catLabel=(L.cats && L.cats[catKey]) || p.category || '';
  var hours = p['hours_'+LANG] || p.hours || ''; var level=p['level_'+LANG]||p.level||''; var desc=p['desc_'+LANG]||p.desc||''; var img=p['image_'+LANG]||p.image||'';
  var btn = withGo? '<div style="margin-top:8px"><button class="goto-btn" data-x="'+(Array.isArray(lngLat)?lngLat[0]:lngLat.lng)+'" data-y="'+(Array.isArray(lngLat)?lngLat[1]:lngLat.lat)+'">'+(L.go||'Git')+' ‚ûú</button></div>' : '';
  var html = '<div style="min-width:220px">'
      +'<div style="font-weight:600;margin-bottom:6px;color:#0f5132">'+name+'</div>'
      +(catLabel?'<div class="badge">'+catLabel+'</div>':'')
      +(hours?'<div style="margin-top:6px"><small>'+L.labels.hours+':</small> '+hours+'</div>':'')
      +(level?'<div><small>'+L.labels.level+':</small> '+level+'</div>':'')
      +(desc?'<div style="margin-top:6px" class="muted">'+linkify(desc)+'</div>':'')
      +(/^https?:\/\//i.test(img)?'<div style="margin-top:6px"><img src="'+img+'" alt=""></div>':'')
      +btn
      +'</div>';
  (popup||(popup=new maplibregl.Popup({closeButton:true, closeOnClick:true}))).setLngLat(lngLat).setHTML(html).addTo(map);
}
document.addEventListener('click', function(e){
  var btn=e.target.closest && e.target.closest('.goto-btn'); if(!btn) return;
  var x=parseFloat(btn.dataset.x), y=parseFloat(btn.dataset.y);
  setDestination([x,y]);
  goBtn.disabled = !(startCoord || lastKnown);
  if(!goBtn.disabled) goBtn.click();
});

/* ================== Yardƒ±mcƒ±lar ================== */
function hav(a,b){ var R=6371000; function toRad(x){return x*Math.PI/180;} var dLat=toRad(b[1]-a[1]); var dLon=toRad(b[0]-a[0]); var sa=Math.sin(dLat/2), sb=Math.sin(dLon/2); var aa=sa*sa + Math.cos(toRad(a[1]))*Math.cos(toRad(b[1]))*sb*sb; return 2*R*Math.asin(Math.sqrt(aa)); }
function lengthOf(coords){ var sum=0; for(var i=1;i<coords.length;i++) sum+=hav(coords[i-1],coords[i]); return sum; }
function fmtDist(m){ return m>=1000 ? (m/1000).toFixed(2)+' km' : Math.round(m)+' m'; }
function clearDestination(){ map.getSource('dest').setData(emptyFC()); destCoord=null; }
function clearStart(){ map.getSource('start').setData(emptyFC()); startCoord=null; }
function clearRoute(){ map.getSource('route').setData(emptyFC()); dirBox.style.display='none'; dirList.innerHTML=''; dirSum.textContent='‚Äì'; dirSub.textContent=''; }
clearRouteBtn.onclick=function(){clearRoute();};
collapseDir.onclick=function(){ var s=getComputedStyle(dirList).display; dirList.style.display= s==='none' ? 'block':'none'; collapseDir.textContent = s==='none' ? '‚ñ≤':'‚ñº'; };

function closePopup(){ if(popup) popup.remove(); }
function coordOfFeature(f){
  var g=f.geometry; if(!g) return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
  if(g.type==='Point') return g.coordinates;
  if(g.type==='Polygon'){ var ring=g.coordinates[0]; return ring[Math.floor(ring.length/2)]; }
  if(g.type==='LineString'){ var c=g.coordinates; return c[Math.floor(c.length/2)]; }
  return [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
}
function bboxFromCoords(coords){ var minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; coords.forEach(function(xy){ var x=xy[0],y=xy[1]; if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y; }); return (isFinite(minX)&&isFinite(minY)&&isFinite(maxX)&&isFinite(maxY))?[minX,minY,maxX,maxY]:null; }

function setMe(xy, accM){ if(accM===undefined) accM=5;
  lastKnown = xy;
  var meSrc = map.getSource('me');
  if (meSrc) {
    meSrc.setData({type:'FeatureCollection',features:[{type:'Feature', properties:{acc:accM}, geometry:{type:'Point', coordinates:xy}}]});
  }
  acc.textContent = "¬±"+accM+" m";
  acc.style.display='block';
  if (followState) map.easeTo({center:lastKnown});
  goBtn.disabled = !(startCoord || lastKnown);
}

/* Bottom sheet: drag + click-to-toggle */
(function(){
  var sheet=$('sheet'), grab=$('grab');
  var H_GRAB=24; // kapalƒ±yken g√∂r√ºnen
  var setTy=function(v){ sheet.style.setProperty('--panel-ty',v+'px'); };
  var getTy=function(){ return parseFloat(getComputedStyle(sheet).getPropertyValue('--panel-ty'))||0; };
  function maxTravel(){
    var h=sheet.getBoundingClientRect().height||320;
    var byH=Math.max(0,h-(H_GRAB+8));
    var byV=Math.min(window.innerHeight*0.6,520);
    return Math.min(byH,byV);
  }
  var MAX=0, sy=null, st=0;
  function recalc(){ MAX=maxTravel(); setTy(Math.min(getTy(),MAX)); }
  window.addEventListener('resize',recalc);
  // BA≈ûLANGI√áTA KAPALI (sadece tutacak) ‚Äî √∂nemli!
  requestAnimationFrame(function(){ recalc(); setTy(MAX); });

  grab.addEventListener('pointerdown',function(e){ sy=e.clientY; st=getTy(); grab.setPointerCapture(e.pointerId); });
  grab.addEventListener('pointermove',function(e){ if(sy==null)return; var dy=e.clientY-sy; setTy(Math.max(0,Math.min(MAX,st+dy))); });
  function end(){ if(sy==null)return; var ty=getTy(); setTy(ty>MAX*0.5?MAX:0); sy=null; }
  grab.addEventListener('pointerup',end); grab.addEventListener('pointercancel',end);

  // Tek tƒ±kla a√ß/kapa
  grab.addEventListener('click',function(){ var ty=getTy(); setTy(ty===0?MAX:0); });

  // Arama odakta iken otomatik a√ß
  $('q').addEventListener('focus',function(){ setTy(0); });
})();

/* Reset */
resetBtn.onclick=function(){
  closePopup(); clearRoute(); clearDestination(); clearStart();
  q.value=''; results.style.display='none';
  pickMode='none'; pickStartBtn.classList.remove('active'); pickDestBtn.classList.remove('active');
  document.getElementById('sheet').style.setProperty('--panel-ty','0px');
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING,maxZoom:19,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING});
};

/* Deep link yardƒ±mcƒ±larƒ± */
function getFeatByToken(token){
  if(!token) return null;
  var val = token.replace(/^fid:|^name:/i,'').trim();
  if (token.indexOf('fid:')===0){
    return allFeats.find(function(f){
      var fid = (f.properties && f.properties.fid) ? f.properties.fid : '';
      return fid === val;
    }) || null;
  } else {
    var nv = norm(val);
    return allFeats.find(function(f){
      var p=f.properties||{};
      var names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
      return names.some(function(n){return n.indexOf(nv)>-1;});
    }) || null;
  }
}
function deepLinkSetDestinationByToken(token, openPopup){
  if (openPopup===undefined) openPopup=true;
  var f = getFeatByToken(token); if(!f) return false;
  var c = coordOfFeature(f); var xy = Array.isArray(c)?c:[c.lng,c.lat];
  setDestination(xy);
  if (openPopup) showPopup(f, xy, true);
  document.getElementById('sheet').style.setProperty('--panel-ty','0px');
  goBtn.disabled = !(startCoord || lastKnown);
  return true;
}
</script>
</body>
</html>
