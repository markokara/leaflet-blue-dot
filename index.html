<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir – Regnum Harita (Otel Odaklı)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; --bg:#fff }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eef2f7}
    #map{position:fixed; inset:0; background:#eef2f7}

    .ol-attribution{font-size:10px; opacity:.85}
    .ol-attribution button{display:none}

    /* Alt panel: tek yerde tüm kontroller */
    .panel{position:fixed; left:50%; bottom:12px; transform:translateX(-50%); width:min(820px,96vw); z-index:1000;}
    .card{background:var(--bg); border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)}
    .p-8{padding:12px}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:8px}
    .grow{flex:1 1 auto}
    input[type="search"]{width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:10px}
    button{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}
    .muted{color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fff}
    .results{background:#fff; border:1px solid #e5e7eb; border-radius:10px; max-height:36vh; overflow:auto; display:none}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}
    .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}

    /* Popup */
    .ol-popup{position:absolute; background:#fff; padding:10px; border-radius:10px; border:1px solid #e5e7eb; min-width:220px; box-shadow:var(--shadow); transform:translate(-50%,-100%); }
    .ol-popup-closer{position:absolute; right:8px; top:6px; text-decoration:none; color:#9ca3af}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}
    .acc{position:fixed; right:12px; bottom:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
    @media (max-width:520px){ .panel{bottom:8px} }
  </style>
</head>
<body>

  <!-- tek panel -->
  <div class="panel">
    <div class="card p-8 stack">
      <div class="row">
        <input id="q" class="grow" type="search" placeholder="Ara: restoran, spa, havuz…" />
        <button id="go" disabled>Git</button>
        <select id="lang" aria-label="Language">
          <option value="tr" selected>TR</option><option value="en">EN</option><option value="ru">RU</option><option value="de">DE</option><option value="pl">PL</option>
        </select>
      </div>

      <div class="row">
        <button id="pick">Haritadan Hedef</button>
        <button id="follow">🎯 İzle: Kapalı</button>
        <button id="toggleDetails">Detaylar: Kapalı</button>
        <label class="pill"><input type="checkbox" id="tglIndoor" checked>Indoor</label>
        <label class="pill"><input type="checkbox" id="tglOutdoor" checked>Outdoor</label>
        <button id="toggle3d" disabled title="3B binalar bir sonraki adımda">3D: Kapalı</button>
        <button id="reset">Sıfırla</button>
        <span class="muted" id="hint" style="display:none">🔎 Arama açık</span>
      </div>

      <div id="results" class="results"></div>

      <div class="muted" style="font-size:11px; text-align:right">© aihotelstech · © OpenStreetMap contributors</div>
    </div>
  </div>

  <div id="acc" class="acc" style="display:none"></div>

  <!-- Popup -->
  <div id="popup" class="ol-popup" style="display:none">
    <a href="#" id="popup-closer" class="ol-popup-closer">✕</a>
    <div id="popup-content"></div>
  </div>

  <div id="map" aria-label="Harita"></div>

<script>
/* ========= İstatik veriler ========= */
const HOTEL_LINESTRING = [[31.804711464001883,36.601378910907385],[31.80265403917545,36.600205665606055],[31.80228664188482,36.59927492200508],[31.801600833608916,36.59833761252443],[31.801902915826247,36.59820651938169],[31.801976395283475,36.59825240200732],[31.80195190213155,36.59832450322001],[31.80176412129427,36.59838349507211],[31.802433600800782,36.59922903998816],[31.80257239533279,36.599130721288105],[31.80225398434746,36.59869156289729],[31.80216417612081,36.59871122675925],[31.802074367895585,36.598567024988114],[31.802224229838373,36.59848223989192],[31.80225339759994,36.5985234212358],[31.802273513296484,36.59851292403289],[31.802366045503817,36.598640505329385],[31.802302681058052,36.5986703819312],[31.802622365198403,36.59910955921026],[31.80345107307025,36.598610964313664],[31.803677172118256,36.59816572643476],[31.80429383960228,36.598196944127224],[31.80458040764242,36.59811821860225],[31.804579740317706,36.59806502337595],[31.804257091554604,36.5976458632729],[31.804193143410373,36.597673695149325],[31.80408873290395,36.597539234701244],[31.80411664632132,36.59752526382472],[31.804081706016063,36.597486963756765],[31.804272117712202,36.59739431772135],[31.804297367166782,36.59742987797935],[31.804422728913238,36.59757244834],[31.804353251330753,36.59763151097012],[31.804489463059923,36.597799011162465],[31.804661637424203,36.59803352121111],[31.805088805694538,36.597730157319674],[31.80537489466451,36.597723591172766],[31.80583999813655,36.59762552952847],[31.806107325335518,36.59750653297091],[31.806473403555856,36.59740452304936],[31.80686759670624,36.59735637365469],[31.806913667981235,36.597251340203414],[31.80664923641001,36.59676774251092],[31.806309307935692,36.596630095343556],[31.806214444095104,36.596660118307824],[31.806133641410156,36.596639459347216],[31.806122453111215,36.59655321675558],[31.806348827441155,36.59652758112688],[31.80661976083391,36.59662385860061],[31.806765735505564,36.59671322837097],[31.807013449339593,36.597141815362505],[31.80729857330894,36.59733611410664],[31.807488502502736,36.59734390028464],[31.807592567311843,36.597572273028405],[31.807432387298377,36.597695328783004],[31.807550121020626,36.597946607765536],[31.807869969017418,36.59842181682616],[31.807913361565653,36.59867675781673],[31.80761858192966,36.59917495531856],[31.806728829965323,36.59968858202838],[31.806145311443345,36.59993243233974],[31.805477016291206,36.60049991840026],[31.80540132525539,36.60062280770822],[31.804707974907046,36.60137777375523]];
const AREA_KM2 = 2; // yalnızca 2km² karelik alan gösterilecek

/* ========= yardımcılar ========= */
const $ = id=>document.getElementById(id);
const q=$('q'), go=$('go'), langSel=$('lang'), pickBtn=$('pick'), followBtn=$('follow'), toggleDetails=$('toggleDetails'), resetBtn=$('reset'), results=$('results'), acc=$('acc'), hint=$('hint'), tglIndoor=$('tglIndoor'), tglOutdoor=$('tglOutdoor');
const popupEl=$('popup'), popupCloser=$('popup-closer'), popupContent=$('popup-content');

/* ========= OSM + vektör katmanları ========= */
const base = new ol.layer.Tile({ source:new ol.source.OSM({attributions:'© aihotelstech · © OpenStreetMap contributors'}) });
const indoorSource  = new ol.source.Vector();
const outdoorSource = new ol.source.Vector();
const indoorLayer   = new ol.layer.VectorImage({ source:indoorSource,  style:styleFactory('indoor') });
const outdoorLayer  = new ol.layer.VectorImage({ source:outdoorSource, style:styleFactory('outdoor') });

/* ========= otel poligonu + 2km² clip ========= */
function lsToPoly3857(ls){
  const ring = ls.slice(); if(ring.length && (ring[0][0]!==ring.at(-1)[0] || ring[0][1]!==ring.at(-1)[1])) ring.push(ring[0]);
  const ring3857 = ring.map(c=> ol.proj.fromLonLat(c));
  return new ol.geom.Polygon([ring3857]);
}
const HOTEL_POLY_3857 = lsToPoly3857(HOTEL_LINESTRING);
const hotelExtent = HOTEL_POLY_3857.getExtent();
const center = ol.extent.getCenter(hotelExtent);
const side = Math.sqrt(AREA_KM2*1_000_000); // metre
const half = side/2;
const CLIP_EXTENT = [center[0]-half, center[1]-half, center[0]+half, center[1]+half];

base.setExtent(CLIP_EXTENT); // bu katman bu extent dışını çizmez

const map = new ol.Map({
  target:'map',
  layers:[base, indoorLayer, outdoorLayer],
  view:new ol.View({
    center:center, zoom:17, rotation:0, extent:CLIP_EXTENT, constrainOnlyCenter:false
  })
});
map.addControl(new ol.control.Rotate());
map.addControl(new ol.control.Attribution({collapsible:false}));

/* otel sınırını vurgula */
const hotelLayer = new ol.layer.Vector({
  source:new ol.source.Vector({features:[ new ol.Feature(HOTEL_POLY_3857.clone()) ]}),
  style:new ol.style.Style({ stroke:new ol.style.Stroke({color:'#ef4444',width:2}), fill:new ol.style.Fill({color:'rgba(239,68,68,0.06)'}) })
});
map.addLayer(hotelLayer);
map.getView().fit(CLIP_EXTENT,{padding:[120,20,160,20], maxZoom:19});

/* ========= stiller ========= */
let showAllDetails=false, searchIds=null;
const FEATURED=new Set(['reception','restaurant','spa','pool','beach','bar','toilet','kidsclub','elevator','gate','parking','shuttle','shop']);
function styleFactory(kind){
  return f=>{
    if(f.get('src')!==kind) return null;
    if(Array.isArray(searchIds)){
      const id=f.ol_uid||f.getId();
      return searchIds.includes(id) ? styleFor(f,1) : null;
    }
    const cat=(f.get('category')||'').toLowerCase();
    if(!showAllDetails && !FEATURED.has(cat)) return null;
    return styleFor(f,1);
  };
}
function styleFor(f,dim){
  const g=f.getGeometry();
  if(g.getType()==='Point'){
    return new ol.style.Style({
      image:new ol.style.Circle({radius:7, fill:new ol.style.Fill({color:`rgba(249,65,68,${0.95*dim})`}), stroke:new ol.style.Stroke({color:`rgba(193,18,31,${1*dim})`,width:2})})
    });
  }
  return new ol.style.Style({ stroke:new ol.style.Stroke({color:`rgba(37,99,235,${1*dim})`,width:2}), fill:new ol.style.Fill({color:`rgba(37,99,235,${.10*dim})`}) });
}
function redraw(){ indoorLayer.changed(); outdoorLayer.changed(); }

/* ========= popup ========= */
const popupOverlay=new ol.Overlay({element:popupEl, autoPan:{animation:{duration:200}}});
map.addOverlay(popupOverlay);
popupCloser.addEventListener('click',e=>{e.preventDefault(); hidePopup();});
function showPopup(f,coord){ popupContent.innerHTML = renderPopup(f); popupEl.style.display='block'; popupOverlay.setPosition(coord); }
function hidePopup(){ popupEl.style.display='none'; popupOverlay.setPosition(undefined); }
function renderPopup(f){
  const p=f.getProperties();
  const name=p.name_tr||p['name_'+(localStorage.getItem('lang')||'tr')]||p.name||'(isim yok)';
  const cat=(p.category||'').toLowerCase();
  const level=p.level||''; const hours=p.hours||'';
  return `<div style="min-width:220px"><div style="font-weight:600;margin-bottom:6px">${name}</div>
  ${cat?`<div class="badge">${cat}</div>`:''}
  ${hours?`<div style="margin-top:6px"><small>Saat:</small> ${hours}</div>`:''}
  ${level?`<div><small>Kat:</small> ${level}</div>`:''}</div>`;
}

/* ========= JSON yükle (sadece otel içinde) ========= */
const fmt=new ol.format.GeoJSON();
let allFeats=[];
function insideHotel(f){
  const g=f.getGeometry(); if(!g) return false;
  const t=g.getType();
  if(t==='Point') return HOTEL_POLY_3857.intersectsCoordinate(g.getCoordinates());
  return ol.extent.intersects(HOTEL_POLY_3857.getExtent(), g.getExtent());
}
async function loadJSONs(){
  const bust = 'v='+Date.now();
  const [indoor,outdoor] = await Promise.all([
    fetch('indoor.json?'+bust,{cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]})),
    fetch('outdoor.json?'+bust,{cache:'no-store'}).then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
  ]);
  indoorSource.clear(); outdoorSource.clear();
  const add=(src,gj,kind)=>{
    const fs=fmt.readFeatures(gj,{featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'});
    fs.forEach(f=>f.set('src',kind));
    src.addFeatures(fs.filter(insideHotel));
  };
  add(indoorSource,indoor,'indoor'); add(outdoorSource,outdoor,'outdoor');
  allFeats = indoorSource.getFeatures().concat(outdoorSource.getFeatures());
  redraw();
}
loadJSONs();

/* ========= arama + sonuç listesi ========= */
function norm(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
const SYNONYMS={ pool:['havuz','pool'], restaurant:['restoran','restaurant'], spa:['spa','wellness'], bar:['bar'], cafe:['cafe','kafe'], shop:['shop','market','magaza'], toilet:['wc','toilet','tuvalet'], reception:['reception','resepsiyon'], beach:['beach','plaj'], kidsclub:['kids club','kidsclub','çocuk'], elevator:['elevator','lift','asansör'], gate:['gate','kapı','giriş'], parking:['parking','otopark'], shuttle:['shuttle','servis','bus'], gym:['gym','fitness','spor'] };
const KEY2CAT=(()=>{const m={};Object.entries(SYNONYMS).forEach(([k,a])=>a.forEach(w=>m[norm(w)]=k));return m})();
function detectCat(q){ const nq=norm(q); for(const [k,arr] of Object.entries(SYNONYMS)) if(arr.some(v=>nq.includes(norm(v)))) return k; return null; }

q.addEventListener('input', ()=>{
  const val=(q.value||'').trim();
  if(!val){ searchIds=null; redraw(); results.style.display='none'; hint.style.display='none'; return; }
  const nq=norm(val); const maybeCat=detectCat(val);
  const hits=allFeats.filter(f=>{
    const p=f.getProperties(); const cat=(p.category||'').toLowerCase();
    if(maybeCat && cat===maybeCat) return true;
    const names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
    if(names.some(n=>n.includes(nq))) return true;
    const ex=[p.desc,p.level,p.hours].filter(Boolean).map(norm);
    return ex.some(d=>d.includes(nq));
  });
  buildResults(hits, maybeCat);
  searchIds = hits.map(f=> f.ol_uid||f.getId());
  redraw(); hint.style.display='inline';
});
q.addEventListener('keydown',e=>{ if(e.key==='Enter'){ const first=results.querySelector('.item'); if(first){ first.click(); e.preventDefault(); } } });

function buildResults(list,cat){
  results.innerHTML='';
  const hint=document.createElement('div'); hint.className='hint'; hint.textContent='🔎 Arama aktif: sadece eşleşenler'; results.appendChild(hint);

  if(cat){
    const feats=allFeats.filter(f=> (f.get('category')||'').toLowerCase()===cat);
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<span>➤ ${cat}</span><small>${feats.length}</small>`;
    div.onclick=()=>{
      if(!feats.length) return;
      searchIds = feats.map(f=> f.ol_uid||f.getId()); redraw();
      const ext=ol.extent.createEmpty(); feats.forEach(f=> ol.extent.extend(ext,f.getGeometry().getExtent()));
      map.getView().fit(ext,{padding:[120,20,160,20], maxZoom:18});
      results.style.display='none';
    };
    results.appendChild(div);
  }

  list.slice(0,80).forEach(f=>{
    const div=document.createElement('div'); div.className='item';
    const name= f.get('name_tr')||f.get('name')||'(isimsiz)';
    const meta=[f.get('src')==='indoor'?'Indoor':'Outdoor', f.get('category')||'', f.get('level')||''].filter(Boolean).join(' · ');
    div.innerHTML=`<span>${name}</span><small>${meta}</small>`;
    div.onclick=()=>{
      searchIds=[f.ol_uid||f.getId()]; redraw();
      focusAndFlash(f); showPopup(f,coordOf(f));
      results.style.display='none'; go.disabled=false;
    };
    results.appendChild(div);
  });

  results.style.display='block';
}

/* ========= hover/flash: "canlanma" ========= */
let lastHover=null;
map.on('pointermove', (evt)=>{
  let hovered=null;
  map.forEachFeatureAtPixel(evt.pixel,(f,l)=>{ if(l===indoorLayer||l===outdoorLayer) hovered=f; });
  if(hovered){
    const id=hovered.ol_uid||hovered.getId();
    if(id!==lastHover){ lastHover=id; flash(hovered); }
  }else lastHover=null;
});
function focusAndFlash(f){
  const g=f.getGeometry(), ext=g.getExtent();
  map.getView().fit(ext,{padding:[120,20,160,20], maxZoom:18});
  // küçük zoom-geri animasyon
  const v=map.getView(), z=v.getZoom(); v.animate({zoom:z+0.6,duration:180},{zoom:z,duration:180});
  flash(f);
}
function coordOf(f){
  const g=f.getGeometry();
  if(g.getType()==='Point') return g.getCoordinates();
  if(g.getType()==='Polygon') return g.getInteriorPoint().getCoordinates();
  return g.getFirstCoordinate();
}
function flash(feature){
  const geom = feature.getGeometry();
  const asPoint = (()=>{
    if(geom.getType()==='Point') return geom.clone();
    const c = coordOf(feature); return new ol.geom.Point(c);
  })();
  const duration = 1200;
  const start = Date.now();
  const listener = map.on('postrender', (e)=>{
    const elapsed = e.frameState.time - start;
    const ratio = Math.min(elapsed/duration,1);
    const rad = 5 + 28*ol.easing.easeOut(ratio);
    const op  = 1 - ratio;

    const vc = ol.render.getVectorContext(e);
    vc.setStyle(new ol.style.Style({
      image:new ol.style.Circle({radius:rad, stroke:new ol.style.Stroke({color:`rgba(239,68,68,${op})`, width:3})})
    }));
    vc.drawGeometry(asPoint);
    map.render();
    if(elapsed>duration) ol.Observable.unByKey(listener);
  });
}

/* ========= UI: toggles & reset ========= */
tglIndoor.onchange=()=> indoorLayer.setVisible(tglIndoor.checked);
tglOutdoor.onchange=()=> outdoorLayer.setVisible(tglOutdoor.checked);
toggleDetails.onclick=()=>{ if(toggleDetails.disabled) return; showAllDetails=!showAllDetails; toggleDetails.textContent=showAllDetails?'Detaylar: Açık':'Detaylar: Kapalı'; redraw(); };

const popupOverlayRef = popupOverlay; // to keep ref alive

/* ========= kullanıcı konumu (opsiyonel) ========= */
let userLayer=null,userPoint=null,accCircle=null,follow=false,watchId=null;
function ensureUser(){
  if(userLayer) return;
  userPoint=new ol.Feature(new ol.geom.Point([0,0]));
  userPoint.setStyle(new ol.style.Style({ image:new ol.style.Circle({radius:6, fill:new ol.style.Fill({color:'#1d4ed8'}), stroke:new ol.style.Stroke({color:'#fff',width:1.8})}) }));
  accCircle=new ol.Feature(new ol.geom.Circle([0,0],1));
  accCircle.setStyle(new ol.style.Style({ stroke:new ol.style.Stroke({color:'#1d4ed8',width:1}), fill:new ol.style.Fill({color:'rgba(29,78,216,.06)'}) }));
  userLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[accCircle,userPoint]}) });
  map.addLayer(userLayer);
}
(function watch(){
  if(!('geolocation' in navigator)) return;
  try{ if(watchId!==null) navigator.geolocation.clearWatch(watchId);}catch{}
  watchId=navigator.geolocation.watchPosition(pos=>{
    const c=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]); ensureUser();
    userPoint.getGeometry().setCoordinates(c); accCircle.getGeometry().setCenter(c); accCircle.getGeometry().setRadius(pos.coords.accuracy||0);
    acc.textContent="±"+Math.round(pos.coords.accuracy||0)+" m"; acc.style.display='block';
    if(follow) map.getView().animate({center:c,duration:200});
  },()=>{}, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
})();
followBtn.onclick=()=>{ follow=!follow; followBtn.textContent=follow?'🎯 İzle: Açık':'🎯 İzle: Kapalı';
  if(follow && userPoint) map.getView().setCenter(userPoint.getGeometry().getCoordinates());
};

/* ========= hedef & “Git” (rota yok – 3. adımda devam) ========= */
let destLayer=null,destPoint=null,pickMode=false;
function setDestination(coord){
  if(!destLayer){
    destPoint=new ol.Feature(new ol.geom.Point(coord));
    destPoint.setStyle(new ol.style.Style({ image:new ol.style.Circle({radius:7, fill:new ol.style.Fill({color:'#ef4444'}), stroke:new ol.style.Stroke({color:'#fff',width:1.8})}) }));
    destLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[destPoint]}) });
    map.addLayer(destLayer);
  } else destPoint.getGeometry().setCoordinates(coord);
  go.disabled=false;
}
function clearDestination(){ if(destLayer){ map.removeLayer(destLayer); destLayer=null; destPoint=null; } }
pickBtn.onclick=()=>{ pickMode=!pickMode; pickBtn.classList.toggle('active',pickMode); };
map.on('click',evt=>{
  if(pickMode){ setDestination(evt.coordinate); pickMode=false; pickBtn.classList.remove('active'); return; }
  let f=null; [indoorLayer,outdoorLayer].forEach(l=> map.forEachFeatureAtPixel(evt.pixel,(feat,lay)=>{ if(lay===l) f=feat; }));
  if(f){ focusAndFlash(f); showPopup(f,coordOf(f)); }
});
go.onclick=()=>{ if(destPoint){ focusAndFlash(destPoint); } };

/* ========= reset ========= */
resetBtn.onclick=()=>{
  hidePopup(); results.style.display='none'; q.value='';
  searchIds=null; redraw(); clearDestination();
  loadJSONs(); // taze veriler
};

/* ========= sonuç ========= */
function coordOf(f){const g=f.getGeometry(); if(g.getType()==='Point') return g.getCoordinates(); if(g.getType()==='Polygon') return g.getInteriorPoint().getCoordinates(); return g.getFirstCoordinate(); }
</script>
</body>
</html>
