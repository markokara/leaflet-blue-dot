<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Admin â€“ Indoor/Outdoor + Paths EditÃ¶r</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Ã‡izim: Mapbox-GL-Draw (MapLibre uyumlu) -->
<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet"/>
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>

<style>
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{position:fixed; inset:0}
  .panel{position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10;
    background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    padding:10px; width:calc(100% - 20px); max-width:1120px}
  .row{display:flex; flex-wrap:wrap; gap:8px}
  .row>*{flex:1 1 auto; min-width:120px}
  button,select,input[type="file"]{padding:10px 12px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer}
  .pill{padding:4px 8px; font-size:12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe}
  .hint{position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#111; color:#fff; font-size:12px; padding:6px 10px; border-radius:8px; z-index:12; display:none}
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:11}
  .card{background:#fff; width:min(780px,92vw); padding:14px; border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid label{font-size:12px; color:#555}
  .grid input,.grid select,.grid textarea{padding:10px; border:1px solid #ddd; border-radius:8px; width:100%}
  textarea{min-height:76px}
  .actions{display:flex; justify-content:space-between; gap:8px; margin-top:10px}
  .danger{border-color:#ffb3b3; background:#fff0f0}
  .primary{border-color:#b3d7ff; background:#f0f7ff}
  .toggle{display:flex; align-items:center; gap:8px}
</style>
</head>
<body>
<div id="map"></div>
<div id="hint" class="hint"></div>

<div class="panel">
  <div class="row" style="margin-bottom:8px">
    <select id="target">
      <option value="outdoor">Aktif: OUTDOOR</option>
      <option value="indoor">Aktif: INDOOR</option>
      <option value="paths">Aktif: PATHS (Yollar)</option>
    </select>
    <button id="btnPoint" class="primary">âž• Nokta</button>
    <button id="btnLine" class="primary">âž• Ã‡izgi</button>
    <button id="btnPoly" class="primary">âž• Poligon</button>
    <button id="btnSelect">â˜‘ SeÃ§ / Ã–zellik</button>
    <button id="btnDuplicate">ðŸ“„ Kopyala</button>
    <label class="toggle"><input type="checkbox" id="toggle3d"> 3D Ã–nizleme</label>
    <span class="pill">SeÃ§ili Ã¶ÄŸeye <b>Ã§ift tÄ±k</b>: Ã–zellik formu â€” <b>Ctrl+D</b>: Kopya</span>
  </div>
  <div class="row">
    <button id="dlIndoor">â¤“ indoor.json</button>
    <button id="dlOutdoor">â¤“ outdoor.json</button>
    <button id="dlPaths">â¤“ paths.json</button>
    <label style="display:flex;gap:6px;align-items:center">â¤’ JSON YÃ¼kle<input id="imp" type="file" accept=".json,application/json"></label>
    <button id="clearLocal" class="danger">ðŸ§¹ Yerel Veriyi Temizle</button>
  </div>
</div>

<!-- Ã–zellik formu -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="card">
    <h3>Ã–zellikler</h3>
    <div class="grid">
      <div><label>Ä°sim</label><input id="name"></div>
      <div><label>Kategori (restaurant, bar, pool, building, pathâ€¦)</label><input id="category" placeholder="pool"></div>
      <div><label>Saatler</label><input id="hours"></div>
      <div><label>Seviye/Kat</label><input id="level" placeholder="0, 1, B1"></div>

      <div style="grid-column:1/-1"><label>AÃ§Ä±klama</label>
        <textarea id="desc" placeholder="Tam URL yazarsan misafir panelde tÄ±klanÄ±r."></textarea></div>
      <div style="grid-column:1/-1"><label>FotoÄŸraf/Ä°kon URL</label><input id="image" placeholder="https://.../foto.jpg"></div>

      <div><label>Dolgu Rengi (hex)</label><input id="fill" placeholder="09DCE4"></div>
      <div><label>Ã‡izgi Rengi (hex)</label><input id="stroke" placeholder="1b7a5b"></div>
      <div><label>Ã‡izgi KalÄ±nlÄ±ÄŸÄ± (px)</label><input id="stroke_w" type="number" step="0.5" value="2"></div>
      <div><label>Ä°kon Boyutu (px)</label><input id="icon_sz" type="number" min="8" step="1" value="22"></div>

      <div><label>YÃ¼kseklik (m)</label><input id="height" type="number" step="0.5" placeholder="3"></div>
      <div><label>Kat SayÄ±sÄ±</label><input id="levels" type="number" step="1" placeholder="1"></div>

      <!-- Yol Ã¶zellikleri -->
      <div><label>Yol Modu</label>
        <select id="mode">
          <option value="">(yol deÄŸil)</option>
          <option value="walk">Yaya</option>
          <option value="bike">Bisiklet</option>
          <option value="shuttle">Shuttle</option>
          <option value="service">Servis</option>
        </select>
      </div>
      <div><label>Tek YÃ¶n?</label>
        <select id="oneway">
          <option value="">HayÄ±r</option>
          <option value="true">Evet</option>
        </select>
      </div>
      <div><label>EriÅŸim</label>
        <select id="access">
          <option value="">VarsayÄ±lan</option>
          <option value="yes">AÃ§Ä±k</option>
          <option value="private">GÃ¶revli</option>
          <option value="no">Girilmez</option>
        </select>
      </div>

      <div><label>Ä°Ã§ mekÃ¢n?</label>
        <select id="indoor">
          <option value="auto" selected>Aktif hedefe gÃ¶re</option>
          <option value="true">Evet (indoor)</option>
          <option value="false">HayÄ±r (outdoor)</option>
        </select>
      </div>

      <div style="grid-column:1/-1"><label>Ã–ÄŸe ID</label><input id="fid" disabled></div>
    </div>

    <div class="actions">
      <div style="display:flex;gap:8px">
        <button id="btnGeom" class="pill">Geometriyi DÃ¼zenle</button>
        <button id="btnDelete" class="danger">Sil</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnSave" class="primary">Kaydet</button>
        <button id="btnClose">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= AYAR ========= */
const MAPTILER_KEY="YOUR_MAPTILER_KEY";
const HOTEL_BBOX=[31.801445,36.597411,31.808467,36.600917];

/* ========= HARÄ°TA ========= */
const map=new maplibregl.Map({
  container:'map',
  style:`https://api.maptiler.com/maps/streets/style.json?key=ym4UWHwsNK61YUsmqi5C`,
  center:[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2],
  zoom:17, pitch:0, bearing:0, maxZoom:22
});
map.on('load',()=> map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:20,maxZoom:19}));

/* ========= Ã‡Ä°ZÄ°M ========= */
const DEFAULT_MODE_COLORS = {walk:'#1b7a5b', bike:'#2563eb', shuttle:'#aa6f00', service:'#666'};
const Draw = new MapboxDraw({
  displayControlsDefault:false,
  controls:{trash:true},
  styles:[
    // Nokta
    {id:'gl-draw-point',type:'circle',filter:['all',['==','$type','Point'],['!=','mode','static']],
      paint:{'circle-radius':['coalesce',['get','icon_sz'],6],
             'circle-stroke-color':'#fff','circle-stroke-width':1.5,
             'circle-color':['case',['has','fill'],['concat','#',['get','fill']],'#f94144']}},
    // Ã‡izgi (paths + diÄŸer)
    {id:'gl-draw-line',type:'line',filter:['all',['==','$type','LineString'],['!=','mode','static']],
      paint:{
        'line-width':['coalesce',['get','stroke_w'],3],
        'line-color':[
          'case',
            ['has','stroke'], ['concat','#',['get','stroke']],
            ['==',['get','mode'],'bike'], DEFAULT_MODE_COLORS.bike,
            ['==',['get','mode'],'shuttle'], DEFAULT_MODE_COLORS.shuttle,
            ['==',['get','mode'],'service'], DEFAULT_MODE_COLORS.service,
            DEFAULT_MODE_COLORS.walk
        ],
        'line-opacity':0.95
      }},
    // Poligon
    {id:'gl-draw-polygon-fill',type:'fill',filter:['all',['==','$type','Polygon'],['!=','mode','static']],
      paint:{'fill-color':['case',['has','fill'],['concat','#',['get','fill']],'#09dce4'],'fill-opacity':0.25}},
    {id:'gl-draw-polygon-stroke',type:'line',filter:['all',['==','$type','Polygon'],['!=','mode','static']],
      paint:{'line-width':['coalesce',['get','stroke_w'],2],
             'line-color':['case',['has','stroke'],['concat','#',['get','stroke']],'#1b7a5b']}}
  ]
});
map.addControl(Draw);

/* Ä°puÃ§larÄ± */
const hint = msg => { const el=document.getElementById('hint'); if(!msg){el.style.display='none';return;} el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',1600); };

/* ========= UI ========= */
const $=id=>document.getElementById(id);
$('btnPoint').onclick=()=>{ Draw.changeMode('draw_point'); setDefaultsOnCreate(); hint('Haritaya tÄ±kla (Nokta)'); };
$('btnLine').onclick =()=>{ Draw.changeMode('draw_line_string'); setDefaultsOnCreate(); hint('Noktalarla yol Ã§iz â€“ Ã§ift tÄ±kla bitir'); };
$('btnPoly').onclick =()=>{ Draw.changeMode('draw_polygon'); setDefaultsOnCreate(); hint('Noktalarla poligon Ã§iz â€“ Ã§ift tÄ±kla bitir'); };
$('btnSelect').onclick=()=>{ Draw.changeMode('simple_select'); hint('SeÃ§im modu'); };

/* yeni oluÅŸanlara varsayÄ±lan layer/mode */
function setDefaultsOnCreate(){
  const target=$('target').value;
  const onCreate=(e)=>{
    e.features.forEach(f=>{
      const p=f.properties||{};
      p.layer = target;
      if(f.geometry.type==='LineString' && target==='paths'){ p.category='path'; p.mode=p.mode||'walk'; }
      Draw.setFeatureProperty(f.id,'layer',p.layer);
      if(p.mode) Draw.setFeatureProperty(f.id,'mode',p.mode);
    });
    map.off('draw.create', onCreate);
  };
  map.on('draw.create', onCreate);
}

/* ========= LOCAL STORAGE & EXPORT ========= */
function emptyFC(){return {type:'FeatureCollection',features:[]};}
const loadLocal=k=>{try{const s=localStorage.getItem(k); return s?JSON.parse(s):null;}catch{return null;}};
const saveLocal=(k,d)=>{try{localStorage.setItem(k,JSON.stringify(d));}catch(e){alert('Yerel depolama dolu olabilir.');}};
function dl(obj,name){ const b=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }

function splitByLayer(fc){
  const res={indoor:emptyFC(),outdoor:emptyFC(),paths:emptyFC()};
  (fc.features||[]).forEach(f=>{
    const p=f.properties||{};
    const layer=p.layer||'outdoor';
    if(layer==='paths' || p.category==='path' || p.mode){ res.paths.features.push(f); }
    else if(layer==='indoor'){ res.indoor.features.push(f); }
    else{ res.outdoor.features.push(f); }
  });
  return res;
}
function mergeToDraw(indoor,outdoor,paths){
  const all=emptyFC();
  [...(indoor?.features||[]),...(outdoor?.features||[]),...(paths?.features||[])]
    .forEach(f=> all.features.push(f));
  Draw.set(all);
  refresh3D(); // 3D kaynaÄŸÄ±nÄ± da gÃ¼ncelle
}

/* Ä°lk yÃ¼kleme */
(function init(){
  mergeToDraw(loadLocal('indoor')||emptyFC(), loadLocal('outdoor')||emptyFC(), loadLocal('paths')||emptyFC());
})();

/* Export butonlarÄ± */
$('dlIndoor').onclick=()=>{const sp=splitByLayer(Draw.getAll()); saveLocal('indoor',sp.indoor); dl(sp.indoor,'indoor.json');};
$('dlOutdoor').onclick=()=>{const sp=splitByLayer(Draw.getAll()); saveLocal('outdoor',sp.outdoor); dl(sp.outdoor,'outdoor.json');};
$('dlPaths').onclick  =()=>{const sp=splitByLayer(Draw.getAll()); saveLocal('paths',sp.paths); dl(sp.paths,'paths.json');};

/* Import (aktif hedefe ekler) */
$('imp').addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const json=JSON.parse(await file.text());
    const target=$('target').value;
    const current=Draw.getAll();
    (json.features||[]).forEach(f=>{ f.properties=f.properties||{}; f.properties.layer=target; current.features.push(f); });
    Draw.set(current);
    const sp=splitByLayer(current); saveLocal('indoor',sp.indoor); saveLocal('outdoor',sp.outdoor); saveLocal('paths',sp.paths);
    refresh3D();
    alert('YÃ¼klendi.');
  }catch{ alert('GeÃ§ersiz GeoJSON.'); }
  e.target.value='';
});

/* Temizle */
$('clearLocal').onclick=()=>{ if(confirm('Yerel veriyi silelim mi?')){ ['indoor','outdoor','paths'].forEach(k=>localStorage.removeItem(k)); Draw.set(emptyFC()); refresh3D(); } };

/* ========= Ã–ZELLÄ°K FORMU (Kaydet dÃ¼zeltildi) ========= */
const modal=$('modal'); const fld=id=>document.getElementById(id);
let editingId=null;

function openForm(id){
  editingId=id; const f=Draw.get(id); if(!f) return; const p=f.properties||{};
  fld('fid').value=id;
  ['name','category','hours','level','desc','image','fill','stroke'].forEach(k=> fld(k).value=p[k]||'');
  fld('stroke_w').value = p.stroke_w ?? 2;
  fld('icon_sz').value  = p.icon_sz ?? 22;
  fld('height').value   = p.height ?? '';
  fld('levels').value   = p.levels ?? p['building:levels'] ?? '';
  fld('mode').value     = p.mode || '';
  fld('oneway').value   = p.oneway ? 'true':'';
  fld('access').value   = p.access || '';
  fld('indoor').value   = (p.layer==='indoor')?'true':(p.layer==='outdoor')?'false':'auto';
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}
function closeForm(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); editingId=null; }

/* Ã§ift tÄ±kla form */
map.on('dblclick',()=>{
  const sel=Draw.getSelectedIds(); if(sel && sel[0]) openForm(sel[0]);
});

/* Kaydet â€” FIX: setFeatureProperty ile gÃ¼venli gÃ¼ncelleme */
$('btnSave').onclick=()=>{
  if(!editingId) return;
  const props={};
  ['name','category','hours','level','desc','image','fill','stroke'].forEach(k=>{
    const v=fld(k).value.trim(); if(v) props[k]=v; else props[k]=undefined;
  });
  const nums=[['stroke_w',parseFloat],['icon_sz',parseFloat],['height',parseFloat]];
  nums.forEach(([k,fn])=>{ const v=fn(fld(k).value); props[k]=Number.isFinite(v)?v:undefined; });
  const lv=parseInt(fld('levels').value,10); if(Number.isFinite(lv)){ props.levels=lv; props['building:levels']=lv; } else { props.levels=undefined; props['building:levels']=undefined; }
  const mode=fld('mode').value; props.mode = mode || undefined;
  props.oneway = (fld('oneway').value==='true') ? true : undefined;
  const acc=fld('access').value; props.access = acc || undefined;

  // layer/indoor kararÄ±
  const ind=fld('indoor').value;
  let layer=$('target').value;
  if(ind==='true') layer='indoor'; else if(ind==='false') layer='outdoor';
  props.layer = (props.mode||props.category==='path') ? 'paths' : layer;

  // uygula
  Object.entries(props).forEach(([k,v])=> Draw.setFeatureProperty(editingId,k,v));
  // local & 3D yenile
  const sp=splitByLayer(Draw.getAll()); saveLocal('indoor',sp.indoor); saveLocal('outdoor',sp.outdoor); saveLocal('paths',sp.paths);
  refresh3D(); hint('Kaydedildi'); closeForm();
};
$('btnDelete').onclick=()=>{ if(editingId && confirm('Silinsin mi?')){ Draw.delete(editingId); const sp=splitByLayer(Draw.getAll()); saveLocal('indoor',sp.indoor); saveLocal('outdoor',sp.outdoor); saveLocal('paths',sp.paths); refresh3D(); closeForm(); } };
$('btnGeom').onclick =()=>{ closeForm(); Draw.changeMode('direct_select',{featureId:editingId}); };
$('btnClose').onclick =()=> closeForm();

/* ========= KOPYALA (buton + Ctrl+D) ========= */
function duplicateSelected(){
  const ids=Draw.getSelectedIds(); if(!ids.length) { hint('Ã–nce bir Ã¶ÄŸe seÃ§'); return; }
  const f=Draw.get(ids[0]); if(!f) return;
  const clone=JSON.parse(JSON.stringify(f));
  // kÃ¼Ã§Ã¼k bir offset (yaklaÅŸÄ±k ~2m)
  const off=0.00002;
  const type=clone.geometry.type;
  const shiftCoord=c=>[c[0]+off,c[1]+off];
  if(type==='Point'){ clone.geometry.coordinates=shiftCoord(clone.geometry.coordinates); }
  else if(type==='LineString'){ clone.geometry.coordinates=clone.geometry.coordinates.map(shiftCoord); }
  else if(type==='Polygon'){ clone.geometry.coordinates=clone.geometry.coordinates.map(r=>r.map(shiftCoord)); }
  // id olmadan ekle
  delete clone.id;
  const current=Draw.getAll(); current.features.push(clone); Draw.set(current);
  refresh3D();
  hint('KopyalandÄ±');
}
$('btnDuplicate').onclick=duplicateSelected;
document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='d'){ e.preventDefault(); duplicateSelected(); } });

/* ========= 3D Ã–NÄ°ZLEME ========= */
map.on('load',()=>{
  map.addSource('extrude',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'extrude-3d',type:'fill-extrusion',source:'extrude',minzoom:15,
    paint:{
      'fill-extrusion-color':['case',['has','fill'],['concat','#',['get','fill']],'#d0c7bb'],
      'fill-extrusion-opacity':0.86,
      'fill-extrusion-height':['coalesce',['get','height'], ['*',['to-number',['get','levels']],3], 0],
      'fill-extrusion-base':0
    },
    layout:{visibility:'none'}
  });
});
$('toggle3d').onchange=()=>{ map.setLayoutProperty('extrude-3d','visibility', $('toggle3d').checked?'visible':'none'); refresh3D(); };

function refresh3D(){
  if(!map.getSource('extrude')) return;
  if(!$('toggle3d').checked){ map.getSource('extrude').setData(emptyFC()); return; }
  const all=Draw.getAll();
  const features=(all.features||[]).filter(f=>{
    return f.geometry?.type==='Polygon' && (
      (f.properties?.height!=null) ||
      (Number.isFinite(parseInt(f.properties?.levels))) ||
      (f.properties?.category==='building')
    );
  });
  map.getSource('extrude').setData({type:'FeatureCollection',features});
}

/* ========= diÄŸer ========= */
$('target').addEventListener('change',()=> hint('Aktif hedef: '+$('target').value.toUpperCase()));
</script>
</body>
</html>
