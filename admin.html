<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Admin ‚Äì OL D√ºzenleme ‚Ä¢ MapLibre 3D √ñnizleme (Satellite taban)</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Mapbox GL Draw (MapLibre uyumlu) -->
<link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css"/>
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>

<!-- Turf (geometri d√ºzelt) -->
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
  :root{
    --shadow:0 10px 28px rgba(0,0,0,.18);
    --border:#d6e2e0; --field:#f6fbf9; --chip:#eaf5ef;
    --brand:#0f5132; --muted:#6b7a7a;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eef6f2}
  #map{position:fixed; inset:0}

  .panel{position:fixed; left:50%; bottom:8px; transform:translateX(-50%); width:min(1020px,96vw); z-index:1000}
  .card{background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow)}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .col{display:flex; flex-direction:column; gap:8px}
  .p-8{padding:10px}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--chip)}
  .muted{color:var(--muted)}
  button, select, input[type="text"], input[type="number"], input[type="color"], input[type="search"]{
    border:1px solid var(--border); background:var(--field); border-radius:10px; padding:8px 10px; font:inherit
  }
  button{cursor:pointer} button:active{transform:translateY(1px)}
  .tiny{padding:6px 8px}
  .grow{flex:1 1 auto}

  dialog{border:none; border-radius:14px; width:min(920px,96vw); box-shadow:var(--shadow)}
  dialog::backdrop{background:rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
  .grid3{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px}
  .full{grid-column:1/-1}
  label small{display:block; color:#607070; margin-bottom:4px}
</style>
</head>
<body>

<div id="map" aria-label="Harita"></div>

<!-- ALT KONTROL PANELƒ∞ -->
<div class="panel">
  <div class="card p-8 col">

    <!-- √úst katman se√ßimi + OSM opaklƒ±k + filtre -->
    <div class="row">
      <select id="overlaySel" title="√úst Katman" class="grow">
        <option value="osm" selected>√úst Katman: OSM kƒ±lavuz (raster)</option>
        <option value="ml3d">√úst Katman: MapLibre 3D (terrain + binalar)</option>
      </select>
      <span class="badge">
        OSM opaklƒ±k
        <input id="osmOpacity" type="range" min="0" max="1" step="0.05" value="0.65" style="width:160px">
        <span id="opv" class="muted">0.65</span>
      </span>
      <span class="badge muted">Taban: Mapbox Satellite (her zaman altta)</span>
    </div>

    <div class="row">
      <select id="targetLayer">
        <option value="OUTDOOR" selected>Hedef katman: OUTDOOR</option>
        <option value="INDOOR">Hedef katman: INDOOR</option>
      </select>
      <input id="levelFilter" class="tiny" type="search" placeholder="Kat filtresi (√∂r: 1) ‚Äî bo≈ü=hepsi" style="min-width:220px">
      <label class="badge"><input type="checkbox" id="hiliteActive"> Aktif katman vurgulu</label>
      <label class="badge"><input type="checkbox" id="showArrows"> Yol y√∂n oklarƒ±</label>
      <span class="grow"></span>
      <button id="btnClrLocal" class="tiny">‚úì Yerel Veriyi Temizle</button>
    </div>

    <!-- √áizim & y√∂netim -->
    <div class="row">
      <button id="btnPoint">+ Nokta</button>
      <button id="btnLine">‚Üù √áizgi</button>
      <button id="btnPoly">‚ñ£ Poligon</button>
      <button id="btnSelect">‚òë Se√ß / √ñzellik</button>
      <button id="btnCopy" title="Se√ßili √∂zelliƒüi kopyala">‚éò Kopyala</button>
      <button id="btnFix"  title="Se√ßili geometriyi d√ºzelt (Turf)">üõ† Geometriyi D√ºzelt</button>
      <span class="grow"></span>
      <span class="badge">
        ‚Üë JSON Y√ºkle <input type="file" id="file" accept=".json">
      </span>
    </div>

    <!-- JSON i√ße/dƒ±≈üa -->
    <div class="row">
      <button id="dlIndoor"  class="tiny">‚Üì indoor.json</button>
      <button id="dlOutdoor" class="tiny">‚Üì outdoor.json</button>
      <button id="dlBuildings" class="tiny">‚Üì buildings.json</button>
      <button id="dlRoutes"    class="tiny">‚Üì routes.json</button>
    </div>

  </div>
</div>

<!-- √ñZELLƒ∞K Dƒ∞YALOƒûU -->
<dialog id="propDlg">
  <form method="dialog" id="propForm">
    <div class="p-8 col">
      <div class="row" style="justify-content:space-between">
        <strong style="color:#0f5132">√ñzellikler</strong>
        <div>
          <button value="cancel" class="tiny">Kapat</button>
          <button id="saveProps" class="tiny" value="default">Kaydet</button>
        </div>
      </div>

      <!-- Genel alanlar -->
      <div class="grid">
        <label><small>ƒ∞sim (varsayƒ±lan)</small><input type="text" id="p_name"></label>
        <label><small>Kategori</small>
          <select id="p_category">
            <option value="">(bo≈ü)</option>
            <option>restaurant</option><option>bar</option><option>cafe</option>
            <option>spa</option><option>pool</option><option>toilet</option>
            <option>reception</option><option>kidsclub</option><option>elevator</option>
            <option>stair</option><option>shop</option><option>gym</option>
            <option>beach</option><option>shuttle</option><option>parking</option>
            <option>gate</option><option>info</option><option>building</option>
            <option>green</option><option>forest</option>
            <option>road</option><option>walkway</option><option>cycleway</option>
          </select>
        </label>
        <label><small>Seviye/Kat (varsayƒ±lan)</small><input type="text" id="p_level" placeholder="√∂rn: 1, B1"></label>
        <label><small>√áalƒ±≈üma Saatleri (varsayƒ±lan)</small><input type="text" id="p_hours" placeholder="09:00-23:00"></label>
        <label class="full"><small>A√ßƒ±klama (varsayƒ±lan)</small><input type="text" id="p_desc" placeholder="Kƒ±sa a√ßƒ±klama veya link"></label>
      </div>

      <!-- Stil & 3D -->
      <div class="grid3">
        <label><small>Dolgu Rengi</small><input type="color" id="p_fill" value="#09DCE4"></label>
        <label><small>√áizgi Rengi</small><input type="color" id="p_stroke" value="#1b7a5b"></label>
        <label><small>√áizgi Kalƒ±nlƒ±ƒüƒ± (px)</small><input type="number" id="p_stroke_w" value="2" min="0" step="0.5"></label>
        <label><small>ƒ∞kon Boyutu (px)</small><input type="number" id="p_icon_sz" value="6" min="1" step="1"></label>
        <label><small>Y√ºkseklik (metre)</small><input type="number" id="p_height" value="0" min="0" step="1"></label>
        <label class="full"><small>Foto/ƒ∞kon URL (varsayƒ±lan)</small><input type="text" id="p_image" placeholder="https://... (PNG/SVG/JPG/WebP)"></label>
      </div>

      <!-- √áok dilli alanlar -->
      <div class="grid full">
        <div>
          <label><small>Dil</small>
            <select id="locLang">
              <option value="tr" selected>T√ºrk√ße (tr)</option>
              <option value="en">English (en)</option>
              <option value="ru">–†—É—Å—Å–∫–∏–π (ru)</option>
              <option value="de">Deutsch (de)</option>
              <option value="pl">Polski (pl)</option>
            </select>
          </label>
        </div>
        <div class="muted" style="align-self:end">Bu b√∂l√ºm se√ßili dil i√ßin <code>name_XX / hours_XX / level_XX / desc_XX / image_XX</code> alanlarƒ±nƒ± yazar.</div>
      </div>
      <div class="grid">
        <label><small>ƒ∞sim (se√ßili dil)</small><input type="text" id="p_name_loc"></label>
        <label><small>Saatler (se√ßili dil)</small><input type="text" id="p_hours_loc"></label>
        <label><small>Seviye/Kat (se√ßili dil)</small><input type="text" id="p_level_loc"></label>
        <label><small>G√∂rsel URL (se√ßili dil)</small><input type="text" id="p_image_loc"></label>
        <label class="full"><small>A√ßƒ±klama (se√ßili dil)</small><input type="text" id="p_desc_loc"></label>
      </div>

      <input type="hidden" id="p_fid">
      <div class="muted">ƒ∞pucu: Renk alanlarƒ±nda # otomatik eklenir. Poligonlarda **Y√ºkseklik** deƒüeri 3D modunda ekstr√ºzyon olarak g√∂r√ºn√ºr.</div>
    </div>
  </form>
</dialog>

<script>
/*** === ANAHTARLAR === ***/
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";  // ‚Üê doldur
const MAPTILER_KEY = "ym4UWHwsNK61YUsmqi5C";  // ‚Üê doldur

/*** === SABƒ∞TLER === ***/
const HOTEL_BBOX=[31.801445,36.597411,31.808467,36.600917];
const CENTER=[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
const DEFAULT_PITCH=45, DEFAULT_BEARING=0;
const PAD={top:20,right:20,bottom:260,left:20};

/*** === HARƒ∞TA === ***/
const blankStyle={version:8,glyphs:`https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${MAPTILER_KEY}`,sources:{},layers:[{id:"bg",type:"background",paint:{"background-color":"#dfe7e7"}}]};
const map=new maplibregl.Map({container:'map',style:blankStyle,center:CENTER,zoom:16,pitch:DEFAULT_PITCH,bearing:DEFAULT_BEARING,maxZoom:21,attributionControl:false});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), 'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'¬© aihotelstech'}));

/* Satellite taban (her zaman altta) */
map.on('load',()=>{
  map.addSource('sat',{type:'raster',tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`],tileSize:256,attribution:"¬© Mapbox ¬© OSM"});
  map.addLayer({id:'sat-lyr',type:'raster',source:'sat'});
});

/* OSM kƒ±lavuz (raster) */
map.on('load',()=>{
  map.addSource('osm',{type:'raster',tiles:[`https://a.tile.openstreetmap.org/{z}/{x}/{y}.png`],tileSize:256,attribution:"¬© OpenStreetMap"});
  map.addLayer({id:'osm-lyr',type:'raster',source:'osm',paint:{'raster-opacity':0.65}});
});

/* MapLibre 3D (OMT + DEM) */
map.on('load',()=>{
  map.addSource('omt',{type:'vector',url:`https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`});
  map.addSource('dem',{type:'raster-dem',url:`https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key=${MAPTILER_KEY}`,tileSize:256});
  // rehber yollar
  map.addLayer({id:'roads',type:'line',source:'omt','source-layer':'transportation',
    layout:{visibility:'none'},paint:{'line-color':'#ffffff','line-width':['interpolate',['linear'],['zoom'],10,0.5,14,2,17,4],'line-opacity':0.8}});
  // 3D binalar (OMT)
  map.addLayer({id:'bldg-3d',type:'fill-extrusion',source:'omt','source-layer':'building',
    layout:{visibility:'none'},
    paint:{
      'fill-extrusion-color':'#b9c9d6','fill-extrusion-opacity':0.85,
      'fill-extrusion-height':['coalesce',['to-number',['get','render_height']],['to-number',['get','height']],6],
      'fill-extrusion-base':['coalesce',['to-number',['get','render_min_height']],['to-number',['get','min_height']],0]
    },minzoom:14});
});

/*** === √úST KATMAN SE√áENEKLERƒ∞ / OPAKLIK === ***/
const overlaySel=$('#overlaySel'), osmOpacity=$('#osmOpacity'), opv=$('#opv');
overlaySel.addEventListener('change',applyOverlay);
osmOpacity.addEventListener('input',()=>{
  opv.textContent=osmOpacity.value;
  if(map.getLayer('osm-lyr')) map.setPaintProperty('osm-lyr','raster-opacity',parseFloat(osmOpacity.value));
});
function applyOverlay(){
  const val=overlaySel.value;
  if(val==='osm'){
    map.setTerrain(null);
    if(map.getLayer('sky')) map.removeLayer('sky');
    ['roads','bldg-3d','indoor-3d','outdoor-3d'].forEach(l=> map.getLayer(l)&&map.setLayoutProperty(l,'visibility','none'));
    map.getLayer('osm-lyr')&&map.setLayoutProperty('osm-lyr','visibility','visible');
    osmOpacity.disabled=false;
  }else{
    map.getLayer('osm-lyr')&&map.setLayoutProperty('osm-lyr','visibility','none');
    map.setTerrain({source:'dem',exaggeration:1});
    if(!map.getLayer('sky')) map.addLayer({id:'sky',type:'sky',paint:{'sky-type':'atmosphere','sky-atmosphere-sun':[0,45],'sky-atmosphere-sun-intensity':10}});
    ['roads','bldg-3d','indoor-3d','outdoor-3d'].forEach(l=> map.getLayer(l)&&map.setLayoutProperty(l,'visibility','visible'));
    osmOpacity.disabled=true;
  }
}
map.on('load',()=>{ applyOverlay(); map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PAD,maxZoom:19}); });

/*** === VERƒ∞ KAYNAKLARI (√áƒ∞Zƒ∞MLER) === ***/
const sourcesDef=[{key:'indoor',color:'#2563eb'},{key:'outdoor',color:'#198754'}];
map.on('load',()=>{
  sourcesDef.forEach(def=>{
    map.addSource(def.key,{type:'geojson',data:loadLocal(def.key)||emptyFC(),promoteId:'fid'});
    addFeatureLayers(def.key,def.color);
  });
  addOur3DExtrusions();   // bizim poligonlarƒ±n 3D‚Äôsi
  refreshAll();           // filtreler & oklar & highlight
});

/* katmanlar */
function addFeatureLayers(src, color){
  map.addLayer({id:`${src}-fill`,type:'fill',source:src,
    paint:{'fill-color':['coalesce',['get','fill'],color],'fill-opacity':['coalesce',['get','fill_op'],0.35]}});
  map.addLayer({id:`${src}-fill-outline`,type:'line',source:src,filter:['==',['geometry-type'],'Polygon'],
    paint:{'line-color':['coalesce',['get','stroke'],color],'line-width':['coalesce',['get','stroke_w'],1.6]}});
  map.addLayer({id:`${src}-line`,type:'line',source:src,filter:['==',['geometry-type'],'LineString'],
    paint:{'line-color':['coalesce',['get','stroke'],color],'line-width':['coalesce',['get','stroke_w'],2.5]}});
  map.addLayer({id:`${src}-pts`,type:'circle',source:src,filter:['==',['geometry-type'],'Point'],
    paint:{'circle-radius':['coalesce',['get','icon_sz'],6],'circle-color':['coalesce',['get','stroke'],'#e53935'],'circle-stroke-color':'#fff','circle-stroke-width':1.6}});
}

/* bizim poligonlardan 3D ekstr√ºzyon (height alanƒ±na g√∂re) */
function addOur3DExtrusions(){
  ['indoor','outdoor'].forEach(src=>{
    map.addLayer({id:`${src}-3d`,type:'fill-extrusion',source:src,layout:{visibility:'none'},
      filter:['==',['geometry-type'],'Polygon'],
      paint:{
        'fill-extrusion-color':['coalesce',['get','fill'],'#a1c4d9'],
        'fill-extrusion-opacity':0.9,
        'fill-extrusion-height':['to-number',['coalesce',['get','height'],0]],
        'fill-extrusion-base':0
      }});
  });
}

/*** === DRAW (ekle/g√ºncelle/sil) === ***/
const Draw=new MapboxDraw({displayControlsDefault:false,styles:MapboxDraw.styles});
map.addControl(Draw,'top-right');

const btnPoint=$('#btnPoint'), btnLine=$('#btnLine'), btnPoly=$('#btnPoly'), btnSelect=$('#btnSelect'), btnCopy=$('#btnCopy'), btnFix=$('#btnFix');
btnPoint.onclick=()=>Draw.changeMode('draw_point');
btnLine.onclick =()=>Draw.changeMode('draw_line_string');
btnPoly.onclick =()=>Draw.changeMode('draw_polygon');
btnSelect.onclick=()=>Draw.changeMode('simple_select');

btnCopy.onclick=()=>{
  const sel=selectOne(); if(!sel) return;
  const f=JSON.parse(JSON.stringify(sel));
  delete f.id; f.properties=f.properties||{};
  addToDataset(activeKey(), normalizeNewFeature(f));
  Draw.changeMode('simple_select');
};

btnFix.onclick=()=>{
  const hit = pickRenderedOne(); // bizim katmanlardan birini se√ßip d√ºzelt
  if(!hit) return alert('D√ºzeltmek i√ßin bir √∂zellik tƒ±klayƒ±n.');
  const srcKey = hit.layer.id.startsWith('indoor')?'indoor':'outdoor';
  const src = map.getSource(srcKey), fc = src._data||emptyFC();
  const fid = hit.properties.fid;
  const idx = fc.features.findIndex(x=>(x.properties||{}).fid===fid);
  if(idx<0) return;
  try{
    let g = fc.features[idx].geometry;
    if(g.type==='Polygon'){
      g = turf.rewind(turf.cleanCoords(g), {reverse:false}).geometry;
      // self-intersection d√ºzeltme (buffer 0)
      g = turf.buffer({type:'Feature',geometry:g}, 0, {units:'meters'}).geometry || g;
    }else if(g.type==='LineString'){
      g = turf.cleanCoords(g).geometry;
    }else if(g.type==='Point'){
      // no-op
    }
    fc.features[idx].geometry=g;
    src.setData(fc); saveLocal(srcKey, fc);
    alert('Geometri d√ºzeltildi.');
  }catch(err){ alert('D√ºzeltme ba≈üarƒ±sƒ±z: '+err.message); }
};

function activeKey(){ return $('#targetLayer').value==='INDOOR'?'indoor':'outdoor'; }
function emptyFC(){ return {type:'FeatureCollection',features:[]} }

map.on('draw.create', e=>{
  e.features.forEach(f=>{
    addToDataset(activeKey(), normalizeNewFeature(f));
    Draw.delete(f.id);
  });
});
map.on('draw.update', ()=>{}); // d√ºzenlemeyi dataset √ºzerinden yapƒ±yoruz
map.on('draw.delete', ()=>{}); // datasetten silmiyoruz (isteƒüe g√∂re eklenebilir)

function normalizeNewFeature(f){
  const g=f.geometry;
  const base={
    type:'Feature',
    geometry:g,
    properties:{
      fid:`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,7)}`,
      name:'', category:'road', level:'', hours:'', desc:'',
      fill:'#09DCE4', stroke:'#1b7a5b', stroke_w:2, icon_sz:6, height:0
    }
  };
  return base;
}
function addToDataset(key, feat){
  const src=map.getSource(key);
  const fc=src._data||emptyFC();
  fc.features.push(feat);
  src.setData(fc); saveLocal(key, fc); refreshAll();
}

/*** === √ñZELLƒ∞K Dƒ∞YALOƒûU === ***/
const dlg=$('#propDlg'), form=$('#propForm');
const p_fid=$('#p_fid'), p_name=$('#p_name'), p_category=$('#p_category'), p_level=$('#p_level'), p_hours=$('#p_hours'), p_desc=$('#p_desc'),
      p_fill=$('#p_fill'), p_stroke=$('#p_stroke'), p_stroke_w=$('#p_stroke_w'), p_icon_sz=$('#p_icon_sz'), p_image=$('#p_image'), p_height=$('#p_height'),
      locLang=$('#locLang'), p_name_loc=$('#p_name_loc'), p_hours_loc=$('#p_hours_loc'), p_level_loc=$('#p_level_loc'), p_desc_loc=$('#p_desc_loc'), p_image_loc=$('#p_image_loc');

map.on('click', (e)=>{
  const hit = pickRenderedOne(e.point);
  if(hit) openProp(hit);
});

function pickRenderedOne(pt){
  const layers=['indoor-pts','outdoor-pts','indoor-fill','outdoor-fill','indoor-line','outdoor-line'];
  const hits=pt? map.queryRenderedFeatures(pt,{layers}) : map.queryRenderedFeatures({x:map.getCanvas().width/2,y:map.getCanvas().height/2},{layers});
  return (hits && hits[0])? hits[0] : null;
}

function openProp(f){
  const p=f.properties||{};
  p_fid.value=p.fid||'';
  p_name.value=p.name||'';
  p_category.value=(p.category||'');
  p_level.value=p.level||'';
  p_hours.value=p.hours||'';
  p_desc.value=p.desc||'';
  p_fill.value=fixColor(p.fill||'#09DCE4');
  p_stroke.value=fixColor(p.stroke||'#1b7a5b');
  p_stroke_w.value=p.stroke_w||2;
  p_icon_sz.value=p.icon_sz||6;
  p_height.value=Number(p.height||0);
  p_image.value=p.image||'';
  // se√ßili dile g√∂re lokalle≈ütirilmi≈ü alanlarƒ± doldur
  loadLocaleFields(p, locLang.value);
  dlg.showModal();
}
locLang.addEventListener('change', ()=>{
  // mevcut kayƒ±ttan se√ßili dile ait alanlarƒ± y√ºkle
  const fid=p_fid.value; if(!fid) return;
  const p = getByFid(fid); if(!p) return;
  loadLocaleFields(p, locLang.value);
});
function loadLocaleFields(props, lang){
  p_name_loc.value = props['name_'+lang] || '';
  p_hours_loc.value= props['hours_'+lang]|| '';
  p_level_loc.value= props['level_'+lang]|| '';
  p_desc_loc.value = props['desc_'+lang] || '';
  p_image_loc.value= props['image_'+lang]|| '';
}

$('#saveProps').addEventListener('click',(ev)=>{
  ev.preventDefault();
  const fid=p_fid.value; if(!fid){ dlg.close(); return; }
  const lang=locLang.value;

  ['indoor','outdoor'].forEach(k=>{
    const src=map.getSource(k); if(!src||!src._data) return;
    const fc=src._data;
    let changed=false;
    fc.features.forEach((f)=>{
      const pp=f.properties||{};
      if(pp.fid===fid){
        pp.name=p_name.value.trim();
        pp.category=p_category.value;
        pp.level=p_level.value.trim();
        pp.hours=p_hours.value.trim();
        pp.desc=p_desc.value.trim();
        pp.fill=fixColor(p_fill.value);
        pp.stroke=fixColor(p_stroke.value);
        pp.stroke_w=Number(p_stroke_w.value)||2;
        pp.icon_sz=Number(p_icon_sz.value)||6;
        pp.height=Number(p_height.value)||0;
        pp.image=p_image.value.trim();
        // dil alanlarƒ±
        if(lang){
          pp['name_'+lang]=p_name_loc.value.trim();
          pp['hours_'+lang]=p_hours_loc.value.trim();
          pp['level_'+lang]=p_level_loc.value.trim();
          pp['desc_'+lang]=p_desc_loc.value.trim();
          pp['image_'+lang]=p_image_loc.value.trim();
        }
        f.properties=pp; changed=true;
      }
    });
    if(changed){ src.setData(fc); saveLocal(k, fc); }
  });
  dlg.close();
});

function getByFid(fid){
  const keys=['indoor','outdoor'];
  for(const k of keys){
    const fc=(map.getSource(k)?._data)||emptyFC();
    const f=fc.features.find(x=>(x.properties||{}).fid===fid);
    if(f) return f.properties;
  }
  return null;
}

function fixColor(s){ if(!s) return s; s=String(s).trim(); return s.startsWith('#')?s:'#'+s; }

/*** === Fƒ∞LTRELER, OKLAR, VURGU === ***/
const levelFilter=$('#levelFilter'), showArrows=$('#showArrows'), hiliteActive=$('#hiliteActive'), targetSel=$('#targetLayer');
[levelFilter, showArrows, hiliteActive, targetSel].forEach(el=> el.addEventListener('input', refreshAll));

function refreshAll(){
  const lv=(levelFilter.value||'').trim();
  const baseFilter = !lv ? ['boolean',true] : ['==',['coalesce',['get','level'],['get','level_tr'],['get','level_en'],['get','level_ru'],['get','level_de'],['get','level_pl']], lv];

  ['indoor','outdoor'].forEach(k=>{
    ['fill','fill-outline','line','pts'].forEach(s=>{
      const id=`${k}-${s}`; if(!map.getLayer(id)) return;
      const typ = s==='pts' ? 'Point' : (s.includes('line')?'LineString':'Polygon');
      map.setFilter(id, ['all',['==',['geometry-type'],typ], baseFilter]);
    });
    const arrowsId=`${k}-arrows`;
    if(showArrows.checked){
      if(!map.getLayer(arrowsId)){
        map.addLayer({ id:arrowsId, type:'symbol', source:k, filter:['==',['geometry-type'],'LineString'],
          layout:{'symbol-placement':'line','text-field':'‚ñ∫','text-size':12,'text-allow-overlap':true,'text-keep-upright':true},
          paint:{'text-color':['coalesce',['get','stroke'],'#1b7a5b'],'text-opacity':0.9} });
      }
      map.setLayoutProperty(arrowsId,'visibility','visible');
      map.setFilter(arrowsId, ['all',['==',['geometry-type'],'LineString'], baseFilter]);
    }else if(map.getLayer(arrowsId)){ map.setLayoutProperty(arrowsId,'visibility','none'); }
  });

  // aktif katman vurgusu
  const active = (targetSel.value==='INDOOR')?'indoor':'outdoor';
  const passive = active==='indoor'?'outdoor':'indoor';
  const dim=hiliteActive.checked;
  ['fill','fill-outline','line','pts'].forEach(s=>{
    const idP=`${passive}-${s}`;
    if(map.getLayer(idP)) map.setPaintProperty(idP, (s==='pts'?'circle-opacity':s.includes('line')?'line-opacity':s.includes('fill')?'fill-opacity':'opacity'), dim?0.25:1);
  });

  // bizim 3D ekstr√ºzyon g√∂r√ºn√ºrl√ºƒü√º (MapLibre 3D modunda a√ßƒ±k)
  const on3D = overlaySel.value==='ml3d';
  ['indoor-3d','outdoor-3d'].forEach(id=>{
    if(map.getLayer(id)) map.setLayoutProperty(id,'visibility', on3D?'visible':'none');
  });
}

/*** === ƒ∞NDƒ∞R / Y√úKLE === ***/
function downloadJSON(name, data){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0);
}
$('#dlIndoor').onclick  =()=> downloadJSON('indoor.json',  map.getSource('indoor')._data||emptyFC());
$('#dlOutdoor').onclick =()=> downloadJSON('outdoor.json', map.getSource('outdoor')._data||emptyFC());
$('#dlBuildings').onclick=()=> downloadJSON('buildings.json', emptyFC());
$('#dlRoutes').onclick   =()=> downloadJSON('routes.json',    emptyFC());

$('#file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt=await f.text(); const jc=JSON.parse(txt);
    // dosya adƒ±na g√∂re hedef
    const key = /indoor/i.test(f.name) ? 'indoor' : /outdoor/i.test(f.name) ? 'outdoor' : (confirm('Dosya OUTDOOR olarak y√ºklensin mi?')?'outdoor':'indoor');
    map.getSource(key).setData(jc);
    saveLocal(key, jc);
    refreshAll();
    alert(`${f.name} y√ºklendi ‚Üí ${key}`);
  }catch(err){ alert('JSON okunamadƒ±: '+err.message); }
  e.target.value='';
});

  /*** === YEREL VERƒ∞ === */
  function saveLocal(key, fc){
    try { localStorage.setItem('adm_' + key, JSON.stringify(fc)); }
    catch (e) {}
  }

  function loadLocal(key){
    try {
      const s = localStorage.getItem('adm_' + key);
      return s ? JSON.parse(s) : null;
    } catch (e) {
      return null;
    }
  }

  document.getElementById('btnClrLocal').onclick = () => {
    ['indoor','outdoor'].forEach(k => localStorage.removeItem('adm_' + k));
    alert('Yerel veriler temizlendi.');
  };

  /*** === YARDIMCI === */
  function $(id){ return document.getElementById(id); }
</script>
</body>
</html>


