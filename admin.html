<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Admin – Indoor/Outdoor/Buildings/Routes Editör</title>

<!-- MapLibre GL -->
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Mapbox Draw (sağlam CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css">
<script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.min.js"></script>

<style>
  :root{ --shadow:0 10px 24px rgba(0,0,0,.22); --border:#e5e7eb; --soft:#f8fafc; --brand:#2563eb; }
  html,body{height:100%;margin:0;font:14px/1.35 system-ui,Segoe UI,Roboto,Arial}
  #map{position:fixed; inset:0}
  .topbar{
    position:fixed; left:12px; top:12px; z-index:10; display:flex; gap:8px; align-items:center;
    background:#fff; border:1px solid var(--border); border-radius:14px; padding:10px; box-shadow:var(--shadow)
  }
  .topbar select,.topbar input[type=range]{padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .panel{
    position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10;
    background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
    padding:10px; width:min(1100px,96vw)
  }
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .row>*{flex:0 0 auto}
  button,select,input[type=file],input[type=text]{padding:9px 11px; border:1px solid var(--border); border-radius:12px; background:#fff; cursor:pointer}
  input[type=text]{cursor:text}
  .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f1f5f9; font-size:12px}
  .primary{background:#eff6ff; border-color:#bfdbfe}
  .danger{background:#fff1f2; border-color:#fecdd3}
  .ok{background:#ecfdf5; border-color:#bbf7d0}
  .active{outline:2px solid var(--brand)}
  .small{font-size:12px; color:#64748b}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.34); display:none; align-items:center; justify-content:center; z-index:12}
  .panel2{background:#fff; width:min(780px,94vw); border-radius:16px; padding:14px; box-shadow:var(--shadow)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid label{font-size:12px; color:#555}
  .grid input,.grid textarea,.grid select{width:100%; padding:10px; border:1px solid var(--border); border-radius:10px}
  textarea{min-height:82px}
  .actions{display:flex; justify-content:space-between; gap:8px; margin-top:10px}
  .actions .left{display:flex; gap:8px}
  .badge{display:inline-flex; align-items:center; gap:6px; font-size:12px}
  .sep{height:1px; background:#e5e7eb; margin:10px 0}
</style>
</head>
<body>
<div id="map"></div>

<!-- ÜST BAR: Base + OSM overlay -->
<div class="topbar">
  <select id="baseSel" title="Taban harita">
    <option value="osm">OSM (Standart)</option>
    <option value="sat">Mapbox Satellite</option>
  </select>
  <span class="small">OSM çizim katmanı</span>
  <input id="osmAlpha" type="range" min="0" max="1" step="0.01" value="0.6" title="OSM opaklık" style="width:160px">
  <span id="alphaVal" class="small">0.60</span>
</div>

<!-- ALT PANEL: kontroller -->
<div class="panel">
  <div class="row" style="margin-bottom:6px">
    <span class="pill small">Aktif hedef vurgulu</span>
    <select id="layerSel" title="Hedef katman">
      <option value="outdoor">Hedef: OUTDOOR</option>
      <option value="indoor">Hedef: INDOOR</option>
      <option value="buildings">Hedef: BUILDINGS</option>
      <option value="routes">Hedef: ROUTES</option>
    </select>
    <input id="levelFilter" placeholder="Kat filtresi (ör: 1) – boş=hepsi" style="min-width:210px">
    <button id="btnPoint" class="primary">➕ Nokta</button>
    <button id="btnLine"  class="primary">〰️ Çizgi</button>
    <button id="btnPoly"  class="primary">⬛ Poligon</button>
    <button id="btnSelect">☑ Seç</button>
    <button id="btnDirect">✏️ Geometri</button>
    <button id="btnCopy"  class="ok">⎘ Kopyala</button>
    <button id="btnReverse" class="ok">⇆ Çizgiyi Ters Çevir</button>
    <button id="btnArrows" class="pill">Yön Okları: Açık</button>
  </div>

  <div class="row">
    <button id="expIndoor">⤓ indoor.json</button>
    <button id="expOutdoor">⤓ outdoor.json</button>
    <button id="expBuildings">⤓ buildings.json</button>
    <button id="expRoutes">⤓ routes.json</button>
    <label>⤒ JSON Yükle <input id="imp" type="file" accept=".json,application/json"></label>
    <button id="clearLocal" class="danger">🧹 Yerel Veriyi Temizle</button>
    <span class="small">• Özellik için çift tıkla</span>
  </div>
</div>

<!-- ÖZELLİK FORMU -->
<div id="propModal" class="modal" aria-hidden="true">
  <div class="panel2">
    <h3>Özellikler</h3>

    <div class="grid">
      <div><label>İsim (varsayılan)</label><input id="f_name" placeholder="Örn: Ana Restoran"></div>
      <div>
        <label>Kategori</label>
        <select id="f_category">
          <option value="">Seçiniz…</option>
          <!-- Otel içi geniş set -->
          <optgroup label="Genel">
            <option>restaurant</option><option>bar</option><option>cafe</option><option>shop</option>
            <option>spa</option><option>gym</option><option>pool</option><option>beach</option>
            <option>toilet</option><option>reception</option><option>elevator</option><option>stair</option>
            <option>kidsclub</option><option>parking</option><option>gate</option><option>info</option>
            <option>building</option>
          </optgroup>
          <optgroup label="Spor / Aktivite">
            <option>tennis</option><option>basketball</option><option>football</option><option>aquapark</option>
            <option>theater</option><option>cinema</option>
          </optgroup>
          <optgroup label="Yol Tipi (routes)">
            <option value="footpath">footpath</option>
            <option value="bikeway">bikeway</option>
            <option value="shuttle">shuttle</option>
            <option value="running">running</option>
          </optgroup>
          <option value="_other">Diğer…</option>
        </select>
      </div>
      <div style="grid-column:1/-1;display:none" id="catOtherWrap"><label>Diğer Kategori</label><input id="f_category_other" placeholder="ör. lounge"></div>
      <div><label>Saatler (varsayılan)</label><input id="f_hours" placeholder="09:00-22:00"></div>
      <div><label>Seviye/Kat (varsayılan)</label><input id="f_level" placeholder="1"></div>
      <div style="grid-column:1/-1"><label>Açıklama (varsayılan)</label><textarea id="f_desc" placeholder="Kısa açıklama veya https://... linkleri (tıklanır)"></textarea></div>
      <div style="grid-column:1/-1"><label>Fotoğraf URL (varsayılan)</label><input id="f_image" placeholder="https://.../foto.jpg"></div>

      <!-- Stil -->
      <div><label>Çizgi Rengi</label><input id="f_stroke" placeholder="#1b7a5b"></div>
      <div><label>Çizgi Kalınlığı</label><input id="f_stroke_w" type="number" step="0.5" min="0"></div>
      <div><label>Doldurma Rengi</label><input id="f_fill" placeholder="#0DD9CE4 veya #00ff00"></div>
      <div><label>Doldurma Opaklığı (0-1)</label><input id="f_fill_op" type="number" step="0.05" min="0" max="1"></div>

      <!-- Icon -->
      <div><label>İkon URL (PNG)</label><input id="f_icon" placeholder="https://.../marker.png"></div>
      <div><label>İkon Boyutu (px)</label><input id="f_icon_sz" type="number" step="1" min="8"></div>

      <!-- 3D Bilgi -->
      <div><label>Yükseklik (metre)</label><input id="f_height" type="number" step="0.5" min="0"></div>
      <div><label>Kat Sayısı</label><input id="f_levels" type="number" step="1" min="0"></div>

      <div><label>Öğe ID</label><input id="f_id" disabled></div>
      <div><label>Özet</label><input id="f_metric" disabled></div>
    </div>

    <div class="sep"></div>

    <!-- Çok dilli paket -->
    <div class="grid">
      <div>
        <label>Dil</label>
        <select id="f_lang">
          <option value="tr">Türkçe</option><option value="en">English</option>
          <option value="ru">Русский</option><option value="de">Deutsch</option><option value="pl">Polski</option>
        </select>
      </div>
      <div class="badge"><span class="small">Bu bölüm <b>name_XX / hours_XX / level_XX / desc_XX / image_XX</b> alanlarını yazar.</span></div>
    </div>
    <div class="grid">
      <div><label>İsim (seçili dil)</label><input id="l_name"></div>
      <div><label>Saatler (seçili dil)</label><input id="l_hours"></div>
      <div><label>Seviye/Kat (seçili dil)</label><input id="l_level"></div>
      <div style="grid-column:1/-1"><label>Açıklama (seçili dil)</label><textarea id="l_desc"></textarea></div>
      <div style="grid-column:1/-1"><label>Fotoğraf URL (seçili dil)</label><input id="l_image" placeholder="https://.../foto.jpg"></div>
    </div>

    <div class="actions">
      <div class="left">
        <button id="propDelete" class="danger">Sil</button>
      </div>
      <div>
        <button id="propSave"   class="primary">Kaydet</button>
        <button id="propClose"  class="primary">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== AYARLAR ===================== */
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";        // ← buraya public token
const HOTEL_BBOX = [31.801445, 36.597411, 31.808467, 36.600917]; // örnek bbox
const START = [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];

/* ===================== HARİTA ===================== */
const map = new maplibregl.Map({
  container:'map',
  style:{version:8, sources:{}, layers:[]}, // boş stil, katmanları biz ekleyeceğiz
  center: START, zoom:16, pitch:0, bearing:0, attributionControl:false
});
map.addControl(new maplibregl.NavigationControl(), 'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'© aihotelstech · © OpenStreetMap'}));

/* 1) Base sources */
map.on('load', ()=>{
  // OSM raster (çizimlerin referansı)
  map.addSource('osm', {type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, attribution:'© OpenStreetMap'});
  map.addLayer({id:'basemap-osm', type:'raster', source:'osm'});

  // Mapbox Satellite (token gerekli)
  if(MAPBOX_TOKEN && MAPBOX_TOKEN.startsWith('pk.')){
    map.addSource('sat', {
      type:'raster',
      tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`],
      tileSize:256, attribution:'© Mapbox'
    });
    map.addLayer({id:'basemap-sat', type:'raster', source:'sat', layout:{visibility:'none'}});
  }

  // OSM overlay (uydu üstüne yarı saydam)
  map.addSource('osm_overlay', {type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256});
  map.addLayer({id:'osm-overlay', type:'raster', source:'osm_overlay', paint:{'raster-opacity': parseFloat($('osmAlpha').value)}, layout:{visibility:'none'}});

  // Çizim kaynak/layer’ları MapboxDraw yönetecek, ama filtreler için stiller:
  installDraw();

  // UI init
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:20,maxZoom:19});
});

/* ===================== DRAW ===================== */
let draw, arrowsOn=true;

function layerColorFor(props){
  // Yol tiplerine göre çizgi rengi
  const cat=(props.category||'').toLowerCase();
  const road=(props.road||props.category||'').toLowerCase();
  if(road==='bikeway') return '#22c55e';
  if(road==='shuttle') return '#f59e0b';
  if(road==='running') return '#ef4444';
  if(road==='footpath') return '#2563eb';
  // binalar/diğer
  if((props.layer||'')==='buildings') return '#8b5e34';
  return props.stroke || '#2563eb';
}

// Draw stilleri (kendi filtrelerimiz)
const drawStyles = [
  // POLY FILL
  {
    id:'gl-draw-polygon-fill',
    type:'fill',
    filter:['all',['==','$type','Polygon'],['!=',['get','user_hidden'],true]],
    paint:{
      'fill-color':['coalesce',['get','fill'],'#3b82f6'],
      'fill-opacity':['coalesce',['get','fill_op'],0.25]
    }
  },
  // POLY OUTLINE
  {
    id:'gl-draw-polygon-stroke',
    type:'line',
    filter:['all',['==','$type','Polygon'],['!=',['get','user_hidden'],true]],
    paint:{
      'line-color':['coalesce',['get','stroke'],'#2563eb'],
      'line-width':['coalesce',['get','stroke_w'],2]
    }
  },
  // LINES
  {
    id:'gl-draw-line',
    type:'line',
    filter:['all',['==','$type','LineString'],['!=',['get','user_hidden'],true]],
    paint:{
      'line-color':['case',['has','stroke'],['get','stroke'], ['case',
        ['==',['downcase',['get','category']],'bikeway'],'#22c55e',
        ['==',['downcase',['get','category']],'shuttle'],'#f59e0b',
        ['==',['downcase',['get','category']],'running'],'#ef4444',
        ['==',['downcase',['get','category']],'footpath'],'#2563eb',
        '#2563eb'
      ]],
      'line-width':['coalesce',['get','stroke_w'],3]
    }
  },
  // YOL OKLARI (harici görsel yok; metin ▶)
  {
    id:'gl-draw-line-arrows',
    type:'symbol',
    filter:['all',['==','$type','LineString'], ['!=',['get','user_hidden'],true], ['==',['get','user_arrows'],true]],
    layout:{
      'symbol-placement':'line',
      'symbol-spacing':35,
      'text-field':'▶',
      'text-size':12,
      'text-keep-upright':false
    },
    paint:{ 'text-color':['coalesce',['get','stroke'],'#2563eb'] }
  },
  // POINTS
  {
    id:'gl-draw-point',
    type:'circle',
    filter:['all',['==','$type','Point'],['!=',['get','user_hidden'],true]],
    paint:{
      'circle-radius':['coalesce',['get','icon_sz'],6],
      'circle-color':['coalesce',['get','stroke'],'#ef4444'],
      'circle-stroke-color':'#fff','circle-stroke-width':1.6
    }
  },
  // Seçili vurgu
  {
    id:'gl-draw-selected',
    type:'line',
    filter:['all',['in','id',['literal',[]]]], // Draw kendisi yönetecek
    paint:{'line-color':'#111','line-width':1}
  }
];

function installDraw(){
  draw = new MapboxDraw({
    displayControlsDefault:false,
    styles: drawStyles,
    modes: MapboxDraw.modes
  });
  map.addControl(draw,'top-left');

  // Yeni çizilen her şeye hedef layer adını ve varsayılanları yaz
  map.on('draw.create', e=>{
    e.features.forEach(f=>{
      const p=f.properties||(f.properties={});
      p.layer = $('layerSel').value;
      if(f.geometry.type==='LineString'){
        if(p.category==null) p.category='footpath';
        p.user_arrows = arrowsOn;
      }
      if(f.geometry.type==='Polygon'){
        if(p.fill_op==null) p.fill_op=0.25;
      }
      colorizeByLayer(p);
    });
    persist();
  });

  map.on('draw.update', ()=>persist());
  map.on('draw.delete', ()=>persist());

  // Çift tık seçili özelliği formda aç
  map.on('dblclick', (ev)=>{
    const fs = map.queryRenderedFeatures(ev.point, {layers:['gl-draw-polygon-fill','gl-draw-polygon-stroke','gl-draw-line','gl-draw-point']});
    if(fs && fs[0]) openForm( draw.get(fs[0].id) );
  });
}

/* ===================== UI ===================== */
const $ = id=>document.getElementById(id);

// Base seçici
$('baseSel').addEventListener('change', ()=>{
  const v=$('baseSel').value;
  map.setLayoutProperty('basemap-osm','visibility', v==='osm'?'visible':'none');
  map.setLayoutProperty('basemap-sat','visibility', v==='sat'?'visible':'none');
  map.setLayoutProperty('osm-overlay','visibility', v==='sat'?'visible':'none');
});

$('osmAlpha').addEventListener('input', ()=>{
  const val=parseFloat($('osmAlpha').value)||0;
  $('alphaVal').textContent=val.toFixed(2);
  map.setPaintProperty('osm-overlay','raster-opacity', val);
});

// Araç butonları
function setMode(mode){
  const ids=['btnPoint','btnLine','btnPoly','btnSelect','btnDirect'];
  ids.forEach(i=>$ (i).classList.remove('active'));
  switch(mode){
    case 'point': draw.changeMode('draw_point'); $('btnPoint').classList.add('active'); break;
    case 'line':  draw.changeMode('draw_line_string'); $('btnLine').classList.add('active'); break;
    case 'poly':  draw.changeMode('draw_polygon'); $('btnPoly').classList.add('active'); break;
    case 'select':draw.changeMode('simple_select'); $('btnSelect').classList.add('active'); break;
    case 'direct':draw.changeMode('direct_select'); $('btnDirect').classList.add('active'); break;
  }
}
$('btnPoint').onclick =()=>setMode('point');
$('btnLine').onclick  =()=>setMode('line');
$('btnPoly').onclick  =()=>setMode('poly');
$('btnSelect').onclick=()=>setMode('select');
$('btnDirect').onclick=()=>setMode('direct');

// Kopyala (seçili öğeyi hafif ofsetle çoğalt)
$('btnCopy').onclick=()=>{
  const sel=draw.getSelected().features[0];
  if(!sel) return alert('Öğe seçin');
  const f=structuredClone(sel);
  // 1.5px ekran ofsetini coor’a çevir (küçük kaydırma)
  const o=10; // piksel
  const c=map.project(map.getCenter()); c.x+=o; c.y+=o; const to=map.unproject(c);
  const from=map.getCenter();
  const dx=to.lng-from.lng, dy=to.lat-from.lat;
  translateGeom(f.geometry, dx, dy);
  // yeni id sahiplensin
  delete f.id;
  draw.add(f);
  persist();
};

// Çizgiyi ters çevir (direction)
$('btnReverse').onclick=()=>{
  const sel=draw.getSelected().features[0];
  if(!sel || sel.geometry.type!=='LineString') return alert('Bir çizgi seçin');
  sel.geometry.coordinates.reverse();
  draw.add(sel); draw.delete(sel.id); // güncelleme hilesi
  draw.add(sel);
  persist();
};

// Yol Okları toggle
$('btnArrows').onclick=()=>{
  arrowsOn=!arrowsOn;
  $('btnArrows').textContent = 'Yön Okları: ' + (arrowsOn?'Açık':'Kapalı');
  // Seçili çizgiye uygula
  const sel=draw.getSelected().features[0];
  if(sel && sel.geometry.type==='LineString'){
    sel.properties.user_arrows=arrowsOn;
    draw.add(sel); draw.delete(sel.id); draw.add(sel); persist();
  }
};

// Kat filtresi (gösterimi MapboxDraw stillerinde yapamayız; biz gizleyeceğiz)
$('levelFilter').addEventListener('input', ()=> refreshFilterView() );
$('layerSel').addEventListener('change', ()=> refreshFilterView() );

function refreshFilterView(){
  const all=draw.getAll().features;
  const target=$('layerSel').value;
  const lvl=($('levelFilter').value||'').trim();
  all.forEach(f=>{
    const p=f.properties||{};
    const isTarget = (p.layer===target);
    const passLvl  = (!lvl || (String(p.level||'')===lvl));
    const visible = isTarget && passLvl;
    p.user_hidden = !visible;
    draw.add(f); draw.delete(f.id); draw.add(f);
  });
}

/* ===================== ÖZELLİK FORMU ===================== */
const modal=$('propModal');
function openForm(f){
  if(!f) return;
  editFeature=f;
  const p=f.properties||(f.properties={});

  // Basit alanlar
  setVal('f_name', p.name||'');
  setVal('f_hours',p.hours||'');
  setVal('f_level',p.level||'');
  setVal('f_desc', p.desc||'');
  setVal('f_image',p.image||'');

  setVal('f_stroke',  p.stroke||'');
  setVal('f_stroke_w',p.stroke_w||'');
  setVal('f_fill',    p.fill||'');
  setVal('f_fill_op', p.fill_op??'');

  setVal('f_icon',    p.icon||'');
  setVal('f_icon_sz', p.icon_sz||'');

  setVal('f_height',  p.height??'');
  setVal('f_levels',  p.levels??p['building:levels']??'');

  setVal('f_id', f.id||'');
  setVal('f_metric', summaryOfGeom(f));

  // kategori
  const catSel=$('f_category');
  if(p.category && [...catSel.options].some(o=>o.value===p.category)) { catSel.value=p.category; $('catOtherWrap').style.display='none'; }
  else if(p.category){ catSel.value='_other'; $('catOtherWrap').style.display='block'; setVal('f_category_other', p.category);}
  else {catSel.value=''; $('catOtherWrap').style.display='none'; setVal('f_category_other','');}
  catSel.onchange=()=>{ $('catOtherWrap').style.display = (catSel.value==='_other')?'block':'none'; };

  // dil paket
  $('f_lang').value = i18nLang;
  loadLangFields(p);

  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}
function setVal(id,v){ $(id).value = (v==null?'':v); }
function getVal(id){ return ($(id).value||'').trim(); }

function validateImg(u){ try{ const x=new URL(u); if(!(x.protocol==='http:'||x.protocol==='https:')) return false; return /\.(jpg|jpeg|png|gif|webp|avif)(\?.*)?$/i.test(x.pathname); }catch{return false;} }

let editFeature=null, i18nLang='tr';
function loadLangFields(p){
  setVal('l_name',  p['name_'+i18nLang]  || '');
  setVal('l_hours', p['hours_'+i18nLang] || '');
  setVal('l_level', p['level_'+i18nLang] || '');
  setVal('l_desc',  p['desc_'+i18nLang]  || '');
  setVal('l_image', p['image_'+i18nLang] || '');
}
$('f_lang').onchange=()=>{ i18nLang=$('f_lang').value; if(editFeature) loadLangFields(editFeature.properties||{}); };

$('propSave').onclick=()=>{
  if(!editFeature) return;
  const p=editFeature.properties||(editFeature.properties={});

  // temel
  const img = getVal('f_image'); if(img && !validateImg(img)) return alert('Fotoğraf URL geçersiz (jpeg/png/webp).');
  const catSel=$('f_category'), other=$('f_category_other');
  p.name  = getVal('f_name') || undefined;
  p.category = (catSel.value==='_other'? (other.value||'') : catSel.value) || undefined;
  p.hours = getVal('f_hours')||undefined;
  p.level = getVal('f_level')||undefined;
  p.desc  = getVal('f_desc') ||undefined;
  p.image = img || undefined;

  p.stroke   = getVal('f_stroke')   || undefined;
  p.stroke_w = parseNum(getVal('f_stroke_w'));
  p.fill     = getVal('f_fill')     || undefined;
  const fop  = parseFloat(getVal('f_fill_op')); p.fill_op = (isFinite(fop)? fop: undefined);

  p.icon     = getVal('f_icon')     || undefined;
  p.icon_sz  = parseNum(getVal('f_icon_sz'));

  p.height   = parseNum(getVal('f_height'));
  const lv   = parseInt(getVal('f_levels'),10); p.levels = isFinite(lv)? lv: undefined; p['building:levels']=p.levels;

  // dil alanları
  const ln=i18nLang, limg=getVal('l_image');
  if(limg && !validateImg(limg)) return alert('Dil-özgü fotoğraf URL geçersiz.');
  p['name_'+ln]  = getVal('l_name')  || undefined;
  p['hours_'+ln] = getVal('l_hours') || undefined;
  p['level_'+ln] = getVal('l_level') || undefined;
  p['desc_'+ln]  = getVal('l_desc')  || undefined;
  p['image_'+ln] = limg || undefined;

  // yol türü ise renk şablonu
  colorizeByLayer(p);

  // uygula
  draw.add(editFeature); draw.delete(editFeature.id); draw.add(editFeature);
  persist();
  alert('Kaydedildi.');
};
$('propClose').onclick=()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); };
$('propDelete').onclick=()=>{ if(editFeature){ draw.delete(editFeature.id); persist(); modal.style.display='none'; } };

document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && modal.style.display==='flex'){ modal.style.display='none'; } });

function parseNum(v){ const n=parseFloat(v); return isFinite(n)? n: undefined; }
function summaryOfGeom(f){
  const g= (f.geometry||f).type ? f.geometry : f;
  if(g.type==='Polygon'){
    const area = Math.abs(ringArea(g.coordinates[0]))/1; // pseudo m² (yaklaşık)
    return 'Alan ~ ' + Math.round(area) + ' m²';
  }
  if(g.type==='LineString'){
    const len = lineLen(g.coordinates);
    return 'Uzunluk ~ ' + Math.round(len) + ' m';
  }
  return '';
}

// çok kaba tahmini m (WebMercator kabulü)
function lineLen(coords){
  let d=0;
  for(let i=1;i<coords.length;i++) d += hav(coords[i-1], coords[i]);
  return d;
}
function hav(a,b){const t=d=>d*Math.PI/180,R=6371000;const dLat=t(b[1]-a[1]),dLon=t(b[0]-a[0]),la1=t(a[1]),la2=t(b[1]);const h=Math.sin(dLat/2)**2+Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.min(1,Math.sqrt(h)));}
function ringArea(ring){ // planar approx
  let s=0; for(let i=0, j=ring.length-1; i<ring.length; j=i++) s += (ring[j][0]*ring[i][1]) - (ring[i][0]*ring[j][1]); return Math.abs(s)*1000000; }

/* ===================== İÇE/DIŞA AKTAR ===================== */
function dl(obj,name){ const b=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }

$('expIndoor').onclick   =()=> exportLayer('indoor');
$('expOutdoor').onclick  =()=> exportLayer('outdoor');
$('expBuildings').onclick=()=> exportLayer('buildings');
$('expRoutes').onclick   =()=> exportLayer('routes');

function exportLayer(name){
  const fs=draw.getAll().features.filter(f=> (f.properties||{}).layer===name);
  dl({type:'FeatureCollection',features:fs}, `${name}.json`);
}

$('imp').addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file) return;
  if(file.size>8*1024*1024){ alert("Dosya > 8MB"); e.target.value=""; return; }
  try{
    const gj=JSON.parse(await file.text());
    if(!(gj && gj.type==='FeatureCollection' && Array.isArray(gj.features))) throw 0;
    gj.features.forEach(f=>{
      const p=f.properties||(f.properties={});
      if(!p.layer) p.layer=$('layerSel').value;
      colorizeByLayer(p);
      if(f.geometry.type==='LineString' && p.user_arrows==null) p.user_arrows=arrowsOn;
    });
    draw.add(gj);
    persist();
    refreshFilterView();
    alert('GeoJSON eklendi (mevcut çizimlere).');
  }catch{ alert('Geçersiz GeoJSON.'); }
  e.target.value="";
});
$('clearLocal').onclick=()=>{ if(confirm('Yerel veriyi sil?')){ localStorage.removeItem('hotel_draw'); location.reload(); } };

/* ===================== YARDIMCILAR ===================== */
function translateGeom(g,dx,dy){
  if(g.type==='Point'){ g.coordinates=[g.coordinates[0]+dx, g.coordinates[1]+dy]; }
  else if(g.type==='LineString'){ g.coordinates=g.coordinates.map(c=>[c[0]+dx,c[1]+dy]); }
  else if(g.type==='Polygon'){ g.coordinates=g.coordinates.map(r=> r.map(c=>[c[0]+dx,c[1]+dy])); }
}
function colorizeByLayer(p){
  // Yol tiplerine preset
  switch((p.category||'').toLowerCase()){
    case 'bikeway': p.stroke='#22c55e'; p.stroke_w=p.stroke_w||3; break;
    case 'shuttle': p.stroke='#f59e0b'; p.stroke_w=p.stroke_w||3; break;
    case 'running': p.stroke='#ef4444'; p.stroke_w=p.stroke_w||3; break;
    case 'footpath': p.stroke='#2563eb'; p.stroke_w=p.stroke_w||3; break;
  }
  if((p.layer||'')==='buildings'){
    p.fill = p.fill || '#c9b49b';
    p.fill_op = p.fill_op ?? 0.25;
    p.stroke = p.stroke || '#785430';
  }
}
// kalıcı kayıt
function persist(){ try{ localStorage.setItem('hotel_draw', JSON.stringify(draw.getAll())); }catch{} }
// ilk yük
map.on('load', ()=>{
  const s=localStorage.getItem('hotel_draw');
  if(s){ try{ const gj=JSON.parse(s); draw.add(gj); }catch{} }
  refreshFilterView();
});

// çift tık dışında tek tıkla da form açmak istersen:
map.on('click', (ev)=>{
  // sadece seçim modunda aç
  if(draw.getMode()!=='simple_select') return;
  const fs = map.queryRenderedFeatures(ev.point, {layers:['gl-draw-polygon-fill','gl-draw-polygon-stroke','gl-draw-line','gl-draw-point']});
  if(fs && fs[0]) openForm( draw.get(fs[0].id) );
});

</script>
</body>
</html>
