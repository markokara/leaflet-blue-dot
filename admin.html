<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin – OI Düzenleme + MapLibre 3D Önizleme (Satellite taban)</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
  :root{
    --shadow:0 10px 28px rgba(0,0,0,.18);
    --bg:#fff; --muted:#68767a; --field:#f7faf9; --border:#d7e5df; --brand:#0f5132;
  }
  html,body{height:100%;margin:0}
  body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eef5f1}
  #map{position:fixed; inset:0}

  .panel{
    position:fixed; left:50%; bottom:12px; transform:translateX(-50%);
    width:min(980px,96vw); z-index:1000;
  }
  .card{background:var(--bg); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:8px}
  .row{display:flex; flex-wrap:wrap; align-items:center; gap:8px}
  .row > *{white-space:nowrap}
  select,button,input[type="checkbox"]{border:1px solid var(--border); background:var(--field); border-radius:10px; padding:8px 10px}
  button{cursor:pointer}
  button:active{transform:translateY(1px)}
  small.muted{color:var(--muted)}
  .pill{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#e9f4ef;}
  .sep{height:28px; width:1px; background:#e7eee9; margin:0 6px}
  .range{display:inline-flex; align-items:center; gap:6px}
  .range input{accent-color:#1b7a5b}
  .float-topright{position:fixed; top:8px; right:8px; z-index:1001; display:flex; gap:6px}
  .float-topright .pill{background:#fff}
</style>
</head>
<body>

<div id="map" aria-label="Harita"></div>

<!-- hızlı anahtarlar -->
<div class="float-topright">
  <div class="pill">
    Üst Katman:
    <select id="overlaySel" title="Üstte görünecek kılavuz">
      <option value="osm" selected>OSM kılavuz (vektör)</option>
      <option value="3d">MapLibre 3D (terrain + binalar)</option>
    </select>
  </div>
  <div class="pill range">
    OSM opaklık
    <input type="range" id="osmAlpha" min="0" max="100" value="60"/>
  </div>
</div>

<!-- alt panel -->
<div class="panel">
  <div class="card">
    <div class="row">
      <div class="pill">Hedef katman:
        <select id="targetSel">
          <option value="outdoor" selected>OUTDOOR</option>
          <option value="indoor">INDOOR</option>
        </select>
      </div>

      <button id="addPoint">＋ Nokta</button>
      <button id="addLine">〰 Çizgi</button>
      <button id="addPoly">⬚ Poligon</button>
      <button id="selectEdit">✎ Seç / Özellik</button>
      <button id="dup">⧉ Kopyala</button>
      <label class="pill"><input type="checkbox" id="dirArrows"/> Yol yön okları</label>

      <div class="sep"></div>

      <button id="importBtn">↥ JSON Yükle</button>
      <input id="file" type="file" accept=".json" style="display:none"/>
      <button id="dlIndoor">↓ indoor.json</button>
      <button id="dlOutdoor">↓ outdoor.json</button>
      <button id="clearLocal" style="margin-left:auto; background:#ffecec; border-color:#f3c7c7">🗑 Yerel Veriyi Temizle</button>
    </div>
    <div class="row" style="margin-top:6px"><small class="muted">
      Altta her zaman <b>Mapbox Satellite</b> var. Üstte OSM (vektör kılavuz) veya MapLibre 3D’yi seçebilirsin.
      Çizdiğin tüm özellikler her iki modda da görünür. İndirilen JSON’lar misafir uygulamasında birebir çalışır.
    </small></div>
  </div>
</div>

<script>
/* ====== ANAHTARLAR ====== */
const MAPBOX_TOKEN = "YOUR_MAPBOX_TOKEN_HERE";   // ← zorunlu
const MAPTILER_KEY = "YOUR_MAPTILER_KEY_HERE";   // ← zorunlu

/* ====== KAPSAM / SABİTLER ====== */
const HOTEL_BBOX = [31.801445, 36.597411, 31.808467, 36.600917];
const CENTER=[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];
const DEFAULT_PITCH=45, DEFAULT_BEAR=0;
const PADDING={top:10,right:10,bottom:240,left:10};

const baseStyle = {
  version:8,
  glyphs:`https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${MAPTILER_KEY}`,
  sources:{},
  layers:[
    {id:"bg", type:"background", paint:{"background-color":"#dfe7e7"}}
  ]
};

/* ====== MAP ====== */
const map = new maplibregl.Map({
  container:"map",
  style:baseStyle,
  center:CENTER,
  zoom:16, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEAR,
  attributionControl:false, maxZoom:22
});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}), "top-right");
map.addControl(new maplibregl.AttributionControl({compact:true, customAttribution:"© aihotelstech"}));

/* ====== KAYNAKLAR / LAYER’LAR ====== */
map.on("load", async ()=>{
  // 0) Satellite tabanı (her zaman görünür)
  map.addSource("mbsat",{ type:"raster",
    tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`],
    tileSize:256, attribution:"© Mapbox © OSM"
  });
  map.addLayer({id:"mbsat-lyr", type:"raster", source:"mbsat", minzoom:0, maxzoom:22});

  // 1) OSM vektör kılavuz (OpenMapTiles)
  map.addSource("omt",{ type:"vector",
    url:`https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`
  });

  // ana yollar
  map.addLayer({
    id:"road-casing", type:"line", source:"omt", "source-layer":"transportation",
    paint:{ "line-color":"#ffffff", "line-width":["interpolate",["linear"],["zoom"],8,1,12,3,14,6,16,12], "line-opacity":0.7 }
  }, "mbsat-lyr");
  map.addLayer({
    id:"road", type:"line", source:"omt", "source-layer":"transportation",
    paint:{ "line-color":"#888", "line-width":["interpolate",["linear"],["zoom"],8,0.4,12,1.6,14,3.2,16,7], "line-opacity":0.8 }
  }, "road-casing");

  // su alanları
  map.addLayer({
    id:"water", type:"fill", source:"omt", "source-layer":"water",
    paint:{ "fill-color":"#cfe8ff", "fill-opacity":0.35 }
  }, "road");

  // etiketler
  map.addLayer({
    id:"place-labels", type:"symbol", source:"omt", "source-layer":"place",
    layout:{
      "text-field":["coalesce",["get","name:tr"],["get","name:en"],["get","name"]],
      "text-font":["Noto Sans Regular"],
      "text-size":["interpolate",["linear"],["zoom"],8,11,14,14]
    },
    paint:{ "text-color":"#0b3a2a", "text-halo-color":"#fff","text-halo-width":1.2, "text-opacity":0.85 }
  }, "water");

  // OSM opaklık ayarı için grup
  osmLayerIds=["road-casing","road","water","place-labels"];

  // 2) 3D için DEM + binalar (başta gizli)
  map.addSource("terrain-dem", {type:"raster-dem",
    url:`https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key=${MAPTILER_KEY}`,
    tileSize:256
  });
  map.addLayer({
    id:"bldg-3d", type:"fill-extrusion", source:"omt", "source-layer":"building",
    minzoom:14,
    paint:{
      "fill-extrusion-color":"#b9c9d6",
      "fill-extrusion-opacity":0.8,
      "fill-extrusion-height":["coalesce",
        ["get","render_height"], ["*", ["to-number",["get","height"], 0], 1], 6
      ],
      "fill-extrusion-base":["coalesce",
        ["get","render_min_height"], ["*", ["to-number",["get","min_height"], 0], 1], 0
      ]
    },
    layout:{visibility:"none"}
  });

  // 3) Çizim kaynakları (her modda üstte)
  ["indoor","outdoor"].forEach(src=>{
    map.addSource(src,{type:"geojson", data:loadLocal(src) || emptyFC(), promoteId:"fid"});
    // poligon
    map.addLayer({id:`${src}-fill`, type:"fill", source:src,
      paint:{ "fill-color":["coalesce",["get","fill"], "#1e90ff"], "fill-opacity":["coalesce",["get","fill_op"],0.35] }
    });
    map.addLayer({id:`${src}-fill-line`, type:"line", source:src,
      filter:["==",["geometry-type"],"Polygon"],
      paint:{ "line-color":["coalesce",["get","stroke"], "#1e90ff"], "line-width":["coalesce",["get","stroke_w"], 2] }
    });
    // çizgi
    map.addLayer({id:`${src}-line`, type:"line", source:src,
      filter:["==",["geometry-type"],"LineString"],
      paint:{ "line-color":["coalesce",["get","stroke"], "#1e90ff"], "line-width":["coalesce",["get","stroke_w"], 3] }
    });
    // çizgi yön okları
    map.addLayer({id:`${src}-line-arrows`, type:"symbol", source:src,
      filter:["==",["geometry-type"],"LineString"],
      layout:{ "symbol-placement":"line", "icon-image":"oneway-white","icon-size":0.8, "visibility":"none" }
    });
    // nokta
    map.addLayer({id:`${src}-pt`, type:"circle", source:src,
      filter:["==",["geometry-type"],"Point"],
      paint:{ "circle-radius":["coalesce",["get","icon_sz"],6], "circle-color":["coalesce",["get","stroke"], "#e53935"], "circle-stroke-color":"#fff", "circle-stroke-width":1.5 }
    });
  });

  // sprite’tan küçük bir ok kullanalım (MapTiler’in default sprite’ı)
  map.setStyle({...map.getStyle(), sprite:`https://api.maptiler.com/maps/streets/sprite@2x?key=${MAPTILER_KEY}`});

  // başlangıç görünümü
  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:PADDING, maxZoom:19, pitch:DEFAULT_PITCH, bearing:DEFAULT_BEAR});

  // UI olayları
  document.getElementById("overlaySel").addEventListener("change", onOverlayChange);
  document.getElementById("osmAlpha").addEventListener("input", e=>{
    const a = (+e.target.value)/100;
    osmLayerIds.forEach(id=> map.setPaintProperty(id, id.includes("labels")?"text-opacity":"line-opacity" , a));
    map.setPaintProperty("water","fill-opacity", a*0.6);
  });
  onOverlayChange(); // varsayılan OSM

  // çizim UI kurulumu
  setupDrawing();
});

/* ====== ÜST KATMAN DEĞİŞİMİ ====== */
let osmLayerIds=[];
function onOverlayChange(){
  const v = document.getElementById("overlaySel").value;
  const a = (+document.getElementById("osmAlpha").value)/100;

  if(v==="osm"){
    // OSM görünür, 3D kapalı
    osmLayerIds.forEach(id=> map.setLayoutProperty(id,"visibility","visible"));
    ["road-casing","road","place-labels"].forEach(id=>{
      if(map.getLayer(id)){ map.setPaintProperty(id, id.includes("labels")?"text-opacity":"line-opacity", a); }
    });
    if(map.getLayer("water")) map.setPaintProperty("water","fill-opacity", a*0.6);
    if(map.getLayer("bldg-3d")) map.setLayoutProperty("bldg-3d","visibility","none");
    map.setTerrain(null);
    if(map.getLayer("sky")) map.removeLayer("sky");
  }else{
    // 3D açık, OSM overlay gizli (sadece satellite + 3D)
    osmLayerIds.forEach(id=> map.setLayoutProperty(id,"visibility","none"));
    if(map.getLayer("bldg-3d")) map.setLayoutProperty("bldg-3d","visibility","visible");
    map.setTerrain({source:"terrain-dem", exaggeration:1});
    if(!map.getLayer("sky")){
      map.addLayer({ id:"sky", type:"sky",
        paint:{ "sky-type":"atmosphere", "sky-atmosphere-sun":[0.0, 45.0], "sky-atmosphere-sun-intensity":10 }
      });
    }
  }
}

/* ====== ÇİZİM / DÜZENLEME ====== */
const targetSel = document.getElementById("targetSel");
const BTN = id=>document.getElementById(id);

let mode=null; // 'point' | 'line' | 'poly' | 'select'
let tempLine=[], tempPoly=[];
let selected={src:null, fid:null};

BTN("addPoint").onclick = ()=> setMode("point");
BTN("addLine").onclick  = ()=> setMode("line");
BTN("addPoly").onclick  = ()=> setMode("poly");
BTN("selectEdit").onclick=()=> setMode("select");
BTN("dup").onclick = duplicateSelected;
BTN("dirArrows").onchange = e=>{
  ["indoor","outdoor"].forEach(s=>{
    const v = e.target.checked ? "visible":"none";
    if(map.getLayer(`${s}-line-arrows`)) map.setLayoutProperty(`${s}-line-arrows`,"visibility",v);
  });
};

function setMode(m){ mode=m; tempLine=[]; tempPoly=[]; flash(`Mod: ${m}`); }

map.on("click", e=>{
  const activeSrc = targetSel.value; // indoor | outdoor

  if(mode==="point"){
    const f = {type:"Feature", properties:newProps(), geometry:{type:"Point", coordinates:[e.lngLat.lng,e.lngLat.lat]}};
    pushFeature(activeSrc,f,true);
  }
  else if(mode==="line"){
    tempLine.push([e.lngLat.lng,e.lngLat.lat]);
    if(tempLine.length>=2){
      const f = {type:"Feature", properties:newProps(), geometry:{type:"LineString", coordinates:tempLine}};
      pushFeature(activeSrc,f,true); tempLine=[];
    }
  }
  else if(mode==="poly"){
    tempPoly.push([e.lngLat.lng,e.lngLat.lat]);
    if(tempPoly.length>=3){
      const f = {type:"Feature", properties:newProps(), geometry:{type:"Polygon", coordinates:[tempPoly.concat([tempPoly[0]])]}};
      pushFeature(activeSrc,f,true); tempPoly=[];
    }
  }
  else if(mode==="select"){
    const layers=[`${activeSrc}-pt`,`${activeSrc}-line`,`${activeSrc}-fill`];
    const feats = map.queryRenderedFeatures(e.point,{layers});
    if(feats[0]){
      const p=feats[0].properties||{}, fid=p.fid;
      selected={src:activeSrc,fid};
      openPropEditor(activeSrc,fid);
    }else{
      selected={src:null,fid:null};
    }
  }
});

function newProps(){
  return { fid: "f"+Date.now(), category:"", name:"", fill:"#09DCE4", fill_op:0.35, stroke:"#2563eb", stroke_w:2, icon_sz:6 };
}

function pushFeature(src, f, save){
  const data = getSrcData(src); data.features.push(f);
  map.getSource(src).setData(data);
  if(save){ saveLocal(src,data); }
}

function getSrcData(src){ return JSON.parse(JSON.stringify(map.getSource(src)._data || emptyFC())); }
function emptyFC(){ return {type:"FeatureCollection",features:[]}; }

/* Özellik düzenleme (çok basit prompt tabanlı) */
function openPropEditor(src,fid){
  const fc=getSrcData(src); const idx=fc.features.findIndex(x=>x.properties?.fid===fid);
  if(idx<0) return;
  const p=fc.features[idx].properties||{};
  const name = prompt("İsim:", p.name||"") ?? p.name;
  const category = prompt("Kategori (ör. restaurant, bar, road):", p.category||"") ?? p.category;
  const fill = prompt("Dolgu rengi (#RRGGBB):", p.fill||"#09DCE4") ?? p.fill;
  const stroke = prompt("Çizgi rengi (#RRGGBB):", p.stroke||"#2563eb") ?? p.stroke;
  const stroke_w = parseFloat(prompt("Çizgi kalınlığı (px):", p.stroke_w??2) ?? p.stroke_w);
  const icon_sz = parseFloat(prompt("Nokta boyutu (px):", p.icon_sz??6) ?? p.icon_sz);
  fc.features[idx].properties={...p,name,category,fill,stroke,stroke_w,icon_sz};
  map.getSource(src).setData(fc); saveLocal(src,fc);
}

function duplicateSelected(){
  const {src,fid}=selected; if(!src||!fid) return alert("Önce bir öğe seçin (Seç/Özellik).");
  const fc=getSrcData(src); const f=fc.features.find(x=>x.properties?.fid===fid); if(!f) return;
  const clone=JSON.parse(JSON.stringify(f)); clone.properties.fid="f"+Date.now();
  if(clone.geometry.type==="Point"){ clone.geometry.coordinates[0]+=0.0002; clone.geometry.coordinates[1]+=0.0002; }
  fc.features.push(clone); map.getSource(src).setData(fc); saveLocal(src,fc);
}

/* ====== İNDİR / YÜKLE / YEREL ====== */
function saveLocal(src,data){ localStorage.setItem("admin_"+src, JSON.stringify(data)); }
function loadLocal(src){ try{ return JSON.parse(localStorage.getItem("admin_"+src)||""); }catch{return null;} }

document.getElementById("dlIndoor").onclick = ()=> downloadJSON("indoor.json", map.getSource("indoor")._data);
document.getElementById("dlOutdoor").onclick= ()=> downloadJSON("outdoor.json", map.getSource("outdoor")._data);
function downloadJSON(fname, obj){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=fname; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
}

document.getElementById("importBtn").onclick=()=> document.getElementById("file").click();
document.getElementById("file").addEventListener("change", async (ev)=>{
  const f=ev.target.files[0]; if(!f) return;
  const txt=await f.text(); let data=null;
  try{ data=JSON.parse(txt); }catch(e){ alert("Geçersiz JSON"); return; }
  // Hangi dosya olduğuna adına bakarak karar ver
  const tgt = f.name.toLowerCase().includes("indoor") ? "indoor" : f.name.toLowerCase().includes("outdoor") ? "outdoor" : (targetSel.value||"outdoor");
  map.getSource(tgt).setData(data); saveLocal(tgt,data);
  flash(`Yüklendi → ${tgt}`);
  ev.target.value="";
});

document.getElementById("clearLocal").onclick=()=>{
  if(confirm("Yerel (localStorage) verileri silinsin mi?")){ localStorage.removeItem("admin_indoor"); localStorage.removeItem("admin_outdoor"); flash("Yerel veriler temizlendi"); }
};

/* ====== UFACIK YARDIMCILAR ====== */
function flash(msg){
  const el=document.createElement("div");
  el.textContent=msg;
  el.style.cssText="position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#0f5132;color:#fff;padding:7px 12px;border-radius:10px;box-shadow:var(--shadow);z-index:2000";
  document.body.appendChild(el); setTimeout(()=>el.remove(),1600);
}
</script>
</body>
</html>

