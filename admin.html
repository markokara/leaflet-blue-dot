<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin – Indoor/Outdoor/3D Bina Editör</title>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>

<style>
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{position:fixed; inset:0; touch-action:none}
  .ol-attribution{font-size:10px;opacity:.85}
  .ol-attribution button{display:none}

  .panel{
    position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10;
    background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    padding:10px; width:calc(100% - 20px); max-width:1180px;
  }
  .row{display:flex; flex-wrap:wrap; gap:8px}
  .row>*{flex:1 1 auto; min-width:120px}
  button,select,input[type="file"],input[type="text"],input[type="number"],input[type="color"],input[type="range"]{
    padding:10px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer
  }
  input[type="text"], input[type="number"], textarea{cursor:text}
  .primary{border-color:#b3d7ff; background:#f0f7ff}
  .active{outline:2px solid #3b82f6; background:#eaf2ff}
  .danger{border:1px solid #ffb3b3; background:#fff0f0}
  .pill{padding:4px 8px; font-size:12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe}
  .small{font-size:12px; color:#555}
  .acc-badge{position:fixed; right:10px; top:10px; z-index:11; background:#fff; border:1px solid #ddd; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:0 4px 12px rgba(0,0,0,.15)}
  #status{position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:11; background:#111; color:#fff; padding:6px 10px; border-radius:8px; display:none; font-size:13px}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:12}
  .panel2{background:#fff; width:min(760px,92vw); border-radius:14px; padding:14px; box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid label{font-size:12px; color:#555}
  .grid input,.grid textarea,.grid select{width:100%; padding:10px; border:1px solid #ddd; border-radius:8px}
  textarea{min-height:72px}
  .actions{display:flex; gap:8px; justify-content:space-between; margin-top:10px}
  .actions .left{display:flex; gap:8px}
  @media (max-width: 640px){
    .panel{padding:8px}
    button,select,input[type="file"],input[type="text"],input[type="number"]{padding:9px; font-size:14px}
    .row>*{min-width:100px}
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="status"></div>
<div id="acc" class="acc-badge" style="display:none"></div>

<!-- === KONTROLLER === -->
<div class="panel">
  <!-- 1: Base & OSM overlay -->
  <div class="row" style="align-items:center">
    <select id="basemapSel" title="Uydu/Harita seç">
      <option value="esri">Esri World Imagery (varsayılan)</option>
      <option value="mapbox">Mapbox Satellite</option>
      <option value="bing">Bing Aerial</option>
      <option value="osm">OpenStreetMap (Standart)</option>
    </select>

    <label style="display:flex;align-items:center;gap:8px; flex:0 0 auto">
      <input id="osmOverlayToggle" type="checkbox" checked>
      OSM çizim katmanı
    </label>
    <div style="display:flex;align-items:center;gap:8px; min-width:260px">
      <span class="small">OSM opaklık</span>
      <input id="osmOverlayOpacity" type="range" min="0" max="1" step="0.05" value="0.60" style="flex:1">
      <span id="osmOverlayOpacityVal" class="small">0.60</span>
    </div>

    <select id="layerSel">
      <option value="outdoor">Hedef katman: OUTDOOR</option>
      <option value="indoor">Hedef katman: INDOOR</option>
      <option value="buildings">Hedef katman: 3D BİNA</option>
      <option value="routes">Hedef katman: YOLLAR</option>
    </select>
    <input id="levelFilter" placeholder="Kat filtresi (ör: 1) – boş=hepsi" />
    <span class="pill small">Aktif katman vurgulu</span>
  </div>

  <!-- 2: Çiz/Düzenle/Seç -->
  <div class="row">
    <button id="addPoint"  class="primary">➕ Nokta</button>
    <button id="addLine"   class="primary">〰️ Çizgi</button>
    <button id="addPoly"   class="primary">⬛ Poligon</button>
    <button id="finishDraw" style="display:none">✔ Bitir</button>
    <button id="selectBtn">☑ Seç / Özellik</button>
    <button id="duplicateBtn" title="Seçili öğeyi kopyala (Ctrl+D)">📄 Kopyala</button>
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="showArrows" checked> Yol yön okları
    </label>
  </div>

  <!-- 3: İndir/Yükle/Temizle -->
  <div class="row">
    <button id="expIndoor">⤓ indoor.json</button>
    <button id="expOutdoor">⤓ outdoor.json</button>
    <button id="expBuildings">⤓ buildings.json</button>
    <button id="expRoutes">⤓ routes.json</button>
    <label style="display:flex;align-items:center;gap:6px">⤒ JSON Yükle
      <input id="imp" type="file" accept=".json,application/json">
    </label>
    <button id="clearLocal" class="danger">🧹 Yerel Veriyi Temizle</button>
  </div>
</div>

<!-- === ÖZELLİK FORMU === -->
<div id="propModal" class="modal" aria-hidden="true">
  <div class="panel2">
    <h3>Özellikler</h3>
    <div class="grid">
      <div><label>İsim (varsayılan)</label><input id="f_name" placeholder="Örn: Ana Restoran"></div>
      <div>
        <label>Kategori</label>
        <select id="f_category">
          <option value="">Seçiniz…</option>
          <option>restaurant</option><option>bar</option><option>spa</option><option>pool</option>
          <option>wc</option><option>elevator</option><option>stair</option><option>kidsclub</option>
          <option>reception</option><option>shop</option><option>gym</option><option>beach</option>
          <option>shuttle</option><option>parking</option><option>gate</option><option>info</option>
          <option>building</option><option>path</option><option>bike</option><option>service</option>
          <option>noentry</option><option>oneway</option>
          <option value="_other">Diğer…</option>
        </select>
      </div>

      <!-- Görsel stil -->
      <div><label>Çizgi Rengi</label><input id="f_stroke" type="text" placeholder="#1b7a5b veya 1b7a5b"></div>
      <div><label>Çizgi Kalınlığı</label><input id="f_stroke_w" type="number" step="0.5" min="0" placeholder="2"></div>
      <div><label>Dolgu Rengi</label><input id="f_fill" type="text" placeholder="#09DCE4 veya 09DCE4"></div>

      <div><label>Seviye/Kat (varsayılan)</label><input id="f_level" placeholder="1"></div>
      <div><label>Saatler (varsayılan)</label><input id="f_hours" placeholder="09:00-22:00"></div>
      <div style="grid-column:1/-1"><label>Açıklama (varsayılan)</label><textarea id="f_desc" placeholder="Kısa açıklama, URL yazarsan popup’ta tıklanabilir olur"></textarea></div>
      <div style="grid-column:1/-1"><label>Fotoğraf/İkon URL</label><input id="f_image" placeholder="https://.../foto.png (PNG/SVG)"></div>

      <!-- 3D / Bina -->
      <div><label>Yükseklik (metre)</label><input id="f_height" type="number" min="0" step="0.5" placeholder="örn: 18"></div>
      <div><label>Kat Sayısı</label><input id="f_levels" type="number" min="0" step="1" placeholder="örn: 6"></div>

      <div><label>İkon Boyutu (px)</label><input id="f_icon_sz" type="number" min="6" step="1" placeholder="24"></div>

      <div><label>Öğe ID (otomatik)</label><input id="f_id" disabled></div>
      <div><label>Koordinat / Özet</label><input id="f_metric" disabled></div>
    </div>

    <div class="actions">
      <div class="left">
        <button id="propGeom" class="pill" title="Geometri noktalarını düzenle">Geometriyi Düzenle</button>
        <button id="propDelete" class="danger">Sil</button>
      </div>
      <div>
        <button class="primary" id="propSave">Kaydet</button>
        <button class="primary" id="propClose">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== ANAHTARLAR ====== */
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug"; // ← Mapbox public tokenını gir
const BING_KEY     = ""; // opsiyonel

/* ====== KISA YARDIMCILAR ====== */
const $ = id => document.getElementById(id);
const statusEl = $("status");
const setStatus = (msg, ms=2000)=>{ if(!msg){statusEl.style.display="none";return;} statusEl.textContent=msg; statusEl.style.display="block"; if(ms>0) setTimeout(()=>statusEl.style.display="none", ms); };
const fmt = new ol.format.GeoJSON();
const to4326 = g=> g.clone().transform('EPSG:3857','EPSG:4326');
function isFC(gj){ return gj && gj.type==="FeatureCollection" && Array.isArray(gj.features); }
const writeGJ = layer => JSON.parse(fmt.writeFeatures(layer.getSource().getFeatures(),{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}));
const readGJToLayer = (layer, gj) => { if(!isFC(gj)) throw new Error("FeatureCollection bekleniyor"); const fs=fmt.readFeatures(gj,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}); layer.getSource().clear(); layer.getSource().addFeatures(fs); };
const saveLocal = (k,layer)=>{ try{ localStorage.setItem(k, JSON.stringify(writeGJ(layer))); }catch(e){ alert("Yerel depolama dolu olabilir."); } };
const loadLocal = k => { const s=localStorage.getItem(k); try{return s?JSON.parse(s):null;}catch{return null;} };
const asHex = v => (!v ? undefined : (v.startsWith('#')?v:('#'+v)));
const deg = r => r*180/Math.PI;

/* ====== STİLLER ====== */
function colorWithAlpha(hex,a){
  if(!hex) return `rgba(0,0,0,${a})`;
  const h = hex.replace('#','');
  const bigint = parseInt(h.length===3 ? h.split('').map(c=>c+c).join('') : h,16);
  const r=(bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
  return `rgba(${r},${g},${b},${a})`;
}
function baseStyle(f, dim=1){
  const p=f.getProperties();
  const t=f.getGeometry().getType();
  const strokeCol = asHex(p.stroke) || '#1b7a5b';
  const strokeW   = Number(p.stroke_w ?? 2);
  const fillCol   = asHex(p.fill)   || '#09DCE4';
  const stroke=new ol.style.Stroke({color: colorWithAlpha(strokeCol, 0.85*dim), width: strokeW});
  const fill  =new ol.style.Fill({color: colorWithAlpha(fillCol,   0.20*dim)});
  if(t==="Point"){
    const iconUrl = p.image || '';
    if(iconUrl){
      return new ol.style.Style({
        image: new ol.style.Icon({src:iconUrl, scale:(Number(p.icon_sz||24)/24)})
      });
    }
    return new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"#f94144"}),stroke:new ol.style.Stroke({color:"#fff",width:1.5})})});
  }
  return new ol.style.Style({stroke,fill});
}

// Yol yön oku — segment orta noktalarına küçük ok yerleştir
const arrow = new Image();
arrow.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="black"><path d="M12 2l-5 9h3v11h4V11h3z"/></svg>';
function lineWithArrowsStyle(f, dim=1){
  const styles=[ baseStyle(f,dim) ];
  if(!$('showArrows').checked) return styles;
  const geom=f.getGeometry();
  if(geom.getType()!=='LineString') return styles;
  const coords = geom.getCoordinates();
  for(let i=1;i<coords.length;i++){
    const a=coords[i-1], b=coords[i];
    const mid=[(a[0]+b[0])/2, (a[1]+b[1])/2];
    const rot=Math.atan2(b[1]-a[1], b[0]-a[0]);
    styles.push(new ol.style.Style({
      geometry: new ol.geom.Point(mid),
      image: new ol.style.Icon({img:arrow, imgSize:[24,24], rotation:rot})
    }));
  }
  return styles;
}
function styleWrapper(name){
  return f=>{
    const active=$("layerSel").value;
    const filter=$("levelFilter").value.trim();
    const lvl=(f.get("level")??"").toString().trim();
    const isActive=active===name;
    const dim = isActive?1:0.35;
    if(filter && lvl!==filter) return null;
    if(name==='routes') return lineWithArrowsStyle(f, dim);
    return baseStyle(f, dim);
  };
}

/* ====== KATMANLAR ====== */
const indoorLayer    = new ol.layer.VectorImage({source:new ol.source.Vector(), style:styleWrapper("indoor")});
const outdoorLayer   = new ol.layer.VectorImage({source:new ol.source.Vector(), style:styleWrapper("outdoor")});
const buildingsLayer = new ol.layer.VectorImage({source:new ol.source.Vector(), style:styleWrapper("buildings")});
const routesLayer    = new ol.layer.VectorImage({source:new ol.source.Vector(), style:styleWrapper("routes")});

const tgtLayer = ()=> {
  const v = $("layerSel").value;
  return v==="indoor" ? indoorLayer : v==="outdoor" ? outdoorLayer : v==="buildings" ? buildingsLayer : routesLayer;
};

/* ====== BASEMAP & OSM OVERLAY ====== */
const srcOSMBase = new ol.source.OSM({ attributions:'© OpenStreetMap' });
const srcEsri = new ol.source.XYZ({
  url:'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  attributions:'© Esri, Maxar'
});
const srcMapbox = MAPBOX_TOKEN ? new ol.source.XYZ({
  url:`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`,
  attributions:'© Mapbox © OpenStreetMap'
}) : null;
const srcBing = BING_KEY ? new ol.source.BingMaps({key:BING_KEY, imagerySet:'Aerial'}) : null;

const lyrBaseOSM  = new ol.layer.Tile({source:srcOSMBase, visible:false});
const lyrBaseEsri = new ol.layer.Tile({source:srcEsri,    visible:true});
const lyrBaseMB   = srcMapbox ? new ol.layer.Tile({source:srcMapbox, visible:false}) : null;
const lyrBaseBing = srcBing   ? new ol.layer.Tile({source:srcBing,   visible:false}) : null;
const baseLayers  = [lyrBaseEsri, lyrBaseMB, lyrBaseBing, lyrBaseOSM].filter(Boolean);

// üstte OSM kılavuz
const lyrOSMOverlay = new ol.layer.Tile({
  source:new ol.source.OSM({ attributions:'© OpenStreetMap' }),
  opacity:0.6, visible:true, zIndex:5
});

/* ====== HARİTA ====== */
const map = new ol.Map({
  target:"map",
  layers:[ ...baseLayers, lyrOSMOverlay, indoorLayer, outdoorLayer, buildingsLayer, routesLayer ],
  view:new ol.View({center: ol.proj.fromLonLat([31.805,36.600]), zoom:18})
});
map.addControl(new ol.control.Attribution({collapsible:false}));

/* ====== BASE/OVERLAY KONTROL ====== */
$("basemapSel").onchange=()=>{
  const v=$("basemapSel").value;
  [lyrBaseEsri, lyrBaseMB, lyrBaseBing, lyrBaseOSM].filter(Boolean).forEach(l=>l.setVisible(false));
  if(v==='esri') lyrBaseEsri.setVisible(true);
  else if(v==='mapbox' && lyrBaseMB) lyrBaseMB.setVisible(true);
  else if(v==='bing' && lyrBaseBing) lyrBaseBing.setVisible(true);
  else lyrBaseOSM.setVisible(true);
};
$("osmOverlayToggle").onchange=()=> lyrOSMOverlay.setVisible($("osmOverlayToggle").checked);
$("osmOverlayOpacity").oninput=()=>{
  const v=parseFloat($("osmOverlayOpacity").value);
  lyrOSMOverlay.setOpacity(v);
  $("osmOverlayOpacityVal").textContent = v.toFixed(2);
};

/* ====== İLK YÜK ====== */
(function initLoad(){
  readGJToLayer(indoorLayer,    loadLocal("indoor")    || {"type":"FeatureCollection","features":[]});
  readGJToLayer(outdoorLayer,   loadLocal("outdoor")   || {"type":"FeatureCollection","features":[]});
  readGJToLayer(buildingsLayer, loadLocal("buildings") || {"type":"FeatureCollection","features":[]});
  readGJToLayer(routesLayer,    loadLocal("routes")    || {"type":"FeatureCollection","features":[]});
})();

/* ====== KONUM (mavi nokta) ====== */
const accEl = $("acc");
let userMarker=null, accCircle=null, userLayer=null, follow=false, watchId=null;
(function startWatch(){
  if(!("geolocation" in navigator)) return;
  try{ if(watchId!==null) navigator.geolocation.clearWatch(watchId);}catch{}
  watchId = navigator.geolocation.watchPosition(pos=>{
    const coords = ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]);
    if(!userMarker){
      userMarker = new ol.Feature(new ol.geom.Point(coords));
      userMarker.setStyle(new ol.style.Style({ image:new ol.style.Circle({radius:6, fill:new ol.style.Fill({color:"#007bff"}), stroke:new ol.style.Stroke({color:"#fff",width:2})}) }));
      accCircle  = new ol.Feature(new ol.geom.Circle(coords, pos.coords.accuracy||0));
      accCircle.setStyle(new ol.style.Style({ stroke:new ol.style.Stroke({color:"#007bff",width:1}), fill:new ol.style.Fill({color:"rgba(0,123,255,0.08)"}) }));
      userLayer  = new ol.layer.Vector({ source:new ol.source.Vector({features:[accCircle,userMarker]}) });
      map.addLayer(userLayer);
    }else{
      userMarker.getGeometry().setCoordinates(coords);
      accCircle.getGeometry().setCenter(coords);
      accCircle.getGeometry().setRadius(pos.coords.accuracy||0);
    }
    accEl.textContent = "±" + Math.round(pos.coords.accuracy||0) + " m";
    accEl.style.display = "block";
  },()=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
})();

/* ====== ETKİLEŞİMLER ====== */
let mode=null, draw=null, select=null, selected=null, modify=null, snap=null;
function resetInteractions(){
  if(draw){map.removeInteraction(draw);draw=null;}
  if(select){map.removeInteraction(select);select=null;}
  if(modify){map.removeInteraction(modify);modify=null;}
  if(snap){map.removeInteraction(snap);snap=null;}
  selected=null; mode=null;
  ["addPoint","addLine","addPoly","selectBtn"].forEach(id=>$(id).classList.remove("active"));
  $("finishDraw").style.display="none"; map.getTargetElement().style.cursor="";
}
function enableSnap(layer){ if(snap) map.removeInteraction(snap); snap=new ol.interaction.Snap({source:layer.getSource()}); map.addInteraction(snap); }

function enrich(f){
  try{ if(!f.getId() && crypto?.randomUUID) f.setId(crypto.randomUUID()); }catch{}
  const g=f.getGeometry();
  const p=f.getProperties();
  if(g.getType()==="Polygon"){
    f.set("area_m2", Math.round(g.getArea()));
    if(p.category==="building" || $("layerSel").value==="buildings"){
      if(p.height==null){
        const lv = parseInt(p.levels ?? p['building:levels'],10);
        if(Number.isFinite(lv)) f.set("height", lv*3);
      }
    }
  }else if(g.getType()==="LineString"){
    const ll = to4326(g).getCoordinates();
    let len=0; for(let i=1;i<ll.length;i++) len += ol.sphere.getDistance(ll[i-1], ll[i]);
    f.set("len_m", Math.round(len));
  }
}
function openForm(f){
  selected=f;
  const p=f.getProperties();
  $("f_name").value   = p.name  || "";
  $("f_category").value = [...$("f_category").options].some(o=>o.value===p.category)? p.category : (p.category? "_other": "");
  $("f_stroke").value   = p.stroke || "";
  $("f_stroke_w").value = p.stroke_w ?? "";
  $("f_fill").value     = p.fill || "";
  $("f_level").value    = p.level || "";
  $("f_hours").value    = p.hours || "";
  $("f_desc").value     = p.desc || "";
  $("f_image").value    = p.image || "";
  $("f_icon_sz").value  = p.icon_sz ?? "";
  $("f_height").value   = p.height ?? "";
  $("f_levels").value   = p.levels ?? p['building:levels'] ?? "";
  $("f_id").value       = f.getId() || "";

  // özet
  const g=f.getGeometry();
  if(g.getType()==='Point'){
    const ll = to4326(g).getCoordinates(); $("f_metric").value = ll[0].toFixed(6)+", "+ll[1].toFixed(6);
  }else if(g.getType()==='LineString'){
    $("f_metric").value = "Çizgi · uzunluk: "+(p.len_m||0)+" m";
  }else{
    $("f_metric").value = "Poligon · alan: "+(p.area_m2||0)+" m²";
  }

  $("propModal").style.display="flex"; $("propModal").setAttribute("aria-hidden","false");

  $("propSave").onclick=()=>{
    const props={
      name:$("f_name").value.trim() || undefined,
      category: ($("f_category").value==="_other"? "_other" : $("f_category").value) || undefined,
      stroke: $("f_stroke").value.trim() || undefined,
      stroke_w: Number($("f_stroke_w").value) || undefined,
      fill: $("f_fill").value.trim() || undefined,
      level:$("f_level").value.trim() || undefined,
      hours:$("f_hours").value.trim() || undefined,
      desc:$("f_desc").value.trim() || undefined,
      image:$("f_image").value.trim() || undefined,
      icon_sz: Number($("f_icon_sz").value)||undefined,
      height: Number($("f_height").value)||undefined,
      levels: parseInt($("f_levels").value||"",10) || undefined,
      'building:levels': parseInt($("f_levels").value||"",10) || undefined
    };
    f.setProperties(props);
    enrich(f); // metrikleri güncelle
    saveLocal($("layerSel").value, tgtLayer());
    setStatus("Kaydedildi.");
  };
  $("propClose").onclick=()=>{ $("propModal").style.display="none"; $("propModal").setAttribute("aria-hidden","true"); resetInteractions(); };
  $("propGeom").onclick=()=>{ if(modify) map.removeInteraction(modify); modify=new ol.interaction.Modify({ features: new ol.Collection([f]) }); map.addInteraction(modify); enableSnap(tgtLayer()); modify.on("modifyend",()=>{ enrich(f); saveLocal($("layerSel").value, tgtLayer()); }); };
  $("propDelete").onclick=()=>{ if(confirm("Bu öğe silinsin mi?")){ tgtLayer().getSource().removeFeature(f); saveLocal($("layerSel").value, tgtLayer()); $("propModal").style.display="none"; resetInteractions(); } };
}

/* Çizim/Seçim */
$("addPoint").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="point"; $("addPoint").classList.add("active"); setStatus("NOKTA: haritaya tıkla/dokun"); map.getTargetElement().style.cursor="crosshair";
  map.once("singleclick", (evt)=>{ const f=new ol.Feature(new ol.geom.Point(evt.coordinate)); enrich(f); tgtLayer().getSource().addFeature(f); openForm(f); saveLocal($("layerSel").value, tgtLayer()); });
};
$("addLine").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="line"; $("addLine").classList.add("active"); setStatus("ÇİZGİ: noktaları yerleştir; çift tıkla bitir ya da ✔ Bitir"); map.getTargetElement().style.cursor="crosshair";
  const layer=tgtLayer(); draw=new ol.interaction.Draw({source:layer.getSource(), type:"LineString"}); map.addInteraction(draw); enableSnap(layer); $("finishDraw").style.display="inline-block";
  $("finishDraw").onclick=()=>{ if(draw) draw.finishDrawing(); };
  draw.once("drawend",(ev)=>{ $("finishDraw").style.display="none"; enrich(ev.feature); openForm(ev.feature); saveLocal($("layerSel").value, layer); });
};
$("addPoly").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="polygon"; $("addPoly").classList.add("active"); setStatus("POLİGON: noktaları yerleştir; çift tıkla bitir ya da ✔ Bitir"); map.getTargetElement().style.cursor="crosshair";
  const layer=tgtLayer(); draw=new ol.interaction.Draw({source:layer.getSource(), type:"Polygon"}); map.addInteraction(draw); enableSnap(layer); $("finishDraw").style.display="inline-block";
  $("finishDraw").onclick=()=>{ if(draw) draw.finishDrawing(); };
  draw.once("drawend",(ev)=>{ $("finishDraw").style.display="none"; enrich(ev.feature); openForm(ev.feature); saveLocal($("layerSel").value, layer); });
};
$("selectBtn").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="select"; $("selectBtn").classList.add("active"); setStatus("SEÇİM: öğeye tıkla → form"); const layer=tgtLayer(); select=new ol.interaction.Select({layers:[layer]}); if(select.setHitTolerance) select.setHitTolerance(6); map.addInteraction(select); select.on("select",ev=>{ selected=ev.selected[0]||null; if(selected) openForm(selected); }); };
$("layerSel").addEventListener("change",()=>{ resetInteractions(); indoorLayer.changed(); outdoorLayer.changed(); buildingsLayer.changed(); routesLayer.changed(); });
$("levelFilter").addEventListener("input",()=>{ indoorLayer.changed(); outdoorLayer.changed(); buildingsLayer.changed(); routesLayer.changed(); });
$("showArrows").addEventListener("change",()=> routesLayer.changed());

/* Kopyala (duplicate) */
function duplicateFeature(f){
  if(!f) return;
  const clone=f.clone();
  clone.setId(crypto?.randomUUID?crypto.randomUUID():undefined);
  const g=clone.getGeometry();
  g.translate(3,3); // küçük bir sapma
  tgtLayer().getSource().addFeature(clone);
  enrich(clone);
  saveLocal($("layerSel").value, tgtLayer());
  setStatus("Kopyalandı.");
}
$("duplicateBtn").onclick=()=> duplicateFeature(selected);
document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='d'){ e.preventDefault(); duplicateFeature(selected); }});

/* ====== İNDİR / YÜKLE / TEMİZLE ====== */
function dl(obj,name){ const b=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement("a"); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
$("expIndoor").onclick=()=> dl(writeGJ(indoorLayer),"indoor.json");
$("expOutdoor").onclick=()=> dl(writeGJ(outdoorLayer),"outdoor.json");
$("expBuildings").onclick=()=> dl(writeGJ(buildingsLayer),"buildings.json");
$("expRoutes").onclick=()=> dl(writeGJ(routesLayer),"routes.json");

$("imp").addEventListener("change", async e=>{
  const file=e.target.files[0]; if(!file) return;
  if(file.size>10*1024*1024){ alert("Dosya > 10MB."); e.target.value=""; return; }
  try{
    const json=JSON.parse(await file.text());
    const layer=tgtLayer(); readGJToLayer(layer,json);
    saveLocal($("layerSel").value, layer);
    alert("GeoJSON yüklendi (aktif katmana).");
  }catch(err){ console.error(err); alert("Geçersiz GeoJSON."); }
  e.target.value="";
});
$("clearLocal").onclick=()=>{ if(confirm("Yerel veriyi sil?")){ ["indoor","outdoor","buildings","routes"].forEach(k=>localStorage.removeItem(k)); alert("Temizlendi. Sayfayı yenileyin."); } };

setStatus("Hazır: Uydu + OSM kılavuz • Indoor/Outdoor/3D/Routes • Kopyalama • Yön okları • Import/Export • LocalStorage");
</script>
</body>
</html>
