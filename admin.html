<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Admin – Tek Sahne (Satellite ↔ MapLibre 3D) + Çizim/Özellikler</title>

<!-- MapLibre -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Mapbox GL Draw (MapLibre ile uyumlu) -->
<link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet">
<script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>

<style>
  :root{ --shadow:0 10px 28px rgba(0,0,0,.18); --muted:#5b6a6a; --brand:#0f5132; --border:#d7e5dc; --chip:#e6f4ef; --bg:#fff; }
  html,body{height:100%;margin:0; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #map{position:fixed; inset:0}
  .panel{position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:10px; width:min(1180px,calc(100% - 20px))}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .row>*{flex:0 0 auto}
  .grow{flex:1 1 auto}
  select,button,input[type="text"],input[type="number"],input[type="range"]{padding:9px 10px; border:1px solid #e5efe9; border-radius:10px; background:#fff}
  button{cursor:pointer} button:active{transform:translateY(1px)}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--chip)}
  .small{font-size:12px;color:#666}
  .acc{position:fixed; right:10px; bottom:10px; z-index:9; background:#fff; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow); display:none}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:11}
  .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; width:min(820px,92vw); box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px}
  .grid label{font-size:12px;color:#555}
  .grid input,.grid select,.grid textarea{width:100%; padding:9px 10px; border:1px solid #e5efe9; border-radius:8px}
  textarea{min-height:64px}
</style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <div class="row">
    <label class="chip"><input type="radio" name="bm" id="bmSat" checked> Satellite</label>
    <label class="chip"><input type="radio" name="bm" id="bm3d"> MapLibre 3D</label>

    <span class="small">Uydu opaklık</span>
    <input id="satOp" type="range" min="0" max="1" step="0.05" value="0.95">
    <span id="satOpVal" class="small">0.95</span>

    <span class="grow"></span>

    <select id="layerSel" title="Düzenleme hedefi">
      <option value="outdoor">Hedef: OUTDOOR</option>
      <option value="indoor">Hedef: INDOOR</option>
      <option value="buildings">Hedef: BUILDINGS (3D)</option>
      <option value="routes">Hedef: ROUTES</option>
    </select>

    <input id="levelFilter" placeholder="Kat filtresi (örn: 1) – boş=hepsi" style="min-width:200px">

    <button id="follow">🎯 Takip: Kapalı</button>
    <label class="chip"><input type="checkbox" id="showArrows" checked> Yol yön okları</label>
  </div>

  <div class="row">
    <button id="editToggle">✏️ Düzenle: Kapalı</button>
    <button id="btnPt">➕ Nokta</button>
    <button id="btnLn">〰️ Çizgi</button>
    <button id="btnPg">⬛ Poligon</button>
    <button id="btnSave">💾 Kaydet (aktif katman)</button>
    <button id="btnProps">☑ Özellikler</button>
    <label>⤒ JSON Yükle <input id="imp" type="file" accept=".json,application/json"></label>
    <button id="expIndoor">⤓ indoor.json</button>
    <button id="expOutdoor">⤓ outdoor.json</button>
    <button id="expBuildings">⤓ buildings.json</button>
    <button id="expRoutes">⤓ routes.json</button>
    <button id="clearLocal" style="border-color:#ffb3b3;background:#fff5f5">🧹 Yerel Veriyi Temizle</button>
  </div>
</div>

<div id="acc" class="acc"></div>

<!-- Özellik formu -->
<div id="propModal" class="modal" aria-hidden="true">
  <div class="card">
    <h3 style="margin:0 0 8px">Özellikler</h3>
    <div class="grid">
      <div><label>İsim</label><input id="p_name" placeholder="Örn: Ana Restoran"></div>
      <div><label>Kategori</label>
        <select id="p_category">
          <option value="">(yok)</option>
          <option>restaurant</option><option>bar</option><option>spa</option><option>pool</option>
          <option>wc</option><option>elevator</option><option>kidsclub</option><option>reception</option>
          <option>beach</option><option>shop</option><option>gym</option><option>gate</option>
          <option>parking</option><option>shuttle</option><option>path</option><option>info</option>
          <option>building</option>
        </select>
      </div>
      <div><label>Saat</label><input id="p_hours" placeholder="09:00-22:00"></div>
      <div><label>Kat / Seviye</label><input id="p_level" placeholder="1"></div>
      <div style="grid-column:1/-1"><label>Açıklama</label><textarea id="p_desc" placeholder="Kısa açıklama veya https://..."></textarea></div>
      <div style="grid-column:1/-1"><label>Foto/ikon URL</label><input id="p_image" placeholder="https://.../foto.png"></div>

      <div><label>Dolgu rengi (fill)</label><input id="p_fill" placeholder="#09DCE4"></div>
      <div><label>Çizgi rengi (stroke)</label><input id="p_stroke" placeholder="#1f2937"></div>
      <div><label>Çizgi kalınlığı (width)</label><input id="p_width" type="number" step="0.5" min="0"></div>
      <div><label>İkon/Emoji</label><input id="p_icon" placeholder="🏊‍♂️"></div>

      <div><label>Yol tipi (routes)</label>
        <select id="p_way">
          <option value="">(yok)</option>
          <option value="foot">Yaya</option>
          <option value="run">Koşu</option>
          <option value="indoor">Indoor koridor</option>
          <option value="bike">Bisiklet</option>
          <option value="shuttle">Shuttle</option>
          <option value="service">Servis/araç</option>
          <option value="no_entry">Girilmez</option>
          <option value="oneway_fwd">Tek yön (→)</option>
          <option value="oneway_rev">Tek yön (←)</option>
        </select>
      </div>

      <div><label>Yükseklik (m)</label><input id="p_height" type="number" step="0.5" min="0"></div>
      <div><label>Kat sayısı</label><input id="p_levels" type="number" step="1" min="0"></div>
    </div>

    <div class="row" style="margin-top:10px; justify-content:space-between">
      <div class="row">
        <button id="propDelete" style="border-color:#ffb3b3;background:#fff5f5">🗑️ Sil</button>
      </div>
      <div class="row">
        <button id="propSave">Kaydet</button>
        <button id="propClose">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== TOKENLER ===== */
const MAPBOX_TOKEN = "pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";   // değiştir
const MAPTILER_KEY = "ym4UWHwsNK61YUsmqi5C"; // değiştir

/* ===== HARİTA SABİTLERİ ===== */
const HOTEL_BBOX = [31.801445, 36.597411, 31.808467, 36.600917];
const PADDING = {top:60,right:16,bottom:180,left:16};
const CENTER = [(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2];

/* yardımcılar */
const $ = id => document.getElementById(id);
const toHex = s => (s||'').trim().replace(/^#?/,'#');
const emptyFC = () => ({type:'FeatureCollection',features:[]});
const lsGet = k => { try{ const s=localStorage.getItem(k); return s?JSON.parse(s):null; }catch{ return null; } };
const lsSet = (k,v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };
const dl = (obj,name)=>{ const b=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement("a"); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); };

/* MapboxDraw, MapLibre ile çalışsın */
window.mapboxgl = maplibregl;

/* ===== MAPLIBRE SAHNESİ ===== */
const baseStyle = {
  version: 8,
  glyphs: `https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${MAPTILER_KEY}`,
  sources: {},
  layers: [{id:'bg',type:'background',paint:{'background-color':'#dfe7e7'}}]
};
const map = new maplibregl.Map({
  container:'map',
  style: baseStyle,
  center:CENTER, zoom:17, pitch:45, bearing:0, maxZoom:21, attributionControl:false
});
map.addControl(new maplibregl.NavigationControl({visualizePitch:true}),'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'© aihotelstech · © OSM · © MapTiler · © Mapbox'}));

/* ===== TABANLAR + KATMANLAR ===== */
map.on('load', () => {
  // Satellite (raster)
  map.addSource('sat', {
    type:'raster',
    tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}@2x?access_token=${MAPBOX_TOKEN}`],
    tileSize:256, attribution:"© Mapbox © OSM"
  });
  map.addLayer({id:'sat-lyr', type:'raster', source:'sat', paint:{'raster-opacity': parseFloat($('satOp').value)}}, 'bg');

  // 3D için DEM + OSM binalar
  map.addSource('dem',{type:'raster-dem', url:`https://api.maptiler.com/tiles/terrain-rgb/tiles.json?key=${MAPTILER_KEY}`, tileSize:256});
  map.addSource('omt',{type:'vector', url:`https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`});

  map.addLayer({
    id:'bldg-3d-osm', type:'fill-extrusion', source:'omt', 'source-layer':'building',
    layout:{visibility:'none'},
    paint:{
      'fill-extrusion-color':'#b9c9d6','fill-extrusion-opacity':0.85,
      'fill-extrusion-height':['coalesce',['to-number',['get','render_height']],['to-number',['get','height']],6],
      'fill-extrusion-base'  :['coalesce',['to-number',['get','render_min_height']],['to-number',['get','min_height']],0]
    }, minzoom:14
  });

  // ÇİZİM KAYNAKLARI (senin verin)
  map.addSource('indoor',    {type:'geojson', data: lsGet('indoor')    || emptyFC(), promoteId:'fid'});
  map.addSource('outdoor',   {type:'geojson', data: lsGet('outdoor')   || emptyFC(), promoteId:'fid'});
  map.addSource('buildings', {type:'geojson', data: lsGet('buildings') || emptyFC(), promoteId:'fid'});
  map.addSource('routes',    {type:'geojson', data: lsGet('routes')    || emptyFC(), promoteId:'fid'});

  addFeatureLayers('indoor');
  addFeatureLayers('outdoor');
  addBuildingLayers();
  addRouteLayers();
  addBlueDot();

  // İlk durumlar (STYLE YÜKLENDİKTEN SONRA!)
  $('satOp').dispatchEvent(new Event('input'));
  applyBasemap();
  applyLevelFilter();

  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]], {padding:PADDING, maxZoom:19});
});

/* ===== STİL LAYERLARI ===== */
function addFeatureLayers(src){
  map.addLayer({id:`${src}-fill`, type:'fill', source:src,
    filter:['==',['geometry-type'],'Polygon'],
    paint:{
      'fill-color'  :['coalesce',['get','fill'],'#2563eb'],
      'fill-opacity':['coalesce',['get','fill_op'],0.35]
    }
  });
  map.addLayer({id:`${src}-outline`, type:'line', source:src,
    filter:['==',['geometry-type'],'Polygon'],
    paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','width'],1.6]}
  });
  map.addLayer({id:`${src}-line`, type:'line', source:src,
    filter:['==',['geometry-type'],'LineString'],
    paint:{'line-color':['coalesce',['get','stroke'],'#1f2937'],'line-width':['coalesce',['get','width'],2.5]}
  });
  map.addLayer({id:`${src}-pts`, type:'circle', source:src,
    filter:['==',['geometry-type'],'Point'],
    paint:{
      'circle-radius':['coalesce',['get','icon_sz'],6],
      'circle-color' :['coalesce',['get','stroke'],'#e53935'],
      'circle-stroke-color':'#fff','circle-stroke-width':1.6
    }
  });
}

function addBuildingLayers(){
  // 2D görünüm (her zaman)
  map.addLayer({id:'bld-2d-fill', type:'fill', source:'buildings',
    filter:['==',['geometry-type'],'Polygon'],
    paint:{'fill-color':['coalesce',['get','fill'],'#c9b49b'],'fill-opacity':0.25}
  });
  map.addLayer({id:'bld-2d-line', type:'line', source:'buildings',
    filter:['==',['geometry-type'],'Polygon'],
    paint:{'line-color':['coalesce',['get','stroke'],'#8b6f55'],'line-width':['coalesce',['get','width'],2]}
  });

  // 3D extrude (3D açıkken görünür)
  map.addLayer({id:'bld-3d-ex', type:'fill-extrusion', source:'buildings',
    layout:{visibility:'none'},
    filter:['==',['geometry-type'],'Polygon'],
    paint:{
      'fill-extrusion-color':['coalesce',['get','fill'],'#c9b49b'],
      'fill-extrusion-opacity':0.95,
      'fill-extrusion-height':[
        'coalesce',
        ['to-number',['get','height']],
        ['*',['to-number',['coalesce',['get','levels'],1]],3]
      ],
      'fill-extrusion-base':0
    }, minzoom:14
  });
}

function addRouteLayers(){
  const colorByWay = [
    'match',['get','way'],
    'bike','#22c55e','run','#a855f7','shuttle','#f59e0b','service','#6b7280','indoor','#0ea5e9','foot','#1f2937',
    /*default*/ ['coalesce',['get','stroke'],'#1f2937']
  ];
  // normal hatlar (no_entry hariç)
  map.addLayer({id:'routes-line', type:'line', source:'routes',
    filter:['all',['==',['geometry-type'],'LineString'], ['!=',['get','way'],'no_entry']],
    paint:{'line-color': colorByWay, 'line-width': ['coalesce',['get','width'], 3]}
  });
  // "no_entry" için ayrı dashed layer (MapLibre'de data-driven dash desteklenmeyebilir)
  map.addLayer({id:'routes-noentry', type:'line', source:'routes',
    filter:['all',['==',['geometry-type'],'LineString'], ['==',['get','way'],'no_entry']],
    paint:{'line-color':'#ef4444','line-width':['coalesce',['get','width'],3],'line-dasharray':[6,6]}
  });
  // yön okları (glyphs tanımlı!)
  map.addLayer({id:'routes-arrows', type:'symbol', source:'routes',
    filter:['all',['==',['geometry-type'],'LineString'], ['in',['get','way'], ['literal',['oneway_fwd','oneway_rev','shuttle','bike','indoor','foot','run']]]],
    layout:{'symbol-placement':'line','text-field':'→','text-size':14,'text-allow-overlap':true,'visibility': $('showArrows').checked ? 'visible':'none'},
    paint:{'text-color': colorByWay}
  });
}

/* ===== 3D AÇ/KAPA + SATELLITE OPACITY ===== */
function applyBasemap(){
  if (!map.isStyleLoaded()) { map.once('idle', applyBasemap); return; }
  if ($('bm3d').checked){
    map.setTerrain({source:'dem', exaggeration:1});
    map.setLayoutProperty('bldg-3d-osm','visibility','visible');
    map.setLayoutProperty('bld-3d-ex','visibility','visible');
  }else{
    map.setTerrain(null);
    map.setLayoutProperty('bldg-3d-osm','visibility','none');
    map.setLayoutProperty('bld-3d-ex','visibility','none');
  }
}
$('bmSat').onchange = applyBasemap;
$('bm3d').onchange  = applyBasemap;
$('satOp').oninput  = ()=>{ const v=parseFloat($('satOp').value); $('satOpVal').textContent=v.toFixed(2); if(map.getLayer('sat-lyr')) map.setPaintProperty('sat-lyr','raster-opacity',v); };

/* ===== LEVEL FİLTRESİ ===== */
function setFilterIf(id, f){ if(map.getLayer(id)) map.setFilter(id, f); }
function applyLevelFilter(){
  const lv=($('levelFilter').value||'').trim();
  const byLevel = lv ? ['==',['to-string',['coalesce',['get','level'],'']], lv] : ['boolean',true];

  // indoor & outdoor
  [['indoor','Polygon','fill'],['indoor','Polygon','outline'],['indoor','LineString','line'],['indoor','Point','pts'],
   ['outdoor','Polygon','fill'],['outdoor','Polygon','outline'],['outdoor','LineString','line'],['outdoor','Point','pts']
  ].forEach(([src,gt,sfx])=>{
    setFilterIf(`${src}-${sfx}`, ['all',['==',['geometry-type'],gt], byLevel]);
  });

  // buildings (2D + 3D)
  setFilterIf('bld-2d-fill', ['all',['==',['geometry-type'],'Polygon'], byLevel]);
  setFilterIf('bld-2d-line', ['all',['==',['geometry-type'],'Polygon'], byLevel]);
  setFilterIf('bld-3d-ex',   ['all',['==',['geometry-type'],'Polygon'], byLevel]);

  // routes
  setFilterIf('routes-line',   ['all',['==',['geometry-type'],'LineString'], ['!=',['get','way'],'no_entry'], byLevel]);
  setFilterIf('routes-noentry',['all',['==',['geometry-type'],'LineString'], ['==',['get','way'],'no_entry'], byLevel]);
  setFilterIf('routes-arrows', ['all',['==',['geometry-type'],'LineString'], ['in',['get','way'], ['literal',['oneway_fwd','oneway_rev','shuttle','bike','indoor','foot','run']]], byLevel]);
}
$('levelFilter').addEventListener('input', applyLevelFilter);

/* ===== YÖN OKLARI GÖRÜNÜRLÜK ===== */
$('showArrows').addEventListener('change', ()=> map.setLayoutProperty('routes-arrows','visibility', $('showArrows').checked?'visible':'none') );

/* ===== BLUE DOT ===== */
function addBlueDot(){
  map.addSource('me',{type:'geojson',data:emptyFC()});
  map.addLayer({id:'me-pt',type:'circle',source:'me',paint:{'circle-radius':6,'circle-color':'#1d4ed8','circle-stroke-color':'#fff','circle-stroke-width':1.6}});
  const acc=$('acc'); let follow=false; let last=null;
  $('follow').onclick=()=>{ follow=!follow; $('follow').textContent = follow?"🎯 Takip: Açık":"🎯 Takip: Kapalı"; if(follow && last) map.easeTo({center:last}); };
  if('geolocation' in navigator){
    navigator.geolocation.watchPosition(p=>{
      last=[p.coords.longitude,p.coords.latitude];
      map.getSource('me').setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:last}}]});
      acc.textContent="±"+Math.round(p.coords.accuracy||0)+" m"; acc.style.display='block';
      if(follow) map.easeTo({center:last});
    }, console.warn, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  }
}

/* ====== DRAW (ÇİZİM) ====== */
const draw = new MapboxDraw({ displayControlsDefault:false });
let editing=false, drawAdded=false;
function activeSrc(){ return $('layerSel').value; }
function readSourceData(name){ return (map.getSource(name)? map.getSource(name)._data : emptyFC()) || emptyFC(); }
function writeSourceData(name, gj){ map.getSource(name).setData(gj); lsSet(name, gj); }

$('editToggle').onclick = ()=>{
  editing = !editing;
  $('editToggle').textContent = editing ? '✏️ Düzenle: Açık' : '✏️ Düzenle: Kapalı';
  if(editing){
    if(!drawAdded){ map.addControl(draw,'top-left'); drawAdded=true; }
    draw.set(readSourceData(activeSrc()));
  }else{
    if(drawAdded){ map.removeControl(draw); drawAdded=false; }
  }
};
$('layerSel').addEventListener('change', ()=>{ if(editing) draw.set(readSourceData(activeSrc())); });

$('btnPt').onclick = ()=> editing && draw.changeMode('draw_point');
$('btnLn').onclick = ()=> editing && draw.changeMode('draw_line_string');
$('btnPg').onclick = ()=> editing && draw.changeMode('draw_polygon');

$('btnSave').onclick = ()=>{
  if(!editing){ alert('Önce "Düzenle"yi aç.'); return; }
  const fc = draw.getAll() || emptyFC();
  let i=1; (fc.features||[]).forEach(f=>{ f.properties=f.properties||{}; f.properties.fid = f.properties.fid || (activeSrc()[0]+(i++)); });
  writeSourceData(activeSrc(), fc);
  alert('Kaydedildi: '+activeSrc());
};

$('imp').addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const gj=JSON.parse(await file.text());
    writeSourceData(activeSrc(), gj);
    if(editing) draw.set(gj);
    alert('Yüklendi (aktif katmana).');
  }catch{ alert('Geçersiz JSON'); }
  e.target.value='';
});

/* ====== Exportlar ====== */
$('expIndoor').onclick   = ()=> dl(readSourceData('indoor'), 'indoor.json');
$('expOutdoor').onclick  = ()=> dl(readSourceData('outdoor'),'outdoor.json');
$('expBuildings').onclick= ()=> dl(readSourceData('buildings'),'buildings.json');
$('expRoutes').onclick   = ()=> dl(readSourceData('routes'),'routes.json');

$('clearLocal').onclick=()=>{
  if(!confirm('Yerel veriyi temizleyip katmanları boşalt?')) return;
  ['indoor','outdoor','buildings','routes'].forEach(k=>{ lsSet(k, emptyFC()); if(map.getSource(k)) map.getSource(k).setData(emptyFC()); });
  if(editing) draw.set(emptyFC());
};

/* ====== Özellik Formu ====== */
const modal=$('propModal');
function openProps(){
  if(!editing){ alert('Önce "Düzenle"yi aç.'); return; }
  const sel=draw.getSelected(); const f=(sel.features||[])[0];
  if(!f){ alert('Bir özellik seç.'); return; }
  const p=f.properties||{};
  $('p_name').value=p.name||'';
  $('p_category').value=p.category||'';
  $('p_hours').value=p.hours||'';
  $('p_level').value=p.level||'';
  $('p_desc').value=p.desc||'';
  $('p_image').value=p.image||'';
  $('p_fill').value=p.fill||'';
  $('p_stroke').value=p.stroke||'';
  $('p_width').value=Number.isFinite(p.width)?p.width:'';
  $('p_icon').value=p.icon_text||'';
  $('p_way').value=p.way||'';
  $('p_height').value=Number.isFinite(p.height)?p.height:'';
  $('p_levels').value=Number.isFinite(p.levels)?p.levels:'';
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');

  $('propSave').onclick=()=>{
    const id=f.id;
    const np={
      name: $('p_name').value||undefined,
      category: $('p_category').value||undefined,
      hours: $('p_hours').value||undefined,
      level: $('p_level').value||undefined,
      desc: $('p_desc').value||undefined,
      image: $('p_image').value||undefined,
      fill:  $('p_fill').value? toHex($('p_fill').value):undefined,
      stroke:$('p_stroke').value? toHex($('p_stroke').value):undefined,
      width: parseFloat($('p_width').value)||undefined,
      icon_text:$('p_icon').value||undefined,
      way: $('p_way').value||undefined,
      height: parseFloat($('p_height').value)||undefined,
      levels: parseInt($('p_levels').value)||undefined,
    };
    Object.entries(np).forEach(([k,v])=> draw.setFeatureProperty(id, k, v));
    modal.style.display='none'; modal.setAttribute('aria-hidden','true');
  };
  $('propDelete').onclick=()=>{ if(confirm('Silinsin mi?')){ draw.delete(f.id); modal.style.display='none'; } };
  $('propClose').onclick=()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); };
}
$('btnProps').onclick=openProps;
</script>
</body>
</html>
