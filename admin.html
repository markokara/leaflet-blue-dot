<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Admin – Indoor/Outdoor/3D/Route Editör</title>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.css" rel="stylesheet"/>
<script src="https://unpkg.com/mapbox-gl-draw@1.5.0/dist/mapbox-gl-draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{position:fixed; inset:0}
  .topbar{
    position:fixed; left:10px; top:10px; z-index:10; display:flex; gap:6px; align-items:center;
    background:#fff; border:1px solid #ddd; padding:6px 8px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.15);
  }
  .panel{
    position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10;
    background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    padding:10px; width:min(1100px,96vw);
  }
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .row>*{flex:0 0 auto}
  select,input,button{padding:9px 10px; border:1px solid #ddd; border-radius:10px; background:#fff}
  button{cursor:pointer}
  .primary{background:#f0f7ff; border-color:#b3d7ff}
  .pill{padding:4px 8px; font-size:12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:12}
  .sheet{background:#fff; width:min(780px,95vw); max-height:90vh; overflow:auto; border-radius:14px; padding:14px; box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid label{font-size:12px; color:#555}
  .grid input,.grid select,.grid textarea{width:100%; padding:9px 10px; border:1px solid #ddd; border-radius:8px}
  textarea{min-height:64px}
  .status{position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:11; background:#111;color:#fff; padding:6px 10px; border-radius:8px; display:none}
</style>
</head>
<body>
<div id="map"></div>
<div class="status" id="status"></div>

<!-- TABAN & HEDEF & OPAKLIK -->
<div class="topbar">
  <select id="baseSel">
    <option value="osm" selected>OSM (Standart)</option>
    <option value="sat">Mapbox Satellite</option>
    <option value="mtstreets">MapTiler Streets</option>
    <option value="photo">Foto Arka Plan</option>
  </select>
  <label class="pill">OSM çizim katmanı
    <input id="osmOpacity" type="range" min="0" max="100" value="60" style="vertical-align:middle; width:120px">
    <span id="opv" style="font-size:12px;color:#555">0.60</span>
  </label>
</div>

<!-- ANA ARAÇ ÇUBUĞU -->
<div class="panel">
  <div class="row" style="margin-bottom:8px">
    <select id="layerSel">
      <option value="outdoor">Hedef: OUTDOOR</option>
      <option value="indoor">Hedef: INDOOR</option>
      <option value="buildings">Hedef: 3D BİNALAR</option>
      <option value="routes">Hedef: YOLLAR</option>
    </select>
    <input id="levelFilter" placeholder="Kat filtresi (ör: 1) – boş=hepsi" style="min-width:160px">
    <button id="btnPoint" class="primary">➕ Nokta</button>
    <button id="btnLine" class="primary">➖ Çizgi</button>
    <button id="btnPoly" class="primary">⬛ Poligon</button>
    <button id="btnSel"  class="">☑ Seç</button>
    <button id="btnDup">📄 Kopyala</button>
    <button id="btnReverse">⇄ Çizgiyi Ters Çevir</button>
    <button id="btnArrows" class="primary">➤ Yön Okları: Açık</button>
    <span class="pill">Aktif hedef vurgulu</span>
  </div>

  <div class="row">
    <button id="expIndoor">⤓ indoor.json</button>
    <button id="expOutdoor">⤓ outdoor.json</button>
    <button id="expBuildings">⤓ buildings.json</button>
    <button id="expRoutes">⤓ routes.json</button>
    <label>⤒ JSON Yükle <input id="imp" type="file" accept=".json,application/json"></label>
    <button id="clearLocal" class="">🧹 Yerel Veriyi Temizle</button>
    <button id="btnProps" class="primary">Özellikler…</button>
  </div>
</div>

<!-- ÖZELLİK MODALI -->
<div class="modal" id="propModal" aria-hidden="true">
  <div class="sheet">
    <h3>Özellikler</h3>
    <div class="grid">
      <div><label>İsim (varsayılan)</label><input id="f_name" placeholder="Örn: Ana Restoran"></div>
      <div>
        <label>Kategori</label>
        <select id="f_category">
          <option value="">Seçiniz…</option>
          <optgroup label="Mekanlar">
            <option>restaurant</option><option>bar</option><option>cafe</option><option>shop</option>
            <option>spa</option><option>gym</option><option>pool</option><option>aquapark</option>
            <option>kidsclub</option><option>beach</option><option>reception</option><option>toilet</option>
            <option>tennis</option><option>basketball</option><option>football</option><option>parking</option>
            <option>gate</option><option>info</option><option>building</option>
          </optgroup>
          <optgroup label="Yol Türleri">
            <option>footway</option><option>cycleway</option><option>jogging</option><option>shuttle</option>
            <option>service</option>
          </optgroup>
          <option value="_other">Diğer…</option>
        </select>
      </div>
      <div style="grid-column:1/-1; display:none" id="catOtherWrap"><label>Diğer Kategori</label><input id="f_category_other" placeholder="ör. lounge"></div>

      <div><label>Saatler</label><input id="f_hours" placeholder="09:00-22:00"></div>
      <div><label>Seviye/Kat</label><input id="f_level" placeholder="1"></div>
      <div style="grid-column:1/-1"><label>Açıklama</label><textarea id="f_desc" placeholder="Kısa açıklama veya https://... linkleri"></textarea></div>

      <div><label>İkon URL (PNG/SVG)</label><input id="f_icon" placeholder="https://.../icon.svg"></div>
      <div><label>İkon Boyutu (px)</label><input id="f_icon_sz" type="number" min="8" max="64" step="1" placeholder="24"></div>

      <div><label>Fotoğraf URL (popup)</label><input id="f_image" placeholder="https://.../foto.jpg"></div>
      <div><label>Yükseklik (m)</label><input id="f_height" type="number" min="0" step="0.5"></div>
      <div><label>Kat Sayısı</label><input id="f_levels" type="number" min="0" step="1"></div>

      <div><label>Çizgi Rengi</label><input id="f_stroke" placeholder="#1b7a5b"></div>
      <div><label>Çizgi Kalınlığı</label><input id="f_stroke_w" type="number" min="0.5" step="0.5" placeholder="2"></div>
      <div><label>Dolu (fill)</label><input id="f_fill" placeholder="#09DCE4"></div>
      <div><label>Dolu Opaklık (0–1)</label><input id="f_fill_op" type="number" min="0" max="1" step="0.05" placeholder="0.25"></div>

      <div><label>Öğe ID (okuma)</label><input id="f_id" disabled></div>
      <div><label>Özet</label><input id="f_metric" disabled></div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid #eee">
    <div class="grid">
      <div>
        <label>Dil</label>
        <select id="f_lang">
          <option value="tr">Türkçe</option><option value="en">English</option>
          <option value="ru">Русский</option><option value="de">Deutsch</option><option value="pl">Polski</option>
        </select>
      </div>
      <div class="pill" style="align-self:end">Bu bölüm name_XX / hours_XX / level_XX / desc_XX / image_XX yazar.</div>
    </div>
    <div class="grid">
      <div><label>İsim (dil)</label><input id="l_name"></div>
      <div><label>Saatler (dil)</label><input id="l_hours"></div>
      <div><label>Seviye/Kat (dil)</label><input id="l_level"></div>
      <div style="grid-column:1/-1"><label>Açıklama (dil)</label><textarea id="l_desc"></textarea></div>
      <div style="grid-column:1/-1"><label>Fotoğraf URL (dil)</label><input id="l_image" placeholder="https://.../foto.jpg"></div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:10px">
      <div class="row">
        <button id="btnGeom" class="pill">Geometriyi Düzenle</button>
        <button id="btnDelete" class="pill">Sil</button>
      </div>
      <div class="row">
        <button id="btnSave" class="primary">Kaydet</button>
        <button id="btnClose" class="primary">Kapat</button>
      </div>
    </div>
  </div>
</div>

<!-- FOTO ARKA PLAN MODALI -->
<div class="modal" id="photoModal" aria-hidden="true">
  <div class="sheet">
    <h3>Foto Arka Plan</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div style="grid-column:1/-1"><label>Görsel URL</label><input id="bgImgUrl" placeholder="https://.../aerial.jpg"></div>
      <div><label>Sol-Üst (lon,lat)</label><input id="bgLT" placeholder="31.80,36.60"></div>
      <div><label>Sağ-Üst (lon,lat)</label><input id="bgRT" placeholder="31.81,36.60"></div>
      <div><label>Sağ-Alt (lon,lat)</label><input id="bgRB" placeholder="31.81,36.59"></div>
      <div><label>Sol-Alt (lon,lat)</label><input id="bgLB" placeholder="31.80,36.59"></div>
      <div style="grid-column:1/-1">
        <label>Opaklık</label>
        <input type="range" id="bgOpacity" min="0" max="100" value="70" style="width:100%">
      </div>
    </div>
    <div class="row" style="justify-content:flex-end; margin-top:10px">
      <button id="bgApply" class="primary">Uygula</button>
      <button id="bgClose" class="primary">Kapat</button>
    </div>
  </div>
</div>

<script>
/* ===== yardımcılar ===== */
const $=id=>document.getElementById(id);
const statusEl=$('status'); const setStatus=(m,ms=1800)=>{ if(!m){statusEl.style.display='none';return;} statusEl.textContent=m; statusEl.style.display='block'; if(ms>0) setTimeout(()=>statusEl.style.display='none',ms); };
const HOTEL_BBOX=[31.801445,36.597411,31.808467,36.600917];
const MAPBOX_TOKEN="pk.eyJ1IjoiaWxnYXJpc2lrIiwiYSI6ImNtZTYyejdkYjBxMDQya3F0ZGxlbDEwcHYifQ.nGPeU6QDAVFW7MGF_i9-ug";
const MAPTILER_KEY="YOUR_MAPTILER_KEY";
const emptyFC=()=>({type:'FeatureCollection',features:[]});
const isIcon=(u)=>{ try{const x=new URL(u); return /\.(png|svg)(\?.*)?$/i.test(x.pathname);}catch{return false;} };
const asHex=c=>!c?null:(c.startsWith('#')?c:('#'+c));

/* ===== MapLibre + Draw ===== */
const baseStyle={ version:8, sources:{}, layers:[{id:'bg',type:'background',paint:{'background-color':'#eef2f7'}}] };
const map=new maplibregl.Map({
  container:'map', style:baseStyle, center:[(HOTEL_BBOX[0]+HOTEL_BBOX[2])/2,(HOTEL_BBOX[1]+HOTEL_BBOX[3])/2], zoom:17, pitch:0, bearing:0,
  attributionControl:false, maxZoom:22
});
map.addControl(new maplibregl.NavigationControl(),'top-right');
map.addControl(new maplibregl.AttributionControl({customAttribution:'© aihotelstech · © OSM · © Mapbox · © MapTiler'}),'bottom-right');

/* Base sources (OSM/Mapbox/MapTiler) */
map.on('load',()=>{
  map.addSource('osm',{type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, attribution:'© OSM'});
  map.addLayer({id:'basemap-osm',type:'raster',source:'osm'});

  if(MAPBOX_TOKEN){
    map.addSource('sat',{type:'raster', tiles:[`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/256/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`], tileSize:256});
    map.addLayer({id:'basemap-sat',type:'raster',source:'sat',layout:{visibility:'none'}});
  }
  map.addSource('mtstreets',{type:'raster', tiles:[`https://api.maptiler.com/maps/streets/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`], tileSize:256});
  map.addLayer({id:'basemap-mtstreets',type:'raster',source:'mtstreets',layout:{visibility:'none'}});

  // OSM çizim üstlüğü (yarı saydam)
  map.addSource('osmOverlay',{type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256});
  map.addLayer({id:'osmOverlay',type:'raster',source:'osmOverlay',paint:{'raster-opacity':0.6}});

  // Foto image source (opsiyon)
  map.addSource('photo',{type:'image', url:'', coordinates:[[0,0],[0,0],[0,0],[0,0]]});
  map.addLayer({id:'basemap-photo',type:'raster',source:'photo',layout:{visibility:'none'},paint:{'raster-opacity':0.7}});

  // Yön oku ikonu
  map.loadImage('https://cdn.jsdelivr.net/gh/maplibre/demotiles@main/arrow.png',(e,img)=>{ if(!e) map.addImage('arrow',img,{sdf:false}); });

  map.fitBounds([[HOTEL_BBOX[0],HOTEL_BBOX[1]],[HOTEL_BBOX[2],HOTEL_BBOX[3]]],{padding:20,maxZoom:19});
});

/* Draw – kategoriye göre renk */
const Draw=new MapboxDraw({
  displayControlsDefault:false,
  controls:{ trash:true },
  styles:[
    // çizgi
    {id:'gl-draw-line',type:'line',filter:['all',['==','$type','LineString'],['!=',['get','user_hidden'],true]],
      paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],2]}},
    // çizgi yön oku
    {id:'gl-draw-line-arrows',type:'symbol',filter:['all',['==','$type','LineString'],['!=',['get','user_hidden'],true],['==',['get','user_arrows'],true]],
      layout:{'symbol-placement':'line','symbol-spacing':30,'icon-image':'arrow','icon-size':0.7}},
    // poligon dolgu
    {id:'gl-draw-polygon-fill',type:'fill',filter:['all',['==','$type','Polygon'],['!=',['get','user_hidden'],true]],
      paint:{'fill-color':['coalesce',['get','fill'],'#09DCE4'],'fill-opacity':['coalesce',['get','fill_op'],0.25]}},
    // poligon dış çizgi
    {id:'gl-draw-polygon-outline',type:'line',filter:['all',['==','$type','Polygon'],['!=',['get','user_hidden'],true]],
      paint:{'line-color':['coalesce',['get','stroke'],'#2563eb'],'line-width':['coalesce',['get','stroke_w'],1.6]}},
    // noktalar (ikon varsa ikon)
    {id:'gl-draw-point',type:'circle',filter:['all',['==','$type','Point'],['!has','icon']],
      paint:{'circle-radius':6,'circle-color':['coalesce',['get','stroke'],'#f94144'],'circle-stroke-color':'#fff','circle-stroke-width':1.6}},
    {id:'gl-draw-point-icon',type:'symbol',filter:['all',['==','$type','Point'],['has','icon']],
      layout:{'icon-image':['get','icon_name'],'icon-size':['/', ['coalesce',['get','icon_sz'],24], 24]}}
  ]
});
map.addControl(Draw);

/* Aktif hedef katman */
const layerSel=$('layerSel'); const osmOpacity=$('osmOpacity'); const opv=$('opv');
function targetLayer(){ return layerSel.value; }

/* OSM overlay opaklık */
osmOpacity.addEventListener('input',()=>{ const v=+osmOpacity.value/100; opv.textContent=v.toFixed(2); if(map.getLayer('osmOverlay')) map.setPaintProperty('osmOverlay','raster-opacity',v); });

/* Base switch + Foto modal */
const baseSel=$('baseSel'); const photoModal=$('photoModal');
baseSel.addEventListener('change',()=>{
  const v=baseSel.value;
  const vis=(id,on)=>{ if(map.getLayer(id)) map.setLayoutProperty(id,'visibility', on?'visible':'none'); };
  vis('basemap-osm', v==='osm'); vis('basemap-sat', v==='sat'); vis('basemap-mtstreets', v==='mtstreets'); vis('basemap-photo', v==='photo');
  if(v==='photo'){ photoModal.style.display='flex'; photoModal.setAttribute('aria-hidden','false'); }
});

/* Foto arka plan modal kontrolleri */
$('bgClose').onclick=()=>{ photoModal.style.display='none'; photoModal.setAttribute('aria-hidden','true'); };
$('bgApply').onclick=()=>{
  const url=$('bgImgUrl').value.trim(); if(!url){ alert('URL girin'); return; }
  function p(v){ const [x,y]=v.split(',').map(s=>+s.trim()); return [x,y]; }
  const lt=p($('bgLT').value), rt=p($('bgRT').value), rb=p($('bgRB').value), lb=p($('bgLB').value);
  map.getSource('photo').updateImage({url,coordinates:[lt,rt,rb,lb]});
  map.setPaintProperty('basemap-photo','raster-opacity', +$('bgOpacity').value/100);
  baseSel.value='photo';
  ['basemap-osm','basemap-sat','basemap-mtstreets'].forEach(id=>{ if(map.getLayer(id)) map.setLayoutProperty(id,'visibility','none'); });
  map.setLayoutProperty('basemap-photo','visibility','visible');
  photoModal.style.display='none'; setStatus('Foto arka plan uygulandı.');
};

/* Seçim / yaratım akışı */
const btnPoint=$('btnPoint'), btnLine=$('btnLine'), btnPoly=$('btnPoly'), btnSel=$('btnSel');
btnPoint.onclick=()=>{ Draw.changeMode('draw_point'); };
btnLine.onclick =()=>{ Draw.changeMode('draw_line_string'); };
btnPoly.onclick =()=>{ Draw.changeMode('draw_polygon'); };
btnSel.onclick  =()=>{ Draw.changeMode('simple_select'); };

/* Özellik modalı */
const modal=$('propModal');
const fields = {
  name:$('f_name'), category:$('f_category'), catOther:$('f_category_other'), catOtherWrap:$('catOtherWrap'),
  hours:$('f_hours'), level:$('f_level'), desc:$('f_desc'),
  icon:$('f_icon'), icon_sz:$('f_icon_sz'), image:$('f_image'),
  height:$('f_height'), levels:$('f_levels'),
  stroke:$('f_stroke'), stroke_w:$('f_stroke_w'), fill:$('f_fill'), fill_op:$('f_fill_op'),
  id:$('f_id'), metric:$('f_metric'),
  langSel:$('f_lang'), l_name:$('l_name'), l_hours:$('l_hours'), l_level:$('l_level'), l_desc:$('l_desc'), l_image:$('l_image'),
  btnSave:$('btnSave'), btnClose:$('btnClose'), btnGeom:$('btnGeom'), btnDelete:$('btnDelete')
};
fields.category.onchange=()=>{ fields.catOtherWrap.style.display = (fields.category.value==='_other')?'block':'none'; };

/* Seçili feature referansı */
let currentId=null;

/* Draw olayları → hedef katman & varsayılan stiller & id */
function applyDefaults(f){
  f.properties = f.properties||{};
  f.properties.__layer = targetLayer();
  if(f.geometry.type==='Polygon'){ if(!f.properties.fill) f.properties.fill='#09DCE4'; if(!f.properties.fill_op) f.properties.fill_op=0.25; }
  if(!f.properties.stroke) f.properties.stroke='#2563eb';
  if(!f.properties.stroke_w) f.properties.stroke_w=2;
  if(f.geometry.type==='LineString' && f.properties.user_arrows==null) f.properties.user_arrows=true;
}
map.on('draw.create',ev=>{
  ev.features.forEach(f=>{ applyDefaults(f); Draw.setFeatureProperty(f.id,'__layer',f.properties.__layer); });
  saveLocal();
  openPropsForSelection();
});
map.on('draw.update', ()=> saveLocal());
map.on('draw.selectionchange', ()=> openPropsForSelection());

/* Seçim ve formu aç */
function openPropsForSelection(){
  const sel=Draw.getSelected(); if(!sel.features.length){ return; }
  const f=sel.features[0]; currentId=f.id;
  const p=f.properties||{};
  // form doldur
  fields.name.value=p.name||''; fields.hours.value=p.hours||''; fields.level.value=p.level||''; fields.desc.value=p.desc||'';
  fields.icon.value=p.icon||''; fields.icon_sz.value=p.icon_sz||''; fields.image.value=p.image||'';
  fields.height.value=p.height??''; fields.levels.value=p.levels??'';
  fields.stroke.value=p.stroke||''; fields.stroke_w.value=p.stroke_w??''; fields.fill.value=p.fill||''; fields.fill_op.value=p.fill_op??'';
  fields.id.value=f.id;
  // kategori
  const cat=p.category||''; if([...fields.category.options].some(o=>o.value===cat)){ fields.category.value=cat; fields.catOtherWrap.style.display='none'; fields.catOther.value=''; }else if(cat){ fields.category.value='_other'; fields.catOtherWrap.style.display='block'; fields.catOther.value=cat; }else{ fields.category.value=''; fields.catOtherWrap.style.display='none'; fields.catOther.value=''; }
  // metrik
  fields.metric.value = summarize(f);
  // dil
  loadLang(p);
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
}

/* dil alanları */
let i18nLang='tr';
function loadLang(p){
  i18nLang=fields.langSel.value;
  fields.l_name.value=p['name_'+i18nLang]||'';
  fields.l_hours.value=p['hours_'+i18nLang]||'';
  fields.l_level.value=p['level_'+i18nLang]||'';
  fields.l_desc.value=p['desc_'+i18nLang]||'';
  fields.l_image.value=p['image_'+i18nLang]||'';
}
fields.langSel.onchange=()=>{ const f=Draw.get(currentId); if(f) loadLang(f.properties||{}); };

/* form kaydet */
fields.btnSave.onclick=()=>{
  const f=Draw.get(currentId); if(!f) return;
  const p=f.properties||(f.properties={});
  const cat = fields.category.value==='_other' ? fields.catOther.value.trim() : fields.category.value;
  p.name=fields.name.value.trim()||undefined; p.category=cat||undefined;
  p.hours=fields.hours.value.trim()||undefined; p.level=fields.level.value.trim()||undefined; p.desc=fields.desc.value.trim()||undefined;
  const ic=fields.icon.value.trim(); p.icon = isIcon(ic)?ic:undefined;
  p.icon_sz = (ic && isIcon(ic)) ? Math.max(8,Math.min(64, +fields.icon_sz.value||24)) : undefined;
  const im=fields.image.value.trim(); p.image = im || undefined;
  p.height = numOr(fields.height.value); p.levels = intOr(fields.levels.value);
  p.stroke = asHex(fields.stroke.value)||undefined; p.stroke_w = numOr(fields.stroke_w.value);
  p.fill = asHex(fields.fill.value)||undefined; p.fill_op = numOr(fields.fill_op.value);

  // dil alanları
  const ln=i18nLang;
  p['name_'+ln]=fields.l_name.value.trim()||undefined;
  p['hours_'+ln]=fields.l_hours.value.trim()||undefined;
  p['level_'+ln]=fields.l_level.value.trim()||undefined;
  p['desc_'+ln]=fields.l_desc.value.trim()||undefined;
  p['image_'+ln]=fields.l_image.value.trim()||undefined;

  Draw.setFeatureProperty(f.id,'user_arrows', (f.geometry.type==='LineString') ? p.user_arrows!==false : undefined);
  saveLocal(); setStatus('Kaydedildi.');
};
fields.btnGeom.onclick=()=>{ Draw.changeMode('direct_select',{featureId:currentId}); };
fields.btnDelete.onclick=()=>{ if(confirm('Silinsin mi?')){ Draw.delete(currentId); modal.style.display='none'; saveLocal(); } };
fields.btnClose.onclick=()=>{ modal.style.display='none'; };

/* Kopyala / Reverse / Oklar */
$('btnDup').onclick=()=>{
  const sel=Draw.getSelected(); if(!sel.features.length) return;
  const f=turf.clone(sel.features[0]); delete f.id;
  // az kaydır
  const off=0.00005;
  if(f.geometry.type==='Point'){ f.geometry.coordinates=[f.geometry.coordinates[0]+off,f.geometry.coordinates[1]+off]; }
  else{ f.geometry.coordinates = turf.transformTranslate(f, 7, 45, {units:'meters'}).geometry.coordinates; }
  applyDefaults(f); Draw.add(f); setStatus('Kopyalandı.');
};
$('btnReverse').onclick=()=>{
  const sel=Draw.getSelected(); if(!sel.features.length) return;
  const f=sel.features[0]; if(f.geometry.type!=='LineString') return alert('Sadece çizgi.');
  const rev=turf.flip(turf.lineString([...f.geometry.coordinates].reverse()));
  f.geometry.coordinates=rev.geometry.coordinates; Draw.add(f); Draw.delete(sel.features[0].id); setStatus('Ters çevrildi.');
};
let arrowsOn=true;
$('btnArrows').onclick=()=>{
  arrowsOn=!arrowsOn;
  const ids=Draw.getAll().features.filter(g=>g.geometry.type==='LineString').map(g=>g.id);
  ids.forEach(id=> Draw.setFeatureProperty(id,'user_arrows',arrowsOn));
  $('btnArrows').textContent = arrowsOn ? '➤ Yön Okları: Açık' : '➤ Yön Okları: Kapalı';
  saveLocal();
};

/* Filtre: kat */
$('levelFilter').addEventListener('input',()=>{
  const flt=$('levelFilter').value.trim().toLowerCase();
  const all=Draw.getAll().features;
  all.forEach(f=>{
    const lvl=((f.properties||{}).level||'').toString().toLowerCase();
    const hide = flt && lvl!==flt;
    Draw.setFeatureProperty(f.id,'user_hidden',hide);
  });
});

/* Export/Import – __layer’e göre ayır */
function splitByLayer(){
  const all=Draw.getAll().features;
  const o={indoor:[],outdoor:[],buildings:[],routes:[]};
  all.forEach(f=>{
    const c=turf.clone(f); delete c.id;
    const L=(c.properties&&c.properties.__layer)||'outdoor';
    (o[L]||o.outdoor).push(c);
  });
  const fc=k=>({type:'FeatureCollection',features:o[k]});
  return {indoor:fc('indoor'), outdoor:fc('outdoor'), buildings:fc('buildings'), routes:fc('routes')};
}
function download(obj,name){ const b=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
$('expIndoor').onclick =()=> download(splitByLayer().indoor,'indoor.json');
$('expOutdoor').onclick=()=> download(splitByLayer().outdoor,'outdoor.json');
$('expBuildings').onclick=()=> download(splitByLayer().buildings,'buildings.json');
$('expRoutes').onclick  =()=> download(splitByLayer().routes,'routes.json');

/* Import → aktif hedefe yazar */
$('imp').addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file) return;
  const txt=await file.text(); let gj; try{ gj=JSON.parse(txt);}catch{ alert('Geçersiz JSON'); e.target.value=''; return; }
  if(!(gj && gj.type==='FeatureCollection')){ alert('FeatureCollection bekleniyor'); e.target.value=''; return; }
  gj.features.forEach(f=>{ f.properties=f.properties||{}; f.properties.__layer=targetLayer(); applyDefaults(f); Draw.add(f); });
  saveLocal(); setStatus('İçeri alındı.');
  e.target.value='';
});
$('clearLocal').onclick=()=>{ if(confirm('Yerel veri silinsin mi?')){ localStorage.removeItem('draw-store'); location.reload(); } };

/* Local storage persist */
function saveLocal(){ const all=Draw.getAll(); try{ localStorage.setItem('draw-store', JSON.stringify(all)); }catch{} }
(function restore(){
  try{ const s=localStorage.getItem('draw-store'); if(!s) return; const data=JSON.parse(s); if(data && data.features) data.features.forEach(f=>Draw.add(f)); }catch{}
})();

/* Yardımcılar */
function numOr(v){ const n=+v; return Number.isFinite(n)?n:undefined; }
function intOr(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:undefined; }
function summarize(f){
  if(f.geometry.type==='Polygon'){ try{ const a=turf.area(f); return `Poligon · alan ≈ ${Math.round(a)} m²`; }catch{return 'Poligon';} }
  if(f.geometry.type==='LineString'){ try{ const l=turf.length(f,{units:'kilometers'}); return `Çizgi · uzunluk ≈ ${(l*1000).toFixed(0)} m`; }catch{return 'Çizgi';} }
  if(f.geometry.type==='Point'){ return 'Nokta'; }
  return '';
}

/* Özellikler butonu: seçili yoksa en son seçtirir */
$('btnProps').onclick=()=>{ if(!Draw.getSelected().features.length){ Draw.changeMode('simple_select'); } openPropsForSelection(); };

/* Hedef katman değişince yeni çizilenlere işaret koyacağız */
layerSel.addEventListener('change',()=> setStatus(`Hedef: ${layerSel.value.toUpperCase()}`));
</script>
</body>
</html>
